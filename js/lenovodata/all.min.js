define("lenovodata/bannerslide",function(require,exports,modules){function doSlide(banner){var slide={current:0,container:banner,self:this,next:function(){slide.current++,3==slide.current&&(slide.current=0),slide.render(slide.current)},render:function(index){slide.container.find("ul.ul-number li").eq(index).addClass("on").siblings().removeClass("on"),slide.container.parent(".banner-bg2").css("background","url(/css/theme/default/img/index/index_banner"+index+".png) top center no-repeat"),slide.container.find("ul.ul-content li").eq(index).show().siblings().hide()}},time=setInterval(slide.next,5e3);slide.container.find("ul.ul-number li").on("click",function(){clearInterval(time),slide.current=$(this).index(),slide.render(slide.current)}).on("mouseout",function(){time=setInterval(slide.next,5e3)}).on("mouseover",function(){clearInterval(time)})}var $=require("jquery");exports.init=function(options){var banner=$("<div class='banner-num'><ul class='ul-number'><li class='on'></li><li></li><li></li></ul></div><div class='banner-content'><ul class='ul-content'><li class='activity mobile'><a href='/client/android/bin/LenovoBox.apk'>下载到PC</a></li><li><a target='_blank' href='http://email.box.lenovo.com/email/lenovo_sjhs1_boxlenovo.html'>免费试用</a></li><li class='client'></li></ul></div>");this.banner=banner,$(".banner-bg2").append(banner),doSlide(banner)}}),define("component/addAuthDialog",function(require,exports,module){function AddAuthDialog(fileAttr,ok_callback){this.fileAttr=fileAttr,this.path=this.fileAttr.path,this.userList=null,this.ok_callback=ok_callback,this.action=AuthModel.ACTION.PREVIEW,this._init()}var $=require("jquery"),Util=require("util"),Tips=require("component/tips"),Dialog=require("component/dialog"),Mask=require("component/mask"),AuthModel=require("model/AuthManager"),AuthCombox=(require("model/UserManager"),require("component/authCombox")),AddUserDialog=require("component/addUserDialog"),SelectUserCore=require("component/selectUserCore");Wait=require("component/wait"),require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(AddAuthDialog.prototype,{_init:function(){var self=this,auth_conainter_id="auth-conainter"+Math.ceil(1e11*Math.random());self.dialog=new Dialog(_("添加授权"),{mask:!0},function(dialog){var authHtml=[];authHtml.push('<div id="add-auth-dialog-id">'),!self.fileAttr.team&&Util.isAdmin()&&(authHtml.push('<div style="margin-top:15px;">'),authHtml.push('<input type="radio" name="auth-select" checked="checked" value="all" id="rd1" style="margin-right:12px;">'),authHtml.push('<label for="rd1">'+_("公共(所有成员可以访问)")+"</label>"),authHtml.push("</div>")),self.fileAttr.team&&(authHtml.push('<div style="margin-top:15px;">'),authHtml.push('<input type="radio" name="auth-select" value="team" id="rd2" style="margin-right:12px;">'),authHtml.push('<label for="rd2">'+_('对团队 "{0}" 的所有成员授权',self.fileAttr.team)+"</label>"),authHtml.push("</div>")),authHtml.push('<div style="margin-top:15px;">'),authHtml.push('<input type="radio"  name="auth-select" value="user" id="rd3" style="margin-right:12px;"/>'),authHtml.push('<label for="rd3">'+_("对指定用户授权")+"</label>"),authHtml.push("</div>"),authHtml.push('<div id="auth-spec-user-list-container" style="margin-top:15px;display:none;">'),authHtml.push('<div id="auth-spec-user-list"></div><!--<a id="addUserBtn" class="addUserBtn">创建用户</a>--></div>'),authHtml.push('<div style="margin-top:15px;"><span style="float:left">'+_("权限")+'</span><span id="'+auth_conainter_id+'" style="margin-left:12px;float:left"></span>'),authHtml.push("</div>"),authHtml.push("</div>"),dialog.append(authHtml.join("")+'<div class="dialog-button-area"><a id="add-auth-dialog-id-ok" class="dialog-button ok">'+_("确定")+'</a> <a id="add-auth-dialog-id-cancel" class="dialog-button cancel">'+_("取消")+"</a></div>")}),new AuthCombox("#"+auth_conainter_id,null,null,function(action){self.action=action}),$("#auth-user-list-search").keyup(function(e){var query=$.trim($("#auth-user-list-search").val());if(""==query)return void self._insertUserList(self.userList);for(var result=[],i=0,len=self.userList.length;len>i;i++)-1!=self.userList[i].user_name.indexOf(query)&&result.push(self.userList[i]);self._insertUserList(result)}),$("#add-auth-dialog-id").find("input").click(function(){var Elem=$(this);if("radio"==Elem.attr("type")&&"user"==Elem.attr("value")&&"none"==$("#auth-spec-user-list-container").css("display")){$("#auth-spec-user-list-container").show();var no=$("#auth-spec-user-list");no.empty(),self.suc=new SelectUserCore(no,self.fileAttr.teamId),$("#addUserBtn").on("click",function(){new Mask(self.dialog.dialog),new AddUserDialog(null,null,function(){},{mask:!1})})}else"user"!=Elem.attr("value")&&"radio"==Elem.attr("type")&&$("#auth-spec-user-list-container").hide()}),$("#add-auth-dialog-id-cancel").click(function(){self.dialog.close()}),$("#add-auth-dialog-id-ok").click(function(){function _create(ret){if(200==ret.code)self.dialog.close(),self.ok_callback();else if(500==ret.code)Tips.warn(ret.message.join("<br/>"));else{if(""==ret.message)return void Tips.warn(_("您的操作失败了，请稍后重试"));Tips.warn(ret.message)}}var authType=$("#add-auth-dialog-id input:radio:checked").attr("value");switch(authType){case"user":for(var arr=self.suc.getSelectedItem(),uids=[],i=0;i<arr.length;i++)uids.push(arr[i].uid);AuthModel.batch_user_set(_create,self.path,self.action,uids);break;case"team":var teamId=self.fileAttr.teamId;AuthModel.create(_create,self.path,self.action,teamId,AuthModel.AGENT_TYPE.TEAM);break;case"all":AuthModel.create(_create,self.path,self.action,null,AuthModel.AGENT_TYPE.ALL)}})},_insertUserList:function(userList){var htmlArr=[];$("#auth-spec-user-list").empty();for(var i=0,len=userList.length;len>i;i++)htmlArr.push('<div style="float:left;width:140px;padding:2px 2px;"><input type="checkbox" value="'+userList[i].uid+'"><span class="icon i-all-portrait" style="margin-left:5px;"></span><span style="float:right;width:100px;text-overflow:ellipsis;overflow:hidden;">'+userList[i].user_name+"</span></div>");$("#auth-spec-user-list").append(htmlArr.join(""))}}),AddAuthDialog}),define("component/addDirAuthDialog",function(require,exports,module){function AddDirAuthDialog(teamPath,parentDialog,userType,teamName,ok_callback){var self=this;self.teamPath=teamPath,self.parentDialog=parentDialog,self.userType=userType,self.teamName=teamName,self.ok_callback=ok_callback,self._init()}var $=require("jquery"),DirSelectDialog=(require("component/dialog"),require("component/dirSelectDialog")),AddFolder=require("component/addfolder"),FileController=require("lenovodata/fileController"),Tips=require("component/tips");require("i18n");var _=$.i18n.prop;return $.extend(AddDirAuthDialog.prototype,{_init:function(){var self=this;self.dialog=new DirSelectDialog({teamPath:self.teamPath,teamName:self.teamName,title:_("添加文件夹访问权限"),buttonContext:'<div class="add-dir-auth-dialog-div" id="auth-create-dir"><span class="add-sign">+</span><span class="create-dir">'+_("添加文件夹")+'</span></div><div class="dialog-button-area"><a id="add-auth-ok-btn" class="dialog-button ok">'+_("添加")+'</a> <a id="cancel-dialog" class="dialog-button cancel">'+_("取消")+"</a></div>"},450,200),$("#auth-create-dir").click(function(){var node=self.dialog.getSelectNode();new AddFolder(window.publist,node.realpath,function(childpath){self.dialog.insertDir(node.realpath,childpath)})}),$("#add-auth-ok-btn").click(function(){return self.authPath=self.dialog.getSelectDir(),self.authPath?(self.dialog.close(),void new FileController(window.publist,"auth",{path:self.authPath})):(self.authPath="/",void Tips.warn(_("根目录禁止授权，请选择其它文件夹")))}),$("#cancel-dialog").click(function(){self.dialog.close()})}}),AddDirAuthDialog}),define("component/addMemberDialog",function(require,exports,module){function AddMemberDialog(params,callback){var auth_list_config={noclick:!0,column:1,hasRoleCombox:!0,template:['<li class="list-item item-{{agent_type}}" index="{{index}}" title="{{name}}{{#email}}({{email}}){{/email}}{{#domain_team}}(',_("域团队"),"){{/domain_team}}{{#domain_user}}-",_("企业认证用户"),'{{/domain_user}}">','<span class="icon i-authdelete"></span><div class="lui-combox auth-combox" id="combox-{{index}}"></div>','<span class="icon i-{{agent_type}}{{#is_domain}}-domain{{/is_domain}}"></span>','<span class="item-text">{{name}}{{#email}}({{email}}){{/email}}</span>',"</li>"].join("")};this.option=$.extend(params,auth_list_config),this.callback=callback,this._init()}var $=require("jquery"),SearchBox=require("component/searchbox"),Tips=require("component/tips"),Dialog=require("component/dialog"),ConfirmDialog=require("component/confirmDialog"),MemberTree=require("component/memberTree"),TeamModel=require("model/TeamManager"),ListView=require("component/listview"),EventTarget=require("component/eventTarget"),_=$.i18n.prop,Util=require("util");return $.extend(AddMemberDialog.prototype,EventTarget,{_init:function(){var inner=["<div class='auth-pane'>","<div class='teamtree'><h2>"+_("团队成员")+"</h2>","<div class='search-box'></div>","<div id='teamGroup' class='treewrapper'></div>","<div class='listwrapper'></div>","</div>","<div class='icon-arrow'><span class='icon i-arrow-right'></span></div>","<div class='share-list'><h2>"+_("成员")+"</h2>","<div class='list-wrap'>","<div class='lui-list'></div>","<a id='removeAll'>"+_("清空所有用户")+"</a>","</div>","</div>","</div>","<div class='dialog-button-area'>","<a class='dialog-button ok'>"+_("确定")+"</a><a class='dialog-button cancel'>"+_("取消")+"</a>","</div>"].join(""),self=this,dialog=new Dialog(_("添加团队成员"),function(parentNode,func){/msie/.test(navigator.userAgent.toLowerCase())&&parentNode.css("width",680),self.contentWraper=parentNode,parentNode.append($(inner)),self.auth_list=new ListView($(".lui-list"),self.option),self.auth_list.data=[],self.render()});this.dialog=dialog},render:function(){var self=this,searchBox=new SearchBox(this.contentWraper.find(".search-box"),function(result){self.contentWraper.find(".treewrapper").hide(),self.contentWraper.find(".listwrapper").show();for(var datas=[],i=0,len=result.length;len>i;i++){var item=result[i],d={};"user"==item.agent_type&&(d={id:item.uid,uid:item.uid,name:item.user_name,email:item.email,is_domain:item.from_domain_account,domain_user:item.from_domain_account,agent_id:item.uid,agent_type:"user",cssAction:"preview"},d.role="member",datas.push(d))}self.user_team_list.render(datas)});self.user_team_list=new ListView($(".listwrapper"),{column:1,template:'<li class="list-item" index="{{index}}" title="{{name}}{{#email}}({{email}}){{/email}}{{#domain_team}}('+_("域团队")+"){{/domain_team}}{{#domain_user}}-"+_("企业认证用户")+'{{/domain_user}}"><span class="icon i-{{agent_type}}{{#is_domain}}-domain{{/is_domain}}"></span><span class="item-text text-{{agent_type}}">{{name}}{{#email}}({{email}}){{/email}}</span></li>'}),searchBox.on("close",function(){self.contentWraper.find(".treewrapper").show(),self.contentWraper.find(".listwrapper").hide()}),self.tree=new MemberTree(self.contentWraper.find(".treewrapper"),function(param,success,error){TeamModel.getTeamListById(function(result){success(result)})},{type:1,title:_("所有用户"),authTree:!0,max_height:220}),self.tree.render(),self.bindEvent()},bindEvent:function(){var self=this;self.tree.on("selectNode",function(node){var obj={id:node.id,uid:node.id,name:node.name,email:node.email,agent_id:node.agent_id,is_domain:node.isCer,agent_type:node.agent_type,role:"member"};Util.dataInArray(obj,self.auth_list.data)||(self.auth_list.data.push(obj),self.renderAuthList())}),self.user_team_list.on("item-added",function(obj){Util.dataInArray(obj,self.auth_list.data)||(self.auth_list.data.push(obj),self.renderAuthList())}),self.auth_list.on("delete",function(index){new ConfirmDialog({content:_("您确认要删除吗？")},function(){self.auth_list.data.splice(index,1),self.renderAuthList()})}),self.contentWraper.find("#removeAll").click(function(ev){0!=self.auth_list.data.length&&new ConfirmDialog({content:_("您确认要清空所有用户吗？")},function(){self.auth_list.data=[],self.renderAuthList()})}),self.contentWraper.find(".dialog-button-area a.ok").click(function(ev){self.submitAuth()}),self.contentWraper.find(".dialog-button-area a.cancel").click(function(ev){self.dialog.close()})},renderAuthList:function(){var self=this,sort_by=function(name,minor){return function(o,p){var a,b;return o&&p&&"object"==typeof o&&"object"==typeof p?(a=o[name],b=p[name],a===b?"function"==typeof minor?minor(o,p):0:typeof a==typeof b?b>a?-1:1:typeof b>typeof a?-1:1):void thro("error")}};self.auth_list.data=Util.unique1(self.auth_list.data);var result=self.auth_list.data.sort(sort_by("agent_type",sort_by("name")));self.auth_list.render(result)},submitAuth:function(){for(var arr=this.auth_list.getAuthItem(),entry_infos=[],i=0;i<arr.length;i++){var item=arr[i];"[object Function]"!=Object.prototype.toString.call(item)&&entry_infos.push('{"uid":'+item.uid+',"role":"'+item.role+'"}')}if(0==entry_infos.length)return this.callback&&this.callback(),void this.dialog.close();var self=this;TeamModel.membership_batch_creat(function(ret){200==ret.code?(Tips.show(_("添加成功")),self.callback&&self.callback(),self.dialog.close()):Tips.warn(ret.message)},this.option.id,entry_infos)}}),AddMemberDialog}),define("component/addTeamDialog",function(require,exports){function AddTeamDialog(teamPath,callback,TeamContext){this.path=teamPath,this.callback=callback,this.TeamContext=TeamContext,this._init()}var $=require("jquery"),Dialog=(require("component/validator"),require("component/dialog")),TeamModel=require("model/TeamManager"),Tips=(require("component/teamMenu"),require("model/AccountManager"),require("component/tips")),Util=require("util"),Mask=require("component/mask"),EventTarget=require("eventTarget");require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(AddTeamDialog.prototype,EventTarget,{_init:function(){var self=this,step1_template='<div id="addTeamDialog" class="form"><p><span class="label">'+_("团队名称")+'</span><input id="name" type="text" maxlength="25"/></p><p><span class="label">'+_("团队空间")+'</span><input id="quota" type="text"/>&nbsp;MB&nbsp;<span class="spaceQuota">'+_("(上限为{{quota}}MB)")+'</span></p><p><span class="label">'+_("团队人数上限")+'</span><input id="userlimit" type="text"/>&nbsp;&nbsp;<span class="userQuota">'+_("(团队成员最大上限为{{user_limit}})")+'</span></p><p><span class="label txarealabl">'+_("备注")+'</span><textarea id="remark" maxlength="250"></textarea></p></div><div class="dialog-button-area"><a id="create" class="dialog-button ok">'+_("创建")+'</a><a id="cancel" class="dialog-button cancel">'+_("取消")+"</a></div>",dialog=('<div id="addTeamDialog"><p class="sucess-top">'+_("团队“{{name}}”创建成功")+'</p><hr><p class="sucess-bottom">'+_("团队包含“成员列表”和“授权列表”两个试图，分别用于管理团队成员和团队成员的批量授权管理。")+'</p></div><div class="dialog-button-area"><a id="cancel-1" class="dialog-button">'+_("关闭")+"</a></div>",new Dialog(_("创建团队"),function(parent){var space=($("#addTeamDialog span.spaceQuota"),$("#addTeamDialog span.userQuota"),{});self.TeamContext?(space.user_limit=self.TeamContext.member_limit,space.quota=self.TeamContext.quota/1024/1024):(space.user_limit=Util.getUserAccountNumQuota(),space.quota=Util.getUserSpaceQuota()/1024/1024),parent.append(Mustache.render(step1_template,space)),parent.find("#create").on("click",function(){var name=$.trim($("#name").val()),quota=$.trim($("#quota").val()),userlimit=$.trim($("#userlimit").val()),remark=$("#remark").val();if(""==name)return void dialog.showMessage("["+_("团队名称")+"]"+_("不能为空"));if(/[\/:*?"<>|\\]|^[.]|[.]$/.test(name))return Tips.warn(_("名称不能包括下列任何字符")+' : \\/:*?"<>|'+_(" 或以 . 开头和结尾！")),!1;if(""==quota)return void dialog.showMessage("["+_("团队空间")+"]"+_("不能为空"));if(!/^\d+$/.test(quota))return void dialog.showMessage(_("请输入正整数")+"["+_("团队空间")+"]");if("disabled"!=$("#userlimit").attr("disabled")){if(""==userlimit)return void dialog.showMessage("["+_("团队人数上限")+"]"+_("不能为空"));if(""!=userlimit&&!/^\d+$/.test(userlimit))return void dialog.showMessage(_("请输入正整数")+"["+_("团队人数上限")+"]");if(""==(userlimit=userlimit.replace(/^0+/,"")))return void dialog.showMessage("["+_("团队人数上限")+"]"+_("不能为零"))}if(remark.length>250)return void dialog.showMessage("["+_("备注")+"]"+_("超过了250个字符"));var limit=$.trim($("#userlimit").val()),mask=new Mask(dialog.dialog);$("body").data("category","add").data("action","功能区内按钮").data("content","团队"),TeamModel.create(function(result){200==result.code?(dialog.close(),Tips.show(_("团队创建成功")),mask.close(),self.callback(result.data),self.fire("close",!0)):(Tips.warn(result.message),mask.close())},{name:self.path+"/"+name,quota:Util.scientificToString(1024*$("#quota").val()*1024),member_limit:limit.toString(),description:remark})}),parent.find("#cancel").on("click",function(){dialog.close()})}))}}),AddTeamDialog}),define("component/addUser2TeamGuidDialog",function(require,exports,module){function AddUser2TeamGuidDialog(uid){this.uid=uid,this._init()}var $=require("jquery"),TeamList=require("component/teamList"),Dialog=require("component/dialog"),ConfirmDialog=require("component/confirmDialog"),Tips=require("component/tips"),SelectTeamDialog=require("component/selectTeamDialog"),TeamModel=require("model/TeamManager");require("i18n");var _=$.i18n.prop;return $.extend(AddUser2TeamGuidDialog.prototype,{_init:function(){var self=this,htmlArr=[];htmlArr.push('<div class="team-user-dialog">'),htmlArr.push('<div class="team-list-subtitle">'+_("所属团队")+"</div>"),htmlArr.push('<div class="team-list-c" style="height:265px;"></div>'),htmlArr.push('<div class="team-list-add-link">'),htmlArr.push('<span class="icon i-add-sign"></span><span>'+_("加入团队")+"</span>"),htmlArr.push("</div>"),htmlArr.push("</div>"),self.dialog=new Dialog(_("用户配置向导"),{mask:!0},function(dialog){dialog.append(htmlArr.join("")+'<div class="dialog-button-area"><a id="teamofusers-next" class="dialog-button ok">'+_("下一步")+'</a><a id="teamofusers-cancel" class="dialog-button cancel">'+_("取消")+"</a></div>")}),TeamModel.list(function(ret){if(200!=ret.code)return void Tips.warn(ret.message);for(var teamData=[],i=0,len=ret.data.length;len>i;i++)teamData.push({name:ret.data[i].name,role:ret.data[i].role,dataid:ret.data[i]._id});new TeamList(".team-list-c",self.uid,teamData,function(e,dataid,uids){new ConfirmDialog({content:_("真的要从团队中删除当前用户吗？")},function(){TeamModel.membership_kickoff(function(ret){Tips.show(ret.message),200==ret.code&&$(e.currentTarget).parent().parent().remove()},dataid,uids)})},function(dataItem,role){TeamModel.set_role(function(ret){200!=ret.code&&Tips.warn(ret.message)},dataItem.dataid,self.uid,role)})},!1,self.uid),$("#teamofusers-next").click(function(){self.dialog.close()}),$("#teamofusers-cancel").click(function(){self.dialog.close()}),$(".team-list-add-link").click(function(){new SelectTeamDialog(function(teams){for(var teamIds=[],i=0,len=teams.length;len>i;i++)teamIds.push(teams[i].value);TeamModel.batch_join(function(ret){200!=ret.code&&Tips.warn(ret.message)},self.uid,teamIds)})})},close:function(){this.dialog.close()}}),AddUser2TeamGuidDialog}),define("component/addUserDialog",function(require,exports){function AddUserDialog(context,teamId,callback,opt){this.context=context,this.teamId=teamId,this._callback=callback,this.opt=opt||{},this._init()}var $=require("jquery"),Dialog=(require("component/validator"),require("component/dialog")),Tips=require("component/tips"),Util=require("util"),UserModel=(require("component/addUser2TeamGuidDialog"),require("model/UserManager")),TeamModel=require("model/TeamManager");require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(AddUserDialog.prototype,{_init:function(){var self=this,create_template='<div id="addUserDialog" class="form"><p><span class="label">'+_("登录邮箱")+'</span><input id="email" type="text" maxlength="50"/> *</p><p><span class="label">'+_("手机号码")+'</span><input id="phone" type="text"/></p><p><span class="label">'+_("用户名")+'</span><input id="name" maxlength="50" type="text"/> *</p><p><span class="label">'+_("个人空间")+'</span><input id="quota" type="text"/>&nbsp;<select class="quotaSelect"><option value="M">MB</option><option value="G">GB</option></select>&nbsp;&nbsp;<span style="color:#888" class="tip">'+_("不能超过企业总空间大小")+"("+Util.formatBytes(window.LenovoData.user.account_info.space.limit)+')</span></p><p><span class="label">'+_("密码")+'</span><input id="password" type="password" maxlength="32" onpaste="return false"/></p><p><span class="label">'+_("重复密码")+'</span><input id="password2" type="password" maxlength="32" onpaste="return false"/></p><p><input type="checkbox" id="mailActive"/><label for="mailActive">'+_("使用激活方式，通过电子邮件发送激活链接，由用户自行设置密码")+'</label></p><p><input type="checkbox" id="changePassword"/><label for="changePassword">'+_("禁止账号修改密码")+'</label></p></div><div class="dialog-button-area"><button id="create" class="dialog-button ok">'+_("创建")+'</button><button id="cancel" class="dialog-button cancel">'+_("取消")+"</button></div>",dialog=('<div id="addUserDialog"><p class="sucess-top">'+_("用户“{{name}}”创建成功")+'</p><hr><p class="sucess-bottom">'+_("你可以进入用户配置向导将用户添加到团队中，并为用户添加文件夹访问权限。<br><br>如果您不需要进行上述操作，请点击“关闭”关闭向导。")+'</p></div><div class="dialog-button-area"><a id="navigate" class="dialog-button">'+_("进入向导")+'</a><a id="close-dialog" class="dialog-button">'+_("关闭")+"</a></div>",new Dialog(_("创建用户"),self.opt,function(parent,callback){parent.append(create_template);var quota=window.LenovoData.user.account_info.default_user_quota;$("#quota").focus(function(){0==$("#quota").val()&&$("#quota").val("")}),$("#quota").blur(function(){""==$("#quota").val()&&$("#quota").val("0")}),$("#quota").val(quota?quota/1024/1024:0);var name=$("#name"),email=$("#email"),quota=$("#quota"),phone=$("#phone"),password=$("#password"),password2=$("#password2");$("#mailActive").on("click",function(e){this.checked?($("#changePassword").get(0).checked=!1,password.attr("disabled",!0),password2.attr("disabled",!0),password.addClass("disabledInput"),password2.addClass("disabledInput")):(password.removeAttr("disabled"),password2.removeAttr("disabled"),password.removeClass("disabledInput"),password2.removeClass("disabledInput"))}),$("#changePassword").on("click",function(e){this.checked&&($("#mailActive").get(0).checked=!1,password.removeAttr("disabled"),password2.removeAttr("disabled"),password.removeClass("disabledInput"),password2.removeClass("disabledInput"))});var quotaUsed=1048576;$(".quotaSelect").change(function(){var n=$(".quotaSelect").val();quotaUsed="G"==n?1073741824:1048576}),parent.find("#create").on("click",function(e){if(""==$.trim(email.val()))return void dialog.showMessage(_("邮箱不能为空"));if(!Util.validEmail(email.val()))return void dialog.showMessage(_("邮箱地址不符合要求"));if(email.val().length<6||email.val().length>50)return void dialog.showMessage(_("邮箱长度限制在6~50个字符"));if(""!=$.trim(phone.val())&&!Util.validMobile(phone.val()))return void dialog.showMessage(_("请输入11位手机号码，如139-XXXX-XXXX"));if(""==$.trim(name.val()))return void dialog.showMessage(_("用户名不能为空"));if(Util.getBytes($.trim(name.val()))>50)return void dialog.showMessage(_("用户名长度限制在50个字符以内"));if(Util.validInput(name,_("用户名不能包括特殊字符"))){if(""==$.trim(quota.val()))return void dialog.showMessage(_("空间大小不能为空"));if(/\./g.test(quota.val())||!Util.validNumber(quota.val()))return void dialog.showMessage(_("空间大小请输入正确的数字"));if(void 0==password.attr("disabled")){if(password.val().length<6||password.val().length>32)return void dialog.showMessage(_("密码长度为6-32个字符"));if(!password2.val()||0==password2.val().length)return void dialog.showMessage(_("请输入确认密码"));if(password.val()!=password2.val())return void dialog.showMessage(_("两次输入密码不一致，请重新输入！"))}$(e.target).attr("disabled",!0).text(_("创建中...")),UserModel.create(function(result){return 200!=result.code?(dialog.showMessage("Error #1001"==result.message.substr(0,11)?_(result.message.substr(13)):_(result.message)),void $(e.target).removeAttr("disabled").text(_("创建"))):(self.uid=result.data.uid,void(self.teamId?TeamModel.membership_create(function(result){200==result.code?(dialog.close(),self.context&&self.context.reload(),Tips.show(_("用户创建成功"))):(dialog.showMessage("Error #1001"==result.message.substr(0,11)?_(result.message.substr(13)):_(result.message)),$(e.target).attr("disabled",!0).text(_("创建")))},self.teamId,[self.uid]):(dialog.close(),self.context&&self.context.reload(),Tips.show(_("用户创建成功")))))},"email:"+$.trim(email.val()).toLowerCase(),name.val(),$.trim(email.val()).toLowerCase(),quota.val()*quotaUsed,password.val(),phone.val(),$("#changePassword").get(0).checked?!1:!0,$("#mailActive").get(0).checked?!1:!0)}}),parent.find("#cancel").on("click",function(){dialog.close()}),$("#mailActive").trigger("click")}))}}),AddUserDialog}),define("component/addfolder",function(require,exports,module){function AddFolder(context,path,callback){this.context=context,this.path=path,this.callback=callback,this.render()}return $=require("jquery"),Util=require("util"),_=$.i18n.prop,FileModel=require("model/FileManager"),Tips=require("component/tips"),AddFolder.prototype={render:function(){function createfolder(){var name=$.trim($(".new-item .edit-name .box").val());if(""==name)return void Tips.warn(_("文件夹名不能为空或空格"));if(Util.validFilename(name)){var newpath="/"+self.path+"/"+name;FileModel.create_folder(function(ret){if(200!=ret.code)return void Tips.warn(ret.message);var curPath=ret.data.path;Tips.show(Mustache.render(_("成功创建“{{name}}”文件夹"),{name:curPath.substring(curPath.lastIndexOf("/")+1)})),self.context.reload(),self.callback&&self.callback(curPath)},newpath,self.context.type?self.context.type:"ent",self.context.from,self.context.neid,self.context.prefix_neid)}}var self=this,template=$(['<div class="new-item clearfix" isfolder="true">','<span class="file-select"><input type="checkbox"/></span>','<span class="file-area"><i class="file-icon icon-file folder"></i>','<span class="file-info">','<div class="edit-name"><input class="box" type="text" value="'+_("新建文件夹")+'">','<span class="icon sure"></span>','<span class="icon cancel"></span>',"</div></span></span></div>"].join("")),template2=$(['<li class="new-item clearfix" isfolder="true">','<span class="file-area"><i class="file-icon icon-file folder"></i>','<span class="file-info">','<div class="edit-name"><input class="box" type="text" value="'+_("新建文件夹")+'">','<span class="icon sure"></span>','<span class="icon cancel"></span>',"</div></span></span></li>"].join(""));if($(".new-item").length>0)return this;var mask=$(".lui-mask");if(1==mask.length){var $parent=$(".lui-dialog li.jqtree-selected");$parent.find("ul>li").length>0?0==$(".new-item").length&&$parent.find("li").eq(0).before(template2):$parent.append(template2)}else $(".list-wraper").find(".scroll-wraper").length>0?0==$(".new-item").length&&$(".scl-content .filelist-item").eq(0).before(template):($(".list-wraper").html(" "),$(".filelist-header").css({visibility:"inherit"}),$(".list-wraper").append(template));$(".new-item .edit-name").length>0&&$(".new-item .edit-name input").focus().select(),$(".new-item .edit-name").find(".box").click(function(){}).on("keypress",function(ev){13==ev.keyCode&&createfolder()});var create=$(".new-item .edit-name").find(".sure"),cancel=$(".new-item .edit-name").find(".cancel");create.on("click",function(e){createfolder()}),cancel.on("click",function(){$(".new-item").remove(),self.context.reload()})}},AddFolder}),define("component/alertDialog",function(require,exports,module){function AlertDialog(message,level,callback){this.title=_("提示"),this.message=message||"",this.level=level||"",this.callback=callback,this._init()}var $=require("jquery"),EventTarget=require("eventTarget"),Dialog=require("component/dialog");require("i18n");var _=$.i18n.prop;return $.extend(AlertDialog.prototype,EventTarget,{_init:function(){var self=this;self.dialog=new Dialog(self.title,{mask:!0},function(dialog){dialog.append("warn"==self.level?'<div class="lui-alertDialog"><div class="cell2"><div class="cell1"></div>'+self.message+'</div></div><div class="dialog-button-area"><a class="dialog-button confirm-cancel ok">'+_("关闭")+"</a></div>":'<div class="lui-alertDialog"><div class="cell2"><div class="cell1"></div>'+self.message+'</div></div><div class="dialog-button-area"><a class="dialog-button confirm-cancel ok">'+_("关闭")+"</a></div>")}),$(".confirm-cancel").click(function(){self.callback&&self.callback(),self.dialog.close(),self.fire("close")})}}),AlertDialog}),define("component/authCombox",function(require,exports,module){function AuthCombox(container,auth_category,data,_callback){this.container="string"==$.type(container)?$(container):container,this.item_title=auth_category?auth_category.item_title:AUTH_CATEGORY.PREVIEW.item_title,this.item_value=auth_category?auth_category.item_value:AUTH_CATEGORY.PREVIEW.item_value,this._callback=_callback,this.data=data,this.currentItem=null,this._init()}var $=require("jquery"),Util=require("util"),AuthModel=(require("component/combox"),require("model/AuthManager"));require("i18n");var AUTH_CATEGORY=($.i18n.prop,AuthModel.AUTH_CATEGORY);return AuthCombox.AUTH_CATEGORY=AUTH_CATEGORY,$.extend(AuthCombox.prototype,{_init:function(){var self=this,comboxId="combox-"+Math.ceil(1e11*Math.random()),comboxIdforJq="#"+comboxId,htmlArr=[];htmlArr.push('<div id="'+comboxId+'" class="ld-combox">'),htmlArr.push('<div><span class="curtext" act="'+self.item_value+'">'+self.item_title+'</span><span class="icon i-expand arrow"></span></div>'),htmlArr.push("<ul>");for(var key in AUTH_CATEGORY)htmlArr.push('<li act="'+AUTH_CATEGORY[key].item_value+'">'+AUTH_CATEGORY[key].item_title+"</li>");htmlArr.push("</ul>"),htmlArr.push("</div>"),self.container.append(htmlArr.join("")),$(comboxIdforJq).mouseleave(function(e){$(this).find("ul").hide()}),$(comboxIdforJq).find("ul").mouseleave(function(e){$(e.currentTarget).hide()}),$(comboxIdforJq).click(function(e){var ul=$(e.currentTarget).find("ul");if("none"==ul.css("display")){var height_ul=ul.height(),ypos_ul=Util.getElementYPos(document.getElementById(comboxId))+22,xpos_ul=Util.getElementXPos(document.getElementById(comboxId))+1,pageHeight=Util.getTotalHeight(),scrollHeight=$(".lui-auth-list").scrollTop();ul.css({position:"fixed",background:"#FFF",left:xpos_ul,top:ypos_ul-scrollHeight,width:$(this).width()}),height_ul+ypos_ul-scrollHeight>pageHeight&&ul.css({top:ypos_ul-scrollHeight-height_ul}),ul.show()}else ul.removeAttr("position"),ul.css("background","#FFF"),$(comboxIdforJq).removeAttr("position"),ul.hide()}),$(comboxIdforJq+" ul li").click(function(e){var item=$(e.currentTarget).attr("act"),text=$(e.currentTarget).html();$(comboxIdforJq).find(".curtext").html(text),$(comboxIdforJq).find(".curtext").attr("act",item),self.currentItem=item,self._callback&&self._callback(item,self.data)})},getSelectItem:function(){var self=this;return self.currentItem}}),AuthCombox}),define("component/authDialog",function(require,exports,module){function AuthDialog(params,callback){var auth_list_config={noclick:!0,column:1,hasAuthCombox:!0,template:['<li class="list-item item-{{agent_type}}" index="{{index}}" title="{{name}}{{#email}}({{email}}){{/email}}{{#domain_team}}(',_("域团队"),"){{/domain_team}}{{#domain_user}}-",_("企业认证用户"),'{{/domain_user}}">','<span class="icon i-authdelete"></span><div class="lui-combox auth-combox" id="combox-{{index}}"></div>','<span class="icon i-{{agent_type}}{{#is_domain}}-domain{{/is_domain}}"></span>','<span class="item-text">{{name}}{{#email}}({{email}}){{/email}}</span>','<span class="i-inherit i-inherit-{{inherit}}" title='+_("允许子团队继承权限")+"></span>","</li>"].join("")};this.option=$.extend(params,auth_list_config),this.callback=callback,this._init()}var $=require("jquery"),SearchBox=require("component/searchbox"),Tips=require("component/tips"),Dialog=require("component/dialog"),ConfirmDialog=require("component/confirmDialog"),AuthPanel=require("component/authPanel"),AuthTree=require("component/authTree"),AuthModel=require("model/AuthManager"),TeamModel=require("model/TeamManager"),ListView=require("component/listview"),EventTarget=require("component/eventTarget"),_=$.i18n.prop,Util=require("util");return $.extend(AuthDialog.prototype,EventTarget,{
_init:function(){var inner=["<div class='auth-pane'>","<div class='teamtree'><h2>"+_("团队成员")+"</h2>","<div class='search-box'></div>","<div id='teamGroup' class='treewrapper'></div>","<div class='listwrapper'></div>","</div>","<div class='icon-arrow'><span class='icon i-arrow-right'></span></div>","<div class='share-list'><h2><span class='authorize'>"+_("权限")+"</span>"+_("共享者")+"<i></i></h2>","<div class='lui-list'></div>","</div>","</div>","<div class='dialog-button-area'>","<a class='dialog-button ok'>"+_("确定")+"</a><a class='dialog-button cancel'>"+_("取消")+"</a>","</div>"].join(""),self=this,dialog=new Dialog(_("/"==location.pathname||"/user/manage"==location.pathname||"/auth/list"==location.pathname?"授权管理":"共享管理"),function(parentNode,func){self.contentWraper=parentNode,parentNode.append($(inner)),/msie/.test(navigator.userAgent.toLowerCase())&&parentNode.css("width",680),self.auth_list=new ListView($(".share-list>.lui-list"),self.option),self.auth_list.data=[],self.render()});this.dialog=dialog},render:function(){var self=this,searchBox=new SearchBox(this.contentWraper.find(".search-box"),function(result){self.contentWraper.find(".listwrapper").show(),self.contentWraper.find(".treewrapper").hide();for(var datas=[],i=0,len=result.length;len>i;i++){var item=result[i],d={};"team"==item.agent_type?d={id:item._id,uid:item._id,name:item.name,agent_id:item._id,is_domain:item.from_domain_account,domain_team:item.from_domain_account,agent_type:"team",cssAction:"preview",inherit:!1}:(d={id:item.uid,uid:item.uid,name:item.user_name,email:item.email,is_domain:item.from_domain_account,domain_user:item.from_domain_account,agent_id:item.uid,agent_type:"user",cssAction:"preview"},d.role="member"),datas.push(d)}self.user_team_list.render(datas)});self.user_team_list=new ListView($(".listwrapper"),{column:1,template:'<li class="list-item" index="{{index}}" title="{{name}}{{#email}}({{email}}){{/email}}{{#domain_team}}('+_("域团队")+"){{/domain_team}}{{#domain_user}}-"+_("企业认证用户")+'{{/domain_user}}"><span class="icon i-{{agent_type}}{{#is_domain}}-domain{{/is_domain}}"></span><span class="item-text text-{{agent_type}}">{{name}}{{#email}}({{email}}){{/email}}</span></li>'}),searchBox.on("close",function(){self.contentWraper.find(".treewrapper").show(),self.contentWraper.find(".listwrapper").hide()}),self.tree=new AuthTree(self.contentWraper.find(".treewrapper"),function(param,success,error){TeamModel.getTeamListById(function(result){success(result)})},{type:1,title:_("所有用户"),authTree:!0,max_height:220}),self.tree.render(),self.requestAuthData(),self.bindEvent()},bindEvent:function(){var self=this;self.tree.on("selectTeam",function(node){var obj={id:node.id,name:node.name,agent_id:node.agent_id,is_domain:node.isCer,agent_type:node.agent_type};(-1!=node.id||"/"==location.pathname||"/auth/list"==location.pathname||"/user/manage"==location.pathname)&&("team"==node.agent_type&&(obj.inherit=!1),"user"==node.agent_type&&(obj.email=node.email),Util.dataInArray(obj,self.auth_list.data)||(self.auth_list.data.push(obj),self.renderAuthList()))}),self.user_team_list.on("item-added",function(obj){Util.dataInArray(obj,self.auth_list.data)||(self.auth_list.data.push(obj),self.renderAuthList())}),self.auth_list.on("changeInherit",function(_index,value){var span_inherit=self.auth_list.node.find(".list-item").eq(_index).find(".i-inherit");span_inherit.removeClass(function(){var clazz=this.className.split(" ");return clazz.splice(0,1),clazz.join(" ")}),span_inherit.addClass("i-inherit-"+value)}),self.auth_list.on("delete",function(index){var curId=self.auth_list.data[index]._id;new ConfirmDialog({content:_("您确认要删除吗？")},function(){curId?AuthModel.batch_del(function(ret){200==ret.code?(self.auth_list.data.splice(index,1),self.renderAuthList(),0==self.auth_list.data.length&&self.callback&&self.callback(),Tips.show(ret.message)):Tips.warn(500==ret.code?ret.message.join("<br"):ret.message)},[{auth_id:curId}]):(self.auth_list.data.splice(index,1),self.renderAuthList())})}),self.contentWraper.find("h2>span.authorize").hover(function(){new AuthPanel($(this))},function(){$("body").find(".auth-panel").remove()}),self.contentWraper.find(".dialog-button-area a.ok").click(function(ev){self.submitAuth()}),self.contentWraper.find(".dialog-button-area a.cancel").click(function(ev){self.callback&&self.callback(),self.dialog.close()})},requestAuthData:function(){var self=this;AuthModel.list_by_resource(function(result){if(200==result.code){for(var data=result.data,i=0,len=data.length;len>i;i++){var item=data[i];self.auth_list.data.push("team"==item.agent_type?{_id:item.id,id:item.agent_id,name:item.agent_name,agent_id:item.agent_id,is_domain:item.from_domain_account,domain_team:item.from_domain_account,agent_type:item.agent_type,cssAction:item.privilege_name,inherit:item.is_subteam_inheritable||!1}:{_id:item.id,id:item.agent_id,name:"all"==item.agent_type?_("所有用户"):item.agent_name,is_domain:item.from_domain_account,domain_user:item.from_domain_account,email:item.email,agent_id:item.agent_id,agent_type:item.agent_type,cssAction:item.privilege_name})}self.renderAuthList()}},self.option.path,"/user/manage"==location.pathname||"/"==location.pathname||"/auth/list"==location.pathname?"ent":null,self.option.prefix_neid)},renderAuthList:function(){var self=this,sort_by=function(name,minor){return function(o,p){var a,b;return o&&p&&"object"==typeof o&&"object"==typeof p?(a=o[name],b=p[name],a===b?"function"==typeof minor?minor(o,p):0:typeof a==typeof b?b>a?-1:1:typeof b>typeof a?-1:1):void thro("error")}};self.auth_list.data=Util.unique1(self.auth_list.data);var result=self.auth_list.data.sort(sort_by("agent_type",sort_by("name")));self.auth_list.render(result)},submitAuth:function(){for(var arr=this.auth_list.getAuthItem(),entry_infos=[],i=0;i<arr.length;i++){var item=arr[i],str_arr=[];"[object Function]"!=Object.prototype.toString.call(item)&&("all"==item.agent_type&&(item.agent_id=Util.getAccountId()),str_arr.push('{"agent_id":'+item.agent_id),str_arr.push('"agent_type":"'+item.agent_type+'"'),"team"==item.agent_type&&str_arr.push('"is_subteam_inheritable":'+item.inherit),str_arr.push('"privilege_id":"'+Util.resolvePrivilegeID(item.cssAction)+'"}'),entry_infos.push(str_arr.join(",")))}if(0==entry_infos.length)return this.callback&&this.callback(),void this.dialog.close();var self=this;AuthModel.auth_batch_create(function(ret){200==ret.code?(Tips.show(_("授权成功")),self.callback&&self.callback(),self.dialog.close()):Tips.warn(ret.message)},this.option.path,"/user/manage"==location.pathname||"/"==location.pathname||"/auth/list"==location.pathname?"ent":null,this.option.prefix_neid,entry_infos)}}),AuthDialog}),define("component/authList",function(require,exports,module){function AuthList(container,uids,data,userType,_callback){this.container="string"==$.type(container)?$(container):container,this.data=data,this.userType=userType||AuthModel.AGENT_TYPE.USER,this.uids=uids,this._callback=_callback,this._init()}var $=require("jquery"),Util=require("util"),ConfirmDialog=require("component/confirmDialog"),AuthModel=require("model/AuthManager"),Tips=require("component/tips"),AuthCombox=require("component/authCombox");require("i18n");var _=$.i18n.prop;return $.extend(AuthList.prototype,{_init:function(){var self=this;self.authlistid="authlist-"+Math.ceil(1e10*Math.random());var htmlArr=[];htmlArr.push('<div class="auth-list-container">'),htmlArr.push('<div class="auth-list-header">'),htmlArr.push('<span class="auth-list-header-col1">'+_("文件夹")+"</span>"),htmlArr.push('<span class="auth-list-header-col2">'+_("权限")+"</span>"),htmlArr.push("</div>"),htmlArr.push('<div class="auth-list-item-container lui-auth-list" id="'+self.authlistid+'">'),htmlArr.push("</div>"),htmlArr.push("</div>"),htmlArr.push('<div class="add-dir-auth-container">'),htmlArr.push('<span class="icon i-add-sign"></span><span>'),htmlArr.push(_("添加文件夹访问权限")),htmlArr.push("</span>"),htmlArr.push("</div>"),self.container.append(htmlArr.join("")),1==self.uids.length?AuthModel.get(function(ret){200==ret.code&&(self.data=ret.data,self._renderList())},"",self.uids[0],self.userType):self._renderList(),$(".auth-list-container").delegate(".i-delete","click",function(e){var authid=$(e.currentTarget).attr("authid");new ConfirmDialog({content:_("真的要删除当前用户的访问权限么？")},function(){AuthModel.batch_del(function(ret){200==ret.code?$(e.currentTarget).parent().parent().remove():Tips.warn(500==ret.code?ret.message.join("<br"):ret.message)},[authid])})}),$(".add-dir-auth-container").click(function(){self._callback&&self._callback(self.uids,self,self.userType)})},_genAuthItem:function(auth,i){var authHtml=[];return authHtml.push('<div class="auth-list-item">'),authHtml.push('<span class="icon i-folder1"></span>'),authHtml.push('<span class="auth-list-item-col1" title="'+Util.getRootDisplayName()+auth.path+'">'+Util.getRootDisplayName()+auth.path+"</span>"),authHtml.push('<span class="auth-list-item-col2"">'),authHtml.push('<a class="icon i-delete" authid="'+auth.id+'"></a></span>'),authHtml.push('<span id="authcombox'+i+'" class="auth-list-item-col3"></span>'),authHtml.push("</div>"),authHtml.join("")},_bindAuthItemEvent:function(auth,i){var self=this;new AuthCombox("#authcombox"+i,AuthModel.getAuthPair(auth.action),null,function(item){self.userType==AuthModel.AGENT_TYPE.TEAM?AuthModel.create(function(ret){return 200!=ret.code?void Tips.warn(_("很抱歉，您的操作失败了，建议您重试一下！")):void 0},auth.path,item,self.uids[0],AuthModel.AGENT_TYPE.TEAM):AuthModel.batch_user_set(function(ret){return 200!=ret.code?void Tips.warn(ret.message.join("<br")):void 0},auth.path,item,self.uids)})},_processData:function(auth){for(var self=this,isExists=!1,i=0,len=self.data.length;len>i;i++)if(self.data[i].path==auth.path){self.data[i].action=auth.action,isExists=!0;break}isExists||self.data.push(auth)},_renderList:function(){var self=this;$("#"+self.authlistid).empty();for(var i=0,len=self.data.length;len>i;i++){var html=self._genAuthItem(self.data[i],i);$("#"+self.authlistid).append(html),self._bindAuthItemEvent(self.data[i],i)}},appendAuthItem:function(auth){var self=this;self._processData(auth),self._renderList()},beforeAuthItem:function(auth,i){var self=this;self._processData(auth),self._renderList()}}),AuthList}),define("component/authPanel",function(require,exports,module){function AuthPanel(node){this.node=$(node),this.render()}var $=require("jquery"),_=$.i18n.prop;return require("mustache"),AuthPanel.prototype={render:function(){var authPanel=$("<div class='auth-panel'><h2></h2><ul class='auth-body'></ul></div>"),data=[{instruction:_("权限说明"),preview:_("预览"),upload:_("上传"),download:_("下载"),uploadlink:_("创建上传外链"),downloadlink:_("创建下载外链"),create:_("新建目录/文件"),remove:_("删除"),rename:_("重命名"),move:_("移动"),copy:_("复制")},{instruction:_("编辑"),preview:"1",upload:"1",download:"1",uploadlink:"1",downloadlink:"1",create:"1",remove:"1",rename:"1",move:"1",copy:"1"},{instruction:_("上传/下载/外链"),preview:"1",upload:"1",download:"1",uploadlink:"1",downloadlink:"1",create:"1",remove:"0",rename:"0",move:"0",copy:"1"},{instruction:_("下载/外链"),preview:"1",upload:"0",download:"1",uploadlink:"0",downloadlink:"1",create:"0",remove:"0",rename:"0",move:"0",copy:"1"},{instruction:_("上传/外链"),preview:"0",upload:"1",download:"0",uploadlink:"1",downloadlink:"0",create:"1",remove:"0",rename:"0",move:"0",copy:"0"},{instruction:_("上传/下载"),preview:"1",upload:"1",download:"1",uploadlink:"0",downloadlink:"0",create:"1",remove:"0",rename:"0",move:"0",copy:"1"},{instruction:_("下载"),preview:"1",upload:"0",download:"1",uploadlink:"0",downloadlink:"0",create:"0",remove:"0",rename:"0",move:"0",copy:"1"},{instruction:_("上传"),preview:"0",upload:"1",download:"0",uploadlink:"0",downloadlink:"0",create:"1",remove:"0",rename:"0",move:"0",copy:"0"},{instruction:_("预览"),preview:"1",upload:"0",download:"0",uploadlink:"0",downloadlink:"0",create:"0",remove:"0",rename:"0",move:"0",copy:"0"}],h_template="<span class='instruction'>{{instruction}}</span><span class='preview'>{{preview}}</span><span class='upload'>{{upload}}</span><span class='download'>{{download}}</span><span class='uploadlink'>{{uploadlink}}</span><span class='downloadlink'>{{downloadlink}}</span><span class='create'>{{create}}</span><span class='remove'>{{remove}}</span><span class='col_rename'>{{rename}}</span><span class='move'>{{move}}</span><span class='copy'>{{copy}}</span>",li_template="<li><span class='instruction'>{{instruction}}</span><span class='preview'><i class='i-auth-{{preview}}'></i></span><span class='upload'><i class='i-auth-{{upload}}'></i></span><span class='download'><i class='i-auth-{{download}}'></i></span><span class='uploadlink'><i class='i-auth-{{uploadlink}}'></i></span><span class='downloadlink'><i class='i-auth-{{downloadlink}}'></i></span><span class='create'><i class='i-auth-{{create}}'></i></span><span class='remove'><i class='i-auth-{{remove}}'></i></span><span class='col_rename'><i class='i-auth-{{rename}}'></i></span><span class='move'><i class='i-auth-{{move}}'></i></span><span class='copy'><i class='i-auth-{{copy}}'></i></span></li>";authPanel.find("h2").append(Mustache.render(h_template,data[0]));for(var i=1;i<data.length;i++)authPanel.find("ul.auth-body").append(Mustache.render(li_template,data[i]));this.node.append(authPanel),authPanel.show()}},AuthPanel}),define("component/authTree",function(require,exports){function AuthTree(node,func,option){this.node="string"==$.type(node)?$(node):node,this.func=func;var config={title:_("团队和用户管理"),authTree:!0};this.option=$.extend(config,option),this.max_height=this.option.max_height||150,this.min_height=this.option.min_height||20,this.type=this.option.type||TREE_TYPE.DEFAULT,this._init()}var $=require("jquery"),UserManager=(require("util"),require("model/UserManager")),TeamManager=require("model/TeamManager"),Scroll=require("component/scroll"),EventTarget=require("component/eventTarget");require("i18n");var _=$.i18n.prop;return require("jqtree"),$.extend(AuthTree.prototype,EventTarget,{_init:function(nodes){var self=this;self.node.append('<div class="menu-item treeswitch" style="cursor: pointer;"><span class="icon i-user7"></span><span class="menu-text">'+this.option.title+'</span></div><div class="sub-menu-item"><div class="treeview-wraper"><div class="treeview"></div></div> </div>'),self.teamTree=self.node.find(".treeview"),self.root=self.node.find(".treeswitch"),self.root.remove(),self.node.find(".treeview-wraper").css("width",self.width),self.teamTree.tree({data:[],closedIcon:'<span class="icon i-fold" style="vertical-align:middle;"></span>',openedIcon:'<span class="icon i-expand" style="vertical-align:middle;"></span>',onCreateLi:function(node,$li){var folder_icon='<span class="icon i-user'+(node.isCer?"Cer":-1==node.id?7:6)+'"></span>';"user"==node.agent_type&&(folder_icon='<span class="icon i-user'+(node.isCer?"-domain":"")+'"></span>',$li.find(".jqtree-title").text(node.name+(node.email?"("+node.email+")":""))),(!node.element&&"user"!=node.agent_type||node.element&&0==node.children.length&&!node.hasOwnProperty("load_on_demand")&&"user"!=node.agent_type)&&(folder_icon='<a class="jqtree_common jqtree-toggler"><span class="icon i-fold" node-data="'+node.id+'" style="vertical-align:middle;"></span></a>'+folder_icon);var item=$li.find(".jqtree-title");item.before(folder_icon),item.attr("title",item.text())}}),$(self.teamTree).delegate(".jqtree-title","click",function(e){self.selectTeam=!0}),$(self.teamTree).delegate(".i-fold","click",function(e){var id=$(e.target).attr("node-data");if(id){var curNode=self.teamTree.tree("getNodeById",id),parentNode=curNode.parent;if(parentNode.element&&$(parentNode.element).removeClass("jqtree-selected"),self.teamTree.tree("selectNode",null),-1==curNode.id)return void UserManager.list_for_pages(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.teamTree.tree("loadData",nodes,curNode),self.teamTree.tree("toggle",curNode),self.teamTree.tree("selectNode",curNode),self._render()}},0,1e4);TeamManager.getTeamListById(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.teamTree.tree("loadData",nodes,curNode),self.teamTree.tree("toggle",curNode),self.teamTree.tree("selectNode",curNode),self._render()}},curNode._id,!0)}}),self.teamTree.bind("tree.init",function(){}),self.teamTree.bind("tree.click",function(event){{var curNode=event.node;curNode.parent}self.fire("selectTeam",curNode),$(curNode).css("color","#1E5D7C"),$(curNode).css("font-weight","normal"),"team"==curNode.agent_type&&TeamManager.getTeamListById(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.teamTree.tree("loadData",nodes,curNode),self.teamTree.tree("toggle",curNode),self.teamTree.tree("selectNode",curNode),self._render()}},curNode._id,!0)}),self.teamTree.bind("tree.close",function(e){self._render()}),self.teamTree.bind("tree.open",function(e){self._render()})},_initData:function(){var self=this;self.func.call(self,{},function(result){if(200!=result.code)return void self.fire("initError");var nodes=self._dataToNodes(result.data.content);nodes.splice(0,0,{id:-1,_id:-1,name:_("所有用户"),label:_("所有用户"),agent_type:"all",children:{length:0}}),self.teamTree.tree("loadData",nodes),self._render()},function(result){console.log("error:"+result)})},render:function(){this._initData()},_render:function(){var self=this,height=this.max_height;self.node.find(".treeview-wraper").show(),self.node.find(".treeview-wraper").css("height",height+20),self.scroll||(self.scroll=new Scroll(self.node.find(".treeview-wraper"))),self.scroll&&self.scroll.render(!0)},_dataToNodes:function(data){for(var nodes=[],i=0,len=data.length;len>i;i++){var childNode,item=data[i];childNode="team"==item.agent_type?{_id:item._id,id:item._id,agent_id:item._id,description:item.description,name:item.name,label:this._getTeamName(item.path),isCer:item.from_domain_account,agent_type:"team"}:{_id:item.uid,id:item.uid,agent_id:item.uid,description:item.user_name,name:item.user_name,email:item.email,label:item.user_name,isCer:item.from_domain_account,agent_type:"user"},nodes.push(childNode)}return nodes},getSelectedNode:function(){return this.teamTree.tree("getSelectedNode").path},setSelectedNode:function(node_path){var node=this.teamTree.tree("getNodeById",node_path);this.teamTree.tree("selectNode",node)},_getTeamName:function(path){var index=path.lastIndexOf("/"),teamName=path.substr(index+1);return teamName}}),AuthTree}),define("component/cleanupDialog",function(require,exports,module){function CleanupDialog(context,param){this.param=param,this.path_type=param.path_type,this.from=param.from,this.neid=param.neid,this._init()}var $=require("jquery"),Tips=require("component/tips"),Dialog=require("component/dialog");ConfirmDialog=require("component/confirmDialog"),FileModel=require("model/FileManager"),require("i18n"),Util=require("util");var _=$.i18n.prop,cleanupTemplate='<div id="cleanupBox"><div class="cleanupBox-head"><input type="checkbox"/>'+_("定期清理文件夹")+'</div><div class="cleanupBox-content"><div class="cleanup-list"><p><i class="icon icon-radio"></i>'+_("自动清理")+'</p><select id="autoSelect"><option selected="selected" value="10">'+_("清理保存10天以上的文件")+'</option><option value="30">'+_("清理保存30天以上的文件")+'</option><option value="90">'+_("清理保存90天以上的文件")+"</option></select><span>"+_("将删除该文件夹内超过时间限制的文件或子文件夹，删除的项保留30天。")+'</span></div><div class="cleanup-list"><p><i class="icon icon-radio"></i>'+_("到期清理")+'</p><input type="text" class="date" id="clearDate" readonly="true"/><span>'+_("将在确定日期彻底删除文件夹内的文件或子文件夹，删除的项保留30天。")+'</span></div><div class="cleanup-list"><p><i class="icon icon-radio"></i>'+_("定时清理")+'</p><select id="clearSelect"><option value="d">'+_("每天清理一次")+'</option><option value="w">'+_("每周清理一次")+'</option><option value="m">'+_("每月清理一次")+'</option></select><select id="selectD"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select><select id="selectW"><option value="0">'+_("星期日")+'</option><option value="1">'+_("星期一")+'</option><option value="2">'+_("星期二")+'</option><option value="3">'+_("星期三")+'</option><option value="4">'+_("星期四")+'</option><option value="5">'+_("星期五")+'</option><option value="6">'+_("星期六")+'</option></select><input type="text" class="date" id="clearTime" readonly="true"/><span>'+_("将在固定时间定期彻底删除文件夹内的文件或子文件夹，删除的项保留30天。")+'</span></div></div></div><div class="dialog-button-area"><a id="cleanup-ok" class="dialog-button ok">'+_("确定")+'</a><a id="cleanup-close" class="dialog-button cancel">'+_("取消")+"</a></div>";return $.extend(CleanupDialog.prototype,{_init:function(){function disable(){$("#cleanupBox select").attr("disabled",!0),$("#cleanupBox .cleanupBox-content input").attr("disabled",!0),$("#cleanupBox select").css({opacity:.6}),$("#cleanupBox .cleanup-list input").css({opacity:.6}),$("#cleanupBox span").css({opacity:.6}),$("#cleanupBox .cleanup-list i").removeClass("icon-radio-selected"),$("#cleanupBox .cleanup-list i").addClass("icon-radio"),$("#cleanupBox .date").val("")}function enable(index){$("#cleanupBox .cleanup-list i").eq(index).removeClass("icon-radio"),$("#cleanupBox .cleanup-list i").eq(index).addClass("icon-radio-selected"),$("#cleanupBox .cleanup-list").eq(index).find("select").attr("disabled",!1),$("#cleanupBox .cleanup-list").eq(index).find("input").attr("disabled",!1),$("#cleanupBox .cleanup-list").eq(index).find("select").css({opacity:1}),$("#cleanupBox .cleanup-list").eq(index).find("input").css({opacity:1}),$("#cleanupBox span").eq(index).css({opacity:1})}function clearSelect(){var n=$("#clearSelect").val();switch(n){case"w":$("#selectD").css("display","none"),$("#clearTime").css("display","none"),$("#selectW").css("display","inline-block"),clean_arg=$("#clearSelect").val()+"-"+$("#selectW").val();break;case"m":$("#selectD").css("display","none"),$("#selectW").css("display","none"),$("#clearTime").css("display","inline-block"),$("#clearTime").eq(0).calendar({onClick:function(el,cell,date,data){el.val(Util.formatDate(date,"dd")),clean_arg=$("#clearSelect").val()+"-"+$("#clearTime").val()}});break;default:$("#clearTime").css("display","none"),$("#selectW").css("display","none"),$("#selectD").css("display","inline-block"),clean_arg=$("#clearSelect").val()+"-"+$("#selectD").val()}}var cleanMode,cleanArg,clean_mode,clean_arg,self=this,num=0;self.dialog=new Dialog(_("设置定期清理"),{mask:!0,minWidth:680},function(dialog){dialog.append(cleanupTemplate)}),disable(),enable(0);var checkBtn=$(".cleanupBox-head input:checkbox"),cleanupP=$("#cleanupBox .cleanupBox-content p");1==checkBtn.attr("checked")?enable(0):(cleanupP.css("color","#d5d5d5"),disable());var onOff=!0;checkBtn.click(function(){onOff?(checkBtn.attr("checked",!0),disable(),enable(0),cleanupP.css("color","#000"),onOff=!1):(checkBtn.attr("checked",!1),disable(),cleanupP.css("color","#d5d5d5"),onOff=!0)}),FileModel.info(function(ret){if(200==ret.code){if(cleanMode=ret.data.clean_mode,cleanArg=ret.data.clean_arg,cleanMode&&cleanArg){switch(checkBtn.attr("checked",!0),cleanMode){case"time":enable(1),$("#clearDate").val(cleanArg),num=1;break;case"period":enable(2);var clearText=cleanArg.match(/[a-z]/),clearSelectText=cleanArg.match(/\d+/);num=2,$("#selectW").css("display","none"),$("#selectD").css("display","none"),$("#clearTime").css("display","none"),"w"==clearText?($("#clearSelect").val(clearText).attr("selected","selected"),$("#selectW").css("display","inline-block"),$("#selectW").val(clearSelectText).attr("selected","selected")):"m"==clearText?($("#clearSelect").val(clearText).attr("selected","selected"),$("#clearTime").val(clearSelectText),$("#clearTime").css("display","inline-block"),clean_arg=$("#clearSelect").val()+"-"+$("#clearTime").val(),$("#clearTime").eq(0).calendar({onClick:function(el,cell,date,data){el.val(Util.formatDate(date,"dd")),clean_arg=$("#clearSelect").val()+"-"+$("#clearTime").val()}})):($("#clearSelect").val(clearText).attr("selected","selected"),$("#selectD").val(clearSelectText).attr("selected","selected"),$("#selectD").css("display","inline-block"));break;default:enable(0),num=0,$("#autoSelect").val(cleanArg).attr("selected","selected")}cleanupP.css("color","#000"),onOff=!1}clearSelect()}},self.param.path,self.path_type,self.from,self.neid);var myDate=new Date;myDate=myDate.getFullYear()+"/"+(myDate.getMonth()+1)+"/"+myDate.getDate(),$("#clearDate").eq(0).calendar({onClick:function(el,cell,date,data){return el.val(Util.formatDate(date,"yyyy-MM-dd")),new Date(myDate)>=new Date($("#clearDate").val().replace(/\-/g,"/"))?(Tips.warn(_("请选择晚于今天的日期！")),void $("#clearDate").val("")):void 0}}),$("#cleanupBox .cleanup-list i").click(function(){if("checked"==checkBtn.attr("checked")){var index=$("#cleanupBox .cleanup-list i").index(this);num=index,disable(),enable(index)}}),$("#clearSelect").change(function(){clearSelect()}),$("#selectD").change(function(){"inline-block"==$("#selectD").css("display")&&(clean_arg=$("#clearSelect").val()+"-"+$("#selectD").val())}),$("#selectW").change(function(){"inline-block"==$("#selectW").css("display")&&(clean_arg=$("#clearSelect").val()+"-"+$("#selectW").val())}),$("#cleanup-ok").click(function(){var path=self.param.path;if("checked"==checkBtn.attr("checked"))switch(num){case 1:if(clean_mode="time",clean_arg=$("#clearDate").val(),""==clean_arg)return void Tips.warn(_("请选择清理日期!"));break;case 2:if(clean_mode="period",clean_arg=clean_arg,""==$("#clearTime").val()&&"inline-block"==$("#clearTime").css("display"))return void Tips.warn(_("请选择清理日期!"));break;default:clean_mode="auto",clean_arg=$("#autoSelect").val()}else clean_arg="",clean_mode="";var infoData={neid:self.neid,path:path,clean_mode:clean_mode,clean_arg:clean_arg,field:"clean"};FileModel.info_set(function(ret){200==ret.code?(Tips.show(_("定期清理设置成功！")),self.dialog.close()):(Tips.show(_(ret.message)),self.dialog.close())},infoData)}),$("#cleanup-close").click(function(){self.dialog.close()})},close:function(){this.dialog.close()}}),CleanupDialog}),define("component/combox",function(require,exports){function Combox(node,data){this.node="string"==$.type(node)?$(node):node,this.data=data,this.selected={},this._init()}var $=jquery=require("jquery"),EventTarget=require("eventTarget"),Scroll=require("component/scroll");return require("mustache"),$.extend(Combox.prototype,EventTarget,{_init:function(){var self=this,combo=$('<div class="lui-combox"></div>'),curli=$('<div class="curli"><span class="curtext"></span><span class="triangle"></span></div>'),ul=$('<ul class="combox-ul"></ul>'),li='<li class="combox-item" index="{{index}}">{{name}}</li>';$.each(self.data,function(idx,item){item.index=idx,ul.append(Mustache.render(li,item))}),combo.append(curli),combo.append(ul),self.node.append(combo),self.scroll=new Scroll(ul),curli.on("click",function(){ul.show(),self.scroll.render()}),$(".lui-combox").on("mouseleave",function(){ul.hide()}),combo.delegate(".combox-item","click",function(e){var tar=$(e.target),idx=tar.attr("index");curli.find(".curtext").html(tar.html()),ul.hide();var da=self.data[idx];self.selected=da,self.fire("change",da)}),combo.delegate(".combox-ul","mouseleave",function(e){var tar=$(e.currentTarget);tar.hide()}),$($(".combox-item",combo).eq(0)).trigger("click")},render:function(da){var self=this;self.node.empty(),self.data=da,this.selected={},self._init()},change:function(index){var self=this,item=self.node.find(".combox-item").eq(index);item&&$(item).trigger("click")},val:function(value){var self=this;return void 0==value?self.selected:void $.each(self.data,function(index,item){item==value&&self.change(index)})}}),Combox}),define("component/confirmDialog",function(require,exports,module){function ConfirmDialog(context,ok_callback,cancel_callback){this.context=context,this.context.title||(this.context.title=_("确认")),this.context.content||(this.context.content=""),this.context.okBtn||(this.context.okBtn=_("确定")),this.context.canBtn||(this.context.canBtn=_("取消")),this.ok_callback=ok_callback,this.cancel_callback=cancel_callback,this._init()}var $=require("jquery"),Dialog=require("component/dialog");require("i18n");var _=$.i18n.prop;return $.extend(ConfirmDialog.prototype,{_init:function(){var self=this;self.dialog=new Dialog(self.context.title,{mask:!0},function(dialog){dialog.append('<div class="confirmCon">'+self.context.content+'</div><div class="dialog-button-area confirmBtn"><a class="dialog-button confirm-ok ok">'+self.context.okBtn+'</a> <a class="dialog-button confirm-cancel cancel">'+self.context.canBtn+"</a></div>")}),$(".confirm-ok").click(function(){self.ok_callback(),self.dialog.close()}),$(".confirm-cancel").click(function(){self.cancel_callback&&self.cancel_callback(),self.dialog.close()})}}),ConfirmDialog}),define("component/copyMoveFileTree",function(require,exports){function copyMoveFileTree(container,reqdata,conf){this.container="string"==$.type(container)?$(container):container,this.width=""==conf.width?170:conf.width,this.max_height=""==conf.max_height?320:conf.max_height,this.min_height=""==conf.min_height?320:conf.min_height,this.autoOpen=conf.autoOpen?!0:!1,this.teamName=conf.teamName,this.isInit=!0,this.path_type=reqdata.path_type,this._init()}var $=require("jquery"),EventTarget=require("eventTarget"),Scroll=require("component/scroll"),Util=require("util"),fileManager=require("model/FileManager"),_=(require("model/AuthManager"),require("i18n"),$.i18n.prop);require("jqtree"),String.prototype.startWith=function(regexp){return new RegExp("^"+regexp).test(this)};var FILTER={content_type:fileManager.CONTENT_TYPE.DIR,sort:fileManager.SORT.ASC};return $.extend(copyMoveFileTree.prototype,EventTarget,{_getDirName:function(path){var index=path.lastIndexOf("/"),dirName=path.substr(index+1);return dirName},_loadData:function(path){var self=this,nodes=[];if(this.autoOpen){var curNode={id:-1,label:_("企业空间"),name:_("企业空间"),is_dir:!1,is_shared:!1,path:"/",path_type:"ent",data:{path_type:"ent",access_mode:2047,realpath:"/",path:"/"}};nodes.push(curNode),self.fileTree.tree("loadData",nodes),fileManager.metadata(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);curNode=self.fileTree.tree("getNodeById",curNode.id),self.fileTree.tree("loadData",nodes,curNode),self.fileTree.tree("toggle",curNode),self.fileTree.tree("selectNode",curNode),self._render()}},path,{path_type:self.path_type,content_type:fileManager.CONTENT_TYPE.DIR,sort:fileManager.SORT.ASC})}else{var curNode={id:-1,label:_("企业空间"),name:_("企业空间"),is_dir:!1,is_shared:!1,path:"/",path_type:"ent",data:{path_type:"ent",access_mode:1025,realpath:"/",path:"/"}};nodes.push(curNode),curNode={id:-2,label:_("个人文件"),name:_("个人文件"),is_dir:!1,is_shared:!1,path:"/",path_type:"self",data:{path_type:"self",access_mode:2047,realpath:"/",path:"/"}},nodes.push(curNode),curNode={id:-3,label:_("我的共享"),name:_("我的共享"),is_dir:!1,is_shared:!1,path:"/",path_type:"share_out",data:{path_type:"share_out",access_mode:1025,realpath:"/",path:"/"}},nodes.push(curNode),curNode={id:-4,label:_("我收到的共享"),name:_("收到的共享"),is_dir:!1,is_shared:!1,path:"/",path_type:"share_in",data:{path_type:"share_in",access_mode:1025,realpath:"/",path:"/"}},nodes.push(curNode),self.fileTree.tree("loadData",nodes),self._render()}},_dataToNodes:function(data){for(var nodes=[],i=0,len=data.length;len>i;i++){var fileItem=data[i];if(fileItem.is_dir){var dir=this._getDirName(fileItem.path),childNode={data:fileItem,
id:fileItem.neid,path_type:fileItem.path_type,label:dir,cssAction:Util.resolveFileAction(fileItem.access_mode).replace(/:/g,"-"),realpath:fileItem.path,path:fileItem.path,from:fileItem.from,prefix_neid:fileItem.prefix_neid,is_dir:!0,is_shared:fileItem.is_shared,is_team:fileItem.is_team};nodes.push(childNode)}}return nodes},_init:function(nodes){var self=this;self.container.append('<div class="menu-item treeswitch" style="cursor: pointer;"><span class="icon i-user7"></span><span class="menu-text"></span></div><div class="sub-menu-item"><div class="treeview-wraper"><div class="treeview"></div></div> </div>'),self.fileTree=self.container.find(".treeview"),self.root=self.container.find(".treeswitch"),self.root.remove(),self.container.find(".treeview-wraper").css("width",self.width),self.fileTree.tree({data:[],closedIcon:'<span class="icon i-fold" style="vertical-align:middle;"></span>',openedIcon:'<span class="icon i-expand" style="vertical-align:middle;"></span>',onCreateLi:function(node,$li){var folder_icon='<span class="icon-file folder"></span>';node.is_shared&&node.is_team?folder_icon='<span class="icon-file folder_team"></span>':node.is_shared&&(folder_icon='<span class="icon-file folder_share"></span>'),(!node.element||node.element&&0==node.children.length&&!node.hasOwnProperty("load_on_demand"))&&(folder_icon='<a class="jqtree_common jqtree-toggler"><span class="icon i-fold" node-data="'+node.id+'" style="vertical-align:middle;"></span></a>'+folder_icon);var item=$li.find(".jqtree-title");item.before(folder_icon),item.attr("title",item.text())}}),$(self.fileTree).delegate(".i-fold","click",function(e){var id=$(e.target).attr("node-data");if(id){{var curNode=self.fileTree.tree("getNodeById",id);curNode.parent}filter=$.extend({path_type:curNode.path_type,prefix_neid:curNode.prefix_neid},FILTER),"share_in"==curNode.path_type&&(filter.from=curNode.from),fileManager.metadata(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.fileTree.tree("loadData",nodes,curNode),self.fileTree.tree("toggle",curNode),self.fileTree.tree("selectNode",curNode),self._render(),self.fire("changePath",curNode.path,curNode.cssAction,curNode.data)}},curNode.path,filter)}}),self.fileTree.bind("tree.init",function(){}),self.fileTree.bind("tree.click",function(event){var curNode=event.node,filter=(curNode.parent,$.extend({path_type:curNode.path_type,prefix_neid:curNode.prefix_neid},FILTER));"share_in"==curNode.path_type&&(filter.from=curNode.from),void 0===curNode.path||curNode.is_new||fileManager.metadata(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.fileTree.tree("loadData",nodes,curNode),self.fileTree.tree("toggle",curNode),self.fileTree.tree("selectNode",curNode),self._render(),self.fire("changePath",curNode.path,curNode.cssAction,curNode.data)}},curNode.path,filter)}),self.fileTree.bind("tree.close",function(e){self._render()}),self.fileTree.bind("tree.open",function(e){self._render()}),self.fileTree.bind("tree.move",function(event){fileManager.move(function(ret){event.move_info.target_node.realpath=event.move_info.target_node.realpath+"/"+event.move_info.moved_node.name},event.move_info.moved_node.realpath,event.move_info.target_node.realpath+"/"+event.move_info.moved_node.name)})},_render:function(){var self=this;self.container.find(".treeview-wraper").show(),self.max_height=self.max_height>45?self.max_height:45;var height=self.max_height<self.fileTree.height()?self.max_height:self.fileTree.height();0==height&&(height=self.max_height),height<self.min_height&&(height=self.min_height),self.container.find(".treeview-wraper").css("height",height),self.scroll||(self.scroll=new Scroll(self.container.find(".treeview-wraper"))),self.scroll&&self.scroll.render(!0)},render:function(){this._loadData()},removeNode:function(id){this.fileTree.tree("removeNode",this.fileTree.tree("getNodeById",id))},getSelectDir:function(){var node=this.fileTree.tree("getSelectedNode"),dir=node.realpath;return dir},getSelectNode:function(){var self=this,node=this.fileTree.tree("getSelectedNode");return node===!1?{data:{path_type:self.path_type,path:"/",neid:0,from:0}}:node},setSelectDir:function(path){var node=this.fileTree.tree("getNodeById",path);this.fileTree.tree("selectNode",node)},insertDir:function(parentPath,childPath){var self=this,parentNode=self.fileTree.tree("getNodeById",parentPath),filter=$.extend({path_type:parentNode.path_type,prefix_neid:parentNode.prefix_neid},FILTER);"share_in"==parentNode.path_type&&(filter.from=parentNode.from),fileManager.metadata(function(message){if(200==message.code){var fileItem=message.data;if(fileItem.is_dir){var dir=self._getDirName(fileItem.path),childNode=self.fileTree.tree("appendNode",{id:fileItem.neid,label:dir,cssAction:Util.resolveFileAction(fileItem.access_mode).replace(/:/g,"-"),realpath:fileItem.path,path:fileItem.path,path_type:fileItem.path_type,is_dir:fileItem.is_dir,is_shared:fileItem.is_shared,isTeam:fileItem.is_team,from:fileItem.from,prefix_neid:fileItem.prefix_neid,data:fileItem},parentNode);self._render(),self.fileTree.tree("selectNode",childNode)}}},childPath,filter)}}),copyMoveFileTree}),define("component/copymove",function(require,exports,module){var FileModel=require("model/FileManager"),AddFolder=require("component/addfolder"),ConfirmDialog=require("component/confirmDialog");require("mustache"),require("i18n");var copymove=function(){this.path_type=null,this.onlycopy=!1};return copymove.prototype={bindEvent:function(dialog,param,context){var self=this;if("[object Array]"==Object.prototype.toString.call(param)){for(var i=0,len=param.length;len>i;i++)if(self.isOnlycopy(param[i])){self.onlycopy=!0;break}}else self.onlycopy=self.isOnlycopy(param);var pathes=self.makeForm(param);$("#copy-file").click(function(){self.copy(dialog,pathes)}),$("#move-file").click(function(e){self.move(dialog,pathes,context)}),$("#create-folder").click(function(){self.createFolder(dialog)}),$("#close-dialog").click(function(){self.close(dialog)})},changePath:function(dialog,realpath,cssAction,dirData){if(void 0!==realpath||void 0!==cssAction||void 0!==dirData){{parseInt(Util.resolvePrivilegeID(cssAction))}Util.isAdmin()&&(dirData.access_mode=Util.resolveActionCss("edit"),dirData.realpath="/"),dirData&&"/"==realpath?"self"==dirData.path_type||Util.isAdmin()&&"ent"==dirData.path_type?($("#copy-file").addClass("ok").removeClass("disabled"),$("#create-folder").addClass("ok").removeClass("disabled"),dialog.isCopy=!0,dialog.isCreateFolder=!0,$("#move-file").addClass("ok").removeClass("disabled"),dialog.isMove=!0):($("#copy-file").removeClass("ok").addClass("disabled"),$("#move-file").removeClass("ok").addClass("disabled"),$("#create-folder").removeClass("ok").addClass("disabled"),dialog.isCopy=!1,dialog.isMove=!1,dialog.isCreateFolder=!1):(1058==(1058&dirData.access_mode)?($("#copy-file").addClass("ok").removeClass("disabled"),$("#move-file").addClass("ok").removeClass("disabled"),dialog.isCopy=!0,dialog.isMove=!0):($("#copy-file").removeClass("ok").addClass("disabled"),$("#move-file").removeClass("ok").addClass("disabled"),dialog.isCopy=!1,dialog.isMove=!1),32==(32&dirData.access_mode)?($("#create-folder").addClass("ok").removeClass("disabled"),dialog.isCreateFolder=!0):($("#create-folder").removeClass("ok").addClass("disabled"),dialog.isCreateFolder=!1)),this.filterShareIn(dialog),$(".create-folder-li input").select()}},isOnlycopy:function(param){var onlycopy=!1;if(param.islocked&&!param.unlockAdmin&&(onlycopy=!0),"edit"==param.action){if(param.isTeam&&(onlycopy=!0),Util.isAdmin()||"self"==param.path_type)return onlycopy;/share|ent/.test(param.path_type)&&/^\/([^\/]+)$/.test(param.path)&&(onlycopy=!0)}else onlycopy=!0;return onlycopy},filterShareIn:function(dialog){this.onlycopy&&($("#move-file").removeClass("ok").addClass("disabled"),dialog.isMove=!1)},copy:function(dialog,pathes){var self=this;if(dialog.isCopy){var to_path=dialog.getSelectNode(),dt={root:"databox",path:to_path.data.path,path_type:to_path.data.path_type,from:to_path.data.from};to_path.data.hasOwnProperty("neid")&&parseInt(to_path.data.neid)>0&&(dt.neid=to_path.data.neid),to_path.data.hasOwnProperty("prefix_neid")&&parseInt(to_path.data.prefix_neid)>0&&(dt.prefix_neid=to_path.data.prefix_neid),to_path=dt,dialog.isCopy&&(self.checkSameRoot(pathes,to_path)?Tips.warn(_("目标与源文件夹相同，请选择其他文件夹")):($("body").data("category","copy"),FileModel.batch_copy(function(ret){200==ret.code?Tips.show(ret.message):Tips.warn(500==ret.code?ret.message.join("<br>"):ret.message)},pathes,to_path),dialog.close()))}},move:function(dialog,pathes,context){var self=this;if(dialog.isMove){var to_path=dialog.getSelectNode(),dt={root:"databox",path:to_path.data.path,path_type:to_path.data.path_type,from:to_path.data.from};to_path.data.hasOwnProperty("neid")&&parseInt(to_path.data.neid)>0&&(dt.neid=to_path.data.neid),to_path.data.hasOwnProperty("prefix_neid")&&parseInt(to_path.data.prefix_neid)>0&&(dt.prefix_neid=to_path.data.prefix_neid),to_path=dt,self.checkSameRoot(pathes,to_path)?Tips.warn(_("目标与源文件夹相同，请选择其他文件夹")):($("body").data("category","move"),FileModel.batch_move(function(ret){200==ret.code?(Tips.show(ret.message),context.reload()):412==ret.code?new ConfirmDialog({content:ret.message,okBtn:_("继续")},function(){FileModel.batch_move(function(res){200==res.code?(Tips.show(res.message),context.reload()):Tips.warn(res.message)},pathes,to_path,!0)}):Tips.warn(500==ret.code?ret.message.join("<br>"):ret.message)},pathes,to_path),dialog.close())}},createFolder:function(dialog){if(dialog.isCreateFolder){var node=dialog.getSelectNode();new AddFolder({reload:function(){},type:node.path_type,from:node.from,prefix_neid:node.prefix_neid},node.path,function(childpath){dialog.addFolder(node.id,childpath)})}},close:function(dialog){dialog.close()},makeForm:function(param){var from=[];if(param.hasOwnProperty("neid")){var dt={root:"databox",path:param.path,path_type:param.path_type,from:param.from,rev:""};parseInt(param.neid)>0&&(dt.neid=param.neid),parseInt(param.prefix_neid)>0&&(dt.prefix_neid=param.prefix_neid),from.push(dt)}else for(var i in param)if(param.hasOwnProperty(i)){var dt={root:"databox",path:param[i].path,path_type:param[i].path_type,from:param[i].from,rev:""};param[i].hasOwnProperty("neid")&&parseInt(param[i].neid)>0&&(dt.neid=param[i].neid),parseInt(param[i].prefix_neid)>0&&(dt.prefix_neid=param[i].prefix_neid),from.push(dt)}return from},checkSameRoot:function(from,to){for(var i in from)if(from.hasOwnProperty(i)){var tmp=from[i],path=tmp.path.split("/");if(path.pop(),path=path.join("/"),path||(path="/"),path==to.path&&tmp.path_type==to.path_type&&tmp.from==to.from)return!0}return!1}},copymove}),define("component/deliveryDialog",function(require,exports,module){function DeliveryDialog(param,ok_callback){var self=this;self.fileAttr=param,self.ok_callback=ok_callback,self.fileAttr.delivery_info={},self._init()}{var $=require("jquery"),DeliveryModel=require("model/DeliveryManager"),ConfirmDialog=require("component/confirmDialog"),EventTarget=require("eventTarget"),AuthModel=require("model/AuthManager"),Util=require("util"),Tips=require("component/tips"),Dialog=require("component/dialog"),EmailTipList=require("component/emailtipList");require("js/gallery/jquery/placeholder/2.0.7/jquery.placeholder")}require("i18n"),require("calendar"),require("Clipboard");var _=$.i18n.prop;return $.extend(DeliveryDialog.prototype,EventTarget,{_render:function(dialog,dialog_cb){function replacePass(id,type){var obj=document.getElementById(id),obj2=$('<input type ="'+type+'" value="'+obj.value+'" id="'+id+'">')[0];obj.parentNode.replaceChild(obj2,obj)}function saveSet(fn){var mode="",password="",description=$("#description").val(),expiration=$("#expiration").val(),re=/([\d]{4})\D+?([\d]{1,2})\D+?([\d]{1,2})?/,display_password=$("#display-password");if(1==$("#delivery-upload").get(0).checked)var upload=!0;if(1==$("#delivery-download").get(0).checked)var download=!0;if(1==$("#delivery-preview").get(0).checked)var preview=!0;if(upload&&download)mode="rw";else if(upload&&preview)mode="wp";else if(upload)mode="w";else if(download)mode="r";else{if(!preview)return void Tips.warn(_("访问权限至少选择一种"));mode="p"}if("none"!=display_password.css("display")&&""==$("#delivery-password").val())return void Tips.warn(_("密码不能为空"));if("none"!=display_password.css("display")&&""!=$("#delivery-password").val()&&(password=$("#delivery-password").val()),1==$("#ulimit-expiration").get(0).checked)expiration=-1;else{if(""==expiration)return void Tips.warn(_("有效期不能为空"));var matchArr=re.exec(expiration);if(4!=matchArr.length)return void Tips.warn(_("日期格式不正确"));expiration=matchArr[1]+"-"+matchArr[2]+"-"+matchArr[3];var exp=new Date(expiration.replace(/\-/g,"/")),now=new Date((new Date).getFullYear()+"/"+((new Date).getMonth()+1)+"/"+(new Date).getDate());if(now>exp)return void Tips.warn(_("有效期必须不能小于当前日期"))}return Util.getBytes(description)>600?void Tips.warn(_("外链说明：最多可以输入300个汉字")):($("body").data("category","modify"),DeliveryModel.create(function(ret){return 200!=ret.code?void Tips.warn(ret.message):(self.fileAttr.delivery_info=ret.data,void self.dialog.close())},self.fileAttr.path,self.fileAttr.path_type,self.fileAttr.from,self.fileAttr.neid,self.fileAttr.prefix_neid,mode,password,expiration,description),void(fn&&fn()))}var self=this,htmlArr=[];if(htmlArr.push('<div class="delivery-dialog">'),htmlArr.push("<div>"),htmlArr.push('<span class="delivery-label">'+_("链接地址")+"</span>"),htmlArr.push('<input class="delivery-text-addr" type="text" value="'+self.fileAttr.delivery_info.url+'" readOnly/>'),htmlArr.push('<button class="delivery-button-copy" id="delivery-copy" data-clipboard-text="'+self.fileAttr.delivery_info.url+'">'+_("复制")+"</button>"),htmlArr.push('<button class="delivery-button-look" id="delivery-look" type="button">'+_("查看")+"</button>"),htmlArr.push("</div>"),htmlArr.push("<div>"),htmlArr.push('<span class="delivery-label">'+_("访问权限")+"</span>"),self.fileAttr.isfolder?(htmlArr.push(!self.fileAttr.action||self.fileAttr.action!=AuthModel.ACTION["UPLOAD:DELIVERY"]&&self.fileAttr.action!=AuthModel.ACTION["UPLOAD:DOWNLOAD:DELIVERY"]&&self.fileAttr.action!=AuthModel.ACTION.EDIT?'<input id="delivery-upload" type="checkbox" checked="false" disabled="disabled" onclick="return false"/>&nbsp;<span style="color:#ccc">'+_("上传")+"</span>":'<input id="delivery-upload" type="checkbox" />&nbsp;'+_("上传")),!self.fileAttr.action||self.fileAttr.action!=AuthModel.ACTION["DOWNLOAD:DELIVERY"]&&self.fileAttr.action!=AuthModel.ACTION["UPLOAD:DOWNLOAD:DELIVERY"]&&self.fileAttr.action!=AuthModel.ACTION.EDIT?(htmlArr.push('<input id="delivery-download"  type="checkbox" style="margin-left:20px;" disabled="disabled" onclick="return false"/>&nbsp;<span style="color:#ccc">'+_("下载")+"</span>"),htmlArr.push('<input id="delivery-preview"  type="checkbox" style="margin-left:20px; " disabled="disabled" onclick="return false" />&nbsp;<span style="color:#ccc">'+_("预览")+"</span>")):(htmlArr.push('<input id="delivery-download"  type="checkbox" style="margin-left:20px;" checked="true"/>&nbsp;'+_("下载")),htmlArr.push('<input id="delivery-preview"  type="checkbox" style="margin-left:20px;" />&nbsp;'+_("预览")))):(htmlArr.push('<input id="delivery-upload" type="checkbox" disabled="disabled" onclick="return false"/>&nbsp;<span style="color:#ccc">'+_("上传")+"</span>"),htmlArr.push('<input id="delivery-download"  type="checkbox" style="margin-left:20px;"/>&nbsp;'+_("下载")),htmlArr.push(Util.canPreview(self.fileAttr.mimeType)?'<input id="delivery-preview"  type="checkbox" style="margin-left:20px;" checked="true"/>&nbsp;'+_("预览"):'<input id="delivery-preview"  type="checkbox" style="margin-left:20px;" checked="false" disabled="disabled" onclick="return false"/>&nbsp;<span style="color:#ccc">'+_("预览")+"</span>")),htmlArr.push("</div>"),htmlArr.push('<div id="password-protocal">'),htmlArr.push('<span class="delivery-label">'+_("密码保护")+"</span>"),htmlArr.push("<select>"),htmlArr.push('<option value="close">'+_("关闭")+"</option>"),htmlArr.push('<option value="open">'+_("开启")+"</option>"),htmlArr.push("</select> "),htmlArr.push('<span id="display-password" style="display:none;">'),htmlArr.push('<input id="delivery-password" type="password" onpaste="return false"/> &nbsp;&nbsp;'),htmlArr.push('<input id="delivery-password-show" type="checkbox"/>'),htmlArr.push(" <span>"+_("显示密码")+"</span>"),htmlArr.push("</span>"),htmlArr.push("</div>"),htmlArr.push("<div>"),htmlArr.push('<span class="delivery-label">'+_("有效期至")+"</span>"),htmlArr.push('<input id="expiration" type="text" style="width:160px;"  readonly="readonly"/>&nbsp;'),htmlArr.push('<input id="ulimit-expiration" type="checkbox" />&nbsp;'+_("无限制")),htmlArr.push('<span id="distanceDays" style="display:none;color:#999">&nbsp;&nbsp;'+_("距离到期还有&nbsp;<em></em>&nbsp;天")+"</span>"),htmlArr.push("</div>"),htmlArr.push("<div>"),htmlArr.push('<span class="delivery-label vertical-a">'+_("外链说明")+"</span>"),htmlArr.push('<textarea id="description" value="" style="width: 376px; height: 149px; resize:none " placeholder="'+_("最多可以输入300个汉字")+'" maxlength="600"></textarea>'),htmlArr.push("</div>"),htmlArr.push('<div style="clear:both"></div>'),htmlArr.push("</div>"),dialog.append(htmlArr.join("")+'<div class="dialog-button-area"><a id="open-send-delivery-dialog" class="dialog-button cancel" style="float:left;">'+_("发送外链")+'</a><a id="delivery-setting-ok" class="dialog-button ok">'+_("确定")+'</a> <a id="auth-dialog-id-cancel" class="dialog-button cancel">'+_("取消")+"</a></div>"),dialog_cb(),$("#description").val(self.fileAttr.delivery_info.description),self.fileAttr.delivery_info.expiration&&-1!=self.fileAttr.delivery_info.expiration){$("#expiration").val(self.fileAttr.delivery_info.expiration.substr(0,10));var exp=new Date(self.fileAttr.delivery_info.expiration.substr(0,10).replace(/\-/g,"/")),now=new Date((new Date).getFullYear()+"/"+((new Date).getMonth()+1)+"/"+(new Date).getDate()),distance=parseInt((exp-now)/1e3/3600/24);$("#distanceDays").css("display","inline-block"),0>distance?$("#distanceDays").html('&nbsp;<span style="color:#FF0000">'+_("外链已过期")+"</span>"):$("#distanceDays em").text(distance)}else $("#ulimit-expiration").get(0).checked=!0,$("#expiration")[0].value="",$("#expiration").attr("disabled",!0);switch($("#delivery-upload").get(0).checked=!1,$("#delivery-download").get(0).checked=!1,$("#delivery-preview").get(0).checked=!1,self.fileAttr.delivery_info.mode){case"rw":$("#delivery-upload").get(0).checked=!0,$("#delivery-download").get(0).checked=!0,$("#delivery-preview").get(0).checked=!0;break;case"r":$("#delivery-download").get(0).checked=!0,$("#delivery-preview").get(0).checked=!0,self.fileAttr.isfolder||Util.canPreview(self.fileAttr.mimeType)||($("#delivery-preview").get(0).checked=!1);break;case"wp":$("#delivery-upload").get(0).checked=!0,$("#delivery-preview").get(0).checked=!0;break;case"w":$("#delivery-upload").get(0).checked=!0;break;case"p":$("#delivery-preview").get(0).checked=!0}1==self.fileAttr.delivery_info.has_password&&($("#display-password").show(),$("#delivery-password").val(self.fileAttr.delivery_info.password),$("#password-protocal select").val("open")),$("input, textarea").placeholder();var clip=new ZeroClipboard(document.getElementById("delivery-copy"),{moviePath:"/js/gallery/ZeroClipboard/ZeroClipboard.swf"});clip.on("complete",function(client,args){Util.sendDirectlyRequest("设置外链","复制外链","-"),Tips.show(_("链接地址已经复制到剪切板中"))}),$("#delivery-copy").click(function(){var link_addr=$(".delivery-text-addr").val();$.copy(link_addr)}),$("#delivery-look").click(function(){var uri=$(".delivery-text-addr").val();Util.sendDirectlyRequest("设置外链",$("body").data("action")+"访问",""),window.open(uri)}),$("#delivery-download").change(function(){Util.sendDirectlyRequest("外链",'"访问权限"选择',"-"),1==$("#delivery-download").get(0).checked&&($("#delivery-preview").get(0).checked=!0)}),$("#delivery-preview").change(function(){Util.sendDirectlyRequest("外链",'"访问权限"选择',"-"),0==$("#delivery-preview").get(0).checked&&($("#delivery-download").get(0).checked=!1)}),$("#delivery-upload").change(function(e){Util.sendDirectlyRequest("外链",'"访问权限"选择',"-")}),$("#password-protocal select").change(function(e){var value=$(this).val(),elem=$("#display-password");"open"===value?(Util.sendDirectlyRequest("外链",'"密码保护"开启',"-"),elem.show()):"close"===value&&(replacePass("delivery-password","password"),Util.sendDirectlyRequest("外链",'"密码保护"关闭',"-"),elem.hide())}),$("#delivery-password-show").change(function(){1==$("#delivery-password-show").get(0).checked?(Util.sendDirectlyRequest("外链",'"显示密码"勾选',"-"),replacePass("delivery-password","text")):replacePass("delivery-password","password")}),$("#ulimit-expiration").click(function(){Util.sendDirectlyRequest("外链",'"有效期至"无限制',"-"),1==$(this).get(0).checked?($("#expiration").val(""),$("#expiration").attr("disabled",!0),$("#distanceDays").css("display","none")):$("#expiration").attr("disabled",!1),$("#expiration").calendar({onClick:function(el,cell,date,data){el.val(Util.formatDate(date,"yyyy-MM-dd"))}})}),$("#delivery-setting-ok").click(function(){saveSet(function(){self.ok_callback&&self.ok_callback()})}),$("#open-send-delivery-dialog").click(function(){saveSet(function(){var link_addr=$(".delivery-text-addr").val();self.sendDeliveryDialog=new Dialog(_("发送外链"),{mask:!0},function(dialog,dialog_cb){var sendHtml=[];sendHtml.push('<div class="delivery-send-dialog">'),sendHtml.push('<p  class="sendTitle">'+_("发送邮件")+"</p>"),sendHtml.push('<div class="sendCon">'),sendHtml.push('<p class="sendLabel">'+_("收件人")+"</p>"),sendHtml.push('<p id="sendTo"><input class="delivery-text-email" id="delivery-email" type="text" value="" placeholder="'+_("邮箱地址以逗号或者分号分隔")+'"/></p>'),sendHtml.push('<p class="sendLabel">'+_("邮件内容")+"</p>"),sendHtml.push('<p><textarea class="delivery-send-content" id="delivery-info" value=""></textarea></p>'),sendHtml.push("</div>"),sendHtml.push("</div>"),dialog.append(sendHtml.join("")+'<div class="dialog-button-area"><a id="auth-dialog-id-ok" class="dialog-button ok">'+_("发送")+'</a> <a id="auth-dialog-id-cancel2" class="dialog-button cancel">'+_("取消")+"</a></div>"),dialog.append("<div>"),EmailTipList.emailTipList($("#sendTo"),$("#delivery-email")),$("input, textarea").placeholder(),$("#auth-dialog-id-ok").click(function(e){var delivery_email=$.trim($("#delivery-email").val()),delivery_info=$.trim($("#delivery-info").val());if(""==delivery_email)return void Tips.warn(_("邮箱不能为空"));for(var emailArr=delivery_email.split(/[;,]/),arr=[],i=0,len=emailArr.length;len>i;i++)if(""==emailArr[i]);else{if(!Util.validEmail(emailArr[i]))return void Tips.warn(_("邮箱格式不正确"));arr.push(emailArr[i])}delivery_email=arr.join(";"),$(e.currentTarget).html(_("发送中...")),$(e.currentTarget).attr("disabled","disabled"),$("body").data("category","send"),DeliveryModel.sendmail(function(ret){if($(e.currentTarget).html(_("发送")),$(e.currentTarget).removeAttr("disabled"),200==ret.code&&200==ret.data.code)Tips.show(_("发送成功")),self.sendDeliveryDialog.close();else{if(502==ret.code)return void Tips.warn(ret.message);Tips.warn(_("发送失败，请重新发送"))}},link_addr,delivery_email,delivery_info,self.fileAttr.isfolder,self.fileAttr.name,self.fileAttr.path)}),$("#auth-dialog-id-cancel2").click(function(){self.sendDeliveryDialog.close()})})})}),$("#auth-dialog-id-cancel-link").click(function(){new ConfirmDialog({content:_("您确认要取消文件外链吗？")},function(){DeliveryModel.del(function(ret){Tips.show(ret.message),200==ret.code&&(self.dialog.close(),self.ok_callback&&self.ok_callback())},self.fileAttr.path)})}),$("#auth-dialog-id-cancel").click(function(){self.dialog.close()})},_init:function(){var self=this,title=_("外链分享");if(self.fileAttr.deliveryCode)DeliveryModel.info(function(ret){return 200!=ret.code?void Tips.warn(ret.message):(self.fileAttr.delivery_info=ret.data,self.dialog=new Dialog(title,{mask:!0},function(dialog,dialog_cb){self._render(dialog,dialog_cb)}),void $("#expiration").calendar({onClick:function(el,cell,date,data){el.val(Util.formatDate(date,"yyyy-MM-dd"))}}))},self.fileAttr.deliveryCode);else{var mode="r";self.fileAttr.action==AuthModel.ACTION["UPLOAD:DELIVERY"]&&(mode="w"),DeliveryModel.create(function(ret){return 200!=ret.code?void Tips.warn(ret.message):(self.fileAttr.delivery_info=ret.data,void(self.dialog=new Dialog(title,{mask:!0},function(dialog,dialog_cb){self._render(dialog,dialog_cb)})))},self.fileAttr.path,self.fileAttr.path_type,self.fileAttr.from,self.fileAttr.neid,self.fileAttr.prefix_neid,mode,"")}},_delivery_info:function(container,has_password,permission,expiration){var self=this,passwordText=self._hasPasswordText(has_password),permissionText=self._permissionText(permission),htmlArr=[];expiration=-1==expiration?_("无限制"):Util.formatDate(expiration,"yyyy年MM月dd日"),htmlArr.push("<span>"+_("密码")+":"+passwordText+"</span>"),htmlArr.push("<span>"+_("权限")+":"+permissionText+"</span>"),htmlArr.push("<span>"+_("有效期至")+":"+expiration+"</span>"),$(container).empty(),$(container).append(htmlArr.join(""))},_hasPasswordText:function(has_password){var passwordText=_("无");return has_password&&(passwordText=_("有")),passwordText},_permissionText:function(mode){var permission=_("下载");switch(mode){case"r":permission=_("下载");break;case"w":permission=_("上传");break;case"rw":permission=_("上传/下载")}return permission}}),DeliveryDialog}),define("component/dialog",function(require,exports){function Dialog(title,config,func){function Dialog(dragId,moveId){var instace={};return instace.dragElement=$(dragId),instace.moveElement=$(moveId),instace.mouseOffsetLeft=0,instace.mouseOffsetTop=0,instace.dragElement.bind("mousedown",function(e){var e=e||window.event,target=$(e.target);return target.hasClass("i-close")?(self.fire("tclose"),void self.close()):(e.preventDefault(),dialogInstace=instace,instace.mouseOffsetLeft=e.pageX-instace.moveElement.offset().left,instace.mouseOffsetTop=e.pageY-instace.moveElement.offset().top,onMoveStartId=setInterval(onMoveStart,10),!1)}),instace}function onMoveStart(){var instace=dialogInstace;if(instace){var maxX=$(window).width()-instace.moveElement.width(),maxY=$(window).height()-instace.moveElement.height();instace.moveElement.css({left:Math.min(Math.max(mousePos.x-instace.mouseOffsetLeft,0),maxX),top:Math.min(Math.max(mousePos.y-instace.mouseOffsetTop,0),maxY)})}}function setPos(){var tleft,ttop,host=$(window),w=host.width(),h=host.height(),tw=uiDialog.outerWidth(),th=uiDialog.outerHeight();tleft=(w-tw)/2,ttop=(h-th)/2,titleEle.width(uiDialog.width()),msgArea.width(uiDialog.width()),uiDialog.css({left:tleft,top:ttop}),$(".lui-mask").length>0&&(uiDialog.css("z-index",window.uuid["z-index"]),window.uuid["z-index"]+=10,mask.css("z-index",window.maskid["z-index"]),window.maskid["z-index"]+=10)}var fn,cfg;2==arguments.length?(cfg={},fn=arguments[1]):(cfg=arguments[1],fn=arguments[2]);var DEFAULT={mask:!0,control:!1};this.cfg=$.extend(DEFAULT,cfg);var uiDialog=$('<div class="lui-dialog"></div>'),titleEle=$('<div class="title-wraper"><span class="title"></span></div>'),oper=$('<span class="oper"><a class="icon i-close"></a></span>'),msgArea=$('<div class="content-msgArea"></div>'),content=$('<div class="content-wraper"></div>'),mask=$('<div class="lui-mask"></div>'),uiDialogMin=$('<div class="lui-min-dialog"><span class="min-dialog-wraper"></span><span class="recover"><span class="icon i-max"></span></span></div>');this.dialog=uiDialog,this.mask=mask,titleEle.find(".title").text(title),uiDialog.append(titleEle),uiDialog.append(msgArea),uiDialog.append(content),titleEle.append(oper),this.cfg.control&&oper.prepend('<a class="icon i-min"></a>'),this.cfg.mask&&mask.appendTo($("body")),this.cfg.minWidth&&uiDialog.css("min-width",this.cfg.minWidth),this.cfg.conPadding&&uiDialog.find(".content-wraper").css("padding",this.cfg.conPadding),uiDialog.appendTo($("body")).fadeIn(1e3);var self=this;$("body").on("keydown",function(e){27==e.keyCode&&self.close()}),fn(content,function(){setPos()}),setPos();var dialogInstace,onMoveStartId,mousePos={x:0,y:0};document.onmouseup=function(e){dialogInstace=!1,clearInterval(onMoveStartId)},document.onmousemove=function(e){var e=window.event||e;mousePos.x=e.clientX,mousePos.y=e.clientY,e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0,e=this.originalEvent,e&&(e.preventDefault?e.preventDefault():e.returnValue=!1)},Dialog(".lui-dialog .title-wraper",".lui-dialog"),window.onresize=setPos;var self=this;oper.find(".i-min").on("click",function(){self.hide(!0);var mind=$(uiDialogMin);mind.appendTo($("body")).fadeIn();var container=mind.find(".min-dialog-wraper");self.fire("min",container),self.minDialog=mind,mind.find(".i-max").on("click",function(){self.show()})}),oper.find(".i-close").on("click",function(e){self.fire("tclose"),self.close()})}var $=require("jquery"),EventTarget=require("eventTarget");return window.uuid||(window.uuid={},window.uuid["z-index"]=50),window.maskid||(window.maskid={},window.maskid["z-index"]=40),$.extend(Dialog.prototype,EventTarget,{hide:function(flag){var self=this;self.mask&&self.mask.fadeOut(600),self.dialog&&(flag?(self.dialog.css("visibility","hidden"),self.fire("hide")):self.dialog.fadeOut(1e3))},show:function(){var self=this;if(self.minDialog&&self.minDialog.fadeOut(500,function(){self.minDialog.remove()}),self.mask&&self.mask.fadeIn(600),self.dialog){var visi=self.dialog.css("visibility");"hidden"==visi&&self.dialog.css("visibility","visible"),self.dialog.fadeIn(1e3),self.fire("show")}},close:function(){var self=this,bool=self.syncFire("close");bool||(self.dialog.remove(),self.mask&&self.mask.fadeOut(800,function(){self.mask.remove()}),$("body").off("keydown"))},showMessage:function(msg){var self=this;self.dialog.find(".content-msgArea").html(msg).stop(!1,!0).slideDown("slow");setTimeout(function(){self.dialog.find(".content-msgArea").empty().stop(!1,!0).slideUp("slow")},3e3)},clearMessage:function(msg){var self=this;self.dialog.find(".content-msgArea").empty().hide()}}),Dialog}),define("component/dirSelectDialog",function(require,exports,module){function DirSelectDialog(context,width,height,autoOpen,isCopyMove){this.context=context,this.width=width,this.height=height,isCopyMove&&(this.isCopy=!1,this.isMove=!1,this.isCreateFolder=!1,this.isCopyMove=!0,FileTree=CopyMoveTree),this.context.title||(this.context.title=""),this.context.subtitle||(this.context.subtitle=""),this.context.buttonContext||(this.context.buttonContext=""),this.autoOpen=autoOpen===!1?!1:!0,this._init()}var $=require("jquery"),FileTree=require("component/fileManager/fileTree"),CopyMoveTree=require("component/copyMoveFileTree"),EventTarget=require("eventTarget"),Dialog=require("component/dialog");require("i18n");$.i18n.prop;return $.extend(DirSelectDialog.prototype,EventTarget,{_init:function(){var self=this;self.dialog=new Dialog(self.context.title,{mask:!0},function(dialog){dialog.append('<div class="selectDirWrapper" id='+(self.isCopyMove?"copy-dialog":"auth-dialog")+'><div id="dir-select-dialog"></div></div>'+self.context.buttonContext),self.ft=new FileTree("#dir-select-dialog",{path_type:"ent"},{width:self.width,min_height:200,max_height:260,autoOpen:self.autoOpen?!0:!1,teamName:self.context.teamName}),self.ft.on("changePath",function(realpath,cssAction,dirData){self.fire("changePath",realpath,cssAction,dirData)}),(self.autoOpen||self.isCopyMove)&&self.ft._loadData(self.context.teamPath),"/"!==self.context.teamPath&&self.ft.root.unbind("click")})},getSelectDir:function(){return this.ft.getSelectDir()},getSelectNode:function(){return this.ft.getSelectNode()},setSelectDir:function(path){return path=path?path.replace("//","/"):"/",this.ft.setSelectDir(path)},appendNode:function(node,data){this.ft.appendNode(node,data)},getTree:function(){return this.ft.getTree()},removeNode:function(id){this.ft.removeNode(id)},insertDir:function(parentPath,childPath){return parentPath=parentPath?parentPath.replace("//","/"):"/",childPath=childPath?childPath.replace("//","/"):"/",this.ft.insertDir(parentPath,childPath)},addFolder:function(parentId,childPath){
var parentPath=parentId,childPath=childPath?childPath.replace("//","/"):"/";return this.ft.insertDir(parentPath,childPath)},reload:function(){},close:function(){this.dialog.close()}}),DirSelectDialog}),define("component/dynamic",function(require,exports){function Dynamic(node,path_type,path,neid,prefix_neid,from){var self=this;self.node="string"==$.type(node)?$(node):node,self.path_type="share_out"==path_type?"self":path_type,self.neid=neid||null,self.path=path||"",self.from=from||"",self.prefix_neid=prefix_neid||0,self.dataList=[],self.selectIndex=0,0!=self.path.indexOf("/")&&(self.path="/"+self.path),self._init()}{var $=jquery=require("jquery"),EventTarget=require("eventTarget"),Util=(require("model/FileManager.js"),require("model/AuthManager"),require("util")),eventController=require("lenovodata/eventController"),eventManager=require("lenovodata/model/EventManager"),List=require("component/list");require("component/scroll")}require("i18n"),require("cookie");$.i18n.prop;return require("mustache"),$.extend(Dynamic.prototype,EventTarget,{_init:function(){var self=this;self.ec=new eventController(function(){self.renderScroll()},!0),self.manager=new eventManager,self.checkHasDynamic(),null!=self.node&&self.infoTab()},infoTab:function(){var self=this,infoTabHead=self.node.find(".infoTab").find(".infoTabHead"),index=localStorage.getItem("showTab")||0;infoTabHead.length>0&&(self.selectHeader(index),infoTabHead.delegate("span","click",function(e){var index=$(e.target).index();localStorage.setItem("showTab",index),1==index&&Util.sendDirectlyRequest("主页面","点击右侧栏动态tab","-"),self.selectHeader(index)}))},selectHeader:function(index){var self=this;self.node.find(".infoTab .infoTabHead span").eq(index).addClass("active").siblings().removeClass("active"),self.node.find(".infoTab .infoBox").eq(index).show().siblings(".infoBox").hide(),1==index&&index!=self.selectIndex?(self.selectIndex=index,self.renderDynamic(),$(".has-dynamic-icon").removeClass("has-dynamic")):(self.selectIndex=index,self.dataList=[]);var dynamicTab=self.node.find(".infoTab .infoTabHead span.infoTabDynamic");dynamicTab.hasClass("active")?$(".show-dynamic-button").addClass("dynamicShow"):$(".show-dynamic-button").removeClass("dynamicShow")},renderDynamic:function(){var self=this,path=self.path,path_type=self.path_type;if(path){self.setBodyHeight();var list=new List("#dynamic-list",function(param,success,error){var params={type:"all",n:param.size,p:param.offset+1,path:path,path_type:path_type};parseInt(self.neid)>0&&(params.neid=self.neid),parseInt(self.prefix_neid)>0&&(params.prefix_neid=self.prefix_neid),self.manager.list(function(result){200==result.code&&($(".scl-content .dynamic-item").remove(),self.dataList=self.dataList.concat(result.data.event),success(self.ec.filterData(self.dataList),result.total),$(".scl-content .dynamic-item").last().css({"margin-bottom":"5px"})),setTimeout(function(){self.checkHasDynamic(!0),$("#has-dynamic").removeClass("has-dynamic"),self.list&&self.list.scroll&&self.list.scroll.render(!0)},100)},params)},!1,10,!0);list.initList({empty:"#template_dynamic_nodata_body","default":"#template_dynamic_list_body",folder:"#template_dynamic_list_body"}),list.render(!0),self.list=list}},checkHasDynamic:function(isDynamic){var self=this,params={path:self.path,path_type:self.path_type};parseInt(self.from)>0&&(params.from=self.from),parseInt(self.prefix_neid)>0&&/^share_/.test(self.path_type)&&(params.prefix_neid=self.prefix_neid),$(".has-dynamic-icon").length>0&&"string"==typeof params.path_type&&self.manager.hasNew(function(json){self.checkHasDynamicBack(json,isDynamic)},params),-1!=location.pathname.indexOf("event/list")?self.manager.hasNew(function(json){},{type:"clear"}):$(".has-dynamic-icon-all").length>0&&"/"==self.path&&self.manager.hasNew(function(json){self.checkAllHasDynamicBack(json)},{})},checkAllHasDynamicBack:function(json){$(".has-dynamic-icon-all i").attr(json.count>9&&json.count<99?{"class":"msgMid"}:json.count>99?{"class":"msgBig"}:{"class":"msgSmall"}),json.hasOwnProperty("hasNew")&&json.hasNew?(json.count>=100&&(json.count="99+"),$(".has-dynamic-icon-all").addClass("has-dynamic").find("i").html(json.count)):$(".has-dynamic-icon-all").removeClass("has-dynamic").find("i").html("")},checkHasDynamicBack:function(json,isDynamic){json.count>=100&&(json.count="99+"),$("#has-dynamic-show-num i").attr(json.count>9&&json.count<99?{"class":"msgMid"}:"99+"==json.count?{"class":"msgBig"}:{"class":"msgSmall"}),json.hasOwnProperty("hasNew")&&json.hasNew?($(".has-dynamic-icon").addClass("has-dynamic"),$("#has-dynamic-show-num").addClass("show").find("i").html(json.count)):($(".has-dynamic-icon").removeClass("has-dynamic"),$("#has-dynamic-show-num").removeClass("show").find("i").html("")),"boolean"==typeof isDynamic&&isDynamic&&$("#has-dynamic").removeClass("has-dynamic")},setBodyHeight:function(){var height=$(".conright").height()-$(".fileAttribute .file-top").height()-$(".fileAttribute .infoTabHead").height()-$("#foot").height()-30;$("#dynamic-list #listBody").empty().css({height:height+8+"px"})},renderScroll:function(){var self=this;self.list&&self.list.scroll.render(!0)}}),Dynamic}),define("component/emailtipList",function(require,exports,module){{var $=require("jquery");require("util")}return UserModel=require("model/UserManager"),{emailTipList:function(node,nodeinput){function setPos(){var ypos=$searchInput.position().top+$searchInput.outerHeight(),xpos=$searchInput.position().left,width=$searchInput.width()+2;$search.css("posotion","relative"),$autocomplete.css({position:"absolute",left:xpos+"px",top:ypos+"px",width:width}),setSelectedItem(0),$autocomplete.show()}var $search=node,$searchInput=$search.find(nodeinput);$searchInput.attr("autocomplete","off");var $autocomplete=$('<div class="autocomplete"></div>').hide().insertAfter(nodeinput),clear=function(){$autocomplete.empty().hide()};$searchInput.blur(function(){setTimeout(clear,500)});var selectedItem=null,timeoutid=null,setSelectedItem=function(item){selectedItem=item,0>selectedItem?selectedItem=$autocomplete.find("li").length-1:selectedItem>$autocomplete.find("li").length-1&&(selectedItem=0),$autocomplete.find("li").removeClass("highlight").eq(selectedItem).addClass("highlight")},_request=function(key){UserModel.getUserEmailList(function(ret){200==ret.code&&ret.data.result&&(ret.data.result.length>10&&ret.data.result.splice(10,ret.data.result-10),$.each(ret.data.result,function(index,term){$("<li></li>").text(term.email).appendTo($autocomplete).addClass("clickable").hover(function(){$(this).siblings().removeClass("highlight"),$(this).addClass("highlight"),selectedItem=index},function(){$(this).removeClass("highlight"),selectedItem=-1}).click(function(){var arr=$searchInput.val().split(/[;,]/);arr.pop();var str=arr.join(";");""==str?str:str+=";",$searchInput.val(str+term.email+";"),$autocomplete.empty().hide()}).keyup(function(event){if(38==event.keyCode){var arr=$searchInput.val().split(/[;,]/);arr.pop();var str=arr.join(";");""==str?str:str+=";",$searchInput.val(str+term.email+";"),$autocomplete.empty().hide()}})}),setPos())},key)};$searchInput.keyup(function(event){var key=$(this).val().split(/[;,]/).pop();event.keyCode>40||8==event.keyCode||32==event.keyCode?($autocomplete.empty().hide(),clearTimeout(timeoutid),timeoutid=setTimeout(function(){_request(key)},100),event.preventDefault()):38==event.keyCode?(setSelectedItem(-1==selectedItem?$autocomplete.find("li").length-1:selectedItem-1),event.preventDefault()):40==event.keyCode&&(setSelectedItem(-1==selectedItem?0:selectedItem+1),event.preventDefault())}).keypress(function(event){if(13==event.keyCode){if(0==$autocomplete.find("li").length||-1==selectedItem)return;var arr=$searchInput.val().split(/[;,]/);arr.pop();var str=arr.join(";");""==str?str:str+=";",$searchInput.val(str+$autocomplete.find("li").eq(selectedItem).text()+";"),$autocomplete.empty().hide(),event.preventDefault(),window.event.cancelBubble=!0,event.stopPropagation()}})}}}),define("component/eventTarget",function(require,exports){var EventTarget={on:function(type,handler){this.handlers||(this.handlers={}),this.handlers[type]=handler},fire:function(type){var args=Array.prototype.slice.call(arguments,1);this.handlers||(this.handlers={});var handler=this.handlers[type];handler&&handler.apply(this,args)},syncFire:function(type){var args=Array.prototype.slice.call(arguments,1);this.handlers||(this.handlers={});var handler=this.handlers[type];return handler?handler.apply(this,args):null},off:function(type,handler){this.handlers||(this.handlers={});var handler=this.handlers[type];handler&&null==this.handlers[type]},broadcast:function(type){var cache=broadcast_cache,args=Array.prototype.slice.call(arguments,1);if(cache){var fn=cache[type];if(fn){var i=0;for(len=fn.length;i<len;i++)fn[i].apply(this,args)}}},onbroadcast:function(type,func){var cache=broadcast_cache;if(cache){var handlers=cache[type]||[];handlers.push(func)}}};return EventTarget}),define("component/eventTemplateTool",function(require,exports,module){var eventTemplateTool=function(){},$=require("jquery"),AuthModel=require("lenovodata/model/AuthManager"),Util=require("lenovodata/util");require("i18n"),require("mustache");var _=$.i18n.prop;eventTemplateTool.prototype={getTemplate:function(data){this.resolveAuth(data);var eventType=parseInt(data.eventType);if(eventType>1e3&&2e3>eventType||eventType>1e4)var data=this.metaTool(data);else if(eventType>2e3&&3e3>eventType)var data=this.userTool(data);else if(eventType>3e3&&4e3>eventType)var data=this.teamTool(data);else if(eventType>4e3&&5e3>eventType)var data=this.authShareTool(data);else if(eventType>5e3&&6e3>eventType)var data=this.otherTool(data);else if(eventType>6e3&&7e3>eventType)var data=this.linkTool(data);return this.specialDesc(data)},metaTool:function(data){switch(parseInt(data.eventType)){case 1001:data.op_user=data.userName,data.event_title=Mustache.render(_("新建了一个文件夹 “{{&target}}”"),{userName:data.userName,target:this.getLastName(data.target[0].path)}),data.event_path={path:this.getLastName(data.target[0].path),pathname:this.getLongPath(data.target[0].path)};break;case 1002:data.op_user=data.userName,data.event_desc=_("上传了一个文件"),data.event_file=this.createFileList(data.target);break;case 1003:data.op_user=data.userName,data.event_path={op:_("下载了文件夹"),path:this.getLastName(data.target[0].path),pathname:this.getLongPath(data.target[0].path)};break;case 1004:data.op_user=data.userName,data.event_desc=_("下载了一个文件"),data.event_file=this.createFileList(data.target);break;case 1005:data.op_user=data.userName,data.event_desc=Mustache.render(_("打包下载了{{fileNum}}个项"),data),data.event_file=this.createFileList(data.target);break;case 1006:data.op_user=data.userName,data.event_desc=_("打包下载文件夹");case 1007:data.op_user=data.userName,data.event_desc=_("删除了文件夹");break;case 1008:data.op_user=data.userName,data.event_desc=_("删除文件");break;case 1009:data.op_user=data.userName,data.event_desc=Mustache.render(_("删除了{{fileNum}}个项"),data),data.event_show_list=this.createShowFileList(data.target);break;case 1010:case 1011:data.op_user=data.userName,data.event_desc=Mustache.render(_("重命名  {{&from}} 为  {{&target}}"),{from:this.getLastName(data.from[0].path),target:this.getLastName(data.target[0].path)});break;case 1012:case 1012001:case 1013:case 1013001:data.op_user=data.userName,this.isTarget(data.eventType)||(data.event_desc=_("移动")+" "+this.getLastName(data.target[0].path)),this.isTarget(data.eventType)&&(data.event_desc=_("增加")+" "+this.getLastName(data.target[0].path));break;case 1014:case 1014001:data.op_user=data.userName,this.isTarget(data.eventType)||(data.event_desc=Mustache.render(_("移动了{{fileNum}}个项"),data),data.event_show_list=this.createShowFileList(data.from)),this.isTarget(data.eventType)&&(data.event_desc=Mustache.render(_("增加了{{fileNum}}个项"),data),data.event_show_list=this.createShowFileList(data.target));break;case 1015:case 1015001:case 1016:case 1016001:data.op_user=data.userName,this.isTarget(data.eventType)||(data.event_desc=_("复制")+" "+this.getLastName(data.target[0].path),data.event_show_list=this.createShowFileList(data.from)),this.isTarget(data.eventType)&&(data.event_desc=_("增加")+" "+this.getLastName(data.target[0].path),data.event_show_list=this.createShowFileList(data.target));break;case 1017:case 1017001:data.op_user=data.userName,this.isTarget(data.eventType)||(data.event_desc=Mustache.render(_("复制了{{fileNum}}个项"),data),data.event_show_list=this.createShowFileList(data.from)),this.isTarget(data.eventType)&&(data.event_desc=Mustache.render(_("增加了{{fileNum}}个项"),data),data.event_show_list=this.createShowFileList(data.target));break;case 1018:data.op_user=data.userName,data.event_desc=_("预览了文件");break;case 1019:data.op_user=data.userName,data.event_desc=_("更新了文件"),data.event_file=this.createFileList(data.target);break;case 1020:data.op_user=data.userName,data.event_desc=_("恢复了文件"),data.event_file=this.createFileList(data.target);break;case 1021:data.op_user=data.userName,data.event_desc=_(data.target.hasOwnProperty(0)&&"true"===data.target[0].isFolder?"还原了文件夹":"还原了文件"),data.event_file=this.createFileList(data.target);break;case 1022:case 1023:data.op_user=data.userName,data.event_desc=Mustache.render(_("为“{{&target}}”增加了备注"),{target:this.getLastName(data.target[0].path)}),data.event_mark=data.mark;break;case 1024:case 1025:data.op_user=data.userName,data.event_desc=Mustache.render(_("为“{{&target}}”修改了备注"),{target:this.getLastName(data.target[0].path)}),data.event_mark=data.mark;break;case 1026:case 1027:data.op_user=data.userName,data.event_desc=Mustache.render(_("为“{{&target}}”删除了备注"),{target:this.getLastName(data.target[0].path)});break;case 1028:data.op_user=data.userName,data.event_desc=Mustache.render(_("为“{{&target}}”设置了定期清理"),{target:this.getLastName(data.target[0].path)});break;case 1029:data.op_user=data.userName,data.event_desc=Mustache.render(_("为“{{&target}}”取消了定期清理"),{target:this.getLastName(data.target[0].path)});break;case 1030:data.op_user=data.userName,data.event_desc=_("锁定文件");break;case 1031:data.op_user=data.userName,data.event_desc=_("解锁文件");break;case 1032:data.op_user=data.userName,data.event_desc=_("请求解锁文件"),data.event_file=this.createFileList(data.target);break;case 1033:data.op_user=data.userName,data.event_desc=_("彻底删除了"),data.event_show_list=this.createShowFileList(data.target);break;case 1034:data.op_user=data.userName,data.event_desc=Mustache.render(_("彻底删除了{{fileNum}}个项"),data),data.event_show_list=this.createShowFileList(data.target);break;case 1035:data.op_user=data.userName,data.event_desc=Mustache.render(_("还原了{{fileNum}}项"),data),data.event_file=this.createFileList(data.target);break;case 1037:data.iconType="pan",data.uid=0,data.event_desc=Mustache.render(_("系统 自动清理了“{{&target}}”"),{target:this.getLastName(data.target[0].path)});break;default:data.event_desc=data.eventType+"还没建立数据"}return data},userTool:function(data){return data},teamTool:function(data){switch(parseInt(data.eventType)){case 3001:data.event_path={op:_("创建了"),path:this.getLastName(data.target[0].path),pathname:this.getLongPath(data.target[0].path)};break;case 3002:data.op_user=data.userName,data.folderIconType="folder_team",data.event_desc=Mustache.render(_("删除了“{{&target}}”"),{target:this.getLastName(data.target[0].path)});break;case 3003:data.op_user=data.targetUserName,data.op_user_tab=data.targetUserName,data.event_desc=Mustache.render(_("{{targetUserName}}加入 “{{teamName}}”"),{targetUserName:data.targetUserName,teamName:data.teamName});break;case 3004:data.folderIconType="folder_team",data.op_user=data.targetUserName,data.op_user_tab=data.targetUserName,data.event_desc=Mustache.render(_("{{targetUserName}}离开 “{{teamName}}”"),{targetUserName:data.targetUserName,teamName:data.teamName});break;case 3005:data.op_user=data.userName,data.event_desc=Mustache.render(_("更新“{{teamName}}”的用户数为 {{numsOrSpaceSize}}"),data);break;case 3006:data.op_user=data.userName,data.event_desc=Mustache.render(_("更新“{{teamName}}”的空间为{{numsOrSpaceSize}}"),{teamName:data.teamName,numsOrSpaceSize:Util.formatBytes(data.numsOrSpaceSize)});break;case 3007:data.op_user=data.userName,data.event_desc=Mustache.render(_("更新“{{teamName}}”的备注 "),data),data.event_mark=data.mark;break;case 3008:data.op_user=data.targetUserName,data.op_user_tab=data.targetUserName,data.event_desc=Mustache.render(_("{{targetUserName}} 成为 “{{teamName}}” 团队管理员"),data);break;case 3009:data.folderIconType="folder_team",data.op_user=data.targetUserName,data.op_user_tab=data.targetUserName,data.event_desc=Mustache.render(_("{{targetUserName}} 被移除 “{{teamName}}” 团队管理员"),data)}return data},authShareTool:function(data){switch(parseInt(data.eventType)){case 4001:data.op_user=data.targetUserName,data.op_user_tab=data.targetUserName,data.event_desc=Mustache.render(_("{{targetUserName}} 获得了 “{{&path}}” 权限: {{&newPrivilege}}"),{targetUserName:data.targetUserName,path:this.getLastName(data.target[0].path),newPrivilege:data.newPrivilege});break;case 4002:data.op_user=Mustache.render("“{{targetUserName}}”",data),data.op_user_tab=Mustache.render("“{{targetUserName}}”",data);break;case 4003:data.event_desc=Mustache.render(_("所有人 获得了 {{&path}} 权限:{{&newPrivilege}}"),{path:this.getLastName(data.path),newPrivilege:data.newPrivilege});break;case 4004:data.op_user=data.targetUserName,data.op_user_tab=data.targetUserName,data.event_desc=Mustache.render(_("{{targetUserName}} 在 {{&path}} 的权限更改为 {{&newPrivilege}}"),{targetUserName:data.targetUserName,path:this.getLastName(data.path),newPrivilege:data.newPrivilege});break;case 4005:data.op_user=Mustache.render("“{{targetUserName}}”",data),data.op_user_tab=Mustache.render("“{{targetUserName}}”",data),data.event_desc=Mustache.render(_("“{{targetUserName}}”的权限由{{&oldPrivilege}} 更改为 {{&newPrivilege}}"),data);break;case 4006:data.event_desc=Mustache.render(_("所有用户 在  {{&path}} 的权限由{{&oldPrivilege}} 更改为{{&newPrivilege}}"),{path:this.getLastName(data.target[0].path),oldPrivilege:data.oldPrivilege,newPrivilege:data.newPrivilege});break;case 4007:data.folderIconType="folder_team",data.op_user=data.targetUserName,data.op_user_tab=data.targetUserName,data.event_desc=Mustache.render(_("{{targetUserName}}在 {{&path}} 的权限: {{&newPrivilege}} 被取消"),{targetUserName:data.targetUserName,path:this.getLastName(data.target[0].path),newPrivilege:data.newPrivilege});break;case 4008:data.folderIconType="folder_team",data.op_user=Mustache.render(_("“{{teamName}}”"),data),data.op_user_tab=Mustache.render(_("“{{teamName}}”"),data),data.event_desc=Mustache.render(_("“{{teamName}}”在 {{&path}} 的权限: {{&newPrivilege}} 被取消"),{teamName:data.teamName,path:data.target[0].path,newPrivilege:data.newPrivilege});break;case 4009:data.folderIconType="folder_team",data.event_desc=Mustache.render(_("所有用户 在 {{&path}} 的权限: {{&newPrivilege}} 被取消"),{path:this.getLastName(data.path),newPrivilege:data.newPrivilege});break;case 4010:data.op_user=data.targetUserName,data.op_user_tab=data.targetUserName,data.event_desc=Mustache.render(_("{{targetUserName}} 加入共享 {{&path}} 权限：{{&newPrivilege}}"),{path:this.getLastName(data.path),newPrivilege:data.newPrivilege,targetUserName:data.targetUserName});break;case 4011:data.folderIconType="folder_share",data.op_user=data.userName,data.event_desc=Mustache.render(_("取消对您的共享  {{&path}} 权限：{{&newPrivilege}}"),{path:this.getLastName(data.target[0].path),newPrivilege:data.newPrivilege});break;case 4012:data.op_user=data.targetUserName,data.op_user_tab=data.targetUserName,data.event_desc=Mustache.render(_("{{targetUserName}} 在 {{&path}}的权限由{{&oldPrivilege}} 改为  {{&newPrivilege}}"),{targetUserName:data.targetUserName,path:this.getLastName(data.path),oldPrivilege:data.oldPrivilege,newPrivilege:data.newPrivilege});break;case 4013:data.folderIconType="folder_share",data.op_user=data.userName,data.event_desc=Mustache.render(_("{{userName}} 退出 {{&path}} 的共享"),{userName:data.userName,path:this.getLastName(data.target[0].path)});break;case 4014:data.op_user=data.userName,data.event_desc=Mustache.render(_("移交 {{&path}} 的共享管理给{{targetUserName}}"),{path:this.getLastName(data.path),targetUserName:data.targetUserName});break;case 4015:data.folderIconType="folder_share",data.op_user=data.userName,data.event_desc=Mustache.render(_("取消 {{&path}} 的对外共享"),{path:this.getLastName(data.path)});break;case 4016:data.op_user=Mustache.render(_("“{{targetUserName}}”"),data),data.op_user_tab=Mustache.render(_("“{{targetUserName}}”"),data),data.event_desc=Mustache.render(_("“{{targetUserName}}”加入共享 {{&path}} 权限:{{&newPrivilege}}"),{targetUserName:data.targetUserName,path:this.getLastName(data.path),newPrivilege:data.newPrivilege});break;case 4017:data.event_desc=Mustache.render(_("所有用户 加入共享“{{&path}}” 权限:{{&newPrivilege}}"),{path:this.getLastName(data.path),newPrivilege:data.newPrivilege});break;case 4018:data.folderIconType="folder_share",data.op_user=data.userName,data.event_desc=Mustache.render(_("取消对“{{targetUserName}}”的共享 {{&path}} 权限：{{&newPrivilege}}"),{targetUserName:data.targetUserName,path:this.getLastName(data.path),newPrivilege:data.newPrivilege});break;case 4019:data.op_user=data.targetUserName,data.op_user_tab=Mustache.render(_("“{{targetUserName}}”"),data),data.event_desc=Mustache.render(_("{{targetUserName}} 在{{&path}} 的权限由{{&oldPrivilege}} 改为 {{&newPrivilege}}"),{targetUserName:data.targetUserName,path:this.getLastName(data.path),oldPrivilege:data.oldPrivilege,newPrivilege:data.newPrivilege});break;case 4020:data.op_user=data.userName,data.event_desc=Mustache.render(_("取消对 所有用户 的共享 “{{&path}}” 权限：{{&newPrivilege}}"),{path:this.getLastName(data.path),newPrivilege:data.newPrivilege});break;case 4021:data.event_desc=Mustache.render(_("所有用户 在“{{&path}}”的权限由“{{&oldPrivilege}}” 改为 “{{&newPrivilege}}”"),{path:this.getLastName(data.path),oldPrivilege:data.oldPrivilege,newPrivilege:data.newPrivilege});break;default:data.event_desc=data.eventType+"还没有建立模板"}return data},otherTool:function(data){switch(parseInt(data.eventType)){case 5001:data.op_user=data.userName,data.event_desc=Mustache.render(_("发布公告 “{{noticeTitle}}”"),data),data.event_notice={content:data.noticeContext};break;case 5002:data.op_user=data.userName,data.event_desc=Mustache.render(_("更新公告 “{{noticeTitle}}”"),data),data.event_notice={content:data.noticeContext};break;case 5003:case 5004:case 5005:case 5006:case 5007:case 5008:case 5009:case 5010:case 5011:case 5012:case 5013:break;default:data.event_desc=data.eventType+"还没有建立模板"}return data},linkTool:function(data){switch(parseInt(data.eventType)){case 6001:data.op_user=data.userName,data.event_delivery={filename:this.getLastName(data.target[0].path),url:this.createDelivery(data.deliveryCode)},data.event_desc=Mustache.render(_("为“{{filename}}”生成外链"),data.event_delivery);break;case 6002:data.op_user=data.userName,data.event_desc=Mustache.render(_("为“{{filename}}”取消外链"),{filename:this.getLastName(data.path)});break;case 6003:data.op_user=data.userName,data.event_desc=Mustache.render(_("为“{{filename}}”生成云附件"),{filename:this.getLastName(data.path)});break;case 6004:case 6005:case 6006:case 6007:break;case 6008:data.op_user=data.userName,data.event_desc=Mustache.render(_("为“{{filename}}”生成邮件附件"),{filename:this.getLastName(data.path)});break;case 6009:data.op_user=data.userName,data.event_desc=Mustache.render(_("为“{{filename}}”取消云附件"),{filename:this.getLastName(data.path)});break;case 6010:data.op_user=data.userName,data.event_desc=Mustache.render(_("为“{{filename}}”取消邮件附件"),{filename:this.getLastName(data.path)});break;default:data.event_desc=data.eventType+"还没有建立模板"}return data},createDelivery:function(code){return"/link/view/"+code},createFileList:function(target){var event_file=[];for(var i in target)if(target.hasOwnProperty(i)){var t=target[i].path.split(".");t=1==t.length?"":t.pop(),"true"==target[i].isFolder&&(t="folder"),event_file.push({type:Util.typeIcon(t),isFolder:"folder"==t?!0:!1,filename:target[i].path.split("/").pop(),neid:target[i].neid,path:target[i].path})}return event_file},createShowFileList:function(target){for(var param=[],i=0;2>i;i++)if(target.hasOwnProperty(i)){var dt=target[i].path.split("/").pop();param.push(dt)}return target.length>2&&param.push("..."),param},isTarget:function(eventType){return eventType>1e4},getLastName:function(path){return path?path.split("/").pop():""},getLongPath:function(path){var _path="",pathType=Util.getPathType();switch(pathType){case"ent":_path=_("企业空间")+path;break;case"self":_path=_("个人文件")+path;break;case"share_out":_path=_("我的共享")+path;break;case"share_in":_path=_("收到的共享")+path}return _path},specialDesc:function(data){return data.event_desc=data.title,data.op_user_tab?data.op_user_tab+=" ":data.op_user_tab="",data},resolveAuth:function(data){data.oldPrivilege=AuthModel.getAuthTitle(data.oldPrivilege),data.newPrivilege=AuthModel.getAuthTitle(data.newPrivilege)}},module.exports=new eventTemplateTool}),define("component/expireDialog",function(require,exports){function ExpireDialog(){function GetDateDiff(startDate,endDate){var startTime=new Date(startDate.getFullYear(),startDate.getMonth(),startDate.getDate()).getTime(),endTime=new Date(Date.parse(endDate.substring(0,10).replace(/-/g,"/"))).getTime(),dates=Math.abs(startTime-endTime)/864e5;return dates}function setPos(){uiDialog.css({bottom:"0px",right:"0px"}),setTimeout(function(){self.dialog.fadeOut(1e3)},5e3)}var uiDialog=$('<div class="lui-dialog expire-dialog"></div>'),oper=$('<span class="oper"><a class="expire-close"></a></span>'),content=$('<div class="content-wraper expire-wraper"></div>');this.dialog=uiDialog;var account_info=window.LenovoData.user.account_info,expire_daynum=GetDateDiff(new Date,account_info.etime);if(!(expire_daynum&&expire_daynum>5)){var template='<a target="_blank" href="/upgrade.html"><span>'+_("<i>◆升级</i>为正式版<br/><i>◆享受</i>专属企业服务<br/><i>◆</i>咨询热线：400-898-7968")+"</span></a>";content.append(template),uiDialog.append(content),uiDialog.append(oper),uiDialog.appendTo($("body")).fadeIn(1e3);var self=this;$("body").on("keydown",function(e){27==e.keyCode&&self.close()}),setPos();var self=this;oper.find(".expire-close").on("click",function(){self.close()})}}var $=require("jquery"),EventTarget=(require("i18n"),require("eventTarget")),_=$.i18n.prop;return window.uuid||(window.uuid={},window.uuid["z-index"]=50),$.extend(ExpireDialog.prototype,EventTarget,{close:function(){var self=this;self.dialog.remove(),$("body").off("keydown")}}),ExpireDialog}),define("component/fileAttrDetail",function(require,exports,module){function FileAttrDetail(context,ok_callback){this.context=context,this.ok_callback=ok_callback,this._init()}var $=require("jquery"),Util=require("util"),AuthModel=require("model/AuthManager"),Dialog=require("component/dialog");require("i18n");var _=$.i18n.prop;require("mustache");var fileAttrTemplate="<div><p><span>"+_("名　　称")+"：</span><span>{{filename}}</span></p><p><span>"+_("路　　径")+"：</span><span>{{path}}</span></p><p><span>"+_("大　　小")+"：</span><span>{{size}}</span></p><p><span>"+_("上传者")+"：</span><span>{{user}}</span></p><p><span>"+_("更新时间")+'：</span><span>{{modified}}</span></p><div class="remarkEdit">'+_("备　　注")+'：<span class="remark" title="{{desc}}">{{desc}}</span><a class="remark-edit" href="javascript:void(0)">'+_("编辑")+"</a></div></div>",dirAttrTemplate="<div><p><span>"+_("类　　型")+"：</span><span>{{category}}</span></p><p><span>"+_("权　　限")+"：</span><span>{{action}}</span></p><p><span>"+_("创  建  者")+"：</span><span>{{user}}</span></p><p><span>"+_("大　　小")+"：</span><span>{{size}}</span></p><p><span>"+_("包　　含")+"：</span><span>{{include}}</span></p><p><span>"+_("更新时间")+'：</span><span>{{modified}}</span></p><div class="remarkEdit">'+_("备　　注")+'：<span class="remark" title="{{desc}}">{{desc}}</span><a class="remark-edit" href="javascript:void(0)">'+_("编辑")+"</a></div></div>";return $.extend(FileAttrDetail.prototype,{_init:function(){var self=this,output=null,title=null,fileAttr={},data=self.context.data,infoBox=$(".infoAuth");if(data.path){var index=data.path.lastIndexOf("/");fileAttr.filename=data.path.substr(index+1)}fileAttr.path=Util.getRootDisplayName()+data.path,fileAttr.size=data.size,fileAttr.version=data.version,fileAttr.user=data.creator,fileAttr.modified=data.datetime,fileAttr.desc=data.desc,fileAttr.action=data.action,fileAttr.category=data.isShare&&data.team?_("团队文件夹")+"("+AuthModel.getAuthTitle(data.action)+")":data.isShare?_("共享文件夹")+"("+AuthModel.getAuthTitle(data.action)+")":_("普通文件夹"),data.isfolder?(fileAttr.include=_("{0}个文件，{1}个文件夹",data.fileNum,data.dirNum),output=Mustache.render(dirAttrTemplate,fileAttr),title=_("文件夹属性")):(output=Mustache.render(fileAttrTemplate,fileAttr),title=_("文件属性")),infoBox.append(output);var reEdit=$(".infoAuth").find(".remark-edit");reEdit.on("click",function(){self.remarkEdit("reEdit",fileAttr.desc)})},remarkEdit:function(context,param){var editDialog=new Dialog(_("备注编辑"),function(parent){parent.append("<div style='background:#FFFFFF;'><textarea style='margin:10px;padding:5px;width:368px;height:150px;resize:none;' placeholder='"+_("最多可输入50个汉字或100个字符")+"' maxlength=100></textarea></div><div class='dialog-button-area'><a class='dialog-button confirm-ok'>"+_("确定")+"</a><a class='dialog-button confirm-cancel'>"+_("取消")+"</a></div>"),param.desc?$("textarea",parent).val(param.desc):$("textarea").placeholder(),parent.find(".confirm-ok").on("click",function(){var desc=$.trim($("textarea").val());return desc&&desc==param.desc||!desc&&!param.desc?void editDialog.close():Util.getBytes(desc)>100?void Tips.warn(_("最多可输入50个汉字或100个字符")):void FileModel.info_set(function(result){200==result.code?(editDialog.close(),param.desc=desc,context.fa.render(param.isfolder?"folder":"file",param),Tips.show(_("备注设置成功"))):(editDialog.close(),Tips.warn(result.data.message))},param.path,desc,"desc")}),parent.find(".confirm-cancel").on("click",function(){editDialog.close()})})}}),FileAttrDetail}),define("component/fileManager/fileAttribute",function(require,exports){function FileAttribute(node,path_type,path){this.node="string"==$.type(node)?$(node):node,this.path_type=path_type||"",this.path=path||"",this.render()}var $=require("jquery"),EventTarget=require("eventTarget"),UserModel=require("model/UserManager"),AccountModel=require("model/AccountManager"),AuthModel=(require("component/scroll"),require("model/AuthManager")),ShareMemberDialog=(require("component/tips"),require("component/shareMemberDialog")),Dynamic=require("component/dynamic"),Util=require("util");require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(FileAttribute.prototype,EventTarget,{render:function(type,data,selfData){function computeSize(da){for(var tot=0,i=0,ii=data.length;ii>i;i++){var sizeStr=data[i].size;tot+=parseInt(sizeStr)}return Util.formatBytes(tot)}var self=this,headerAuth=$(".filelist-header-auth");self.node.empty(),self.data=data,type||"share_in"!=self.path_type&&"share_out"!=self.path_type||""!=self.path||(type="shared");var template,temp,templateDetail,tempDetail;switch(type){case"folder":tempDetail=$("#template_folderAttribute_detail").html(),temp=$("#template_folderAttribute").html();break;case"file":tempDetail=$("#template_fileAttribute_detail").html(),temp=$("#template_fileAttribute").html();break;case"folderdelete":tempDetail=$("#template_folderAttribute_deleteDetail").html(),temp=$("#template_folderAttribute_delete").html();break;case"filedelete":tempDetail=$("#template_fileAttribute_filedelete").html(),temp=$("#template_folderAttribute_delete").html();break;case"shared":var obj={};obj.countAll=data?data.length:0,data&&""!=data.path&&selfData&&"share_in"!=selfData.type&&"share_out"!=selfData.type?(tempDetail=$("#template_folderAttribute_detail").html(),tempDetail=Mustache.render(tempDetail,data)):(tempDetail=$("#template_fileAttribute_shared").html(),obj.countAll<2&&(tempDetail=tempDetail.replace(/<p>(.)+<\/p>/,"<p>"+_("共有{0}个共享文件夹",obj.countAll)+"</p>")),tempDetail=Mustache.render(tempDetail,obj));break;case"multi":var curData,parentData;selfData?(curData=selfData.currentData,parentData=selfData.parentData,tempDetail=$("#template_folderAttribute_detail").html()):templateDetail=$("#template_fileAttribute_init").html(),
temp=$("#template_fileAttribute_multi").html();var obj={},actionObj={},allStatus={hasDeleted:!1,hasNoDeleted:!1};obj.count=data.length;for(var i=0,ii=data.length;ii>i;i++){var action=data[i].action;actionObj[action]=action,data[i].isdelete?allStatus.hasDeleted=!0:allStatus.hasNoDeleted=!0}obj.size=computeSize(curData),obj.cssAction=AuthModel.getContextAction(actionObj),allStatus.hasDeleted&&allStatus.hasNoDeleted&&(obj.cssAction=AuthModel.ACTION.LIST),template=Mustache.render(temp,obj),tempDetail=Mustache.render(tempDetail,parentData);break;case"multi-filedelete":if(temp=$("#template_fileAttribute_multifiledelete").html(),data){var obj={count:data.length,size:computeSize(data),cssAction:AuthModel.ACTION.DELETE};template=Mustache.render(temp,obj)}break;case"multi-folderdelete":if(temp=$("#template_fileAttribute_multifolderdelete").html(),data){var obj={count:data.length,size:computeSize(data),cssAction:AuthModel.ACTION.DELETE};template=Mustache.render(temp,obj)}break;case"multi-delete":var curData,parentData;if(data.path?(curData=data.currentData,parentData=data.parentData,tempDetail=$("#template_folderAttribute_detail").html()):(curData=data,templateDetail=$("#template_fileAttribute_init").html()),temp=$("#template_fileAttribute_multifiledelete").html(),data){var obj={count:data.length,size:computeSize(data),cssAction:AuthModel.ACTION.DELETE};template=Mustache.render(temp,obj),tempDetail=Mustache.render(tempDetail,parentData)}break;default:type&&"init"!=type||""!=self.path||(templateDetail=$("#template_fileAttribute_init").html(),headerAuth.hide(),data&&(data.cssAction=AuthModel.ACTION.DELETE))}template||(template=Mustache.render(temp,data)),templateDetail||(templateDetail=Mustache.render(tempDetail,data)),headerAuth.html(""),headerAuth.append(template),self.node.append(templateDetail),"[object Array]"!=Object.prototype.toString.call(data)&&data&&data.hasOwnProperty("path")&&new Dynamic("#file-attr-wraper",self.data.path_type,self.data.path,self.data.neid,self.data.prefix_neid,self.data.from);var dynamicTab=$(".conright").find(".infoTab .infoTabHead span.infoTabDynamic");if(dynamicTab.hasClass("active")?$(".show-dynamic-button").addClass("dynamicShow"):$(".show-dynamic-button").removeClass("dynamicShow"),"init"==type||void 0==type||"multi"==type||"multi-delete"==type){var _updateQuota=function(used,quota){$(".space-bar").eq(0).html('<span style="width:'+used/quota*200+'px"></span>');var quota=Util.formatBytes(quota),used=Util.formatBytes(used);$("#space-used").html(used),$("#space-quota").html(quota)};Util.isAdmin()?AccountModel.quota_get(function(ret){var quota=ret.data.space.limit,used=ret.data.space.used;_updateQuota(used,quota)}):UserModel.quota(function(space){var quota=space.quota,used=space.used;_updateQuota(used,quota)})}var auth=headerAuth.find(".auth");if(self.data&&Util.haveDirAuth(self.data)?auth&&auth.css("display","inline-block"):auth&&auth.css("display","none"),self.data&&self.data.isfolder&&("upload:delivery"==self.data.action||"download:delivery"==self.data.action||"upload:download:delivery"==self.data.action)&&$(".action-upload-delivery .link").css("display","inline-block"),self.data&&self.data.creator_uid?(self.data&&(self.data.creator_uid==Util.getUserID()||Util.isAdmin())&&$(".fileAttribute").find(".remark-edit").show(),self.data&&(self.data.creator_uid==Util.getUserID()||Util.isAdmin())&&self.data.isfolder&&!self.data.team?$(".fileAttribute").find(".cleanup").css("display","inline-block"):$(".fileAttribute").find(".cleanup").hide()):(self.data&&(self.data.creator==Util.getUserName()||Util.isAdmin())&&$(".fileAttribute").find(".remark-edit").show(),self.data&&(self.data.creator==Util.getUserName()||Util.isAdmin())&&self.data.isfolder&&!self.data.team?$(".fileAttribute").find(".cleanup").css("display","inline-block"):$(".fileAttribute").find(".cleanup").hide()),self.data&&self.data.isShare){var members,entrys=[{neid:self.data.neid}];AuthModel.list_by_batch_resource(function(ret){200==ret.code&&(members=ret.data,self.node.find(".file-share-user .user-num").html(members.length>99?"99+":members.length))},JSON.stringify(entrys),"ent"==this.path_type?0:1),self.node.find(".file-share-user").on("click",function(e){if(0!=$("body").find(".lui-hover-dialog").length)$("body").find(".lui-hover-dialog").remove();else{Util.sendDirectlyRequest("主页面","点击右侧栏成员数","-");{new ShareMemberDialog(self.node.find(".file-share-user"),{data:members})}}})}var preview=headerAuth.find(".preview"),link=headerAuth.find(".link"),_delete=headerAuth.find(".delete"),rename=headerAuth.find(".rename"),cleanup=headerAuth.find(".cleanup"),download=headerAuth.find(".download"),copy=headerAuth.find(".copy"),history=headerAuth.find(".history"),recovery=headerAuth.find(".undo"),purge=headerAuth.find(".purge"),auth=headerAuth.find(".auth"),transfer=headerAuth.find(".transfer"),attribute=headerAuth.find(".attribute"),cancelauth=headerAuth.find(".cancelauth"),remarkEdit=self.node.find(".remark-edit"),attribute=self.node.find(".attribute"),rmShare=headerAuth.find(".rmShare"),exitShare=headerAuth.find(".exitshare"),lock=headerAuth.find(".lock"),unlock=headerAuth.find(".unlock"),reqUnlock=headerAuth.find(".reqUnlock");preview&&preview.on("click",function(){self.fire("preview",self.data)}),link&&link.on("click",function(){self.fire("share",self.data)}),_delete&&_delete.on("click",function(){self.fire("remove",self.data)}),copy&&copy.on("click",function(){self.fire("copymove",self.data)}),rename&&rename.on("click",function(){self.fire("rename",self.data)}),cleanup&&cleanup.on("click",function(){self.fire("cleanup",self.data)}),history&&history.on("click",function(){self.fire("history",self.data)}),recovery&&recovery.on("click",function(){self.fire("recover",self.data)}),purge&&purge.on("click",function(){self.fire("purge",self.data)}),download&&download.on("click",function(){self.fire("download",self.data)}),auth&&auth.on("click",function(){self.fire("auth",self.data)}),transfer&&transfer.on("click",function(){self.fire("transfer",self.data)}),cancelauth&&cancelauth.on("click",function(){self.fire("cancelauth",self.data)}),rmShare&&rmShare.on("click",function(){self.fire("rmShare",self.data)}),exitShare&&exitShare.on("click",function(){self.fire("exitshare",self.data)}),remarkEdit&&remarkEdit.on("click",function(){self.fire("remarkEdit",self.data)}),lock&&lock.on("click",function(){self.fire("lock",self.data)}),unlock&&unlock.on("click",function(){self.fire("unlock",self.data)}),reqUnlock&&reqUnlock.on("click",function(){self.fire("reqUnlock",self.data)}),attribute&&attribute.on("click",function(){var onOff=!0;self.fire("attribute",self.data,onOff)})}}),FileAttribute}),define("component/fileManager/fileList",function(require,exports){function FileList(node,file_template,filedelete_template,folder_template,folderdelete_template,empty_template,cssAction,type,from,prefix_neid){this.node="string"==$.type(node)?$(node):node,this.file_template=file_template,this.filedelete_template=filedelete_template,this.folder_template=folder_template,this.folderdelete_template=folderdelete_template,this.empty_template=empty_template,this.totalSize=0,this.pageSize=50,this.pages=1,this.lastSize=0,this.orderby=FileModel.ORDERBY.MTIME,this.includeDeleted="false",this.sort=FileModel.SORT.ASC,this.cssAction=cssAction,this.type=type,this.from=from,this.newFloder=[],this.prefix_neid=prefix_neid,this._init()}var $=jquery=require("jquery"),EventTarget=require("eventTarget"),FileModel=require("model/FileManager.js"),AuthModel=require("model/AuthManager"),Util=require("util"),Scroll=require("component/scroll");require("i18n"),require("cookie");var _=$.i18n.prop;return require("mustache"),FileList.view_model="list",$.extend(FileList.prototype,EventTarget,{_requestData:function(path,offset,limit,func,error,from,prefix_neid){var self=this,path_type=self.type,filter={path_type:path_type,include_deleted:self.includeDeleted,offset:offset,limit:limit,orderby:self.orderby,sort:self.sort};"share_in"==path_type&&from&&(filter.from=from),("share_in"==path_type||"share_out"==path_type)&&self.prefix_neid&&(filter.prefix_neid=self.prefix_neid),FileModel.metadata(function(result){if(200==result.code){var data=result.data,datas=[];self.totalSize=data.total_size,self.authable=data.authable;for(var i=0,ii=data.content.length;ii>i;i++){var item=data.content[i],d=self._adapt(item);datas.push(d)}""!=path&&(file=Util.resolvePath(data.path,data.is_dir),self.parentData=self._adapt(data)),func&&func(datas)}else error&&error()},"/"+path,filter)},_adapt:function(item){var file=Util.resolvePath(item.path,item.is_dir),typeIcon=file.type;item.is_dir&&(typeIcon=item.is_shared&&item.is_team?"folder_team":item.is_shared?"folder_share":"folder");var d={};return d.isfolder=item.is_dir,d.isdelete=item.is_deleted,d.isShare=item.is_shared,d.thumbExist=item.thumb_exist,d.isTeam=item.is_team,d.type=typeIcon,d.typeIcon=Util.typeIcon(typeIcon),d.name=file.name,d.filename=file.name,d.size=Util.formatBytes(item.bytes),d.datetime=Util.formatDate(item.modified,_("yyyy-MM-dd")+" hh:mm"),d.path=item.path,d.path_type=item.path_type,d.creator=item.creator,d.updator=item.updator,d.creator_uid=item.creator_uid,d.neid=item.neid,d.prefix_neid=item.prefix_neid,d.from=item.from,d.hash=item.hash,d.action=Util.resolveFileAction(item.access_mode),d.languageAction=AuthModel.getAuthTitle(d.action),d.authable=item.authable,d.cssAction=Util.resolveFileAction(item.access_mode).replace(/:/g,"-"),d.hasDelivery=item.delivery_code?!0:!1,d.islocked=item.lock_uid?!0:!1,d.unlockAdmin=item.lock_uid==Util.getUserID()||Util.isAdmin(),d.deliveryTitle=_(d.hasDelivery?"查看外链":"外链分享"),d.deliveryCode=item.delivery_code,d.mimeType=item.mime_type,d.desc=item.desc,d.share_to_personal=item.share_to_personal,d.isshared=item.is_shared&&"/folder/self"==location.pathname,d.owner=item.from_name,d.isImage=/image/.test(item.mime_type),d.category=_(item.is_shared?item.is_team?"团队文件夹":"共享文件夹":"普通文件夹"),d.isfolder||(d.rev=item.rev,d.version=item.rev_index>999?"999+":item.rev_index),d},_renderList:function(){var self=this;self._requestData(self.path,0,self.pages*self.pageSize,function(datas){self.render(datas)},function(){},self.from,self.prefix_neid)},_init:function(){var self=this;$.cookie("orderby")&&(self.orderby=$.cookie("orderby")),$.cookie("sort")&&(self.sort=$.cookie("sort"));var filelist=$('<div class="lui-filelist"></div>'),header_template=$("#template_filelist_listheader").html(),list_wraper=$('<div class="list-wraper list-view"></div>'),h=self.node.height()-self.node.find(".filelist-header").outerHeight();filelist.append(header_template),filelist.append(list_wraper),self.node.append(filelist),this.filelist=filelist,this.mode=FileList.view_model,list_wraper.height(h),self._initContextMenu(),self._initDisplayModel(filelist),self._initSearchModel(),self.paging=!1,$("#item-selectAll").unbind("click").on("click",function(e){$(this).prop("checked")?$(".filelist-item").addClass("item-selected"):$(".filelist-item").removeClass("item-selected"),$(".item-checkbox").prop("checked",$(this).prop("checked")),Util.sendDirectlyRequest("主页面",'"文件名"前的全选按钮',"-"),self._select()});var sm=$(".filelist-header");switch(self.orderby){case"mtime":sm.find(".updateData i").addClass("icon "+self.orderby+self.sort);break;case"name":sm.find(".updateUser i").addClass("icon "+self.orderby+self.sort);break;case"size":sm.find(".updateSize i").addClass("icon "+self.orderby+self.sort);break;case"updator":sm.find(".updateUser i").addClass("icon "+self.orderby+self.sort)}sm.on("click",function(e){function doNext(){self.sort="asc"==self.sort?"desc":"asc",$(".filelist-header").find("span i").removeClass(),tar.find("i").addClass("icon "+clas+self.sort),Util.sendDirectlyRequest("文件列表","排序",FileModel.ORDERNAME[clas]+""+("desc"==self.sort?"降序":"升序")),self.doSort(clas,self.sort)}var clas,tar=$(e.target);tar.hasClass("icon")&&(tar=tar.parent()),tar.hasClass("updateTitle")?(clas="name",doNext()):tar.hasClass("updateSize")?(clas="size",doNext()):tar.hasClass("updateData")?(clas="mtime",doNext()):tar.hasClass("updateUser")&&(clas="updator",doNext(self,clas))}),self._bindListItemEvent(list_wraper)},_initContextMenu:function(){var self=this,contextMunu_folder=$("#template_contextMenu_folder").html(),contextMunu_file=$("#template_contextMenu_file").html(),contextMunu_fileDelete=$("#template_contextMenu_filedelete").html(),contextMunu_folderDelete=$("#template_contextMenu_folderdelete").html(),contextMunu_multi=$("#template_contextMenu_multi").html(),contextMunu_multiDelete=$("#template_contextMenu_multidelete").html();self.node.append(contextMunu_folder),self.node.append(contextMunu_file),self.node.append(contextMunu_fileDelete),self.node.append(contextMunu_folderDelete),self.node.append(contextMunu_multi),self.node.append(contextMunu_multiDelete),$("#fileManagerWraper").off("click"),$("#fileManagerWraper").on("click",function(e){var tar=e.target;if($(tar).hasClass("menu-item")){var clas=tar.id;$("body").data("action","右键菜单").data("content",1==$.isArray(self.currentData)?"-":self.currentData.isfolder?"文件夹":"文件"),self.fire(clas,self.currentData),e.preventDefault(),e.stopPropagation()}}),$("#folderContextMenu,#fileContextMenu,#fileDeleteContextMenu,#folderDeleteContextMenu,#multiContextMenu,#multiDeleteContextMenu").on("mouseleave",function(e){$(this).hide()}).on("click",function(e){$(this).hide()})},_initDisplayModel:function(filelist){function fnList(){var wraper=$(".list-wraper",filelist),lview=$(".oper .list-view"),iview=$(".oper .icon-view"),lview=$(".oper .list-view"),iview=$(".oper .icon-view");lview.addClass("list-view-on"),iview.removeClass("icon-view-on"),wraper.removeClass("icon-view"),wraper.addClass("list-view"),$(".select-all label").show(),$(".filelist-header").addClass("list-header"),$(".updateUser").addClass("updateShow"),$(".updateData").addClass("updateShow"),$(".updateSize").addClass("updateShow"),FileList.view_model=self.mode="list",wraper.find(".filelist-item").removeClass("thumb-nail"),self.scroll&&self.scroll.render()}function fnicon(){var wraper=$(".list-wraper",filelist),lview=$(".oper .list-view"),iview=$(".oper .icon-view");lview.removeClass("list-view-on"),iview.addClass("icon-view-on"),wraper.removeClass("list-view"),wraper.addClass("icon-view"),FileList.view_model=self.mode="icon",self.data&&self._generateThumbs(function(flag,index,url){if(flag){var parentFileItem=wraper.find(".filelist-item");$(parentFileItem).eq(index).addClass("thumb-nail")}}),self.scroll&&self.scroll.render(),$(".select-all label").hide(),$(".updateUser").removeClass("updateShow"),$(".updateData").removeClass("updateShow"),$(".updateSize").removeClass("updateShow")}var self=this;$("#fileManagerHeader").delegate(".oper .list-view","click",function(){Util.sendDirectlyRequest("主页面","列表显示方式选择","-"),fnList()}),$("#fileManagerHeader").delegate(".oper .icon-view","click",function(){Util.sendDirectlyRequest("主页面","图标显示方式选择","-"),fnicon()}),"list"==self.mode?fnList():fnicon()},_generateThumbs:function(callback){for(var self=this,data=self.data,i=0;i<data.length;i++){var cur=data[i];cur.thumbExist&&!cur.isdelete&&("edit"==cur.cssAction||"preview"==cur.cssAction)&&!function(param,index){var imgUrl=FileModel.thumbnails(Util.getStorageUrl(),param.path,param.path_type,param.from,param.neid,130,70,param.hash,param.rev),image=new Image;if(image.src=imgUrl,image.complete)callback(!0,index,imgUrl);else try{image.onload=function(){callback(!0,index,imgUrl)},image.onerror=function(){callback(!1,index)}}catch(e){callback(!1,index)}}(cur,i)}},_bindListItemEvent:function(list_wraper){var self=this,val=",",ibe=-1;list_wraper.delegate(".filelist-item","mousedown",function(e){var cbx,flag,cmd,ctar=$(e.currentTarget),tar=$(e.target),da=self.data[ctar.attr("index")],isf=ctar.attr("isfolder"),event=($(".filelist-header-auth"),e||window.e);if(2==e.button){var px=e.pageX,py=e.pageY;if("[object Array]"==Object.prototype.toString.call(self.currentData)&&self.currentData.length>1){for(var cssAction,action,actionObj={},allStatus={hasDeleted:!1,hasNoDeleted:!1},i=0,len=self.currentData.length;len>i;i++)self.currentData[i].isdelete?allStatus.hasDeleted=!0:allStatus.hasNoDeleted=!0,action=self.currentData[i].action,actionObj[action]=action;if(cssAction=AuthModel.getContextAction(actionObj),allStatus.hasDeleted&&allStatus.hasNoDeleted)return;if(cssAction==AuthModel.ACTION.LIST)return;var menu;menu=$(allStatus.hasDeleted?"#multiDeleteContextMenu":"#multiContextMenu"),menu.show(),menu.removeClass(),menu.addClass("pop-menu action-"+cssAction);var top=py;return top+menu.outerHeight()>$(window).height()&&(top-=menu.height()),menu.css({left:px-5,top:top}),e.preventDefault(),void e.stopPropagation()}var menu;"true"==isf?da.isdelete?menu=$("#folderDeleteContextMenu"):(menu=$("#folderContextMenu"),da.isshared?menu.find("#auth").html(_("共享管理")):"/folder/self"==location.pathname&&menu.find("#auth").html(_("共享"))):da.isdelete?(menu=$("#fileDeleteContextMenu"),"no-version"==da.hasMoreVersion&&menu.find("#history").hide()):menu=$("#fileContextMenu"),menu.removeClass(),menu.addClass("pop-menu action-"+da.cssAction);var top=py;top+menu.outerHeight()>$(window).height()&&(top-=menu.height()),menu.css({left:px-5,top:top}),menu.show(),cbx=ctar.find(".item-checkbox"),flag=2,cmd="",e.preventDefault(),e.stopPropagation(),$(document).bind("contextmenu",function(){return!1})}else if($("body").data("action","文件列表按钮"),tar.hasClass("item-checkbox"))cbx=tar,flag=1,cmd="";else if(tar.hasClass("file-select"))cbx=tar.find("input:checkbox"),flag=4,cmd="";else if(tar.hasClass("i-preview"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="preview";else if(tar.hasClass("i-undo"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="recover";else if(tar.hasClass("copy"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="copymove";else if(tar.hasClass("i-auth"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="auth";else if(tar.hasClass("cleanup"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="cleanup";else if(tar.hasClass("i-delete"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="remove";else if(tar.hasClass("i-purge"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="purge";else if(tar.hasClass("rename"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="rename";else if(tar.hasClass("transfer"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="transfer";else if(tar.hasClass("i-exitshare"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="exitshare";else if(tar.hasClass("cancelauth"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="cancelauth";else if(tar.hasClass("history"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="history";else if(tar.hasClass("rmShare"))cbx=ctar.find(".rmShare"),flag=2,cmd="rmShare";else if(tar.hasClass("i-sendlink"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="share";else if(tar.hasClass("lock"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="lock";else if(tar.hasClass("unlock"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="unlock";else if(tar.hasClass("reqUnlock"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="reqUnlock";else if(tar.hasClass("sure")||tar.hasClass("cancel"))cbx=ctar.find(".item-checkbox"),flag=2,e.preventDefault(),e.stopPropagation();else{if(tar.hasClass("rename-input"))return cbx=ctar.find(".item-checkbox"),flag=2,!0;if(tar.hasClass("i-more"))cbx=ctar.find(".item-checkbox");else if(tar.hasClass("i-download"))cbx=ctar.find(".item-checkbox"),flag=2,cmd="download";else if(tar.hasClass("icon")||tar.hasClass("display-name")||tar.parent().hasClass("display-name")&&0!=tar.parent().find("b").length){cbx=ctar.find(".item-checkbox");var isf=ctar.attr("isfolder");if(flag=2,"true"==isf)return $(".uploadButton").show(),$("body").data("action","点击名称链接"),void self.fire("folderClick",da);cmd="download",$("body").data("action","点击文件名称")}else tar.hasClass("history")?self.fire("history",da):(cbx=ctar.find(".item-checkbox"),flag=3,cmd="")}$("#search-input").blur();var cbox=cbx.get(0),i=ctar.attr("index");if($(window).keydown(function(e){e.shiftKey&&(key=!0)}).keyup(function(){key=!1}),1==flag)cbox.checked?ctar.removeClass("item-selected"):ctar.addClass("item-selected");else if(4==flag)cbox.checked?(cbox.checked=!1,ctar.removeClass("item-selected")):(cbox.checked=!0,ctar.addClass("item-selected"));else if(2==flag)cbox.checked||($(".item-checkbox",self.filelist).each(function(idx,itm){itm.checked=!1}),$(".filelist-item",self.filelist).removeClass("item-selected"),ctar.addClass("item-selected"),cbox.checked=!0);else if(cbox)if(event.ctrlKey)1==cbox.checked?(cbox.checked=!1,ctar.removeClass("item-selected")):(ctar.addClass("item-selected"),cbox.checked=!0);else if(event.shiftKey)if(-1!=ibe){$(".item-checkbox",self.filelist).each(function(idx,itm){itm.checked=!1}),ctar.siblings().removeClass("item-selected"),val=",";for(var ii=Math.min(i,ibe);ii<=Math.max(i,ibe);ii++)val+=ii+",",$(".filelist-item").eq(ii).addClass("item-selected"),$(".filelist-item").eq(ii).find(".item-checkbox").get(0).checked=!0}else-1!=val.indexOf(","+i+",")?(val=val.replace(","+i+",",","),cbox.checked=!1,ctar.removeClass("item-selected")):($(".item-checkbox",self.filelist).each(function(idx,itm){itm.checked=!1}),$(".filelist-item",self.filelist).removeClass("item-selected"),ctar.addClass("item-selected"),cbox.checked=!0,val+=i+",",ibe=i);else cbox.checked?(ctar.removeClass("item-selected"),cbox.checked=!1):($(".item-checkbox",self.filelist).each(function(idx,itm){itm.checked=!1}),$(".filelist-item",self.filelist).removeClass("item-selected"),ctar.addClass("item-selected"),cbox.checked=!0,val+=i+",",ibe=i);var itemBox=$(".scl-content").find(".filelist-item"),itemCheckbox=$(".scl-content").find(".item-checkbox"),cur=$(".scl-content").find(".item-selected").attr("index");switch($(document).keydown(function(event){if(0==$(".lui-dialog").length&&0==$("#fileManagerWraper").find(".new-item").length&&0==$("#fileManagerWraper").find(".edit-name").length)if(event=event||window.event,38==event.keyCode)cur>0&&($(".filelist-item",self.filelist).removeClass("item-selected"),itemBox.eq(cur).prev().addClass("item-selected"),$(".item-checkbox",self.filelist).each(function(idx,itm){itm.checked=!1}),cur--,itemCheckbox.eq(cur).get(0).checked=!0);else if(40==event.keyCode)cur<itemBox.length-1&&($(".filelist-item",self.filelist).removeClass("item-selected"),itemBox.eq(cur).next().addClass("item-selected"),$(".item-checkbox",self.filelist).each(function(idx,itm){itm.checked=!1}),cur++,itemCheckbox.eq(cur).get(0).checked=!0);else if(13==event.keyCode){var ctar=itemBox.eq(cur),isf=ctar.attr("isfolder"),isFocus=$("#search-input").is(":focus");if("true"==isf&&!isFocus){var da=self.data[ctar.attr("index")];$("body").data("action","文件列表回车"),self.fire("folderClick",da)}event.preventDefault(),event.stopPropagation()}}),2==e.button?self._select():(self.timer&&clearTimeout(self.timer),self.timer=setTimeout(function(){self._select()},500)),$(".delivery-false").remove(),cmd){case"preview":self.fire("preview",da,self.data);break;case"recover":self.fire("recover",da,self.data);break;case"purge":self.fire("purge",da,self.data);break;case"history":self.fire("history",da);break;case"copymove":self.fire("copymove",da);break;case"auth":self.fire("auth",da);break;case"cleanup":self.fire("cleanup",da);break;case"remove":self.fire("remove",da);break;case"rename":self.fire("rename",da);break;case"transfer":self.fire("transfer",da);break;case"attribute":self.fire("attribute",da);break;case"share":self.fire("share",da);break;case"rmShare":self.fire("rmShare",da);break;case"exitshare":self.fire("exitshare",da);break;case"cancelauth":self.fire("cancelauth",da);break;case"lock":self.fire("lock",da);break;case"unlock":self.fire("unlock",da);break;case"reqUnlock":self.fire("reqUnlock",da);break;case"download":var action=self.currentData.action;action&&"preview"==action||"upload:delivery"==action||"upload"==action||self.fire("download",da)}var fileTimer,fileHead=$(".filelist-header-auth");fileHead.delegate(".fileMore","mouseenter",function(e){var ctar=$(e.currentTarget);ctar.siblings("ul").stop(!0,!0).slideDown()}),fileHead.delegate(".fileMore","mouseleave",function(e){var ctar=$(e.currentTarget);fileTimer=setTimeout(function(){ctar.siblings("ul").stop(!0,!0).slideUp()},100)}),fileHead.delegate("ul","mouseenter",function(e){clearTimeout(fileTimer)}),fileHead.delegate("ul","mouseleave",function(e){var ctar=$(e.currentTarget);ctar.stop(!0,!0).slideUp()}),2!=e.button&&(self.onBeforeSelect(event),$(document).bind("mousemove",function(e){var event=e||window.e;"checkbox"!=$(e.target).attr("type")&&(self.onSelect(event),self.clearEventBubble(e))}),$(document).bind("mouseup",function(){self.ondragEnd()}),$(document).bind("mouseleave",function(){$(document).unbind("mousemove"),$(document).unbind("mouseup")}),$("#fileManagerWraper").bind("mouseleave",function(e){0!=$(self.selectDiv).length&&($(self.selectDiv).remove(),self.ondragEnd())})),e.preventDefault(),e.stopPropagation()}),$("#fileManagerWraper").bind("mousedown",function(e){var event=e||window.e;2!=e.button&&(self.onBeforeSelect(event),$(document).bind("mousemove",function(e){var event=e||window.e;"checkbox"!=$(e.target).attr("type")&&(self.onSelect(event),self.clearEventBubble(e))}),$(document).bind("mouseup",function(){self.ondragEnd()}),self.clearEventBubble(e))}),list_wraper.delegate("input[type=text]","mousedown",function(e){e.stopPropagation()}),list_wraper.delegate("","mousedown",function(e){e.stopPropagation()}),list_wraper.delegate(".sure","mousedown",function(e){e.stopPropagation()}),list_wraper.delegate(".cancel","mousedown",function(e){e.stopPropagation()}),$("#fileManagerWraper").delegate(".pop-menu li","mousedown",function(e){e.stopPropagation()}),$("#fileManagerWraper").delegate(".filelist-header-auth span","mousedown",function(e){e.stopPropagation()}),list_wraper.delegate(".filelist-item","dblclick",function(e){var ctar=$(e.currentTarget),isf=ctar.attr("isfolder");if(clearTimeout(self.timer),"true"==isf){var da=self.data[ctar.attr("index")];$(".uploadButton").show(),$("body").data("action","鼠标左键双击"),self.fire("folderClick",da)}e.preventDefault(),e.stopPropagation()}),list_wraper.delegate(".filelist-item","mouseenter",function(e){for(var tar=$(e.currentTarget),da=self.data[tar.attr("index")],operate=$(e.currentTarget).find(".file-operate"),len=$(e.currentTarget).parents(".list-view"),cbox=$(".item-checkbox",self.filelist),num=0,i=0;i<cbox.length;i++)cbox.get(i).checked&&num++;if(tar.addClass("item-selected"),Util.haveDirAuth(da)?operate.find(".auth").css("display","inline-block"):operate.find(".auth").hide(),da.isfolder||Util.canPreview(da.mimeType)||operate.find(".preview").hide(),da.isfolder&&!da.isTeam&&"share_in"!=self.type&&"ent"!=self.type?da.isShare?(operate.find("span.transfer").css("display","block"),operate.find("span.cancelauth").css("display","block")):(operate.find("span.transfer").hide(),operate.find("span.cancelauth").hide()):(da.isTeam||"share"==self.type)&&(operate.find("span.transfer").hide(),operate.find("span.cancelauth").hide()),(/share|ent/.test(da.path_type)&&/^\/([^\/]+)$/.test(da.path)&&!Util.isAdmin()||da.isTeam)&&(operate.find("span.rename").hide(),operate.find("span.delete").hide()),(da.isTeam||"share_in"==self.type&&""==self.path)&&operate.find("span.cleanup").hide(),Util.isAdmin()&&(operate.find("span.transfer").hide(),operate.find("span.cancelauth").hide()),!da.isfolder||da.isTeam||"edit"!=da.action?operate.find(".cleanup").hide():operate.find(".cleanup").css("display","block"),"share_in"==self.type&&(1==da.share_to_personal&&""==self.path?operate.find("span.exitshare").css("display","inline-block"):operate.find("span.exitshare").hide()),"share_out"==self.type&&""==self.path&&operate.find("span.delete").hide(),-1!=tar.attr("index")){var d=self.data[tar.attr("index")];d.isfolder&&d.isTeam&&0==d.path.lastIndexOf("/")||"edit"!=d.action?(tar.find("#delete").hide(),tar.find(".rename").hide(),/download/.test(d.action)&&tar.find(".copy").css("display","block")):e.isfolder&&e.isTeam&&(tar.find("#delete").hide(),tar.find(".rename").hide())}len.length>0&&1>=num&&operate.addClass("operateShow");for(var iMore=operate.find(".fileMore"),oUl=operate.find("ul"),aSpan=oUl.find("span"),count=0,i=0;i<aSpan.length;i++)"none"==aSpan.eq(i).css("display")&&count++;aSpan.length==count&&iMore.hide();var fileTimer;operate.delegate(".fileMore","mouseenter",function(e){var ctar=$(e.currentTarget),ul=ctar.siblings("ul"),h=$(window).height()-ul.height()-32;ul.css("display","block"),h<ul.offset().top&&ul.css({top:"-"+ul.height()+"px"})}),operate.delegate(".fileMore","mouseleave",function(e){var ctar=$(e.currentTarget);fileTimer=setTimeout(function(){ctar.siblings("ul").hide().removeAttr("style")},100)}),operate.delegate("ul","mouseenter",function(e){clearTimeout(fileTimer)}),operate.delegate("ul","mouseleave",function(e){var ctar=$(e.currentTarget);ctar.hide().removeAttr("style")}),e.preventDefault(),e.stopPropagation()}),list_wraper.delegate(".filelist-item","mouseleave",function(e){var tar=$(e.currentTarget),operate=$(e.currentTarget).find(".file-operate"),cbox=tar.find("input:checkbox").get(0);0==cbox.checked&&(tar.removeClass("item-selected"),tar.find("")),operate.find("ul").slideUp(),operate.removeClass("operateShow")})},_select:function(){var self=this,coll=$(".item-selected",self.filelist),headerAuth=$(".filelist-header-auth");if(coll.length>1){var datas=[];$.each(coll,function(idx,item){var d=self.data[$(item).attr("index")];datas.push(d)}),self.currentData=datas,self.fire("multiSelect",self,datas),headerAuth.show()}else if(1==coll.length){var d=self.data[coll.attr("index")];self.currentData=d,d&&(self.fire("select",d,coll),headerAuth.show(),"edit"!=self.currentData.action&&($("#fileContextMenu").find("#lock").hide(),$("#fileContextMenu").find("#unlock").hide()))}else 0==coll.length&&(self.currentData=null,headerAuth.hide(),self.fire("unselect",self.parentData))},renderByPath:function(path){var self=this;self.path=path,self._renderList()},render:function(data){var self=this,filelist=self.filelist,list=$(".list-wraper",filelist);if(list.empty(),self.data=data,0==data.length)return $(".filelist-header").css({visibility:"hidden"}),$(".filelist-header-auth").hide(),data.searchData||self.fire("afterRender",self.parentData),void self._empty(list);$(".filelist-header").css({visibility:"inherit"});var scroll_wraper=$('<div class="scroll-wraper"></div>'),h=self.node.height()-self.node.find(".filelist-header").outerHeight();scroll_wraper.height(h),$(".filelist-header-auth").hide();for(var i=0,ii=data.length;ii>i;i++){var cda=data[i],itm=self._adaptTemplate(cda);itm.attr("index",i),cda.isfolder||Util.canPreview(cda.mimeType)||itm.find(".preview").hide(),cda.isfolder||cda.action!=AuthModel.ACTION["UPLOAD:DELIVERY"]||itm.find("#sendlink").hide(),scroll_wraper.append(itm)}self.lastSize=data.length,list.append(scroll_wraper),self.scroll=new Scroll(scroll_wraper),self.scroll.on("reachEnd",function(){self.lastSize<self.totalSize&&(self.paging||(self.paging=!0,self.loading(),setTimeout(function(){self.nextPage()},2e3)))}),self._generateThumbs(function(flag,index,url){if(flag){var fileItem=list.find(".filelist-item").eq(index);$(fileItem).find("span.file-area>img").attr("src",url);var h=$(fileItem).find("span.file-area>img").height();70>h&&$(fileItem).find("span.file-area>img").css("marginTop",(70-h)/2),"icon"==self.mode&&$(fileItem).addClass("thumb-nail")}else list.find(".filelist-item").eq(index).find("span.file-area>img").remove()}),data.searchData||self.fire("afterRender",self.parentData),self.fire("shareInit",self.data)},_adaptTemplate:function(cda){var itm,self=this;if(cda.isfolder?cda.isdelete?(itm=$(Mustache.render($(self.folderdelete_template).html(),cda)),itm.addClass("changeGrey")):itm=$(Mustache.render($(self.folder_template).html(),cda)):cda.isdelete?(itm=$(Mustache.render($(self.filedelete_template).html(),cda)),itm.addClass("changeGrey")):(itm=$(Mustache.render($(self.file_template).html(),cda)),cda.thumbExist||itm.find("span.file-area>img").remove()),cda.keyword){var name=itm.find(".display-name"),name1="";if(!cda.keyword.match(/[&^()+-.]/)){
var patten=new RegExp(cda.keyword,"i");name.text().replace(patten,function(s,t){name1=name.text().replace(patten,'<b class="searchKey">'+s+"</b>")})}name1||(name1=name.text()),itm.find(".display-name").html(name1)}if("icon"==self.mode&&cda.thumbExist){var imgUrl=FileModel.thumbnails(Util.getStorageUrl(),cda.path,cda.path_type,cda.from,cda.neid,130,70,cda.hash,cda.rev),image=new Image;if(image.src=imgUrl,image.complete)itm.find("span.file-area>img").attr("src",imgUrl),$(itm).addClass("thumb-nail");else try{image.onload=function(){itm.find("span.file-area>img").attr("src",imgUrl),$(itm).addClass("thumb-nail")},image.onerror=function(){itm.find("span.file-area>img").remove()}}catch(e){itm.find("span.file-area>img").remove()}}return itm},add:function(data){var self=this,len=self.data.length;self.removeLoading();for(var i=0,ii=data.length;ii>i;i++){var itm=self._adaptTemplate(data[i]);itm.attr("index",len+i);var cda=data[i];cda.isfolder||Util.canPreview(cda.mimeType)||itm.find(".i-preview").remove(),cda.isfolder||cda.action!=AuthModel.ACTION["UPLOAD:DELIVERY"]||itm.find(".i-sendlink").remove(),self.scroll.appendContent(itm)}self.data=self.data.concat(data),self.scroll.render(!0);var pos=self.calculateScrollRate(data.length);self.scroll.scrollTo(pos,!0)},calculateScrollRate:function(num){var self=this,rate=(self.data.length-num)/self.data.length;return rate},nextPage:function(){var self=this;self.removeLoading(),self.current=self.lastSize,self._requestData(self.path,self.lastSize,self.pageSize,function(datas){self.add(datas),self.lastSize+=datas.length,self.paging=!1,self.pages++},function(){self.removeLoading(),self.paging=!1},self.from,self.prefix_neid)},doSort:function(orderby,sort){var self=this;self.orderby=orderby,$.cookie("orderby",orderby),$.cookie("sort",sort),self._renderList()},loading:function(){this.wait=new Wait},removeLoading:function(){this.wait.close()},_empty:function(parent){var empty_img,empty_txt,self=this,pathname=location.pathname;if(self.data.searchData)empty_img="empty_search",empty_txt=_("抱歉，没有找到相关的文件/文件夹",self.data.keyword);else if("/"==pathname&&""==self.path){var user_role=window.LenovoData&&window.LenovoData.user.user_role;"admin"==user_role?(empty_img="empty empty_self",empty_txt=_("上传文件到联想网盘，<br/>安全高效快捷")):(empty_img="empty empty_ent",empty_txt=_("您暂时未被授权任何团队文件夹，请联系管理员"))}else if("/folder/self"==pathname&&""==self.path){empty_img="empty empty_self",empty_txt=_("上传文件到联想网盘，<br/>安全高效快捷");var quota=window.LenovoData&&window.LenovoData.user.user_info.quota;0==quota&&($("#fileManagerHeader .button-area").hide(),$(".uploadButton").hide(),empty_txt=_("您的个人文件夹空间为零，请联系管理员为您分配空间"))}else"/folder/myshare"==pathname&&""==self.path?(empty_img="empty empty_share_out",empty_txt=_("开启共享，轻松协作")+'<br/><a target="_blank" href="/help/help_tab2.html?tag=order#60">'+_("如何共享我的文件？")+"</a>"):"/folder/shared"==pathname&&""==self.path?(empty_img="empty empty_share_in",empty_txt=_("没有收到的共享")):"/link/list"==pathname&&""==self.path?(empty_img="empty empty_link",empty_txt=_("没有任何外链")+'<br/><a target="_blank" href="/help/help_tab2.html?tag=share#50">'+_("如何创建一个外链？")+"</a>"):"/mail/list"==pathname&&""==self.path?(empty_img="empty empty_mail",empty_txt=_("没有邮件附件")+'<br/><a target="_blank" href="#">'+_("如何添加邮件附件？")+"</a>"):"/event/list"==pathname&&""==self.path?(empty_img="empty empty_event",empty_txt=_("文件动态早知晓 重要信息0遗漏")):(empty_img="empty empty_default",empty_txt=_("空文件夹"));parent.append(Mustache.render($(self.empty_template).html(),{cssAction:self.cssAction,empty_img:empty_img,empty_txt:empty_txt}))},_initSearchModel:function(){var oBtn=$(".oper .operSearch");oBtn.delegate(".i-search","click",function(){var searchBox=$(".search-area");searchBox.slideToggle()})},reload:function(){var self=this;self.fire("reload"),self._renderList()},onBeforeSelect:function(evt){var self=this;document.getElementById("selContainer")?self.selectDiv=document.getElementById("selContainer"):(self.selectDiv=document.createElement("div"),$(self.selectDiv).css({position:"absolute",width:0,height:0,left:0,top:0,"font-size":0,margin:0,padding:0,border:"1px dashed #0099FF","background-color":"#C3D5ED","z-index":1e3,filter:"alpha(opacity:60)",opacity:"0.6",display:"none"}),self.selectDiv.id="selContainer",document.body.appendChild(this.selectDiv)),self.startX=self.posXY(evt).x,self.startY=self.posXY(evt).y,self.isSelect=!0},posXY:function(event){event=event||window.event;var posX=event.pageX,posY=event.pageY;return{x:posX,y:posY}},onSelect:function(evt){var self=this;if(self.isSelect){$(self.selectDiv).show();for(var posX=self.posXY(evt).x,poxY=self.posXY(evt).y,regionList=($(self.selectDiv)[0].style.left=Math.min(posX,this.startX)+"px",$(self.selectDiv)[0].style.top=Math.min(poxY,this.startY)+"px",$(self.selectDiv)[0].style.width=Math.abs(posX-this.startX)+"px",$(self.selectDiv)[0].style.height=Math.abs(poxY-this.startY)+"px",$(".filelist-item")),i=0;i<regionList.length;i++){var r=regionList[i],sr=self.innerRegion(self.selectDiv,r);$(self.selectDiv).width()>0&&(sr?($(r).addClass("item-selected"),$(r).find("input")[0].checked="checked"):($(r).removeClass("item-selected"),$(r).find("input").removeAttr("checked"),$("#item-selectAll").removeAttr("checked")))}}},innerRegion:function(selDiv,region){{var self=this,t1=parseInt(selDiv.style.top),l1=parseInt(selDiv.style.left),r1=t1+parseInt(selDiv.offsetWidth),b1=t1+parseInt(selDiv.offsetHeight),t2=self.getPos(region).top,l2=self.getPos(region).left,r2=l2+parseInt(region.offsetWidth),b2=t2+parseInt(region.offsetHeight);Math.max(t1,t2),Math.min(r1,r2),Math.min(b1,b2),Math.max(l1,l2)}return t2>b1||l2>r1||t1>b2||l1>r2?null:region},getPos:function(obj){for(var l=0,t=0;obj;)l+=obj.offsetLeft,t+=obj.offsetTop,obj=obj.offsetParent;return{left:l,top:t}},ondragEnd:function(){var self=this;0!=$(self.selectDiv).length&&(self.selectDiv.style.display="none"),self.isSelect=!1,$("fileManagerWrapper ")&&$("#selContainer").height()>10&&self._select(),$(document).unbind("mousemove"),$(document).unbind("mouseup"),$("#fileManagerWraper").unbind("mouseleave")},clearEventBubble:function(evt){var evt=evt||window.event;evt.stopPropagation?evt.stopPropagation():evt.cancelBubble=!0,evt.preventDefault?evt.preventDefault():evt.returnValue=!1}}),FileList}),define("component/fileManager/fileNavigator",function(require,exports,module){function FileNavigator(context){this.cssAction=context.cssAction,this.type=context.path_type,this._init()}var $=require("jquery"),Util=require("util"),EventTarget=require("eventTarget"),Scroll=(require("component/fileManager/fileTree"),require("component/scroll"));require("mustache"),require("i18n");$.i18n.prop;return $.extend(FileNavigator.prototype,EventTarget,{_init:function(){var self=this;self.scroll=null},render:function(paths,width){function stopFunc(e){document.all?event.cancelBubble=!0:e.stopPropagation()}var self=this,fileNav=[],moreNav=[];self.paths=paths,self.width=width?width:430;var dirItemArr=paths,item='<a src="{{url}}" title="{{dirname}}" class="item_arrow"><span class="item_title">{{dirname}}</span></a>',first_temple='<a  src="/" id="nav_root" title="{{dirname}}" class="item_arrow"><span class="item_title">{{dirname}}</span></a><i class="icon i-arrow-l" id="showTree"></i>';1==paths.length&&(first_temple='<a  id="nav_root" title="{{dirname}}" class="item_arrow_root"><span class="item_title">{{dirname}}</span></a>',window.fileManager.navTree&&window.fileManager.navTree.fileTree.childCount>0&&(first_temple+='<i class="icon i-arrow-l" id="showTree"></i>'));for(var delimiter="",first=Mustache.render(first_temple,{dirname:Util.getRootDisplayName(self.type)}),ellipsis='<span class="moreNav item_arrow"><i class="moreNavBtn">......</i></span>',len=dirItemArr.length,lessItemArrDis=[],i=0;len>i;i++)if(""!=dirItemArr[i]){var src=dirItemArr.slice(0,i+1).join("/");lessItemArrDis[i]=dirItemArr[i].length<=8?dirItemArr[i]:dirItemArr[i].substring(0,8)+"...";var tmp=Mustache.render(item,{url:src,dirname:lessItemArrDis[i]});moreNav.push(delimiter+tmp)}for(var dirItemArrDis=[],i=len-1;i>=0;i--){if(""!=dirItemArr[i]){var src=dirItemArr.slice(0,i+1).join("/");if(i==len-1)fileNav.unshift(delimiter+'<span class="item_arrow_cur" title='+dirItemArr[i]+">"+dirItemArr[i]+"</span>");else{dirItemArrDis[i]=dirItemArr[i].length<=8?dirItemArr[i]:dirItemArr[i].substring(0,8)+"...";var tmp=Mustache.render(item,{url:src,dirname:dirItemArrDis[i]});fileNav.unshift(delimiter+tmp)}}$(".filenav-area").append(first+fileNav.join(""));var realWidth=parseInt($(".filenav-area").css("width"));if(realWidth>self.width){moreNav.splice(len-fileNav.length),fileNav.shift(),$(".filenav-area").empty(),$(".filenav-area").append(first+ellipsis+fileNav.join(""));break}i>0&&$(".filenav-area").empty()}null==self.scroll&&(self.scroll=new Scroll("#moreNavList"));var showOnff=!0;$(".filenav-area").delegate("#showTree","click",function(e){showOnff?($("#filetreewrap").css("visibility","visible"),stopFunc(e),showOnff=!1):($("#filetreewrap").css("visibility","hidden"),showOnff=!0)}),document.onclick=function(e){$("#filetreewrap").css("visibility","hidden"),showOnff=!0},$("#filetreewrap").on("click",function(e){stopFunc(e)}),$("body").delegate(".lui-wait","click",function(e){stopFunc(e)}),$(".fileManager_top > a").mouseover(function(e){$(e.currentTarget).css("text-decoration","underline")}),$(".fileManager_top > a").mouseout(function(e){$(e.currentTarget).css("text-decoration","")}),$(".fileManager_top").delegate("a","click",function(){var path=$(this).attr("src");return path?void self.fire("changePath",path,self.cssAction):!1}),$(".moreNavList").delegate("span","click",function(){var path=$(this).find("a").attr("src");self.fire("changePath",path,self.cssAction)});var timer,onOff=!0;$(".moreNav").delegate(".moreNavBtn","click",function(e){var cur=$(e.currentTarget).find(".i-arrow");onOff?(cur.length<1&&$(".moreNavList .scl-content").append(moreNav.join("")),$(".moreNavList").stop(!1,!0).slideDown(function(){var height=$("#moreNavList .scl-content").height()>100?100:$("#moreNavList .scl-content").height();$("#moreNavList").css({height:height+"px"}),self.scroll.render(!0)}),onOff=!1):($(".moreNavList").stop(!1,!0).slideUp(function(){$(".moreNavList .scl-content").empty()}),onOff=!0),e.stopPropagation(),e.preventDefault()}),$(".moreNav").mouseenter(function(e){clearTimeout(timer)}),$(".moreNav").mouseleave(function(e){clearTimeout(timer),timer=setTimeout(function(){$(".moreNavList").slideUp(function(){$(".moreNavList .scl-content").empty()}),onOff=!0},50)}),$(".moreNavList").mouseenter(function(e){clearTimeout(timer)}),$(".moreNavList").mouseleave(function(e){clearTimeout(timer),timer=setTimeout(function(){$(".moreNavList").slideUp(function(){$(".moreNavList .scl-content").empty()}),onOff=!0},50)})}}),FileNavigator}),define("component/fileManager/fileTree",function(require,exports){function FileTree(container,reqdata,conf){this.container="string"==$.type(container)?$(container):container,this.width=""==conf.width?170:conf.width,this.max_height=""==conf.max_height?320:conf.max_height,this.min_height=""==conf.min_height?320:conf.min_height,this.autoOpen=conf.autoOpen?!0:!1,this.teamName=conf.teamName,this.isInit=!0,this.path_type=reqdata.path_type,this._init()}{var $=require("jquery"),_=(require("i18n"),$.i18n.prop),EventTarget=require("eventTarget"),Scroll=require("component/scroll"),Util=require("util");require("model/AuthManager")}require("jqtree");var fileManager=require("model/FileManager");return String.prototype.startWith=function(regexp){return new RegExp("^"+regexp).test(this)},$.extend(FileTree.prototype,EventTarget,{_getDirName:function(path){var index=path.lastIndexOf("/"),dirName=path.substr(index+1);return dirName},_loadData:function(path){var self=this;fileManager.metadata_no_wait(function(message){if(200==message.code){var data=message.data;if("/"==data.path){var nodes=self._dataToNodes(message.data.content);self.fileTree.tree("loadData",nodes)}else{var curNode={id:data.path,label:self._getDirName(data.path),cssAction:Util.resolveFileAction(data.access_mode).replace(/:/g,"-"),realpath:data.path,is_dir:data.is_dir,is_shared:data.is_shared,is_team:data.is_team};self.fileTree.tree("loadData",[curNode]);var nodes=self._dataToNodes(message.data.content);curNode=self.fileTree.tree("getNodeById",curNode.id),self.fileTree.tree("loadData",nodes,curNode),self.fileTree.tree("toggle",curNode),self.fileTree.tree("selectNode",curNode)}self._render()}},path,{path_type:self.path_type,content_type:fileManager.CONTENT_TYPE.DIR,sort:fileManager.SORT.ASC})},_dataToNodes:function(data){for(var nodes=[],i=0,len=data.length;len>i;i++){var fileItem=data[i];if(fileItem.is_dir){var dir=this._getDirName(fileItem.path),childNode={data:fileItem,id:fileItem.path,label:dir,cssAction:Util.resolveFileAction(fileItem.access_mode).replace(/:/g,"-"),realpath:fileItem.path,is_dir:!0,is_shared:fileItem.is_shared,is_team:fileItem.is_team,prefix_neid:fileItem.prefix_neid,from:fileItem.from};nodes.push(childNode)}}return nodes},_init:function(nodes){var self=this;self.container.append('<div class="menu-item treeswitch" style="cursor: pointer;"><span class="icon i-fold"></span><span class="icon i-space"></span><span class="menu-text">'+_("企业空间")+'</span></div><div class="sub-menu-item"><div class="treeview-wraper"><div class="treeview"></div></div> </div>'),self.fileTree=self.container.find(".treeview"),self.root=self.container.find(".treeswitch"),self.container.find(".treeview-wraper").css("width",self.width),self.fileTree.tree({data:[],closedIcon:'<span class="icon i-fold" style="vertical-align:middle;"></span>',openedIcon:'<span class="icon i-expand" style="vertical-align:middle;"></span>',onCreateLi:function(node,$li){var folder_icon='<span class="icon-file folder"></span>';node.is_shared&&node.is_team?folder_icon='<span class="icon-file folder_team"></span>':node.is_shared&&(folder_icon='<span class="icon-file folder_share"></span>'),(!node.element||node.element&&0==node.children.length&&!node.hasOwnProperty("load_on_demand"))&&(folder_icon='<a class="jqtree_common jqtree-toggler"><span class="icon i-fold" node-data="'+node.id+'" style="vertical-align:middle;"></span></a>'+folder_icon);var item=$li.find(".jqtree-title");item.before(folder_icon),item.attr("title",item.text())}}),$(self.fileTree).delegate(".i-fold","click",function(e){var id=$(e.target).attr("node-data");id&&(curNode=self.fileTree.tree("getNodeById",id),parentNode=curNode.parent,parentNode.element&&$(parentNode.element).removeClass("jqtree-selected"),fileManager.metadata_no_wait(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.fileTree.tree("loadData",nodes,curNode),self.fileTree.tree("toggle",curNode),self.fileTree.tree("selectNode",curNode),self._render()}},curNode.realpath,{path_type:self.path_type,content_type:fileManager.CONTENT_TYPE.DIR,sort:fileManager.SORT.ASC,prefix_neid:curNode.prefix_neid,from:curNode.from}))}),self.fileTree.bind("tree.init",function(){}),self.fileTree.bind("tree.click",function(event){{var curNode=event.node;curNode.parent}$(self.root).css("color","#1E5D7C"),$(self.root).css("font-weight","normal"),self.fire("changePath",curNode.realpath,curNode.cssAction,curNode.data),void 0===curNode.realpath||curNode.is_new||fileManager.metadata_no_wait(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.fileTree.tree("loadData",nodes,curNode),self.fileTree.tree("toggle",curNode),self.fileTree.tree("selectNode",curNode),self._render()}},curNode.realpath,{path_type:self.path_type,content_type:fileManager.CONTENT_TYPE.DIR,sort:fileManager.SORT.ASC,prefix_neid:curNode.prefix_neid,from:curNode.from})}),self.fileTree.bind("tree.close",function(e){self._render()}),self.fileTree.bind("tree.open",function(e){self._render()}),self.fileTree.bind("tree.move",function(event){fileManager.move(function(ret){event.move_info.target_node.realpath=event.move_info.target_node.realpath+"/"+event.move_info.moved_node.name},event.move_info.moved_node.realpath,event.move_info.target_node.realpath+"/"+event.move_info.moved_node.name)})},_render:function(){var self=this;self.container.find(".treeview-wraper").show(),self.max_height=self.max_height>45?self.max_height:45;var height=self.max_height<self.fileTree.height()?self.max_height:self.fileTree.height();0==height&&(height=self.max_height),height<self.min_height&&(height=self.min_height),self.container.find(".treeview-wraper").css("height",height),self.scroll||(self.scroll=new Scroll(self.container.find(".treeview-wraper"))),self.scroll&&self.scroll.render(!0)},reload:function(){var self=this;fileManager.metadata_no_wait(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.fileTree.childCount=nodes.length,0!=nodes.length&&(self.fire("loaded"),self.fileTree.tree("loadData",nodes),self._render(),self.container.find(".scl-content").css({top:0}))}},"/",{path_type:self.path_type,content_type:fileManager.CONTENT_TYPE.DIR,sort:fileManager.SORT.ASC,orderby:fileManager.ORDERBY.MTIME})},render:function(){var self=this;self.autoOpen&&($(self.root).hide(),fileManager.metadata_no_wait(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.fileTree.childCount=nodes.length,0!=nodes.length&&(self.fire("loaded"),self.fileTree.tree("loadData",nodes),self._render())}},"/",{path_type:self.path_type,content_type:fileManager.CONTENT_TYPE.DIR,sort:fileManager.SORT.ASC,orderby:fileManager.ORDERBY.MTIME}))},appendNode:function(node,data){node.id?(this.fileTree.tree("appendNode",data,node),this.fileTree.tree("openNode",node),this.scroll.render(!0)):this.selectRoot.find(".i-fold").length>0?(this.inserNewFoder=data,this.selectRoot.find(".i-fold").click()):this.fileTree.tree("appendNode",data)},updateNode:function(){},removeNode:function(id){this.fileTree.tree("removeNode",this.fileTree.tree("getNodeById",id))},getSelectDir:function(){var node=this.fileTree.tree("getSelectedNode"),dir=node.realpath;return dir},getSelectNode:function(){var self=this,node=this.fileTree.tree("getSelectedNode");return node===!1?{data:{path_type:self.path_type,path:"/",neid:0,from:0}}:node},setSelectDir:function(path){var node=this.fileTree.tree("getNodeById",path);this.fileTree.tree("selectNode",node)},insertDir:function(parentPath,childPath){var self=this;fileManager.metadata_no_wait(function(message){if(200==message.code){var fileItem=message.data;if(fileItem.is_dir){var dir=self._getDirName(fileItem.path),parentNode=self.fileTree.tree("getNodeById",parentPath),childNode=self.fileTree.tree("appendNode",{id:fileItem.path,label:dir,cssAction:Util.resolveFileAction(fileItem.access_mode).replace(/:/g,"-"),realpath:fileItem.path,is_dir:fileItem.is_dir,is_shared:fileItem.is_shared,isTeam:null==fileItem.team?!1:!0},parentNode);self._render(),self.fileTree.tree("selectNode",childNode)}}},childPath,{path_type:self.path_type,content_type:fileManager.CONTENT_TYPE.DIR,sort:fileManager.SORT.ASC})}}),FileTree}),define("component/fileManager/index",function(require,exports){function FileManager(node,type){this.node=node,this.currentData=null,this.firstLoadFlag=!1,this.type=type}var $=require("jquery"),EventTarget=(require("component/tips"),require("eventTarget")),FileList=require("component/fileManager/fileList"),FileAttribute=require("component/fileManager/fileAttribute"),FileNavigator=require("component/fileManager/fileNavigator"),AuthModel=require("model/AuthManager"),FileModel=require("model/FileManager"),Util=require("util"),FileUploadDialog=require("component/fileUploadDialog/index"),FileSearchBox=(require("component/dynamic"),require("component/filesearchbox")),FileController=(require("component/fileManager/fileTree"),require("lenovodata/fileController")),flashCheckDialog=(require("lenovodata/searchController"),require("component/flashCheckDialog")),PreviewController=require("lenovodata/previewController");require("cookie"),require("calendar"),require("i18n");{var _=$.i18n.prop,l_cookie=$.cookie("X-LENOVO-SESS-ID"),l_language=$.cookie("language"),uid=Util.getUserID();Util.getStorageUrl()+Util.getApiVersion()+"/files/databox/{directory}{file}?X-LENOVO-SESS-ID="+l_cookie+"&uid="+uid+"&overwrite=true&source=file&language="+l_language+"&t="}return $.extend(FileManager.prototype,EventTarget,{renderList:function(){var self=this;self.filelist&&(self.filelist._renderList(),self.fire("reload",self))},_renderList:function(){var self=this;self.node="string"==$.type(self.node)?$(self.node):self.node;var fa=new FileAttribute("#file-attr-wraper",self.type,self.path);$.each(["copymove","preview","share","exitshare","auth","cancelauth","transfer","attribute","download","history","rename","cleanup","recover","purge","rmShare","remarkEdit","lock","unlock","reqUnlock","remove"],function(index,key){fa.on(key,function(e){$("body").data("category",key).data("action","工具栏内按钮").data("content",1==$.isArray(e)?"-":e&&e.isfolder?"文件夹":"文件"),self[key](e)})}),self.node.empty(),self.filelist=null;var fl_from,fl_prefix_neid;"share_in"!=self.type&&"share_out"!=self.type||!self.currentData||(fl_from=self.currentData.from,fl_prefix_neid=self.currentData.prefix_neid);var fl=new FileList(self.node,"#template_filelist_fileview","#template_filelist_filedelete","#template_filelist_folderview","#template_filelist_folderdelete","#template_nofile",self.cssAction,self.type,fl_from,fl_prefix_neid);$.each(["preview","share","auth","cancelauth","exitshare","transfer","rename","cleanup","copymove","expire","history","attribute","recover","purge","download","upload","addfolder","rmShare","lock","unlock","reqUnlock","remove"],function(index,key){fl.on(key,function(e){$("body").data("category",key).data("content",e?1==$.isArray(e)?"-":e.isfolder?"文件夹":"文件":""),self[key](e)})}),fl.on("select",function(e,cur){var type;if(type=e.isfolder?e.isdelete?"folderdelete":"folder":e.isdelete?"filedelete":"file",e.islocked?($("#fileContextMenu").find("#lock").hide(),e.unlockAdmin?($("#fileContextMenu").find("#unlock").show(),$("#fileContextMenu").find("#reqUnlock").hide()):($("#fileContextMenu").find("#unlock").hide(),$("#fileContextMenu").find("#reqUnlock").show())):($("#fileContextMenu").find("#lock").show(),$("#fileContextMenu").find("#unlock").hide(),$("#fileContextMenu").find("#reqUnlock").hide()),"upload"!=e.action||e.isfolder||$("#fileContextMenu").hide(),e.hasDelivery?($(".pop-menu #share").text(_("查看外链")),$(".pop-menu #rmShare").show(),($(".pop-menu").hasClass("action-download")||$(".pop-menu").hasClass("action-preview")||$(".pop-menu").hasClass("action-upload")||$(".pop-menu").hasClass("action-upload-download"))&&$(".pop-menu #rmShare").hide()):($(".pop-menu #share").text(_("外链分享")),$(".pop-menu #rmShare").hide()),e.isdelete){var op_map={rename:_("重命名"),"delete":_("删除"),move:_("移动")};FileModel.info(function(res){200==res.code&&(e.deleted_ops=op_map[res.data.deleted_ops],fa.render(type,e))},e.path,e.path_type,e.from,e.neid)}else fa.render(type,e);Util.haveDirAuth(e)?$("#auth").css("display","block"):$("#auth").hide(),e.isfolder||Util.canPreview(e.mimeType)||($("#preview").hide(),$(".filelist-header-auth").find("span.preview").hide()),e.isfolder&&e.isTeam||"edit"!=e.action?($("#folderContextMenu").find("#rename").hide(),$("#folderContextMenu").find("#remove").hide(),$(".filelist-header-auth").find("span.rename").hide(),$(".filelist-header-auth").find("span.delete").hide(),/download/.test(e.action)||/edit/.test(e.action)?($("#folderContextMenu").find("#copymove").show(),$("#fileContextMenu").find("#copymove").show(),$(".filelist-header-auth").find("span.copy").css("display","block")):($("#folderContextMenu").find("#copymove").hide(),$("#fileContextMenu").find("#copymove").hide(),$(".filelist-header-auth").find("span.copy").hide())):($("#folderContextMenu").find("#rename").show(),$("#folderContextMenu").find("#copymove").show(),$("#folderContextMenu").find("#remove").show(),$(".filelist-header-auth").find("span.rename").css("display","block"),$(".filelist-header-auth").find("span.copy").css("display","block"),$(".filelist-header-auth").find("span.delete").css("display","inline-block")),e.isfolder&&!e.isTeam&&"share_in"!=self.type&&"ent"!=self.type&&(e.isShare?($("#folderContextMenu").find(".transfer").show(),$("#folderContextMenu").find(".cancelauth").show(),$(".filelist-header-auth").find("span.transfer").css("display","block"),$(".filelist-header-auth").find("span.cancelauth").css("display","block")):($("#folderContextMenu").find(".transfer").hide(),$("#folderContextMenu").find(".cancelauth").hide(),$(".filelist-header-auth").find("span.transfer").hide(),$(".filelist-header-auth").find("span.cancelauth").hide())),!e.isfolder||e.isTeam||"edit"!=e.action?($("#folderContextMenu").find("#cleanup").hide(),$(".filelist-header-auth").find("span.cleanup").hide()):($("#folderContextMenu").find("#cleanup").css("display","block"),$(".filelist-header-auth").find("span.cleanup").css("display","block")),/share|ent/.test(e.path_type)&&/^\/([^\/]+)$/.test(e.path)&&!Util.isAdmin()||e.isTeam?($("#folderContextMenu").find("#rename").hide(),$("#folderContextMenu").find("#remove").hide(),$(".filelist-header-auth").find(".rename").hide(),$(".filelist-header-auth").find(".delete").hide()):($("#folderContextMenu").find("#rename").show(),$("#folderContextMenu").find("#remove").show()),"share_out"!=this.type&&"share_in"!=this.type||""!=self.path||($("#folderContextMenu").find("#remove").hide(),$(".filelist-header-auth").find("span.delete").hide()),"share_in"==this.type&&(1==e.share_to_personal&&""==self.path?($("#folderContextMenu").find("#exitshare").show(),$(".filelist-header-auth").find(".fileAttribute span.exitshare").show()):($("#folderContextMenu").find("#exitshare").hide(),$(".filelist-header-auth").find(".fileAttribute span.exitshare").hide()));for(var oUl=$(".filelist-header-auth").find("ul"),iMore=$(".filelist-header-auth").find(".fileMore"),aSpan=oUl.find("span"),count=0,i=0;i<aSpan.length;i++)"none"!=aSpan.eq(i).css("display")&&count++;1>count&&iMore.hide()}),fl.on("multiSelect",function(self,datas){var type,folder=0,file="",deleted=!1,undeleted=!1,e=self.currentData;if($.each(e,function(index,item){file+=item.isfolder?"1":"0",item.isdelete?deleted=!0:undeleted=!0}),deleted&&undeleted)fa.render("multi",datas,self);else if(deleted){var result=folder^parseInt(file,2);type=0==result?"multi-filedelete":1==result?"multi-folderdelete":"multi-delete",fa.render(type,datas,self)}else""==self.path?fa.render("multi",datas):fa.render("multi",datas,self)}),fl.on("unselect",function(e){""!=self.path?fa.render("folder",e):"share_in"!=self.type&&"share_out"!=self.type||""!=self.path?fa.render("init"):fa.render("shared",fl.data)}),fl.on("folderClick",function(da){da&&!da.isdelete&&(self.currentData=da,parseInt(da.from)>0&&localStorage.setItem("from",da.from),parseInt(da.prefix_neid)>0&&localStorage.setItem("prefix_neid",da.prefix_neid),Util.sendDirectlyRequest("打开文件夹",$("body").data("action"),"-"),self.browse("/"+da.path,da.cssAction),fa.render("folder",da))}),fl.on("afterRender",function(da){""!=self.path?fa.render("folder",da):fa.render();var ca=self.currentData=fl.parentData,hassearchresult=$("#fileManagerHeader>.fileManager_top").hasClass("vh");ca&&self._renderHeader(ca.path,ca.cssAction),hassearchresult&&self._renderHeader(self.path,self.cssAction),self.firstLoadFlag||(self.firstLoadFlag=!0,self.fire("loadComplete"))}),fl.on("shareInit",function(da){("share_in"==self.type||"share_out"==self.type)&&""==self.path&&fa.render("shared",da,self)}),fl.on("reload",function(){self.fire("reload")}),setTimeout(function(){fl.renderByPath(self.path)},125),self.filelist=fl,self.fa=fa},_renderHeader:function(path,cssAction){var icon,self=this,names=path.split("/"),cname=names[names.length-1];""==cname?icon="folder_global":(icon="folder",self.currentData&&(icon=self.currentData.isShare&&self.currentData.team?"folder_team":self.currentData.isShare?"folder_share":"folder"));var data={name:""==cname?Util.getRootDisplayName():cname,icon:icon,role:Util.isAdmin()?"admin":"user",cssAction:cssAction},tmpl_head=$("#template_fileManager_head").html();tmpl_head=Mustache.render(tmpl_head,data);var header=$("#fileManagerHeader");header.empty(),header.append(tmpl_head);var dynamicTab=$(".infoTab .infoTabHead span.infoTabDynamic");if(dynamicTab.hasClass("active")?$(".show-dynamic-button").addClass("dynamicShow"):$(".show-dynamic-button").removeClass("dynamicShow"),self.filelist&&""!=self.path){var trash=$(".header_bot").find(".trash"),text=trash.find(".i-trashBtn");"false"==self.filelist.includeDeleted?(trash.removeClass("trashShow"),text.attr("title",_("显示已删除")),Util.sendDirectlyRequest("文件列表","隐藏已删除","")):(trash.addClass("trashShow"),text.attr("title",_("隐藏已删除")),Util.sendDirectlyRequest("文件列表","显示已删除",""))}$("#fileManagerHeader").height(50);var h=$(".page-body").height(),fh=h-$("#fileManagerHeader").outerHeight();$("#fileManagerWraper").height(fh);var fnav=new FileNavigator({cssAction:self.cssAction,path_type:self.type});""!==names[0]&&names.unshift(""),fnav.render(names,430),fnav.on("changePath",function(path,cssAction){self.browse(path,cssAction)});{var uploadbtn=header.find(".uploadButton"),addfolderbtn=header.find(".addfolder"),quota=window.LenovoData&&window.LenovoData.user.user_info.quota;window.LenovoData&&window.LenovoData.user.user_role}0==quota&&"self"==self.type&&(uploadbtn.hide(),$("#fileManagerHeader .button-area").hide()),addfolderbtn.on("click",function(){$("body").data("category","addfolder").data("action","工具栏内按钮").data("content","文件夹"),self.addfolder()}),$(".path").click("click",function(event){fileTree.render();var top=Util.getElementYPos(this)+$(this).outerHeight(),left=Util.getElementXPos(this);$("#filetree").css({top:top,left:left}),"block"!=$("#filetree").css("display")?$("#filetree").show():$("#filetree").hide(),event?event:window.event,event.cancelBubble=!0,event.stopPropagation()});var trash=$(".header_bot").find(".trash");trash.on("click",function(){var text=trash.find(".i-trashBtn");"true"==self.filelist.includeDeleted?(trash.removeClass("trashShow"),text.attr("title",_("显示已删除")),self.filelist.includeDeleted="false",Util.sendDirectlyRequest("文件列表","隐藏已删除","")):(trash.addClass("trashShow"),text.attr("title",_("隐藏已删除")),self.filelist.includeDeleted="true",Util.sendDirectlyRequest("文件列表","显示已删除","")),self.filelist._renderList()});{var headMenu="#head";new FileSearchBox($(headMenu).find("#file-searchbox"),function(flag){flag?($(".uploadButton").hide(),$(header).find(".fileManager_top").addClass("vh"),$(header).find(".search-result").show()):($(".uploadButton").show(),$(header).find(".fileManager_top").removeClass("vh"),$(header).find(".search-result").hide())})}},browse:function(path,cssAction){if(path){path=path.replace("//","/");var self=this;"/"==path.slice(0,1)&&(path=path.slice(1)),self.path=path,""==path&&(cssAction="/folder/shared"==location.pathname||"/folder/myshare"==location.pathname?AuthModel.ACTION.PREVIEW:"/folder/self"==location.pathname?AuthModel.ACTION.EDIT:Util.isAdmin()?AuthModel.ACTION.EDIT:AuthModel.ACTION.PREVIEW),self.cssAction=cssAction,self._renderHeader(path,cssAction),self._renderList(),""==path?(localStorage.removeItem("currentPath"),localStorage.removeItem("cssAction")):(localStorage.setItem("currentPath",path),localStorage.setItem("cssAction",cssAction)),flashCheckDialog.checkFlash(),this.upload(self.cssAction)}},upload:function(cssAction){function loadready(cssAction){$(".uploadButton").removeClass(function(){var clazz=this.className.split(" ");return clazz.length>1?clazz[1]:""}).addClass("action-"+cssAction).css("left",Util.getElementXPos(document.getElementById("upload_button")))}var self=this,URL=Util.getStorageUrl()+Util.getApiVersion()+"/files/databox/{directory}{file}?X-LENOVO-SESS-ID="+l_cookie+"&uid="+uid+"&overwrite=true&source=file&language="+l_language+"&t=";if(null!=swfUploadDom)return $(".uploadButton").removeClass(function(){var clazz=this.className.split(" ");return clazz.length>1?clazz[1]:"";

}).addClass("action-"+cssAction),void swfUploadDom.setFolder(self.path,self.type,self.filelist.from,self.filelist.prefix_neid);var fileDialog=new FileUploadDialog(self.path,URL,self.type,self.filelist.from);swfUploadDom=fileDialog,fileDialog.on("close",function(count){swfUploadDom=null,count>0&&self._renderList()}),fileDialog.on("update",function(count){self._renderList()});var flag=!1;fileDialog.on("completeOne",function(total){function wait(){setTimeout(function(){flag?(flag=!1,wait()):self.filelist._renderList()},200)}flag=!0,setTimeout(function(){flag=!1,wait()},200)}),fileDialog.on("loadready",function(){loadready(self.cssAction)})},addfolder:function(){var self=this;FileController(self.filelist,"addfolder",self.path)},copymove:function(e){var self=this;FileController(self,"copymove",e)},remove:function(e){var self=this;FileController(self,"remove",e)},preview:function(e){var self=this;PreviewController(self,"preview",e,self.filelist.data)},share:function(e){var self=this;FileController(self,"share",e)},rmShare:function(e){var self=this;FileController(self,"rmShare",e)},exitshare:function(e){var self=this;FileController(self.filelist,"exitshare",e)},lock:function(e){var self=this;FileController(self,"lock",e)},unlock:function(e){var self=this;FileController(self,"unlock",e)},reqUnlock:function(e){var self=this;FileController(self,"reqUnlock",e)},download:function(e){var self=this;FileController(self,"download",e)},history:function(e){var self=this;FileController(self,"history",e)},remarkEdit:function(e){FileController(this,"remarkEdit",e)},rename:function(e){var self=this;FileController(self,"rename",e)},cleanup:function(e){var self=this;FileController(self,"cleanup",e)},recover:function(e){var self=this;FileController(self,"recover",e)},purge:function(e){var self=this;FileController(self,"purge",e)},auth:function(e){var self=this;FileController(self,"auth",e)},cancelauth:function(e){var self=this;FileController(self.filelist,"cancelauth",e)},transfer:function(e){var self=this;FileController(self.filelist,"transfer",e)},expire:function(e){var self=this;FileController(self,"expire",e)},attribute:function(e){var self=this;FileController(self,"attribute",e)},remarkEdit:function(e){FileController(this,"remarkEdit",e)},reload:function(){var self=this;self.filelist._renderList(),self.fire("reload",self)},processSearch:function(result){$(".search-result>.searchNav").html(_("共搜索出{0}个结果",result))},getState:function(){return swfUploadDom?swfUploadDom.getState():void 0}}),FileManager}),define("component/fileUploadDialog/fileUploadList",function(require,exports){function FielUploadList(node,instance,path,path_type,from,prefix_neid){this.cache={},this.cache.files=[],this.cache.filesIndex={},this.cache.processes=[],this.cache.instance=instance,this.total=0,this.current=0,this.completed=0,this.succeed=0,this.path=path,this.from=from?from:"",this.prefix_neid=prefix_neid?prefix_neid:"",this.path_type=path_type,this.isDelivery=!1,this.deliveryCode="",this.token="",this.flushCount=0,this.flushTime=(new Date).getTime(),this.ui=null;var node=this.node="string"==$.type(node)?$(node):node}{var $=require("jquery"),EventTarget=(require("component/scroll"),require("eventTarget")),Util=require("util"),Tips=require("component/tips"),Util=(require("lenovodata/fileController"),require("util")),AuthUploadManager=require("lenovodata/model/AuthUploadManager");require("component/progressbar")}require("swfupload/swfupload.js"),require("swfupload/plugins/swfupload.speed.js"),require("i18n");var _=$.i18n.prop;return $.extend(FielUploadList.prototype,EventTarget,{add:function(file){var self=this,g=self.cache,files=g.files,type=(g.processes,self.node,file.name.split(".")),_html='<div class="task-file"><div class="f-l icon-file '+Util.typeIcon(type.pop())+'"></div><div class="f-l filename" id="filename_'+file.id+'">'+file.name+'</div><div class="f-l progress" id="progress_'+file.id+'">'+_("排队中")+'</div><div class="f-l size" id="size_'+file.id+'"><span id="file_send_'+file.id+'"></span>'+Util.formatBytes(file.size)+'</div><div class="f-l time" id="time_'+file.id+'"></div><div class="op"><a class="cancelUploadBtn f-l op-btn upload-cancel" id="cancel_'+file.id+'" calcelId="'+file.id+'" href="javascript:;"></a></div><div class="max-progress" id="max_process_'+file.id+'"></div><div class="clear"></div></div>';ul=$(".upload-task-list .file-list");var index=files.length;files.push({file:file,path:self.path,path_type:self.path_type,from:self.from,prefix_neid:self.prefix_neid}),self.taskIsView||(self.taskIsView=!0,self.taskView(!0)),g.filesIndex[file.id]=index,self.total++,ul.append(_html)},updateMinProgress:function(percent){if("0px"!=$(".upload-task-list").css("bottom")){var maxWidth=$(".upload-task-list").width();$(".min-progress").css({width:percent*maxWidth/100+"px"})}else $(".min-progress").css({width:"0px"})},taskView:function(isshow){var self=this;isshow?"0px"!=$(".upload-task-list").css("bottom")&&$(".upload-task-list").animate({bottom:"0px"},function(){$("#set-min").html("—")}):(self.taskIsView=!1,$(".upload-task-list").animate({bottom:-($(".upload-task-list").height()+2)+"px"}))},closeAllTask:function(){var self=this;for(self.cache.instance.stopUpload();self.cache.instance.getStats().files_queued>0;)self.cache.instance.cancelUpload();self.total=0,self.succeed=0,self.cache.files=[],self.cache.filesIndex={},self.cache.processes=[],self.current=0,self.completed=0,$(".upload-task-list .file-list").empty(),self.taskView(!1)},netWorkError:function(){{var self=this,g=self.cache,files=g.files;g.processes}for(self.cache.instance.stopUpload();self.cache.instance.getStats().files_queued>0;)self.cache.instance.cancelUpload();null!=self.ui&&self.ui.message(_("网络连接错误，请稍后重试"));for(var i in files){var file=files[i].file;$("#progress_"+file.id).addClass("error").html(_("已取消")),$("#time_"+file.id).remove(),$("#size_"+file.id).remove(),$("#cancel_"+file.id).remove(),$("#max_process_"+file.id).css({width:"0px"})}},start:function(queuedNum){var self=this,g=self.cache,files=g.files;self.current=files.length-queuedNum,self.bindEvent(),self.updateUplode(),self.startTime=new Date,self.loadBytes=0},bindEvent:function(){var self=this;$(".upload-task-list .cancelUploadBtn").unbind("click").click(function(e){return self.cancelUploadFile($(this).attr("calcelId")),e.stopPropagation(),e.preventDefault(),!1}),$(".upload-task-list #cancelAll").unbind("click").click(function(){self.closeAllTask()})},cancelUploadFile:function(fileId){var self=this;fileId?(self.cache.instance.cancelUpload(fileId),$("#progress_"+fileId).html(_("已取消")),$("#cancel_"+fileId).removeClass("upload-success upload-cancel").addClass("upload-error"),$("#size_"+fileId).html(""),$("#time_"+fileId).html(""),$("#filename_"+fileId).addClass("error"),$("#max_process_"+fileId).css({width:"0px"}),self.succeed++,self.current++,self.updateUplode()):self.closeAllTask(),self.startUpload()},startUpload:function(){var self=this,g=self.cache,files=g.files,_file=(g.processes,files[self.current]);if(!(self.current>=files.length)){var file=_file.file,path=_file.path,path_type=_file.path_type,from=_file.from,prefix_neid=_file.prefix_neid;file&&self.checkNetWork(function(){self.isDelivery?AuthUploadManager.authDeliveryUpload(function(data){self.uploadCall(data,file)},self.deliveryCode,path,file.size,self.token):AuthUploadManager.authUpload(function(data){self.uploadCall(data,file)},path,path_type,from,file.size,prefix_neid)})}},uploadCall:function(data,file){var self=this;200==data.code&&"undefined"!=typeof data.data.result&&"success"==data.data.result?self.cache.instance.startUpload(file.id):(self.fail(file,data),self.startUpload())},setPostParams:function(path,path_type,from,prefix_neid){var self=this;self.path=path,self.path_type=path_type,self.from=from,self.prefix_neid=prefix_neid;var post_params={path:path,path_type:path_type,uid:Util.getUserID()};from&&(post_params.from=from),/^share/.test(path_type)&&parseInt(prefix_neid)>0&&(post_params.prefix_neid=prefix_neid),self.cache.instance.flashReady(function(){self.cache.instance.setPostParams(post_params)}),self.fire("loadready")},getPostParams:function(){var self=this,g=self.cache,files=g.files,_file=(g.processes,files[self.current]);return{path:_file.path,path_type:_file.path_type,from:_file.from,prefix_neid:_file.prefix_neid}},update:function(file,percent,bytesLoaded,total){var self=this,g=self.cache,useTime=(g.files,g.processes,(new Date).getTime()-self.startTime.getTime());if($(".max-progress").css({width:"0px"}),self.updateMinProgress(percent),(useTime>1e3||0==self.loadBytes)&&($("#time_"+file.id).html(self.makeTime(bytesLoaded,total,useTime)),self.loadBytes=bytesLoaded,self.startTime=new Date),percent){var tw=$(".upload-task-list .file-list").width();$("#max_process_"+file.id).css({width:tw*percent/100+"px"}),100>percent?($("#progress_"+file.id).html(percent+"%"),$("#upload_progress").html("("+percent+"%)")):($("#progress_"+file.id).html(_("正在入库...")),$("#upload_progress").html("("+_("正在入库...")+")")),$("#file_send_"+file.id).html(Util.formatBytes(bytesLoaded)+"/")}},makeTime:function(loadBytes,total,useTime){var self=this,time=Util.formatTime((total-loadBytes)/(1e3*(loadBytes-self.loadBytes)/useTime));return parseInt(time)>0?time:Util.formatTime(0)},complete:function(file,data){{var self=this,g=self.cache;g.filesIndex,g.processes}self.succeed++,self.current++,self.startTime=new Date,self.updateUplode(),$("#cancel_"+file.id).unbind("click").removeClass("upload-error upload-cancel").addClass("upload-success"),setTimeout(function(){$("#progress_"+file.id).html(data.has_more_version?_("已完成，覆盖同名文件"):_("已完成")),$("#size_"+file.id).html(""),$("#time_"+file.id).html(""),$(".upload-task-list .file-list .max-progress").css({width:"0px"})},300),Tips.show(file.name+_("已上传成功")),self.startTime=new Date,self.flushPage(),self.flushCount++,self.loadBytes=0},next:function(){{var self=this,g=self.cache,processes=(g.files,g.processes);processes[self.current]}self.completed++,self.current++},getCurrentFileName:function(){var self=this,g=self.cache,files=g.files,file=(g.processes,files[self.current]);return file.file.name},fail:function(file,data){{var self=this,g=self.cache;g.filesIndex,g.processes}self.succeed++,self.current++,self.updateUplode(),self.cache.instance.cancelUpload(file.id),setTimeout(function(){$("#progress_"+file.id).addClass("error").html(data.message),$("#time_"+file.id).remove(),$("#size_"+file.id).remove(),$("#max_process_"+file.id).css({width:"0px"}),$("#cancel_"+file.id).unbind("click").removeClass("upload-error upload-cancel upload-success").remove()},300)},updateUplode:function(){var self=this;if($(".upload-task-list .file-list").scrollTop($(".upload-task-list .file-list .task-file").height()*(self.succeed-1)),self.getState().idle){$("#upload_txt").html(_("已完成")),$("#total_count").html(""),$("#upload_progress").html("");var minInt=$(".upload-task-list .min-show").height()-$(".upload-task-list").height()+1;$(".upload-task-list").animate({bottom:minInt+"px"},function(){self.taskIsView=!1,$("#set-min").html("口")})}else $("#upload_txt").html(_("正在上传")+":"),$("#total_count").html(self.succeed+"/"+self.total)},getState:function(){var self=this;try{var st=self.cache.instance.getStats(),state={};return state.idle=0==st.files_queued&&0==st.in_progress?!0:!1,state.stats=st,state}catch(e){}},flushPage:function(){{var self=this,g=self.cache,files=g.files;g.processes}self.current>=files.length-1?self.fire("completeOne"):(new Date).getTime()-self.flushTime>5e3&&self.flushCount>=5&&(self.flushTime=(new Date).getTime(),self.flushCount=0,self.fire("completeOne"))},checkNetWork:function(call){var self=this;Util.ajax_json_get("/st.php?_="+(new Date).getTime(),function(xhr){200==xhr.status?call():self.netWorkError()})}}),FielUploadList}),define("component/fileUploadDialog/index",function(require,exports){function FileUploadDialog(folder,uploadURL,path_type,from){this.folder=folder,this.uploadURL=uploadURL,this.type=path_type,this.from=from,this._init()}{var $=require("jquery"),SwfUploadUI=(require("component/dialog"),require("component/fileUploadDialog/swfUploadUI")),EventTarget=require("eventTarget");require("util"),require("component/progressbar")}require("i18n");$.i18n.prop;return $.extend(FileUploadDialog.prototype,EventTarget,{_init:function(){var self=this,uploadUI=new SwfUploadUI("body",self.uploadURL);self.uploadUI=uploadUI,uploadUI.init(self.folder,self.type,self.from),uploadUI.on("completeOne",function(){self.fire("completeOne")}),uploadUI.on("loadready",function(){self.fire("loadready")})},setFolder:function(folder,type,from,prefix_neid){var self=this;self.folder=folder,self.type=type,self.uploadUI&&self.uploadUI.preparePath(folder,type,from,prefix_neid)},show:function(){var self=this;self.dialog},getState:function(){var self=this;return self.uploadUI.getState()}}),FileUploadDialog}),define("component/fileUploadDialog/swfUploadBuilder",function(require,exports){function SwfUploadBuilder(node,eventManager,opt){var DEFAULT={single:!1,image:!1,buttonText:!1};opt=$.extend(DEFAULT,opt);var language=$.cookie("language"),imageUrl="en"==language?"/css/theme/default/img/upload-en.png":"/css/theme/default/img/upload-zh.png";this.setting={upload_url:"",button_action:opt.single?-100:-110,file_size_limit:"1048576",file_types:opt.fileType||"*.*",file_types_description:"All Files",file_upload_limit:"10000",file_queue_limit:"0",moving_average_history_size:40,file_dialog_start_handler:eventManager.fileDialogStart,file_queued_handler:eventManager.fileQueued,file_queue_error_handler:eventManager.fileQueueError,file_dialog_complete_handler:eventManager.fileDialogComplete,upload_start_handler:eventManager.uploadStart,upload_progress_handler:eventManager.uploadProgress,upload_error_handler:eventManager.uploadError,upload_success_handler:eventManager.uploadSuccess,upload_complete_handler:eventManager.uploadComplete,swfupload_loaded_handler:eventManager.loadReady,button_image_url:opt.image||imageUrl,button_placeholder_id:node,button_width:"80",button_height:"32",button_text:"",button_text_style:".theFont {font-size: 14px; color:#ffffff; font-weight: bold; cursor: pointer;}",button_text_left_padding:40,button_text_top_padding:8,button_cursor:SWFUpload.CURSOR.HAND,button_window_mode:"transparent",flash_url:"/resource/swfupload.swf?rev=20141124",prevent_swf_caching:!1,debug:!1}}var $=require("jquery");require("cookie"),require("i18n");$.i18n.prop;require("swfupload/swfupload.js"),require("swfupload/plugins/swfupload.queue.js"),require("swfupload/plugins/swfupload.speed.js");var flashCheckDialog=require("component/flashCheckDialog");return $.extend(SwfUploadBuilder.prototype,{setProperty:function(key,value){this.setting[key]=value},build:function(){return $.each(SWFUpload.instances,function(i,is){is.destroy()}),flashCheckDialog.checkFlash()?new SWFUpload(this.setting):null}}),SwfUploadBuilder}),define("component/fileUploadDialog/swfUploadUI",function(require,exports){function SwfUploadUI(container,uploadURL){this.node="string"==$.type(container)?$(container):container,this.uploadURL=uploadURL,this.instance=null,this.succeed=0}var $=require("jquery"),Util=(require("cookie"),require("util")),SwfUploadBuilder=require("component/fileUploadDialog/swfUploadBuilder"),EventTarget=require("eventTarget"),FileUploadList=require("component/fileUploadDialog/fileUploadList"),ConfirmDialog=require("component/confirmDialog");require("i18n");var _=$.i18n.prop;return $.extend(SwfUploadUI.prototype,EventTarget,{init:function(folder,path_type,from){var self=this;self.directory=folder;var swf,filelist,box=$('<div class="upload-task-list"><div class="min-show"><div class="bar-line-5"></div><div class="bar-title"><div class="min-progress"></div><div class="max-title f-l"><span id="upload_txt">'+_("正在上传")+':</span><span id="total_count"></span><span id="upload_progress"></span></div><div class="f-r op"><span id="set-min">—</span><span id="close-upload-task-list">×</span></div></div></div><div class="line-1"></div><div class="task-title"><div class="f-l file">'+_("文件")+'</div><div class="f-l progress">'+_("进度")+'</div><div class="f-l size">'+_("大小")+'</div><div class="f-l time">'+_("剩余时间")+'</div><div class="f-l"><a class="btn" id="cancelAll" href="javascript:;">'+_("取消所有")+'</a></div></div><div class="error-handle"><div class="message">文件过大</div></div><div class="line-1"></div><div class="file-list"></div></div>'),EventManager={fileDialogStart:function(){},fileQueued:function(file){filelist.add(file)},fileDialogComplete:function(numFilesSelected,numFilesQueued){if(numFilesQueued>0){var status=this.getStats();0==status.in_progress&&(void 0!==self.tempDirectory&&(self.directory=self.tempDirectory),filelist.start(numFilesQueued),swf.setUploadURL(self.makeURL()),filelist.startUpload())}},uploadStart:function(file){Util.sendLog("flags=startupload","filename="+file.name,"filesize="+file.size)},uploadProgress:function(file,bytesLoaded,bytesTotal){var percent=Math.ceil(bytesLoaded/bytesTotal*100);filelist.update(file,percent,bytesLoaded,bytesTotal)},uploadSuccess:function(file,serverData,code){Util.sendLog("flags=successupload","filename="+file.name,"averageSpeed="+file.averageSpeed,"filesize="+file.size,"timeElapsed="+file.timeElapsed);var data=$.parseJSON(serverData);data.type&&"error"==data.type?filelist.fail(file,data):(filelist.complete(file,data),Util.sendBuridPointRequest(),self.fire("uploadSuccess",file,filelist.current+1,filelist.total),self.succeed++)},uploadComplete:function(){0===this.getStats().files_queued||(swf.setUploadURL(self.makeURL()),filelist.startUpload())},fileQueueError:function(file,errorCode,message){Util.sendLog("flags=queueerror","errcode="+errorCode,"filename="+file.name,"averageSpeed="+file.averageSpeed,"filesize="+file.size,"timeElapsed="+file.timeElapsed);try{switch(file.name&&void 0==file.size&&errorCode==SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE&&(errorCode=SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT),errorCode){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:self.message(_("文件超过1G了，请使用")+'<a href="/client/windows/bin/LenovoBox.zip">'+_("客户端</a>上传"));break;case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE:if("File is zero bytes or cannot be accessed and cannot be uploaded."==message&&/msie/.test(navigator.userAgent.toLowerCase())){self.message(_("你选择的文件过多，请使用")+'<a href="/client/windows/bin/LenovoBox.zip">'+_("客户端</a>上传"));break}self.message(_("您选择了一个空文件，换个试试")),this.debug("Error Code: Zero byte file, File name: "+file.name+", File size: "+file.size+", Message: "+message);break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:self.message(_("不能上传")+file.name+",文件类型不允许"),this.debug("Error Code: Invalid File Type, File name: "+file.name+", File size: "+file.size+", Message: "+message);break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:self.message("亲，歇会儿，你已经传了100个了");break;default:null!==file&&self.message(_("很抱歉，您的操作失败了，建议您重试一下！")),this.debug("Error Code: "+errorCode+", File name: "+file.name+", File size: "+file.size+", Message: "+message)}}catch(ex){this.debug(ex)}},loadReady:function(){filelist.setPostParams(self.directory,path_type,self.filelist.from,self.filelist.prefix_neid)},uploadError:function(file,errorCode,message){Util.sendLog("flags=uploaderror","errcode="+errorCode,"filename="+file.name,"averageSpeed="+file.averageSpeed,"filesize="+file.size,"timeElapsed="+file.timeElapsed);try{try{message=$.parseJSON(message)}catch(err){message={errorCode:message,message:message}}switch(errorCode){case SWFUpload.UPLOAD_ERROR.HTTP_ERROR:message.message=_("网络连接错误，请稍候重试！"),"400"==message?message={message:_("路径太长，最长支持255个字符！")}:"403"==message?message={message:_("没有权限，目标文件禁止该操作。")}:"405"==message?message={message:_("空间不足，无法完成操作！请联系管理员。")}:"401"==message&&(message={message:_("The token dose not exist or has already expired")}),filelist.fail(file,message);break;case SWFUpload.UPLOAD_ERROR.MISSING_UPLOAD_URL:filelist.fail(file,message);break;case SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED:filelist.fail(file,message);break;case SWFUpload.UPLOAD_ERROR.IO_ERROR:message.message=_("网络连接错误，请稍候重试！"),filelist.fail(file,message);break;case SWFUpload.UPLOAD_ERROR.SECURITY_ERROR:message.message=_("上传失败，请重试！")+"(#2049)",filelist.fail(file,message);break;case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED:filelist.fail(file,message);break;case SWFUpload.UPLOAD_ERROR.SPECIFIED_FILE_ID_NOT_FOUND:filelist.fail(file,message);break;case SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED:filelist.fail(file,message);break;case SWFUpload.UPLOAD_ERROR.FILE_CANCELLED:break;case SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED:filelist.fail(file,_("已取消"));break;default:"Error #2049"==message?filelist.fail(file,_("上传失败，请重试！")+"(#2049)"):"Error #2038"==message?filelist.fail(file,_("网络连接错误，请稍候重试！")):filelist.fail(file,message)}}catch(ex){this.debug(ex)}}};swf=new SwfUploadBuilder("swfupload-holder",EventManager).build(),swf&&(filelist=new FileUploadList(box,swf,folder,path_type),self.instance=swf,filelist.on("uploadSuccess",function(){self.fire("uploadSuccess")}),filelist.on("completeOne",function(){self.fire("completeOne")}),self.filelist=filelist,self.filelist.ui=self,0==$(".upload-task-list").length&&(self.node.append(box),this.bindEvent(swf)),self.filelist.on("loadready",function(){self.fire("loadready")}))},bindEvent:function(swf){var self=this;$("#set-min").unbind("click").click(function(){self.slideDownFileList()}),$("#close-upload-task-list").unbind("click").click(function(){var st=self.getState(swf);if(st.idle)self.closeAllTask();else{var content={title:_("提示"),content:_("确认取消所有未上传的任务?")};new ConfirmDialog(content,function(){self.closeAllTask()})}})},closeAllTask:function(){var self=this;self.filelist.closeAllTask()},slideDownFileList:function(){if("0px"==$(".upload-task-list").css("bottom")){var minInt=$(".upload-task-list .min-show").height()-$(".upload-task-list").height()+1;$(".min-progress").css({width:"0px"}),$(".upload-task-list").animate({bottom:minInt+"px"},function(){$("#set-min").html("口")})}else $(".upload-task-list").animate({bottom:"0px"},function(){$("#set-min").html("—")})},setDelivery:function(isDelivery,deliveryCode,token){var self=this;self.filelist&&(self.filelist.isDelivery=isDelivery,self.filelist.token=token,self.filelist.deliveryCode=deliveryCode)},makeURL:function(){var self=this,params=[],name=self.filelist.getCurrentFileName(),param=self.filelist.getPostParams(),dir=param.path.replace(/^\//,"");""!=dir&&(dir+="/");var data={directory:dir,file:name},tempURL=self.uploadURL.replace(/\{([^\}]+)\}/g,function(s0,s1){return data[s1]});tempURL+=(new Date).getTime(),tempURL=encodeURI(tempURL),tempURL=tempURL.replace(/#/g,"%23");for(var i in param)("from"!=i||null!=param[i])&&("prefix_neid"!=i||void 0!=param[i])&&"path"!=i&&params.push(i+"="+param[i]);return tempURL+=-1!==tempURL.indexOf("?")?"&"+params.join("&"):"?"+params.join("&")},preparePath:function(path,path_type,from,prefix_neid){var self=this;self.tempDirectory=path,self.directory=path,self.filelist&&(self.filelist.path=path,self.filelist.from=/^share/.test(path_type)?from:"",self.filelist.path_type=path_type,self.filelist.prefix_neid=prefix_neid,self.filelist.setPostParams(path,path_type,self.filelist.from,prefix_neid))},message:function(msg){var self=this,msgh=self.node.find(".upload-task-list .error-handle");msgh.find(".message").empty().html(msg),msgh.show(),self.filelist.taskView(!0),setTimeout(function(){msgh.fadeOut(1e3),self.getState(self.instance).idle&&self.filelist.taskView(!1)},5e3)},getState:function(swf){var self=this;try{if(swf)var st=swf.getStats();else var st=self.instance.getStats();var state={};return state.idle=0==st.files_queued&&0==st.in_progress?!0:!1,state.stats=st,state}catch(e){}}}),SwfUploadUI}),define("component/filesearchbox",function(require,exports,module){function FileSearchBox(node,func){this.node=$(node),this.callback=func,this.render()}return SearchController=require("lenovodata/searchController"),require("calendar"),FileSearchBox.prototype={render:function(){var template=$(['<div class="search-area-box"><input id="search-input" placeholder='+_("搜索文件")+">",'<i id="search-btn" class="icon i-search" title="'+_("搜索")+'"></i>','<span class="search-more"><span class="arrow"></span></span></div>'].join(""));this.node.empty(),this.node.append(template),this.node.append($("#template_sinior_search").html()),this.bindEvent()},bindEvent:function(){function searchBoxShow(){$("#searchBox").stop(!1,!0).slideDown(),onOff=!1}function searchBoxHide(){$(".gldp-default").hide(),$("#searchBox").stop(!1,!0).slideUp(),onOff=!0}var self=this,onOff=!0,timer=null;self.node.on("mouseleave",function(ev){clearTimeout(timer),timer=setTimeout(function(){searchBoxHide()},2e3)}),self.node.on("mouseenter",function(ev){clearTimeout(timer)}),$("#type").mouseenter(function(){clearTimeout(timer)}),self.node.delegate(".search-more","click",function(ev){onOff?searchBoxShow():searchBoxHide(),$("#startDate").calendar({onClick:function(el,cell,date,data){el.val(Util.formatDate(date,"yyyy-MM-dd"))}}),$("#endDate").calendar({onClick:function(el,cell,date,data){el.val(Util.formatDate(date,"yyyy-MM-dd"))}}),$(".gldp-default").on("mouseenter",function(ev){clearTimeout(timer)}),$(".gldp-default").on("mouseleave",function(ev){$(".gldp-default").hide()})});var searchbtn=$("#search-btn"),sinput=$("#search-input");$("#gosearch").on("click",function(){var val=$.trim(sinput.val()),desc=$("#searchBox").find("#desc")[0].checked?!0:!1,size_start=$("#searchBox").find(".size").eq(0).val(),size_end=$("#searchBox").find(".size").eq(1).val();if(""!=size_start&&!Util.validNumber(size_start))return void Tips.warn(_("[起始大小]：请输入正确的数字"));if(""!=size_end&&!Util.validNumber(size_end))return void Tips.warn(_("[结束大小]：请输入正确的数字"));if(size_start&&size_end&&parseInt(size_start)>parseInt(size_end))return void Tips.warn(_("结束大小必须大于起始大小"));var time_start=$("#startDate").val(),time_end=$("#endDate").val();if(new Date(time_start.replace(/\-/g,"/"))>new Date(time_end.replace(/\-/g,"/")))return void Tips.warn(_("结束日期必须大于开始日期"));time_start&&(time_start+=" 00:00:00"),time_end&&(time_end+=" 23:59:59");var creator=$(".creator").val(),filetype=$("#searchBox #type").val();if(path&&(self.path=path),searchbtn.hasClass("i-search"))var val=$.trim(sinput.val());searchbtn.removeClass("i-search").addClass("i-close2"),searchBoxHide(),self.callback&&self.callback(!0),Util.sendDirectlyRequest("搜索","高级搜索","-"),SearchController(window.fileManager,"file",val,size_start,size_end,time_start,time_end,creator,filetype,desc)}),searchbtn.on("click",function(e){var me=$(this);if(me.hasClass("i-close2"))self.callback&&self.callback(!1),searchbtn.removeClass("i-close2").addClass("i-search"),window.fileManager.browse(window.fileManager.path||"/",self.cssAction);else{var val=$.trim(sinput.val());""!=val&&(self.callback&&self.callback(!0),searchbtn.removeClass("i-search").addClass("i-close2"),Util.sendDirectlyRequest("搜索","普通搜索","-"),SearchController(window.fileManager,"file",val))}}),sinput.on("keydown",function(e){if(!searchbtn.hasClass("i-close2")&&13==e.keyCode){var val=$.trim(sinput.val());""!=val&&(self.callback&&self.callback(!0),searchbtn.removeClass("i-search").addClass("i-close2"),Util.sendDirectlyRequest("搜索","普通搜索","-"),SearchController(window.fileManager,"file",val))}}).on("focus",function(e){self.node.addClass("searchboxfocus")}).on("blur",function(e){self.node.removeClass("searchboxfocus")})}},FileSearchBox}),define("component/flashCheckDialog",function(require,exports,module){function flashCheckDialog(){}var $=require("jquery"),Dialog=require("component/dialog");require("i18n");var _=$.i18n.prop;return $.extend(flashCheckDialog.prototype,{checkFlash:function(){var hasFlash=0;try{if(document.all){var swf=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");swf&&(hasFlash=1)}else if(navigator.plugins&&navigator.plugins.length>0){var swf=navigator.plugins["Shockwave Flash"];swf&&(hasFlash=1)}}catch(ex){hasFlash=0}return 0==hasFlash&&this.unFlashEvent(),document.getElementById("upload_button")&&($(window).resize(function(){$(".uploadButton").css("left",Util.getElementXPos(document.getElementById("upload_button"))).show()}),$(".uploadButton").css("left",Util.getElementXPos(document.getElementById("upload_button"))).show()),1==hasFlash?!0:!1},unFlashEvent:function(){var self=this;$(".uploadButton").unbind("click").click(function(){self.show()}),$("#uploadButton").unbind("click").click(function(){self.show()}),$("body").undelegate("#delivery-copy","click").delegate("#delivery-copy","click",function(){self.show()}),$(".uploadButton2").unbind("click").click(function(){self.show()})},show:function(){var dialog=new Dialog(_("提示"),{mask:!0,minWidth:500},function(dialog){dialog.append('<div class="lui-alertDialog" style="width:500px"><div class="cell2"><div class="cell1"></div>要使用该功能，您需要安装Flash插件, 猛击<a target="_blank" style="color:#2A7EF9;" href="http://get.adobe.com/cn/flashplayer/">这里</a>安装</div></div><div class="dialog-button-area"><a class="dialog-button confirm-cancel cancel">'+_("关闭")+"</a></div>")});$(".confirm-cancel").click(function(){dialog.close()})}}),new flashCheckDialog}),define("component/galleryslide/base",function(require,exports){function GallerySlide(config,imageId){var _CONFIG={node:"",data:[],ratio:1.375,scroll:"vertical",imageMargin:8,borderWidth:8};this.imageId=imageId?imageId:0,this.cfg=$.extend(_CONFIG,config),MARGIN=this.cfg.imageMargin,BORDER_WIDTH=this.cfg.borderWidth,this.cache={};var cache=this.cache;cache.current=0,cache.total=this.cfg.data.total||0;var nstr=this.cfg.node;this.node="string"==$.type(nstr)?$(nstr):nstr,this._init(imageId)}var $=require("jquery"),EventTarget=require("eventTarget");require("mustache");var MARGIN,BORDER_WIDTH;return $.extend(GallerySlide.prototype,EventTarget,{_init:function(imgId){var gs,sc,cnt,ib,prev,next,pw,ph,nw,nh,imgW,imgH,v_template='<div class="lui-gallerySlide"><div class="gs-vertical"><div class="prev"><div class="prev-arrow"></div></div><div class="content-wraper"><div class="gsContent"><div class="img-border"></div></div></div><div class="next"><div class="next-arrow"></div></div></div></div>',h_template='<div class="lui-gallerySlide"><div class="gs-horizontal"><div class="content-wraper"><div class="gsContent"><div class="img-border"></div></div></div></div></div>',self=this,node=self.node,cfg=self.cfg,cache=self.cache,data=cfg.data,vw=node.width(),vh=node.height();if("vertical"==cfg.scroll){gs=$(v_template),gs.appendTo(node),sc=$(".content-wraper",gs),cnt=$(".gsContent",gs),ib=$(".img-border",gs),prev=$(".prev",gs),next=$(".next",gs),pw=prev.outerWidth(),ph=prev.outerHeight(),nw=next.outerWidth(),nh=next.outerHeight(),gs.width(vw),gs.height(vh),sc.css({top:ph,left:0}),sc.width(vw);var tw=vw,th=vh-ph-nh;cnt.width(tw),imgW=tw,imgH=Math.round(imgW/cfg.ratio),cnt.height(data.total*imgH),cache.totalCount=Math.floor(th/imgH);var totalHeight=cache.totalCount*imgH;sc.height(totalHeight),sc.css("top",ph+(th-totalHeight)/2)}else{gs=$(h_template),gs.appendTo(node),sc=$(".content-wraper",gs),cnt=$(".gsContent",gs),ib=$(".img-border",gs),prev=$(".prev",gs),next=$(".next",gs),pw=prev.outerWidth(),ph=prev.outerHeight(),nw=next.outerWidth(),nh=next.outerHeight(),gs.width(vw),gs.height(vh),sc.css({left:pw,top:0}),sc.height(vh);var tw=vw-pw-nw,th=vh;cnt.height(th),imgH=91,imgW=121,cnt.width(data.total*imgW),cache.totalCount=Math.floor(tw/imgW);var totalWidth=cache.totalCount*imgW;sc.width(totalWidth),sc.css("left",pw+(tw-totalWidth)/2),cnt.width()<totalWidth&&cnt.css("left",(totalWidth-cnt.width())/2)}top.window.LenovoData&&(ib.width(imgW-BORDER_WIDTH-MARGIN+2),ib.height(imgH-BORDER_WIDTH-MARGIN+2)),ib.css({left:MARGIN/2,top:MARGIN/2}),cache.current=self.imageId,cache.currentId=data.list[self.imageId].id,cache.center=Math.ceil(cache.totalCount/2)-1,cache.half=cache.totalCount-cache.center-1,cache.imgW=imgW,cache.imgH=imgH,cache.initFlag=!1,prev.on("click",function(){self.prev()}),next.on("click",function(){self.next()}),window.onresize=function(){var o=data.list[self.cache.current];

self._preLoadImage(o.id,o.originPath,function(id,url,width,height){var ot=self._clone(data.list[self.cache.current]);ot.id==id&&(ot.url=url,ot.width=width,ot.height=height,ot.total=data.total,ot.index=self.cache.current+1,self.fire("change",ot))})}},myEncodeURI:function(url){return url=url.replace(/#/g,"%23"),url+="&_="+(new Date).getTime()},_initPhotos:function(){for(var template='<span class="gsImageWraper"><img class="gsImage" id="{{id}}" src="{{thumbnails}}"/></span>',frag=document.createDocumentFragment(),self=this,node=self.node,cfg=self.cfg,cache=self.cache,data=cfg.data,i=0,ii=data.list.length;ii>i;i++){var obj=data.list[i];obj.thumbnails=self.myEncodeURI(obj.thumbnails);var imgWrap=$(Mustache.render(template,obj));imgWrap.width(cache.imgW),imgWrap.height(cache.imgH),imgWrap.attr("dataIndex",i);var img=$(".gsImage",imgWrap);imgWrap.appendTo(frag);var imageReady=function(){var list=[],intervalId=null;return tick=function(){for(var i=0;i<list.length;i++)list[i].end?list.splice(i--,1):list[i]();!list.length&&stop()},stop=function(){clearInterval(intervalId),intervalId=null},function(url,ready,load,error){var onready,width,height,newWidth,newHeight,img=new Image;return img.src=url,img.complete?(ready.call(img),void(load&&load.call(img))):(width=img.width,height=img.height,img.onerror=function(){error&&error.call(img),onready.end=!0,img=img.onload=img.onerror=null},onready=function(){newWidth=img.width,newHeight=img.height,(newWidth!==width||newHeight!==height||newWidth*newHeight>8800)&&(ready.call(img),onready.end=!0)},onready(),img.onload=function(){!onready.end&&onready(),load&&load.call(img),img=img.onload=img.onerror=null},void(onready.end||(list.push(onready),null===intervalId&&(intervalId=setInterval(tick,40)))))}}();!function(obj,img){var changeStyle=function(){var width=this.width,height=this.height;80>height&&img.css("marginTop",(82-height)/2+4),110>width?img.css("marginLeft",(121-width)/2):width>110&&img.css("width",110)},onerror=function(){var that_imag=document.getElementById(obj.id);that_imag.src="/css/theme/default/img/index/loadfailedsmall.png",that_imag.style.marginTop="28px",that_imag.style.marginLeft="33px",that_imag.style.width="58px",that_imag.style.height="42px",that_imag.style.border=0};imageReady(obj.thumbnails,changeStyle,null,onerror)}(obj,img)}var contentNode=$(".gsContent",node);contentNode.append(frag),self.fire("loaded"),contentNode.on("click",function(e){var tar=$(e.target),par=tar.parent();if(par.hasClass("gsImageWraper")&&!cache.processing){var index=tar.parent().attr("dataIndex");cache.current=index-0,cache.currentId=tar.attr("id"),self.render(),self.fire("changeButton")}})},render:function(){var self=this,cfg=self.cfg,g=self.cache,data=cfg.data,gc=g.current,o=data.list[gc];if(g.initFlag||(g.initFlag=!0,self._initPhotos()),!(gc>data.total-1)){if(self.fire("beforeChange"),o.originPath)self._preLoadImage(o.id,o.originPath,function(id,url,width,height){var ot=self._clone(data.list[gc]);ot.id==id&&(ot.url=url,ot.width=width,ot.height=height,ot.total=data.total,ot.index=gc+1,self.fire("change",ot))});else{var ot=self._clone(data.list[gc]);self.fire("change",ot)}self._scrollToCenter()}},_scrollToCenter:function(){var et,newt,self=this,node=self.node,g=self.cache,cfg=self.cfg,data=cfg.data,border=$(".img-border",node),ele=$(".gsContent",node);if(g.processing=!0,"vertical"==cfg.scroll){var btop=g.current*g.imgH+MARGIN/2;if(border.stop().animate({top:btop},500,"swing",function(){}),et=ele.css("top").slice(0,-2)-0,g.current<g.center){var rdis,dis=g.center-g.current,diff=g.center-g.totalCount+g.half+1;0>diff?rdis=0:(rdis=dis>diff?diff:dis,g.center=g.center-rdis),newt=et+rdis*g.imgH,ele.stop().animate({top:newt},300,"swing",function(){g.processing=!1})}else{var rdis,dis=g.current-g.center,diff=g.center+g.half;if(diff>=data.total-1)rdis=0;else{var tc=data.total-1-diff;rdis=dis>tc?tc:dis,g.center=g.center+rdis}newt=et-rdis*g.imgH,ele.stop().animate({top:newt},300,"swing",function(){g.processing=!1})}}else{var bleft=g.current*g.imgW+MARGIN/2;if(border.stop().animate({left:bleft},500,"swing",function(){}),et=ele.css("left").slice(0,-2)-0,g.current<g.center){var rdis,dis=g.center-g.current,diff=g.center-g.totalCount+g.half+1;0>diff?rdis=0:(rdis=dis>diff?diff:dis,g.center=g.center-rdis),newt=et+rdis*g.imgW,ele.stop().animate({left:newt},300,"swing",function(){g.processing=!1})}else{var rdis,dis=g.current-g.center,diff=g.center+g.half;if(diff>=data.total-1)rdis=0;else{var tc=data.total-1-diff;rdis=dis>tc?tc:dis,g.center=g.center+rdis}newt=et-rdis*g.imgW,ele.stop().animate({left:newt},300,"swing",function(){g.processing=!1})}}},_preLoadImage:function(id,url,callback){var img=new Image,self=this;img.src=self.myEncodeURI(url),img.complete?callback(id,self.myEncodeURI(url),img.width,img.height):(img.onload=function(){callback(id,self.myEncodeURI(url),img.width,img.height),img.onload=null},img.onerror=function(){callback(id,"/css/theme/default/img/index/loadfailed.png",84,60)})},next:function(){var self=this,cache=self.cache,data=self.cfg.data;cache.processing||cache.current<data.total-1&&(cache.current++,cache.currentId=data.list[cache.current].id,self.render())},prev:function(){var self=this,cache=self.cache,data=self.cfg.data;cache.processing||cache.current>0&&(cache.current--,cache.currentId=data.list[cache.current].id,self.render())},_clone:function(source){var obj={};for(var key in source)obj[key]=source[key];return obj},_scalePhoto:function(w,h,iw,ih){var scale,size={};return iw>w?(size.width=w,scale=w/iw,size.height=ih*scale):(size.width=iw,size.height=ih),size.height>h&&(size.height=h,scale=h/ih,size.width=iw*scale),size}}),GallerySlide}),define("component/galleryslide/photogallery",function(require,exports){function PhotoGallery(data,currentId){this.cache={};var mask=(this.cache,$('<div class="lui-mask"></div>')),template='<div class="lui-photoGallery"><div class="image-info"><span class="right-info"><span class="photo-title"></span><span class="photo-description"></span><span>(</span><span class="page"></span><span>)</span></span><div class="left-tool"><span class="icon i-close"></span></div></div><div style="clear:both;"></div><div class="center-content"><div class="prev"><div class="prev-arrow"></div></div><div class="next"><div class="next-arrow"></div></div><img class="pgImage" src="img/loading5.gif" alt="" title=""/></div><div style="clear:both;"></div><div class="right-slide"></div></div>',node=$(template);data.mask||mask.appendTo($("body")).fadeIn(600),node.appendTo($("body")).fadeIn(600),this.node=node,this.mask=mask,this.data=data,this.currentId=currentId,this._init()}var $=require("jquery"),EventTarget=require("eventTarget"),GallerySlide=require("./base.js");return $.extend(PhotoGallery.prototype,EventTarget,{_init:function(){function doProcessIe(e){var pw=$(".pgImage",pg).parent().width(),ph=$(".pgImage",pg).parent().height(),size=self._scalePhoto(pw,ph,e.width,e.height),newImg=$("<img class='pgImage' src="+e.url+">");newImg.attr("alt",e.name),newImg.width(size.width),newImg.height(size.height),newImg.css({left:(pw-size.width)/2,top:(ph-size.height)/2}),imgParent.find(".pgImage").remove(),imgParent.append(newImg);var title=$(".photo-title",pg),desc=$(".photo-description",pg),page=$(".page",pg);title.text(e.name),desc.text(e.description),page.html(e.index+"/"+e.total)}var self=this,pg=self.node,data=(self.cache,self.data),holder=$(".right-slide",pg),img=$(".pgImage",pg),imgParent=img.parent(),prev=$(".prev-arrow",pg),next=$(".next-arrow",pg),pw=($(".center-content",pg),imgParent.width()),ph=imgParent.height();img.css({left:(pw-58)/2,top:(ph-10)/2}),$(".i-close",pg).on("click",function(){top.window.previewData?(top.window.previewData=null,$(top.window.document.getElementById("lui-mask-iframe")).remove(),$(top.window.document.getElementById("web_iframediv")).remove()):(window.open("","_self",""),window.close())}),$(".icon",pg).hover(function(){$(this).css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -372px -21px"})},function(){$(this).css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -404px -21px"})});var gs=new GallerySlide({node:holder,data:data,scroll:"horizontal"},self.currentId);gs.on("beforeChange",function(e){$.browser&&$.browser.msie&&(Anim.stop(img),new Anim(img,{opacity:.4},.3,"easeBothStrong",function(){}).run())});gs.on("change",function(e){doProcessIe(e)}),gs.render(),prev.on("click",function(e){gs.prev(),e.preventDefault(),e.stopPropagation()}),next.on("click",function(e){gs.next(),e.preventDefault(),e.stopPropagation()}),gs.cache.total>1&&next.css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -83px 0"}),gs.on("changeButton",function(){if(gs.cache.total>1){var cindex=gs.cache.current,total=gs.cache.total;0==cindex?(next.css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -83px 0"}),prev.css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -163px 0"})):cindex==total-1?(next.css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat 0px 0"}),prev.css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -245px 0"})):(next.css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -83px 0"}),prev.css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -245px 0"}))}}),prev.hover(function(){gs.cache.total>1&&0!=gs.cache.current&&$(this).css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -205px 0"})},function(){gs.cache.total>1&&0!=gs.cache.current?$(this).css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -245px 0"}):gs.cache.total>1&&0==gs.cache.current&&$(this).css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -163px 0"})}),next.hover(function(){gs.cache.total>1&&gs.cache.current!=gs.cache.total-1&&$(this).css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -42px 0"})},function(){gs.cache.total>1&&gs.cache.current!=gs.cache.total-1?$(this).css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat -83px 0"}):gs.cache.total>1&&gs.cache.current==gs.cache.total-1&&$(this).css({background:"url(css/theme/default/img/index/icon_preview.png) no-repeat 0px 0"})})},_scalePhoto:function(w,h,iw,ih){var scale,size={};return iw>w?(size.width=w,scale=w/iw,size.height=ih*scale):(size.width=iw,size.height=ih),size.height>h&&(size.height=h,scale=h/ih,size.width=iw*scale),size}}),PhotoGallery}),define("component/galleryslide/photoslide",function(require,exports,module){function PhotoSlide(data,currentId){this.cache=data,this.size=data.length,this.current=currentId,this.width=100,this.margin=22,this.init()}{var $=require("jquery");require("util")}return PhotoSlide.prototype={init:function(){var inner=$(["<div class='lui-photoslide'>","<div class='lui-photo-title'><h2></h2><span class='icon i-preview-close'></span></div>","<div class='prev'><i class='icon i-arrow-prev'></i></div><div class='next'><i class='icon i-arrow-next'></i></div>","<div class='lui-photo-content'>","<div class='lui-photo-image'><div class='img-wraper'><img src='img/loading5.gif'></div></div>","</div>","<div class='lui-photo-bottom'><div class='lui-slide'><div class='image-border'></div><ul class='image-ul'></ul></div></div>","</div>"].join(""));$("body").append(inner),this.content=inner,this.size<3&&inner.find(".lui-slide").css("width",this.size*this.width+(this.size-1)*this.margin);var height=document.body.offsetHeight-186;inner.find(".img-wraper").css({marginTop:(height-60)/2}),inner.find(".lui-slide>ul").css("width",this.size*(this.width+this.margin));for(var i=0;i<this.size;i++){var li=$("<li class='lui-slide-image'></li>");inner.find(".lui-slide>ul").append(li)}this.render(),this.bindEvent();var self=this;window.onresize=function(){self.render()}},render:function(){var loadImage=function(){var list=[],intervalId=null;return tick=function(){for(var i=0;i<list.length;i++)list[i].end?list.splice(i--,1):list[i]();!list.length&&stop()},stop=function(){clearInterval(intervalId),intervalId=null},function(url,ready,load,error){var onready,width,height,newWidth,newHeight,img=new Image;return img.src=url,img.complete?(ready.call(img),void(load&&load.call(img))):(width=img.width,height=img.height,img.onerror=function(){error&&error.call(img),onready.end=!0,img=img.onload=img.onerror=null},onready=function(){newWidth=img.offsetWidth,newHeight=img.height,(newWidth!==width||newHeight!==height||newWidth*newHeight>8800)&&(ready.call(img),onready.end=!0)},onready(),img.onload=function(){!onready.end&&onready(),load&&load.call(img),img=img.onload=img.onerror=null},void(onready.end||(list.push(onready),null===intervalId&&(intervalId=setInterval(tick,40)))))}}(),self=this,height=document.body.offsetHeight-186;if(this.cache[this.current].image){var that=this.cache[this.current].image,src=that.getAttribute("src");$(".img-wraper").css("marginTop",height>that.height?(height-that.height)/2:0),$(".img-wraper").css("width",that.width),height<that.height?($(".img-wraper>img").css("height",height).css("width",that.width*(height/that.height)),$(".img-wraper").css("width",that.width*(height/that.height))):$(".img-wraper>img").css({width:that.width,height:that.height}),$(".img-wraper>img").attr("src",src),$(".lui-photo-title>h2").html(this.cache[this.current].name)}else loadImage(this.cache[this.current].originPath,function(){var src=this.getAttribute("src");$(".img-wraper").css("marginTop",height>this.height?(height-this.height)/2:0),$(".img-wraper").css("width",this.width),height<this.height?($(".img-wraper>img").css("height",height).css("width",this.width*(height/this.height)),$(".img-wraper").css("width",this.width*(height/this.height))):$(".img-wraper>img").css({height:this.height,width:this.width}),$(".img-wraper>img").attr("src",src),self.cache[self.current].image=this,$(".lui-photo-title>h2").html(self.cache[self.current].name)},null,function(){var image=$("<img src='/css/theme/default/img/index/loadfailed.png'>");$(".img-wraper").css("marginTop",(height-60)/2),$(".img-wraper").css({width:80,height:60}),$(".img-wraper>img").attr("src",image.attr("src")).css({width:80,height:60}),self.cache[self.current].image=image[0],$(".lui-photo-title>h2").html(self.cache[self.current].name)});var start=0,end=this.cache.length;this.size>3&&(0==this.current?end=3:this.current==end-1?start=end-3:(start=this.current-1,end=this.current+2));for(var i=start;end>i;i++)this.cache[i].preimage||!function(index){loadImage(self.cache[index].thumbnails,function(){var height=this.height,width=this.width;100>height&&$(this).css("marginTop",(100-height)/2),100>width&&$(this).css("marginLeft",(100-width)/2),self.content.find(".image-ul>li").eq(index).append(this),self.cache[index].preimage=this},null,function(){var preimage=$("<img src='/css/theme/default/img/index/loadfailedsmall.png'>");preimage.css({width:48,height:40,marginTop:30,marginLeft:26,border:0}),self.content.find(".image-ul>li").eq(index).append(preimage),self.cache[index].preimage=preimage})}(i);this.slide()},bindEvent:function(){var self=this;$(".i-preview-close",this.content).on("click",function(e){parent.window.previewData?(parent.window.previewData=null,$(parent.window.document.getElementById("lui-mask-iframe")).remove(),$(parent.window.document.getElementById("web_iframediv")).remove()):(window.open("","_self",""),window.close())}),$(".i-arrow-prev",this.content).on("click",function(e){self.prev()}),$(".i-arrow-next",this.content).on("click",function(e){self.next()}),$(this.content).delegate(".lui-slide-image","click",function(e){var index=$(this).index();index!=self.current&&(self.current=index,self.render())})},next:function(){this.size>0&&this.current<this.size-1&&(this.current++,this.render())},prev:function(){this.size>0&&0!=this.current&&(this.current--,this.render())},slide:function(){this.size>3&&this.current>0&&this.current<this.size-1&&this.content.find(".lui-slide>ul").css("left",-(this.current-1)*(this.width+this.margin)),this.size>3&&this.current==this.size-1&&this.content.find(".lui-slide>ul").css("left",-(this.current-2)*(this.width+this.margin));var pos=0;pos=0==this.current?0:this.current==this.size-1&&this.size>=3?2:1,this.content.find(".image-border").css("left",pos*(this.width+this.margin))}},PhotoSlide}),define("component/historyDialog",function(require,exports,module){function HistoryDialog(context,callback){this.context=context,this.context.title,this.context.content||(this.context.content=""),this._callback=callback,this._init()}var $=require("jquery"),Dialog=require("component/dialog"),EventTarget=require("eventTarget"),Table=require("component/table");require("i18n");var _=$.i18n.prop;return $.extend(HistoryDialog.prototype,EventTarget,{_init:function(){var self=this;self.dialog=new Dialog(_("历史版本"),{mask:!0,minWidth:300,conPadding:"0px"},function(dialog){dialog.append('<div id="history-dialog-id"></div><div class="dialog-button-area"><a id="history-close" class="dialog-button cancel">'+_("关闭")+"</a></div>")}),self.dialog.on("close",function(){self.fire("close")});var title=self.context.title,file={};file.type=title.substring(title.lastIndexOf(".")),file.name=title.substring(0,title.lastIndexOf("."));new Table({node:"#history-dialog-id",template:{header:'<li title="'+self.context.title+'"><span style="text-overflow: ellipsis;overflow: hidden;max-width:206px;white-space: nowrap;">'+file.name+'</span><span style="vertical-align: top;">'+file.type+"</span></li>",row:'<li class="row"><p class="rowline"><span class="col1">{{version}}</span><span class="col2"><a>{{user}}</a> '+_("于 {0} {1}","{{modified}}","{{revop}}")+'<span class="{{curVer}}">'+_("当前版本")+'</span></span></p><span class="col3"><a path="{{path}}" rev="{{rev}}" neid="{{neid}}" op="download">'+_("下载")+'</a><a path="{{path}}" rev="{{rev}}" neid="{{neid}}" op="restore" class="dis-{{curVer}}">'+_("设为当前")+"</a></span></li>"},data:self.context.content});$("#history-dialog-id .row .col3 a").click(function(e){self._callback($(this).attr("op"),$(this).attr("path"),$(this).attr("neid"),$(this).attr("rev"))}),$("#history-close").click(function(){self.close()})},close:function(){var self=this;self.dialog.close()}}),HistoryDialog}),define("component/importUserDialog",function(require,exports){function ImportUserDialog(){this._init()}var $=require("jquery"),Upload=require("component/upload"),Table=require("component/table"),EventTarget=require("eventTarget"),Tips=require("component/tips"),Dialog=require("component/dialog"),Util=require("lenovodata/util");require("i18n");var _=$.i18n.prop;return require("mustache"),require("cookie"),$.extend(ImportUserDialog.prototype,EventTarget,{_init:function(){var self=this,create_template='<div id="importUserDialog" class="form"><p>'+_("第一步，下载模版文件")+'</p><p><img src="/img/model-excel.png"/>'+_("csv文件")+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="/img/download.png"/><a href="/resource/excel-model.csv">'+_("下载模版")+"</a></p><br><p>"+_("第二步，编辑模版文件")+'</p><p><img width="526px" height="101px" src="/img/model-table.png"/></p><br><p>'+_("第三步，上传编辑好的文件")+'</p><p class="uploadArea"></p></div><div class="dialog-button-area"><a id="import" class="dialog-button ok">'+_("导入")+'</a><a id="cancel" class="dialog-button cancel">'+_("取消")+"</a></div>",dialog=new Dialog(_("批量添加用户"),function(parent){parent.append(create_template);var tempP='<span class="theFont">'+_("添加文件")+"</span>",l_cookie=$.cookie("X-LENOVO-SESS-ID"),up=new Upload(parent.find(".uploadArea"),Util.getApiVersion()+"/user/batch_create",{single:!0,fileType:"*.csv",buttonText:tempP,postParam:{"X-LENOVO-SESS-ID":l_cookie}});up.on("complete",function(serverData){serverData=$.parseJSON(serverData);for(var da=[],i=0;i<serverData.length;i++){var item=serverData[i].src.split(",");/^Error/.test(serverData[i].message)&&(serverData[i].message=serverData[i].message.substr(12));var d={index:i+1,email:item[0],phone:item[1],name:item[2],password:item[3],result:serverData[i].message};""==d.result&&(d.result=_("导入成功")),da.push(d)}$.each(SWFUpload.instances,function(i,is){is.destroy()}),dialog.close();var dia2=new Dialog(_("批量添加用户"),function(parent){var html='<div id="importUserDialog2"><p>'+_("总计导入{0}个用户，导入用户角色均为“普通用户”",'<span id="importedNum"></span>')+'</p><div id="importedUser"></div><div id="importedUserTeam"></div></div><div class="dialog-button-area"><a id="cancel" class="dialog-button cancel">'+_("关闭")+"</a></div>";parent.append(html),$("#importedNum").text(da.length);{var tableHeader='<li><span class="col1"></span><span class="col2">'+_("用户名")+'</span><span class="col3">'+_("登录邮箱")+'</span><span class="col4">'+_("手机号码")+'</span><span class="col5">'+_("密码")+'</span><span class="col6">'+_("状态")+"</span></li>",tr='<li><span class="col1">{{index}}</span><span class="col2">{{name}}</span><span class="col3">{{email}}</span><span class="col4">{{phone}}</span><span class="col5">{{password}}</span><span class="col6">{{result}}</span></li>';new Table({node:"#importedUser",template:{header:tableHeader,row:tr},data:da})}$(".contentTable").css("height","393px"),$(".contentTable .contentArea").css("overflow","auto"),parent.find("#cancel").on("click",function(){dia2.close()})});dia2.on("close",function(){self.fire("close")}),Util.sendBuridPointRequest()}),up.on("error",function(data){var errorCode=data.errCode,message=data.msg;errorCode==SWFUpload.UPLOAD_ERROR.HTTP_ERROR&&"400"==message&&Tips.warn(_("请用标准批量创建文档来创建你的批量注册文档！"))}),parent.find("#import").on("click",function(){return"none"==$(".uploadProgress").css("display")?void Tips.warn(_("请选择文件")):void up.startUpload()}),parent.find("#cancel").on("click",function(){$.each(SWFUpload.instances,function(i,is){is.destroy()}),dialog.close()})})}}),ImportUserDialog}),define("component/linkMobile",function(require,exports){function LinkMobile(node,dataFunction,noPaging){this.node="string"==$.type(node)?$(node):node,this.dataFn=dataFunction,this.totalSize=0,this.pageSize=50,this.page=0,this.totalPage=0,this.currentPage=0,this.sortby="",this.includeDeleted="false",this.currentData=[],this.sort="asc",this.noPaging=noPaging}var $=jquery=require("jquery"),EventTarget=require("eventTarget"),Util=require("util"),Scroll=(require("model/DeliveryManager"),require("component/scroll"));return require("mustache"),$.extend(LinkMobile.prototype,EventTarget,{_requestData:function(func,error){var self=this;self.dataFn.call(self,{includeDeleted:self.includeDeleted,offset:self.page,size:self.pageSize,orderby:self.orderby,sort:self.sort},function(data,total_size){total_size?(self.totalSize=total_size,self.totalPage=total_size%self.pageSize==0?total_size/self.pageSize:parseInt(total_size/self.pageSize)+1):self.totalPage=1,func&&func(data)},function(){error&&error()})},initHeader:function(headerTemplate,func){var self=this;self.headerTemplate=headerTemplate;var header_temp=$(headerTemplate).html();header_temp=Mustache.render(header_temp,{}),header=$(header_temp);var headerWraper=$("#listHeader");headerWraper.empty(),headerWraper.append(header);{var h=$(".page-body").height();h-$("#listHeader").outerHeight()}func(self,headerWraper)},renderHeader:function(data){var self=this,header_temp=$(self.headerTemplate).html();header_temp=Mustache.render(header_temp,data);var headerWraper=$("#listHeader");headerWraper.empty(),headerWraper.append(header_temp)},initListbar:function(listbarTemplate,func){$("#listbar").prepend($(listbarTemplate).html()),$(".select-all").on("click",function(e){$(this).hasClass("down-all")?($(this).text("取消"),$(this).removeClass("down-all"),$(".list-item .item-operate").show(),$(".item-checkbox").each(function(idx,item){item.checked=!1})):($(this).text("下载"),$(this).addClass("down-all"),$(".list-item .item-operate").hide(),$(".list-item .item-operate").find(".i-download").removeClass("i-download-hover"),$(".item-checkbox").each(function(idx,item){item.checked=!0}))})},renderListbar:function(){$("#download-btn").stop(!0,!0).slideUp()},initList:function(models){var self=this,uilist=$('<div class="lui-list"></div>'),listHeader=$(models.head).html(),list_wraper=$('<div class="list-wraper list-view"></div>'),listBody=$("#listBody");self.templates=models,uilist.append(listHeader),uilist.append(list_wraper),listBody.append(uilist),self.uilist=uilist,self.mode="list",self.listBody=listBody,self._initSortMenu(),self._initDisplayModel(uilist),self.paging=!1,$("#item-selectAll").on("click",function(e){var tar=$(e.target).get(0);tar.checked?($(".list-item").addClass("item-selected"),$(".item-checkbox").each(function(idx,item){item.checked=!0})):($(".list-item").removeClass("item-selected"),$(".item-checkbox").each(function(idx,item){item.checked=!1})),self._select()})},_initSortMenu:function(){var self=this,sm=$("#sortMenu");sm.on("click",function(e){function doNext(clas){tar=$(tar),2==clas.length&&("asc"==clas[1]?(self.sort="asc",tar.removeClass("asc"),tar.addClass("desc")):"desc"==clas[1]&&(self.sort="desc",tar.removeClass("desc"),tar.addClass("asc"))),self.doSort(clas[0]),$(".sort-text").html('<a class="'+self.sort+'"><span class="i-sort"></span></a>'+tar.text()),$("#sortMenu").hide()}var tar=e.target;if("a"==tar.nodeName.toLowerCase()){var clas=tar.className.split(" ");doNext(clas)}}),sm.on("mouseleave",function(e){sm.hide()}),$(".cur-sort").click(function(){sm.toggle(400)})},addContextMenu:function(contexts){var self=this;self.contextMenu={};for(var key in contexts)!function(k){var contextMunu=$($(contexts[k]).html());self.listBody.append(contextMunu),contextMunu.off("click"),contextMunu.on("click",function(e){var tar=$(e.target).get(0),cn=tar.className;if("menu-item"==cn||$(tar).hasClass("menu-item")){var clas=tar.id;self.currentData=[],$(".item-checkbox:checked").each(function(idx,item){var index=$(item).parent().parent().attr("index");self.currentData.push(self.data[index])}),self.fire(clas,self,clas,self.currentData),e.preventDefault(),e.stopPropagation()}contextMunu.hide()}),contextMunu.on("mouseleave",function(e){$(this).hide()}),self.contextMenu[k]=contextMunu}(key)},_initDisplayModel:function(uilist){var self=this,lview=$(".oper .list-view",uilist),iview=$(".oper .icon-view",uilist);lview.on("click",function(){var wraper=$(".list-wraper",uilist);lview.addClass("list-view-on"),iview.removeClass("icon-view-on"),wraper.removeClass("icon-view"),wraper.addClass("list-view"),self.mode="list",wraper.find(".list-item").removeClass("thumb-nail"),self.scroll&&self.scroll.render()}),iview.on("click",function(){var wraper=$(".list-wraper",uilist);lview.removeClass("list-view-on"),iview.addClass("icon-view-on"),wraper.removeClass("list-view"),wraper.addClass("icon-view"),self.mode="icon",self.data&&self._generateThumbs(function(flag,index,url){if(flag){var parentFileItem=wraper.find(".list-item");$(parentFileItem).eq(index).addClass("thumb-nail")}}),self.scroll&&self.scroll.render()}),lview.trigger("click")},_generateThumbs:function(callback){for(var self=this,data=self.data,i=0;i<data.length;i++){var cur=data[i];if(!cur.thumbExist||!cur.isDelivery||!/[rp]/gi.test(cur.mode)){var Extension,ImgType=cur.type,jar={folder:"folder",doc:"word",docx:"word",rtf:"word",txt:"text",jpg:"pic",jpeg:"pic",png:"pic",bmp:"pic",gif:"pic",tiff:"pic",pcx:"pic",psd:"pic",thm:"pic",yuv:"pic",pps:"ppt",ppsx:"ppt",ppt:"ppt",pptx:"ppt",xls:"excel",xlsx:"excel",csv:"excel",lock:"lock",pct:"pdf",pdf:"pdf",pmd:"pdf",mp3:"music",wma:"music",ra:"music",wav:"music",mid:"music",vqf:"music",aif:"music",au:"music",dsp:"music",cmf:"music",cda:"music",mod:"music",iff:"music",m3u:"music",m4a:"music",mpa:"music",aiff:"music",avi:"video",mov:"video",mpg:"video",mp4:"video",xv:"video","3gp":"video",divx:"video",dat:"video",rm:"video",rmvb:"video",asf:"video",wmv:"video",vob:"video",mkv:"video",flv:"video","3g2":"video",asx:"video",exe:"exe",rar:"zip",zip:"zip",zipx:"zip","7z":"zip",cab:"zip",arj:"zip",jar:"zip",lzh:"zip",bin:"zip",deb:"zip",gz:"zip",rpm:"zip",sit:"zip",sitx:"zip",tar:"zip",cad:"cad",dxf:"cad",psd:"ps",ai:"ai",dw:"dw",fil:"fl",id:"id",ae:"ae","3d":"3d",eps:"svg",svg:"svg",cdr:"svg",cdr:"svg",pages:"other",log:"other",msg:"other",wps:"other",xps:"other",chm:"other",pdg:"other",key:"other",dat:"other",efx:"other",sdf:"other",vcf:"other",wks:"other",munbers:"other","3dm":"other",max:"other",com:"other",bat:"other",scr:"other",lib:"other",app:"other",cgi:"other",gadget:"other",vb:"other",wsf:"other",accdb:"other",db:"other",dbf:"other",mdb:"other",pdb:"other",sql:"other",cpl:"setting",cur:"setting",dll:"setting",dmp:"setting",drv:"setting",lnk:"setting",sys:"setting",cfg:"setting",ini:"setting",keychain:"setting",prf:"setting",c:"cpp","class":"cpp",cpp:"cpp",cs:"cpp",dtd:"cpp",fla:"cpp",java:"cpp",m:"cpp",pl:"cpp",py:"cpp",html:"html",htm:"html",xhtml:"html",php:"html",css:"html",js:"html",xml:"html",asp:"html",cer:"html",rss:"html",ttf:"font",fnt:"font",otf:"font",fon:"font",dmg:"iso",toast:"iso",vcd:"iso",iso:"iso"};$.map(jar,function(key,value){ImgType==value&&(Extension=key)}),void 0==Extension&&(Extension="other"),$("div.item-area-box").eq(i).find("img").attr("src","/img/fileicon/"+Extension+"_50.png"),Extension=null}!function(param,index){var imgUrl=FileModel.thumbnails(Util.getStorageUrl(),param.path,"","","",50,50,param.hash,param.rev,cur.isDelivery,param.deliveryCode,param.token,param.previewUrl),image=new Image;if(image.src=imgUrl,image.complete)callback(!0,index,imgUrl);else try{image.onload=function(){callback(!0,index,imgUrl)},image.onerror=function(){callback(!1,index)}}catch(e){callback(!1,index)}}(cur,i)}},bindItemEvent:function(eve){var self=this,list_wraper=$(".list-wraper",self.uilist);list_wraper.delegate(".list-item","mousedown",function(e){{var cbx,flag,cmd,ctar=$(e.currentTarget),tar=$(e.target),da=self.data[ctar.attr("index")];ctar.attr("isfolder")}if(2==e.button){var menu,md,px=e.pageX,py=e.pageY;if("[object Array]"==Object.prototype.toString.call(self.currentData)&&self.currentData.length>1?(menu=self.contextMenu.multi,md="multi"):(menu=self.contextMenu["default"],md="default"),menu){self.fire("contextMenu",menu,da);var top=py;top+$("#head").height()+$("#foot").height()+menu.outerHeight()>$(window).height()&&(top-=menu.height()),menu.css({left:px-5,top:top-65}),menu.show()}cbx=ctar.find(".item-checkbox"),flag=2,cmd=""}else tar.hasClass("item-checkbox")?(cbx=tar,flag=1,cmd=""):tar.hasClass("cmd")?(cbx=ctar.find(".item-checkbox"),flag=2,cmd=$.trim(tar.get(0).className.replace("cmd",""))):tar.hasClass("icon")?(tar.addClass("i-download-hover"),cbx=ctar.find(".item-checkbox"),flag=2,cmd=$.trim(tar.parent().get(0).className.replace("cmd",""))):tar.hasClass("item-icon")?(cbx=ctar.find(".item-checkbox"),flag=2,cmd="item-icon"):(cbx=ctar.find(".item-checkbox"),flag=2,cmd="item-area");var cbox=cbx.get(0);if(1==flag)cbox.checked?ctar.removeClass("item-selected"):ctar.addClass("item-selected");else if(2==flag){{$("#item-selectAll").length>0?$("#item-selectAll")[0].checked:!1}cbox.checked||($(".item-checkbox",self.uilist).each(function(idx,itm){itm.checked=!1}),$(".list-item",self.uilist).removeClass("item-selected"),ctar.addClass("item-selected"),cbox.checked=!0)}else cbox.checked?(ctar.removeClass("item-selected"),cbox.checked=!1):($(".item-checkbox",self.uilist).each(function(idx,itm){itm.checked=!1}),$(".list-item",self.uilist).removeClass("item-selected"),ctar.addClass("item-selected"),cbox.checked=!0);self._select();var fn=eve[cmd];fn&&fn(self,self.currentData)})},_select:function(){var self=this,coll=$(".item-selected",self.uilist);if(coll.length>1){var datas=[];$.each(coll,function(idx,item){var d=self.data[$(item).attr("index")];datas.push(d)}),self.currentData=datas,self.fire("multiSelect",datas)}else if(1==coll.length){var d=self.data[coll.attr("index")];self.currentData.length=1,self.currentData[0]=d,self.fire("select",d)}else 0==coll.length&&(self.currentData=[],self.fire("unselect"));self.currentData.length==self.uilist.find(".item-checkbox").length?$("#item-selectAll").prop("checked",!0):$("#item-selectAll").prop("checked",!1),
self.fire("selectItem",self.currentData)},render:function(fn){var self=this;self._renderList(),fn&&fn()},reload:function(){var self=this;self._renderList(),self.fire("reload")},gotoParentLevel:function(path){this.fire("gotoParentLevel",path)},_renderList:function(path){var self=this;self._requestData(function(datas){self.renderList(datas)})},renderList:function(data){if(void 0!==data){var self=this,uilist=self.uilist,list=$(".list-wraper",uilist);list.empty(),self.currentData=[];var checkbox_all=$("#item-selectAll");checkbox_all.length>0&&(checkbox_all.get(0).checked=!1),self.data=data;{self.listBody.height()-self.node.find(".list-header").outerHeight()}if(0==data.length)return self._empty(list),void self.fire("render");$(".select-all").html("下载");for(var scrollWraper=$('<div class="scrollWraper"></div>'),i=0,ii=data.length;ii>i;i++){var cda=data[i],temp=1==cda.isfolder?self.templates.folder:self.templates["default"],itm=$(Mustache.render($(temp).html(),cda));itm.attr("index",i);var diff=cda.expiration&&-1!=cda.expiration?new Date(cda.expiration.replace(/[年月日]/g,"/")).getTime()+864e5-new Date:1;0>diff&&itm.addClass("changeGrey"),scrollWraper.append(itm)}var pageButton=self.generatePage();pageButton.length>0&&this.noPaging&&scrollWraper.append(pageButton),list.append(scrollWraper),self.scroll=new Scroll(scrollWraper),self._generateThumbs(function(flag,index,url){if(flag){var fileItem=list.find(".list-item").eq(index);$(fileItem).find("span.item-area img").attr("src",url),$(fileItem).find("div.item-area-box").css("background","#d2d2d2");var oImg=$(fileItem).find("span.item-area img");oImg.load(function(){var w=oImg.width(),h=oImg.height();50>w&&$(fileItem).find("span.item-area img").css({paddingLeft:(50-w)/2,paddingRight:(50-w)/2}),50>h&&$(fileItem).find("span.item-area img").css("marginTop",(50-h)/2),"icon"==self.mode&&$(fileItem).addClass("thumb-nail")})}else list.find(".filelist-item").eq(index).find("span.item-area img").remove()}),self.isMobile(),self.fire("render")}},addItem:function(data){for(var self=this,container=self.uilist.find(".scl-content"),len=self.data.length,i=0,ii=data.length;ii>i;i++){var itm=$(Mustache.render($(self.templates["default"]).html(),data[i]));itm.attr("index",len+i),self.data[len+i]=data[i],container.append(itm)}self.scroll.render(!0)},nextPage:function(){var self=this;return self.page>=self.totalSize?void(self.paging=!1):(self.page+=1,void self._requestData(function(datas){self.addItem(datas),self.paging=!1},function(){self.paging=!1}))},doSort:function(key){var self=this;self.orderby=key,self._renderList()},loading:function(){var self=this,loader=$('<div id="cur-loading"><img src="/img/loading3.gif"/></div>'),container=self.uilist.find(".scl-content");container.append(loader),self.scroll.render(!0),self.scroll.scrollTo(1,!0)},removeLoading:function(){var self=this;$("#cur-loading").remove(),self.scroll.render(),self.scroll.scrollTo(1,!0)},_empty:function(parent){var self=this;parent.append($(self.templates.empty).html())},addData:function(data){var self=this,container=self.uilist.find(".list-wraper").find(".scl-content").empty(),len=self.data.length;self.removeLoading();for(var i=0,ii=data.length;ii>i;i++){var itm=$(Mustache.render($(self.templates["default"]).html(),data[i]));itm.attr("index",len+i),container.append(itm)}var pageButton=self.generatePage();pageButton.length>0&&container.append(pageButton),self.scroll.render(!0)},toPage:function(page){var self=this;0>page||page>parseInt(self.totalSize/self.pageSize)||(self.currentPage=page,self.page=self.pageSize*page,self._requestData(function(datas){self.addData(datas)},function(){self.removeLoading()}))},generatePage:function(){var self=this,pageNumber=parseInt(self.totalSize/self.pageSize)+1,container="",pre=$('<span class="preGrouppage"></span><span class="prePage"></span>'),point=$("<span class='point'>...</span>"),next=$('<span class="nextPage"></span><span class="nextGrouppage"></span><input type="text" class="pageInput"/><span class="button"></span>');if(pageNumber>1){if(container=$("<div class='list-foot'></div>"),container.append(pre),11>=pageNumber)for(var i=0;pageNumber>i;i++)container.append(i==self.currentPage?$("<a class='active' href='javascript:void(0);'>"+(i+1)+"</a>"):$('<a href="javascript:void(0);">'+(i+1)+"</a>"));else{for(var i=0;9>i;i++)container.append(i==self.currentPage?$("<a class='active' href='javascript:void(0);'>"+(i+1)+"</a>"):$('<a href="javascript:void(0);">'+(i+1)+"</a>"));container.append(point);for(var j=pageNumber-2;pageNumber>j;j++)container.append(j==self.currentPage?$("<a class='active' href='javascript:void(0);'>"+(j+1)+"</a>"):$('<a href="javascript:void(0);">'+(j+1)+"</a>"))}container.append(next),container.delegate(".prePage","click",function(e){self.toPage(self.currentPage-1)}),container.delegate(".nextPage","click",function(e){self.toPage(self.currentPage+1)}),container.delegate(".preGrouppage","click",function(e){self.toPage(0)}),container.delegate(".nextGrouppage","click",function(e){self.toPage(parseInt(self.totalSize/self.pageSize))}),container.delegate("a","click",function(e){var page=$(this).text();isNaN(page)||(page=parseInt(page)-1,self.toPage(page))}),container.delegate("span.button","click",function(e){var page=$(".pageInput",container).val();isNaN(page)||(page=parseInt(page)-1,self.toPage(page))})}return container},isMobile:function(){var regex_match=/(iphone|ipad)/i,u=navigator.userAgent;if(null==u)return!0;var result=regex_match.exec(u);return null==result?!1:!0}}),LinkMobile}),define("component/linkNavigator",function(require,exports,module){function LinkNavigator(context){this.cssAction=context.cssAction,this._init()}var $=require("jquery"),EventTarget=(require("util"),require("eventTarget"));require("mustache"),require("i18n");$.i18n.prop;return $.extend(LinkNavigator.prototype,EventTarget,{_init:function(){},render:function(paths,width){var self=this,fileNav=[];self.paths=paths,self.width=width?width:300;for(var dirItemArr=paths,item='<a class="listNav" src="{{url}}" title="{{dirname}}">{{dirname}}</a>',delimiter='<span class="icon i-fold">&gt;</span>',first='<a class="listNav" src="'+dirItemArr[0]+'" title="'+dirItemArr[0]+'">'+dirItemArr[0].substring(0,5)+"...</a>",ellipsis='<span class="icon i-fold">&gt;</span><span>...</span><span class="icon i-fold">&gt;</span>',len=dirItemArr.length,dirItemArrDis=[],i=len-1;i>=0;i--){if(""!=dirItemArr[i]){var src=dirItemArr.slice(0,i+1).join("/");if(i==len-1)fileNav.unshift('<span class="dirNav" title='+dirItemArr[i]+">"+dirItemArr[i]+"</span>");else{dirItemArrDis[i]=dirItemArr[i].length<=5?dirItemArr[i]:dirItemArr[i].substring(0,5)+"...";var tmp=Mustache.render(item,{url:src,dirname:dirItemArrDis[i]});fileNav.unshift(tmp+delimiter)}}$(".filenav-area").empty(),$(".filenav-area").append(fileNav.join(""));var realWidth=parseInt($(".filenav-area").css("width"));if(realWidth>self.width){fileNav.shift(),$(".filenav-area").empty(),$(".filenav-area").append(first+ellipsis+fileNav.join(""));break}i>0&&$(".filenav-area").empty()}$(".filenav-area > a").mouseover(function(e){$(e.currentTarget).css("text-decoration","underline")}),$(".filenav-area > a").mouseout(function(e){$(e.currentTarget).css("text-decoration","")}),$(".filenav-area > a").click(function(){var path=$(this).attr("src");self.fire("changePath",path,self.cssAction)})}}),LinkNavigator}),define("component/list",function(require,exports){function List(node,dataFunction,noPaging,pagesize,scrollBottom){this.node="string"==$.type(node)?$(node):node,this.dataFn=dataFunction,this.totalSize=0,this.pageSize=pagesize||50,this.page=0,this.totalPage=0,this.currentPage=0,this.sortby="",this.includeDeleted="false",this.currentData=[],this.sort="asc",this.noPaging=noPaging,this.scrollBottom=scrollBottom===!0?!0:!1}{var $=jquery=require("jquery"),EventTarget=require("eventTarget"),Util=require("util"),Scroll=(require("component/tips"),require("component/scroll")),RegionSelect=require("component/regionSelect");$.i18n.prop}return require("mustache"),require("Clipboard"),$.extend(List.prototype,EventTarget,{_requestData:function(func,error){var self=this;self.dataFn.call(self,{includeDeleted:self.includeDeleted,offset:self.page,size:self.pageSize,orderby:self.orderby,sort:self.sort},function(data,total_size){total_size?(self.totalSize=total_size,self.totalPage=Math.ceil(parseInt(total_size)/self.pageSize)):self.totalPage=1,func&&func(data)},function(){error&&error()})},initHeader:function(headerTemplate,func){var self=this;self.headerTemplate=headerTemplate;var header_temp=$(headerTemplate).html();header_temp=Mustache.render(header_temp,{}),header=$(header_temp);var headerWraper=$("#listHeader");headerWraper.empty(),headerWraper.append(header);var h=$(".page-body").height(),fh=h-$("#listHeader").outerHeight();$("#listBody").height($("#listBody").hasClass("mobile_listBody")?"":fh),func(self,headerWraper)},renderHeader:function(data,fn){var self=this,header_temp=$(self.headerTemplate).html();header_temp=Mustache.render(header_temp,data);var headerWraper=$("#listHeader");headerWraper.empty(),headerWraper.append(header_temp),fn&&fn()},singlePage:function(singleTem,data){var self=this;self.singleTem=singleTem;var single_temp=$(self.singleTem).html();single_temp=Mustache.render(single_temp,data);var singleWraper=$("#link-single");singleWraper.empty(),singleWraper.append(single_temp)},initList:function(models){var self=this,uilist=$('<div class="lui-list"></div>'),listHeader=$(models.head).html(),list_wraper=$('<div class="list-wraper list-view"></div>'),listBody=$("#listBody");self.templates=models,uilist.append(listHeader),uilist.append(list_wraper),listBody.append(uilist),self.uilist=uilist,self.mode="list",self.listBody=listBody,self._initSortMenu(),self._initCommandMenu(),self._initDisplayModel(uilist),self.paging=!1,"/"==location.pathname||/^\/folder/.test(location.pathname)||$("#item-selectAll").on("click",function(e){var tar=$(e.target).get(0);tar.checked?($(".list-item").addClass("item-selected"),$(".item-checkbox").each(function(idx,item){item.checked=!0})):($(".list-item").removeClass("item-selected"),$(".item-checkbox").each(function(idx,item){item.checked=!1}),self.fire("unselect")),self._select()})},_initCommandMenu:function(){var self=this;$(".command",self.listBody).on("click",function(e){var tar=e.target;if("span"==tar.nodeName.toLowerCase()){var clas=tar.className;$("body").data("action",(self.currentData[0]?self.currentData[0].hasOwnProperty("path")?"文件夹":"用户":"")+"列表头").data("category",clas),self.fire(clas,self,clas,self.currentData)}})},_initSortMenu:function(){var self=this,sm=$("#sortMenu");sm.on("click",function(e){function doNext(clas){tar=$(tar),2==clas.length&&("asc"==clas[1]?(self.sort="asc",tar.removeClass("asc"),tar.addClass("desc")):"desc"==clas[1]&&(self.sort="desc",tar.removeClass("desc"),tar.addClass("asc"))),self.doSort(clas[0]),$(".sort-text").html('<a class="'+self.sort+'"><span class="i-sort"></span></a>'+tar.text()),$("#sortMenu").hide()}var tar=e.target;if("a"==tar.nodeName.toLowerCase()){var clas=tar.className.split(" ");doNext(clas)}}),sm.on("mouseleave",function(e){sm.hide()}),$(".cur-sort").click(function(){sm.toggle(400)})},addContextMenu:function(contexts){var self=this;self.contextMenu={};for(var key in contexts)!function(k){var contextMunu=$($(contexts[k]).html());self.listBody.append(contextMunu),contextMunu.off("click"),contextMunu.on("click",function(e){var tar=$(e.target).get(0),cn=tar.className;if("menu-item"==cn||$(tar).hasClass("menu-item")){var clas=tar.id;self.currentData=[],$(".item-checkbox:checked").each(function(idx,item){var index=$(item).parent().parent().attr("index");self.currentData.push(self.data[index])}),$("body").data("category",clas).data("action","右键菜单").data("content",self.currentData[0].hasOwnProperty("path")?"文件":"用户"),self.fire(clas,self,clas,self.currentData),e.preventDefault(),e.stopPropagation()}contextMunu.hide()}),contextMunu.on("mouseleave",function(e){$(this).hide()}),self.contextMenu[k]=contextMunu}(key)},_initDisplayModel:function(uilist){var self=this,lview=$(".oper .list-view",uilist),iview=$(".oper .icon-view",uilist);lview.on("click",function(){var wraper=$(".list-wraper",uilist);lview.addClass("list-view-on"),iview.removeClass("icon-view-on"),wraper.removeClass("icon-view"),wraper.addClass("list-view"),self.mode="list",wraper.find(".list-item").removeClass("thumb-nail"),self.scroll&&self.scroll.render()}),iview.on("click",function(){var wraper=$(".list-wraper",uilist);lview.removeClass("list-view-on"),iview.addClass("icon-view-on"),wraper.removeClass("list-view"),wraper.addClass("icon-view"),self.mode="icon",self.data&&self._generateThumbs(function(flag,index,url){if(flag){var parentFileItem=wraper.find(".list-item");$(parentFileItem).eq(index).addClass("thumb-nail")}}),self.scroll&&self.scroll.render()}),lview.trigger("click")},_generateThumbs:function(callback){for(var self=this,data=self.data,i=0;i<data.length;i++){var cur=data[i];cur.thumbExist&&cur.isDelivery&&/[rp]/gi.test(cur.mode)&&!function(param,index){var imgUrl=FileModel.thumbnails(Util.getStorageUrl(),param.path,"","","",130,70,param.hash,param.rev,cur.isDelivery,param.deliveryCode,param.token,param.previewUrl),image=new Image;if(image.src=imgUrl,image.complete)callback(!0,index,imgUrl);else try{image.onload=function(){callback(!0,index,imgUrl)},image.onerror=function(){callback(!1,index)}}catch(e){callback(!1,index)}}(cur,i)}},bindItemEvent:function(eve){var self=this,list_wraper=$(".list-wraper",self.uilist);list_wraper.delegate(".list-item","mousedown",function(e){{var cbx,flag,cmd,ctar=$(e.currentTarget),tar=$(e.target),da=self.data[ctar.attr("index")];ctar.attr("isfolder")}if(2==e.button){var menu,md,px=e.pageX,py=e.pageY;if("[object Array]"==Object.prototype.toString.call(self.currentData)&&self.currentData.length>1?(menu=self.contextMenu.multi,md="multi"):(menu=self.contextMenu["default"],md="default"),menu){self.fire("contextMenu",menu,da);var top=py;top+$("#head").height()+$("#foot").height()+menu.outerHeight()>$(window).height()&&(top-=menu.height()),menu.css({left:px-5,top:top}),menu.show()}cbx=ctar.find(".item-checkbox"),flag=2,cmd=""}else tar.hasClass("item-checkbox")?(cbx=tar,flag=1,cmd=""):tar.hasClass("cmd")?(cbx=ctar.find(".item-checkbox"),flag=2,cmd=$.trim(tar.get(0).className.replace("cmd",""))):tar.hasClass("icon")?(cbx=ctar.find(".item-checkbox"),flag=2,cmd=$.trim(tar.parent().get(0).className.replace("cmd",""))):tar.hasClass("display-name")?(cbx=ctar.find(".item-checkbox"),flag=2,cmd="display-name"):tar.hasClass("item-icon")?(cbx=ctar.find(".item-checkbox"),flag=2,cmd="item-icon"):(cbx=ctar.find(".item-checkbox"),flag=3,cmd=""),$("body").data("category",cmd.replace("cmd-","")).data("action",(da.hasOwnProperty("path")?"文件":"用户")+"列表按钮").data("content",da.hasOwnProperty("path")?"文件夹":"用户");var cbox=cbx.get(0);if(1==flag)cbox.checked?ctar.removeClass("item-selected"):ctar.addClass("item-selected");else if(2==flag){var check_all=$("#item-selectAll").length>0?$("#item-selectAll")[0].checked:!1;check_all&&2==e.button||($(".item-checkbox",self.uilist).each(function(idx,itm){itm.checked=!1}),$(".list-item",self.uilist).removeClass("item-selected"),ctar.addClass("item-selected"),cbox.checked=!0,ctar.next().is(":hidden")&&($(".cp-delivery").slideUp(200),ctar.next().slideDown(200)))}else cbox.checked?(ctar.removeClass("item-selected"),cbox.checked=!1):($(".item-checkbox",self.uilist).each(function(idx,itm){itm.checked=!1}),$(".list-item",self.uilist).removeClass("item-selected"),ctar.addClass("item-selected"),cbox.checked=!0),ctar.next().is(":hidden")&&($(".cp-delivery").slideUp(200),ctar.next().slideDown(200));self._select();var fn=eve[cmd];fn&&fn(self,self.currentData),e.preventDefault(),e.stopPropagation()}),list_wraper.delegate(".list-item","mouseenter",function(e){self.fire("mouseenter",e.currentTarget)}),list_wraper.delegate(".list-item","mouseleave",function(e){self.fire("mouseleave",e.currentTarget)})},_select:function(){var self=this,coll=$(".item-selected",self.uilist);if(coll.length>1){var datas=[];$.each(coll,function(idx,item){var d=self.data[$(item).attr("index")];datas.push(d)}),self.currentData=datas,self.fire("multiSelect",datas)}else if(1==coll.length){var d=self.data[coll.attr("index")];self.currentData.length=1,self.currentData[0]=d,self.fire("select",d)}else 0==coll.length&&(self.currentData=[],self.fire("unselect"));self.currentData.length==self.uilist.find(".item-checkbox").length?$("#item-selectAll").prop("checked",!0):$("#item-selectAll").prop("checked",!1),self.fire("selectItem",self.currentData)},render:function(){var self=this;self._renderList()},reload:function(){var self=this;self._renderList(),self.fire("reload")},gotoParentLevel:function(path){this.fire("gotoParentLevel",path)},_renderList:function(){var self=this;self._requestData(function(datas){self.renderList(datas)})},renderList:function(data){if(void 0!==data){var self=this,uilist=self.uilist,list=$(".list-wraper",uilist);list.empty(),self.currentData=[];{$("#item-selectAll")}self.data=data;var h=self.listBody.height()-self.node.find(".list-header").outerHeight();if(0==data.length)return list.height(h-1),self._empty(list),void self.fire("render");var scroll_wraper=$('<div class="scroll-wraper"></div>');scroll_wraper.height($("#listBody").hasClass("mobile_listBody")?"":h);for(var i=0,ii=data.length;ii>i;i++){var cda=data[i],temp=1==cda.isfolder?self.templates.folder:self.templates["default"],itm=$(Mustache.render($(temp).html(),cda));itm.attr("index",i);var diff=cda.expiration&&-1!=cda.expiration?new Date(cda.expiration.replace(/[年月日]/g,"/")).getTime()+864e5-new Date:1;0>diff&&itm.addClass("changeGrey"),scroll_wraper.append(itm)}var pageButton=self.generatePage();pageButton.length>0&&this.noPaging&&scroll_wraper.append(pageButton),list.append(scroll_wraper),self.scroll=new Scroll(scroll_wraper,self.scrollBottom),this.noPaging||self.scroll.on("reachEnd",function(){self.page<self.totalPage-1&&(self.paging||(self.paging=!0,setTimeout(function(){self.nextPage()},100)))}),self._generateThumbs(function(flag,index,url){if(flag){var fileItem=list.find(".list-item").eq(index);$(fileItem).find("span.item-area>img").attr("src",url);var h=$(fileItem).find("span.item-area>img").height();70>h&&$(fileItem).find("span.item-area>img").css("marginTop",(70-h)/2),"icon"==self.mode&&$(fileItem).addClass("thumb-nail")}else list.find(".filelist-item").eq(index).find("span.item-area>img").remove()}),self.fire("render")}},addDragselect:function(node){var self=this;new RegionSelect(self,{node:node,region:".list-item",selectedClass:"item-selected"}).select()},addItem:function(data){for(var self=this,container=self.uilist.find(".scl-content"),len=self.data.length,i=0,ii=data.length;ii>i;i++){var itm=$(Mustache.render($(self.templates["default"]).html(),data[i]));itm.attr("index",len+i),self.data[len+i]=data[i],container.append(itm)}self.uilist.find(".scroll-wrapper").height(self.listBody.height()-self.node.find(".list-header").outerHeight()),self.scroll.render(!0)},nextPage:function(){var self=this;self.page>=self.totalSize?self.paging=!1:self.page+=1,self._requestData(function(datas){self.addItem(datas),self.paging=!1},function(){self.paging=!1})},doSort:function(key){var self=this;self.orderby=key,self._renderList()},loading:function(){var self=this,loader=$('<div id="cur-loading"><img src="/img/loading3.gif"/></div>'),container=self.uilist.find(".scl-content");container.append(loader),self.scroll.render(!0),self.scroll.scrollTo(1,!0)},removeLoading:function(){var self=this;$("#cur-loading").remove(),self.scroll.render(),self.scroll.scrollTo(1,!0)},_empty:function(parent){var self=this;parent.append($(self.templates.empty).html())},addData:function(data){var self=this,container=self.uilist.find(".list-wraper").find(".scl-content").empty(),len=self.data.length;self.removeLoading();for(var i=0,ii=data.length;ii>i;i++){var itm=$(Mustache.render($(self.templates["default"]).html(),data[i]));itm.attr("index",len+i),container.append(itm)}var pageButton=self.generatePage();pageButton.length>0&&container.append(pageButton),self.scroll.render(!0)},toPage:function(page){var self=this;0>page||page>parseInt(self.totalSize/self.pageSize)||(self.currentPage=page,self.page=self.pageSize*page,self._requestData(function(datas){self.addData(datas)},function(){self.removeLoading()}))},generatePage:function(){var self=this,pageNumber=parseInt(self.totalSize/self.pageSize)+1,container="",pre=$('<span class="preGrouppage"></span><span class="prePage"></span>'),point=$("<span class='point'>...</span>"),next=$('<span class="nextPage"></span><span class="nextGrouppage"></span><input type="text" class="pageInput"/><span class="button"></span>');if(pageNumber>1){if(container=$("<div class='list-foot'></div>"),container.append(pre),11>=pageNumber)for(var i=0;pageNumber>i;i++)container.append(i==self.currentPage?$("<a class='active' href='javascript:void(0);'>"+(i+1)+"</a>"):$('<a href="javascript:void(0);">'+(i+1)+"</a>"));else{for(var i=0;9>i;i++)container.append(i==self.currentPage?$("<a class='active' href='javascript:void(0);'>"+(i+1)+"</a>"):$('<a href="javascript:void(0);">'+(i+1)+"</a>"));container.append(point);for(var j=pageNumber-2;pageNumber>j;j++)container.append(j==self.currentPage?$("<a class='active' href='javascript:void(0);'>"+(j+1)+"</a>"):$('<a href="javascript:void(0);">'+(j+1)+"</a>"))}container.append(next),container.delegate(".prePage","click",function(e){self.toPage(self.currentPage-1)}),container.delegate(".nextPage","click",function(e){self.toPage(self.currentPage+1)}),container.delegate(".preGrouppage","click",function(e){self.toPage(0)}),container.delegate(".nextGrouppage","click",function(e){self.toPage(parseInt(self.totalSize/self.pageSize))}),container.delegate("a","click",function(e){var page=$(this).text();isNaN(page)||(page=parseInt(page)-1,self.toPage(page))}),container.delegate("span.button","click",function(e){var page=$(".pageInput",container).val();isNaN(page)||(page=parseInt(page)-1,self.toPage(page))})}return container}}),List}),define("component/listview",function(require,exports){function ListView(node,config){var DEFAULT={column:3,template:'<li class="list-item" index="{{index}}" title="{{name}}"><input class="item-checkbox" type="checkbox"/><span class="icon i-user"></span><span class="item-text">{{name}}</span><span class="isfull-{{member_limit}}">('+_("已满")+")</span></li>"};this.node="string"==$.type(node)?$(node):node,this.cfg=$.extend(DEFAULT,config),this.selected={},this._init()}{var $=jquery=require("jquery"),EventTarget=require("eventTarget"),Scroll=(require("util"),require("component/scroll")),LuiCombox=require("component/luicombox");require("component/userTeamAuthCombox")}require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(ListView.prototype,EventTarget,{_init:function(){var self=this,ul=$('<ul class="lui-listview"></ul>');self.node.append(ul),self.scroll=new Scroll(ul),ul.delegate(".list-item","click",function(e){var cbox,cur=$(e.currentTarget),index=cur.attr("index"),tar=$(e.target);if(tar.hasClass("item-checkbox")){if(cbox=tar.get(0),tar.parent().find(".isfull-true").length>0)return void(cbox.checked=!1);cbox.checked?(cur.addClass("selected"),self.selected[index]=self.data[index]):(cur.removeClass("selected"),delete self.selected[index])}else{if(cbox=cur.find(".item-checkbox").get(0),cur.find(".isfull-true").length>0)return;if(cbox){if("u"==e.target.tagName.toLowerCase()){e.stopPropagation(),e.preventDefault();var _index=cur.attr("index");if(-1!=_index){var obj={},item_added=self.data[_index];for(var k in item_added)obj[k]=item_added[k];return void self.fire("item-added",obj)}}else if($(e.target).hasClass("text-team")){e.stopPropagation(),e.preventDefault();var _index=cur.attr("index");if(-1!=_index)return void self.fire("teamClick",_index)}else if($(e.target).hasClass("text-all"))return e.stopPropagation(),e.preventDefault(),void self.fire("allClick");cbox.checked?(cbox.checked=!1,cur.removeClass("selected"),delete self.selected[index]):(cbox.checked=!0,cur.addClass("selected"),self.selected[index]=self.data[index])}else if(tar.hasClass("i-authdelete")){var _index=tar.parent().attr("index");-1!=_index&&self.fire("delete",_index)}else{var _index=tar.parent().attr("index");if(-1!=_index){var obj={},item_added=self.data[_index];for(var k in item_added)obj[k]=item_added[k];self.fire("item-added",obj)}}}self.fire("selected",self.selected)})},render:function(data){var self=this,cols=(self.node.find(".lui-listview"),self.cfg.column);self.data=data,self.scroll.emptyContent(),0==data.length&&$("#teamList .scl-content").append("<p style='text-align:center;line-height:200px;'>"+_("您目前没有可加入的团队")+"</p>");for(var i=0,len=data.length;len>i;i++){data[i].index=i;var li=$(Mustache.render(self.cfg.template,data[i]));if(li.find(".isfull-true").length>0&&(li.find("input[type='checkbox']").attr("disabled","disabled"),li.css("background-color","#e0e0e0")),self.cfg.hasRoleCombox){var combox=new LuiCombox(li.find(".lui-combox"),{initval:"member",type:"combox_role"});combox.on("change",function(_index,type,value){self.data[_index][type]=value})}else if(self.cfg.hasAuthCombox){var combox=new LuiCombox(li.find(".lui-combox"),{initval:data[i].cssAction,inherit:data[i].inherit,isteam:"team"==data[i].agent_type});combox.on("change",function(_index,type,value){self.data[_index][type]=value}),combox.on("changeInherit",function(_index,type,value){self.data[_index][type]=value,self.fire("changeInherit",_index,value)})}li.width(100/cols+"%"),self.scroll.appendContent(li)}self.selected={},self.scroll.render()},getSelectedItem:function(){var self=this,data=self.selected,items=[];for(var key in data)items.push(data[key]);return items},getAllItem:function(){for(var self=this,data=self.data,items=[],i=0;i<data.length;i++)items.push(data[i]);return items},getAuthItem:function(){for(var self=this,data=self.data,items=[],i=0;i<data.length;i++)items.push(data[i]);return items},selectAll:function(flag){var self=this;$(self.node.find(".list-item")).each(function(index,item){flag?($(item).addClass("selected"),$(item).find(".item-checkbox").get(0).checked=!0,self.selected[index]=self.data[index]):($(item).removeClass("selected"),$(item).find(".item-checkbox").get(0).checked=!1,delete self.selected[index])})}}),ListView}),define("component/lockDialog",function(require,exports,module){function LockDialog(context,param){var self=this;self.filename=param.name,self.path=param.path,self.neid=param.neid,self.path_type=param.path_type,self.prefix_neid=param.prefix_neid,self.context=context,self._init()}var $=require("jquery"),Tips=require("component/tips"),Dialog=require("component/dialog"),FileManager=require("model/FileManager");require("i18n");var _=$.i18n.prop;require("mustache");var template='<div class="lockConWrapper"><p class="tishi">'+_('您将锁定文件"{0}",锁定后将阻止其他人更新文件内容。',"{{name}}")+'</p><label><input type="checkbox" id="setLockTime"> '+_("为这个锁定设置一个过期时间")+'</label><p class="title">'+_("持续时长")+'</p><p><select disabled="disabled" id="selectTime"><option value="-1">'+_("无限制")+'</option><option value="900">'+_("15分钟")+'</option><option value="1800">'+_("半小时")+'</option><option value="3600">'+_("1小时")+'</option><option value="86400">'+_("1天")+'</option><option value="604800 ">'+_("1周")+'</option><option value="2592000 ">'+_("1个月")+'</option></select></p></div><div class="dialog-button-area"><a id="addLock" class="dialog-button ok">'+_("确定")+'</a><a id="cancel" class="dialog-button cancel">'+_("取消")+"</a></div>";return $.extend(LockDialog.prototype,{_init:function(){var self=this;self.dialog=new Dialog(_("锁定文件"),{mask:!0},function(dialog,dialog_cb){var Dom=Mustache.render(template,{name:self.filename});dialog.append(Dom),self._render(dialog,dialog_cb)})},_render:function(dialog,dialog_cb){var self=this;$("#setLockTime").change(function(){$("#setLockTime")[0].checked?$("#selectTime").removeAttr("disabled"):$("#selectTime").attr("disabled","disabled")}),$("#addLock").click(function(){var time=$("#selectTime").val();Util.sendBuridPointRequest(),FileManager.lock(self.path,self.path_type,"",self.prefix_neid,self.neid,time,function(ret){200==ret.code?(Tips.show(_("文件锁定成功")),self.dialog.close(),self.context.reload()):Tips.warn(ret.message)})}),$("#cancel").click(function(){self.dialog.close()})}}),LockDialog}),define("component/luicombox",function(require,exports,module){function LuiCombox(node,options){this.node=$(node),this.option=$.extend({isteam:!1,initval:"preview"},options),this.render()}var $=require("jquery"),_=$.i18n.prop,Util=require("util"),EventTarget=require("component/eventTarget"),AUTHITEM={preview:{name:_("预览"),value:"preview"},upload:{name:_("上传"),value:"upload"},"upload:delivery":{name:_("上传/外链"),value:"upload:delivery"},download:{name:_("下载"),value:"download"},"download:delivery":{name:_("下载/外链"),value:"download:delivery"},"upload:download":{name:_("上传/下载"),value:"upload:download"},"upload:download:delivery":{name:_("上传/下载/外链"),value:"upload:download:delivery"},edit:{name:_("编辑"),value:"edit"}},ROLEITEM={member:{name:_("团队成员"),value:"member"},admin:{name:_("团队管理员"),value:"admin"}};return $.extend(LuiCombox.prototype,EventTarget,{render:function(){var combox=$("<span class='combox-text'></span><span class='icon i-luicombox'></span>");this.node.append(combox);var datalist=$("<ul class='combox-ul'></ul>");for(var i in AUTHITEM){var item="<li class='combox-item' cssaction={{value}}>{{name}}</li>";item=$(Mustache.render(item,AUTHITEM[i])),datalist.append(item)}if(this.option.isteam&&datalist.append(Mustache.render('<li class="combox-item-inherit"><input {{#inherit}}checked{{/inherit}} type="checkbox"/>'+_("允许子团队继承权限")+"</li>",{inherit:this.option.inherit})),"combox_role"==this.option.type){datalist.html("");for(var i in ROLEITEM){var item="<li class='combox-item' cssaction={{value}}>{{name}}</li>";item=$(Mustache.render(item,ROLEITEM[i])),datalist.append(item)}this.node.find(".combox-text").html(ROLEITEM[this.option.initval].name)}else this.node.find(".combox-text").html(AUTHITEM[this.option.initval].name);this.node.append(datalist),this.datalist=datalist,this.bindEvent()},bindEvent:function(){var self=this;this.node.delegate(".combox-text,.i-luicombox","click",function(ev){var ele=self.node.find(".combox-text")[0],top=Util.getElementYPos(ele),left=Util.getElementXPos(ele),height=ele.offsetHeight;if(/msie 7/.test(navigator.userAgent.toLowerCase())){left+=1,top+=1;var zIndex=0;$(".lui-combox").each(function(index,combox){zIndex<$(combox).css("z-index")&&(zIndex=$(combox).css("z-index"))}),self.node.css("z-index",zIndex+1)}self.datalist.css({top:top+height,left:left-1}),self.datalist.show()}),this.node.on("mouseleave",function(ev){self.datalist.hide()}),this.datalist.on("mouseleave",function(ev){self.datalist.hide()}),this.datalist.delegate("li.combox-item","mouseenter",function(ev){$(ev.currentTarget).addClass("active")}),this.datalist.delegate("li.combox-item","mouseleave",function(ev){$(ev.currentTarget).removeClass("active")}),this.datalist.delegate("li.combox-item","click",function(ev){self.datalist.hide(),self.node.find(".combox-text").html(ev.currentTarget.innerHTML);var value=ev.currentTarget.getAttribute("cssaction"),index=$(this).parents(".list-item").attr("index");return"combox_role"==self.option.type?(self.fire("change",index,"role",value),this):void self.fire("change",index,"cssAction",value)}),this.datalist.delegate("li.combox-item-inherit>input","click",function(ev){var value=ev.currentTarget.checked,index=$(this).parents(".list-item").attr("index");self.fire("changeInherit",index,"inherit",value)})}}),LuiCombox}),define("component/mailList",function(require,exports){function MailList(node,template,dataFunc){this.node="string"==$.type(node)?$(node):node,this.template=template,this.totalSize=0,this.pageSize=50,this.current=0,this.sort="desc",this.dataFunc=dataFunc,this._init()}var $=jquery=require("jquery"),EventTarget=require("eventTarget"),Scroll=(require("util"),
require("component/scroll"));require("mustache"),require("i18n");var _=$.i18n.prop;return $.extend(MailList.prototype,EventTarget,{_requestData:function(func){var self=this;self.dataFunc(function(data){func(data)},self.pageSize,self.current)},_renderList:function(){var self=this;self._requestData(function(datas){self.render(datas)})},renderList:function(){var self=this;self._renderList()},_init:function(){var self=this,mailList=$('<div class="lui-mailList"></div>');self.node.append(mailList),self.mailList=mailList,self.paging=!1,self._renderList(),self._bindListItemEvent()},_bindListItemEvent:function(){var self=this,listWraper=self.node.find(".lui-mailList");listWraper.delegate(".list-item","click",function(e){var ctar=$(e.currentTarget),tar=$(e.target),da=self.data[ctar.attr("index")];if(tar.hasClass("title")){self.mailList.remove(".displayPanel");var displayPanel=$('<div class="displayPanel"></div>'),temp='<div class="head" title={{head}}>{{head}}<span class="icon i-delete"></span></div><div class="body"><pre>{{body}}</pre></div>',tempNormal='<div class="head" title={{head}}>{{head}}<span class="icon i-delete"></span></div><div class="body" style="word-wrap:break-word;"><div>{{body}}</div></div>';displayPanel.append(Mustache.render(/[\n]/.test(da.body)?temp:tempNormal,{head:da.title,body:da.body})),self.mailList.append(displayPanel),displayPanel.width(self.mailList.outerWidth()+10),displayPanel.height(self.mailList.height()+80),new Scroll(displayPanel),self.fire("open",da),displayPanel.find(".i-delete").on("click",function(){displayPanel.hide(300,function(){displayPanel.remove(),self.fire("back")})})}})},render:function(data){var self=this,list=self.mailList;if(list.empty(),self.data=data,0==data.length)return void self._empty(list);for(var i=0,ii=data.length;ii>i;i++){var cda=data[i];cda.titleEx=cda.top_index>-1&&0==i?_("【置顶:{0}】",cda.title):cda.title;var itm=$(Mustache.render(self.template,cda));itm.attr("index",i),list.append(itm)}self.scroll=new Scroll(list),self.scroll.on("reachEnd",function(){self.current+self.pageSize<=self.totalSize&&(self.paging||(self.paging=!0,self.loading(),setTimeout(function(){self.nextPage()},2e3)))})},add:function(data){var self=this,container=self.filelist.find(".scl-content"),len=self.data.length;self.removeLoading();for(var i=0,ii=data.length;ii>i;i++){var itm=$(Mustache.render(self.template,data[i]));itm.attr("index",len+i),container.append(itm)}self.scroll.render(!0)},nextPage:function(){var self=this;return self.current+self.pageSize>self.totalSize?(self.removeLoading(),void(self.paging=!1)):(self.current+=self.pageSize,void self._requestData(function(datas){self.add(datas),self.paging=!1},function(){self.removeLoading(),self.paging=!1}))},doSort:function(key){var self=this;self.orderby=key,self._renderList()},loading:function(){var self=this,loader=$('<div id="cur-loading"><img src="img/loading3.gif"/></div>'),container=self.filelist.find(".scl-content");container.append(loader),self.scroll.render(!0),self.scroll.scrollTo(1,!0)},removeLoading:function(){var self=this;$("#cur-loading").remove(),self.scroll.render(),self.scroll.scrollTo(1,!0)},_empty:function(parent){var self=this;parent.append($(self.empty_template).html());var upload=parent.find("#first-upload"),addfolder=parent.find("#first-addfolder");upload&&upload.on("click",function(){self.fire("upload")}),addfolder&&addfolder.on("click",function(){self.fire("addfolder")})}}),MailList}),define("component/manageAuthDialog",function(require,exports,module){function ManageAuthDialog(uids,authArr,userType,ok_callback){var self=this;self.uids=uids,self.authArr=authArr||[],self.userType=userType||AuthModel.AGENT_TYPE.USER,self.ok_callback=ok_callback,self._init()}var $=require("jquery"),Dialog=require("component/dialog"),AddDirAuthDialog=(require("component/confirmDialog"),require("component/addDirAuthDialog")),AuthList=require("component/authList"),AuthModel=require("model/AuthManager");require("i18n");var _=$.i18n.prop;return $.extend(ManageAuthDialog.prototype,{_init:function(){var self=this;self.dialog=new Dialog(_("授权管理"),{mask:!0},function(dialog){var authHtml=[];authHtml.push('<div class="manage-auth-dialog">'),authHtml.push('<div class="manage-auth-dialog-subtitle">'+_("权限列表(所选用户如果对该目录已经有权限，则会更新该用户的访问权限)")+"</div>"),authHtml.push('<div class="container"></div>'),authHtml.push("</div>"),dialog.append(authHtml.join("")+'<div class="dialog-button-area"><a id="manage-auth-dialog-id-ok" class="dialog-button ok">'+_("确定")+'</a> <a id="manage-auth-dialog-id-cancel" class="dialog-button cancel">'+_("取消")+"</a></div>"),self.authList=new AuthList(".container",self.uids,self.authArr,self.userType,function(uids,authList,userType){new AddDirAuthDialog(uids,authList,userType)})}),$("#manage-auth-dialog-id-cancel").click(function(){self.dialog.close()}),$("#manage-auth-dialog-id-ok").click(function(){self.dialog.close()})}}),ManageAuthDialog}),define("component/manageTeamDialog",function(require,exports){function ManageTeamDialog(context,teamId,teamFolder,func){this.context=context,this.teamId=teamId,this.teamFolder=teamFolder,this.func=func,this.current={},this._init()}var $=require("jquery"),Dialog=(require("component/validator"),require("component/dialog")),Tips=(require("component/confirmDialog"),require("model/FileManager"),require("component/tips")),Util=require("util"),TeamModel=require("model/TeamManager");require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(ManageTeamDialog.prototype,{_init:function(){function render(){var step1_template='<div id="manageTeamDialog" class="form"><p><span class="label">'+_("团队类型")+'</span>{{type}}</p><p><span class="label">'+_("团队名称")+'</span>{{name}}</p><p><span class="label">'+_("团队空间")+'</span><input id="quota" type="text" value="{{quota}}"/>&nbsp;MB&nbsp;<span class="spaceQuota">'+_("(上限为{{spaceQuota}}MB)")+'</span></p><p><span class="label">'+_("团队人数上限")+'</span><input id="userlimit" type="text" value="{{member_limit}}"/>&nbsp;&nbsp;<span class="userQuota">'+_("(团队成员最大上限为{{user_limit}})")+'</span></p><p><span class="label">'+_("备注")+'</span><textarea id="remark" maxlength="250">{{description}}</textarea></p></div><div class="dialog-button-area"><a id="create" class="dialog-button ok">'+_("确定")+'</a><a id="cancel" class="dialog-button cancel">'+_("取消")+"</a></div>",dialog=('<div id="manageTeamDialog"><p class="sucess-top">'+_("团队设置成功")+'</p></div><div class="dialog-button-area"><a id="cancel" class="dialog-button cancel">'+_("关闭")+"</a></div>",new Dialog(_("团队设置"),function(parent){parent.append(Mustache.render(step1_template,self.data)),"admin"!=window.LenovoData.user.user_role&&$("#del-team").remove(),parent.find("#create").on("click",function(){var quota=$("#quota").val(),userlimit=$("#userlimit").val(),remark=$("#remark").val();return""==quota?void dialog.showMessage("["+_("团队空间")+"]"+_("不能为空")):/^\d+$/.test(quota)?""==userlimit?void dialog.showMessage("["+_("团队人数上限")+"]"+_("不能为空")):""==userlimit||/^\d+$/.test(userlimit)?"0"==userlimit?void dialog.showMessage("["+_("团队人数上限")+"]"+_("不能为0")):remark.length>250?void dialog.showMessage("["+_("备注")+"]"+_("超过了250个字符")):($("body").data("category","teamSetting").data("action","功能区内按钮").data("content","团队"),void TeamModel.info_set(function(result){return 200!=result.code?void Tips.warn(result.message):(dialog.close(),self.func(result.data),Tips.show(_("团队设置成功")),void 0)},self.teamId,{name:self.current.name,quota:Util.scientificToString(1024*$("#quota").val()*1024),member_limit:$.trim($("#userlimit").val()),description:$("#remark").val()})):void dialog.showMessage(_("请输入正确的数字")+"["+_("团队人数上限")+"]"):void dialog.showMessage(_("请输入正整数")+"["+_("团队空间")+"]")}),parent.delegate("#cancel","click",function(){dialog.close()})}))}{var self=this;$("#manageTeamDialog span.spaceQuota"),$("#manageTeamDialog span.userQuota")}self.context.path?(userQuota=self.context.member_limit,spaceQuota=self.context.quota/1024/1024):(userQuota=Util.getUserAccountNumQuota(),spaceQuota=Util.getUserSpaceQuota()/1024/1024),TeamModel.info_get(function(result){200==result.code&&(self.data={},self.data.type=_(result.data.from_domain_account?"域团队":"本地团队"),self.data.name=result.data.name,self.data.quota=result.data.quota?result.data.quota/1024/1024:0,self.data.spaceQuota=spaceQuota,self.data.user_limit=userQuota,self.data.member_limit=-1==result.data.member_limit?Util.getUserAccountNumQuota():result.data.member_limit,self.data.description=result.data.description,render())},self.teamId)}}),ManageTeamDialog}),define("component/mask",function(require,exports,module){function Mask(node){this.node="string"==$.type(node)?$(node):node;var mask=$('<div class="lui-mask"></div>');if(mask.appendTo($("body")),this.node){var offset=this.node.offset();mask.css({width:this.node.outerWidth(),height:this.node.outerHeight(),left:offset.left,top:offset.top,background:"#ffffff"})}mask.css("z-index",window.uuid["z-index"]),window.uuid["z-index"]+=10,this.mask=mask}var $=require("jquery"),EventTarget=require("eventTarget");return window.uuid||(window.uuid={},window.uuid["z-index"]=50),$.extend(Mask.prototype,EventTarget,{close:function(){var self=this;self.mask&&self.mask.remove()}}),Mask}),define("component/memberTree",function(require,exports){function MemberTree(node,func,option){this.node="string"==$.type(node)?$(node):node,this.func=func;var config={title:_("团队和用户管理"),authTree:!0};this.option=$.extend(config,option),this.max_height=this.option.max_height||150,this.min_height=this.option.min_height||20,this.type=this.option.type||TREE_TYPE.DEFAULT,this._init()}var $=require("jquery"),UserManager=(require("util"),require("model/UserManager")),TeamManager=require("model/TeamManager"),Scroll=require("component/scroll"),EventTarget=require("component/eventTarget");require("i18n");var _=$.i18n.prop;return require("jqtree"),$.extend(MemberTree.prototype,EventTarget,{_init:function(nodes){var self=this;self.node.append('<div class="menu-item treeswitch" style="cursor: pointer;"><span class="icon i-user7"></span><span class="menu-text">'+this.option.title+'</span></div><div class="sub-menu-item"><div class="treeview-wraper"><div class="treeview"></div></div> </div>'),self.teamTree=self.node.find(".treeview"),self.root=self.node.find(".treeswitch"),self.root.remove(),self.node.find(".treeview-wraper").css("width",self.width),self.teamTree.tree({data:[],closedIcon:'<span class="icon i-fold" style="vertical-align:middle;"></span>',openedIcon:'<span class="icon i-expand" style="vertical-align:middle;"></span>',onCreateLi:function(node,$li){var folder_icon='<span class="icon i-user'+(node.isCer?"Cer":-1==node.id?7:6)+'"></span>';"user"==node.agent_type&&(folder_icon='<span class="icon i-user'+(node.isCer?"-domain":"")+'"></span>',$li.find(".jqtree-title").text(node.name+(node.email?"("+node.email+")":""))),(!node.element&&"user"!=node.agent_type||node.element&&0==node.children.length&&!node.hasOwnProperty("load_on_demand")&&"user"!=node.agent_type)&&(folder_icon='<a class="jqtree_common jqtree-toggler"><span class="icon i-fold" node-data="'+node.id+'" style="vertical-align:middle;"></span></a>'+folder_icon);var item=$li.find(".jqtree-title");item.before(folder_icon),item.attr("title",item.text())}}),$(self.teamTree).delegate(".jqtree-title","click",function(e){self.selectTeam=!0}),$(self.teamTree).delegate(".i-fold","click",function(e){var id=$(e.target).attr("node-data");if(id){var curNode=self.teamTree.tree("getNodeById",id),parentNode=curNode.parent;if(parentNode.element&&$(parentNode.element).removeClass("jqtree-selected"),self.teamTree.tree("selectNode",null),-1==curNode.id)return void UserManager.list_for_pages(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.teamTree.tree("loadData",nodes,curNode),self.teamTree.tree("toggle",curNode),self.teamTree.tree("selectNode",curNode),self._render()}},0,1e4);TeamManager.getTeamListById(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.teamTree.tree("loadData",nodes,curNode),self.teamTree.tree("toggle",curNode),self.teamTree.tree("selectNode",curNode),self._render()}},curNode._id,!0)}}),self.teamTree.bind("tree.init",function(){}),self.teamTree.bind("tree.click",function(event){{var curNode=event.node;curNode.parent}return $(curNode).css("color","#1E5D7C"),$(curNode).css("font-weight","normal"),"user"==curNode.agent_type?(self.fire("selectNode",curNode),void(self.selectTeam=!1)):void(-1==curNode._id?UserManager.list_for_pages(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.teamTree.tree("loadData",nodes,curNode),self.teamTree.tree("toggle",curNode),self.teamTree.tree("selectNode",curNode),self._render()}},0,1e4):TeamManager.getTeamListById(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.teamTree.tree("loadData",nodes,curNode),self.teamTree.tree("toggle",curNode),self.teamTree.tree("selectNode",curNode),self._render()}},curNode._id,!0))}),self.teamTree.bind("tree.close",function(e){self._render()}),self.teamTree.bind("tree.open",function(e){self._render()})},_initData:function(){var self=this;self.func.call(self,{},function(result){if(200!=result.code)return void self.fire("initError");var nodes=self._dataToNodes(result.data.content);nodes.splice(0,0,{id:-1,_id:-1,name:_("所有用户"),label:_("所有用户"),agent_type:"all",children:{length:0}}),self.teamTree.tree("loadData",nodes);var curNode=self.teamTree.tree("getNodeById",-1);UserManager.list_for_pages(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.teamTree.tree("loadData",nodes,curNode),self.teamTree.tree("toggle",curNode),self._render()}},0,1e4),self._render()},function(result){console.log("error:"+result)})},render:function(){this._initData()},_render:function(){var self=this,height=this.max_height;self.node.find(".treeview-wraper").show(),self.node.find(".treeview-wraper").css("height",height+20),self.scroll||(self.scroll=new Scroll(self.node.find(".treeview-wraper"))),self.scroll&&self.scroll.render(!0)},_dataToNodes:function(data){for(var nodes=[],i=0,len=data.length;len>i;i++){var childNode,item=data[i];childNode="team"==item.agent_type?{_id:item._id,id:item.path,agent_id:item._id,description:item.description,name:item.name,label:this._getTeamName(item.path),isCer:item.from_domain_account,agent_type:"team"}:{_id:item.uid,id:item.uid,agent_id:item.uid,description:item.user_name,name:item.user_name,email:item.email,label:item.user_name,isCer:item.from_domain_account,agent_type:"user"},nodes.push(childNode)}return nodes},getSelectedNode:function(){return this.teamTree.tree("getSelectedNode").path},setSelectedNode:function(node_path){var node=this.teamTree.tree("getNodeById",node_path);this.teamTree.tree("selectNode",node)},_getTeamName:function(path){var index=path.lastIndexOf("/"),teamName=path.substr(index+1);return teamName}}),MemberTree}),define("component/messageBox",function(require,exports){function MessageBox(editable){this.current=0,this.pageSize=50,this.editable=editable,this.currentId="",this.currentItem=null,this.editMode=!1,this.updateMode=!1,this.data=[],this._init()}var $=require("jquery"),NoticeModel=(require("component/combox"),require("model/NoticeManager")),MailList=require("component/mailList"),Util=require("util"),Tips=require("component/tips"),EventTarget=require("eventTarget");require("i18n");var _=$.i18n.prop,sort="desc";return $.extend(MessageBox.prototype,EventTarget,{_init:function(){var self=this,template='<div class="lui-messageBox"><div class="triangle border-br"></div><div class="triangle border-bgd"></div><div class="messagebox"><div class="header"><span class="tab active">'+_("公告")+'</span></div><p class="oper"><span class="combo1">'+_("发布公告")+'</span><span class="combo2 desc"><span class="i-sort"></span>'+_("最近更新")+'</span></p><div class="msgPost"><p><input id="noticeTitle" type="text" maxlength="50"/><br><textarea id="noticeContent" maxlength="250"></textarea><br><input id="post" class="button" type="button" value="'+_("确定")+'"/><input id="cancel" class="button" type="button" value="'+_("取消")+'"/></p></div><div class="msgDispay"></div></div>',mb=$(template);$("body").append(mb),Util.isAdmin()||Util.isTeamLeader()?"en"==$.cookie("language")&&$(".lui-messageBox").find(".triangle").css("left","130px"):$(".lui-messageBox").find(".triangle").css("left","285px");var timer=null;mb.on("mouseleave",function(e){self.editMode||(timer=setTimeout(function(){self.destory()},1500))}),mb.on("mouseover",function(){clearTimeout(timer)});var panelPost=mb.find(".msgPost"),panelDisplay=mb.find(".msgDispay"),combo1=mb.find(".combo1"),combo2=mb.find(".combo2"),title=mb.find("#noticeTitle"),content=mb.find("#noticeContent"),post=mb.find("#post"),cancel=mb.find("#cancel"),template='<div class="list-item view-{{isviewed}}" id="{{id}}" index="{{index}}"><p class="title" title="{{titleEx}}">{{titleEx}}</p><p class="content">{{body}}</p><div class="item-menu"><span class="icon i-top" title="'+_("置顶")+'"></span><span class="icon i-edit" title="'+_("编辑")+'"></span><span class="icon i-delete" title="'+_("删除")+'"></span></div></div>',list=new MailList(panelDisplay,template,function(success,size,page){NoticeModel.pull(function(result){if(200==result.code){0==result.data.new_num?$("#msgCount").hide():($("#msgCount").attr(result.data.new_num>9&&result.data.new_num<99?{"class":"msgMid"}:result.data.new_num>99?{"class":"msgBig"}:{"class":"msgSmall"}),$("#msgCount").text(result.data.new_num).show());for(var datas=[],i=0,ii=result.data.messages.length;ii>i;i++){var item=result.data.messages[i],d={index:i,ctime:item.ctime,id:item.id,title:item.title,body:item.body,account_id:item.account_id,isviewed:item.isviewed,status:item.status,top_index:item.top_index};datas.push(d),self.data=datas}success(datas)}},500,page,sort)});list.on("open",function(data){Util.sendDirectlyRequest("公告","查看",""),data.isviewed||NoticeModel.viewed(function(result){200==result.code&&NoticeModel.pull(function(result){200==result.code&&(0==result.data.new_num?$("#msgCount").hide():($("#msgCount").attr(result.data.new_num>9&&result.data.new_num<99?{"class":"msgMid"}:result.data.new_num>99?{"class":"msgBig"}:{"class":"msgSmall"}),$("#msgCount").text(result.data.new_num).show()))},500,0)},data.id)}),list.on("back",function(){list.renderList()}),combo1.on("click",function(){panelPost.show(),panelDisplay.hide(),self.editMode=!0}),combo2.on("click",function(){"asc"==sort?($(this).removeClass("asc"),$(this).addClass("desc"),sort="desc"):($(this).removeClass("desc"),$(this).addClass("asc"),sort="asc"),list.renderList()}),post.on("click",function(){return""==$.trim(title.val())?void Tips.warn(_("请输入公告标题")):""==$.trim(content.val())?void Tips.warn(_("请输入公告内容")):$.trim(content.val()).length>250?void Tips.warn(_("公告内容不能超过250个汉字")):void(self.updateMode?($("body").data("category","message").data("action","修改").data("content","-"),NoticeModel.update(function(result){200==result.code&&(title.val(""),content.val(""),panelPost.hide(),panelDisplay.show(),list.renderList(),self.updateMode=!1,self.editMode=!1)},self.currentId,title.val(),content.val().replace(/\r/g,"<br>"))):($("body").data("category","message").data("action","创建").data("content","-"),NoticeModel.create(function(result){200==result.code&&(title.val(""),content.val(""),panelPost.hide(),panelDisplay.show(),list.renderList(),self.editMode=!1)},title.val(),content.val())))}),cancel.on("click",function(){panelDisplay.show(),panelPost.hide(),self.editMode=!1}),self.editable&&(mb.delegate(".list-item","mouseenter",function(e){var cur=$(e.currentTarget),menu=cur.find(".item-menu");menu.show(),self.currentId=cur.attr("id"),self.currentItem=cur}),mb.delegate(".list-item","mouseleave",function(e){var cur=$(e.currentTarget),menu=cur.find(".item-menu");menu.hide()}),mb.delegate(".item-menu","click",function(e){var tar=$(e.target);if(tar.hasClass("i-top"))$("body").data("category","message").data("action","置顶").data("content","-"),NoticeModel.top(function(result){200==result.code&&list.renderList()},self.currentId,1),$(this).on("mouseleave",function(){return!1});else if(tar.hasClass("i-edit")){var idx=self.currentItem.attr("index"),d=self.data[idx];title.val(d.title),content.val(d.body),panelPost.show(),panelDisplay.hide(),self.editMode=!0,self.updateMode=!0}else if(tar.hasClass("i-delete")){self.currentItem.find(".confirm-box").remove();var cb=$('<div class="confirm-box"><span class="ok">'+_("确认删除")+'</span><span class="cancel">'+_("取消")+"</span></div>");self.currentItem.append(cb),cb.find(".ok").on("click",function(){$("body").data("category","message").data("action","删除").data("content","-"),NoticeModel.del(function(result){200==result.code&&(Tips.show(_("删除成功")),list.renderList())},self.currentId)}),cb.find(".cancel").on("click",function(){cb.hide(500,function(){cb.remove()})})}$(this).hide()})),panelPost.hide(),Util.isAdmin()||combo1.hide(),$(document).mouseup(function(e){mb.is(e.target)||0!=mb.has(e.target).length||$(e.target).hasClass("i-msg")||0!=$(".lui-mask").length||self.destory()}),self.mb=mb},destory:function(){var self=this;self.fire("destory"),self.mb.remove()}}),MessageBox}),define("lenovo/dmt/1.0.0/component/noticeSet",["jquery","util","component/tips","lenovodata/model/AccountManager","js/gallery/mustache/0.7.2/mustache.js"],function(require,exports){var $=jquery=require("jquery"),Util=require("util"),Tips=require("component/tips"),AccountModel=require("lenovodata/model/AccountManager");_=$.i18n.prop,require("js/gallery/mustache/0.7.2/mustache.js"),$(function(){function init(){AccountModel.get_notice_config(function(ret){if(200==ret.code){for(var leng=ret.data.content.length,arr=[],data=[],team=[],auth=[],delivery=[],elseEvent=[],i=0;leng>i;i++){var item=ret.data.content[i],d={},str=[];d.eId=item.name.substr(6),d.value=item.values,d.switchBtn=d.value[0]||d.value[1]||d.vlaue[2],d.eName=getName(d.eId),eval(d.value[0])&&str.push(_("网页动态")),eval(d.value[2])&&str.push(_("邮件通知")),d.eNotice=str.join("、"),arr[d.eId]=d}data.push(arr[1001]),data.push(arr[1010]),data.push(arr[1007]),data.push(arr[1012]),data.push(arr[1028]),team.push(arr[3002]),team.push(arr[3003]),auth.push(arr[4001]),auth.push(arr[4004]),auth.push(arr[4007]),auth.push(arr[4014]);for(var j=0;j<data.length;j++){var temple=$("#dataTemple").html(),dataTemple=Mustache.render(temple,data[j]);$("#data").append(dataTemple)}for(var j=0;j<team.length;j++){if(0==j)var temple=$("#teamElseTemple").html();else var temple=$("#dataTemple").html();var dataTemple=Mustache.render(temple,team[j]);$("#team").append(dataTemple)}for(var j=0;j<auth.length;j++){var temple=$("#dataTemple").html(),dataTemple=Mustache.render(temple,auth[j]);$("#auth").append(dataTemple)}addEvent()}},"1")}function addEvent(){$(".i-shouqi").click(function(){var obj=$(this).parents("dl");obj.children("dd").slideToggle(),$(this).toggleClass("i-openup")}),$("body").delegate(".noticeBtn","click",function(){var dd=$(this).parents("dd"),id=dd.attr("id").substr(1),idArr=setEvent(id),postData=[];switchyes=dd.hasClass("false");for(var j=0;j<idArr.length;j++)for(var i=0;3>i;i++){var postItem={config_type:1,config_id:Util.getAccountId()};0==i?(postItem.name="event."+idArr[j]+".sub",postItem.value=switchyes?!0:!1):1==i?(postItem.name="event."+idArr[j]+".client",postItem.value=switchyes?!1:!1):2==i&&(postItem.name="event."+idArr[j]+".email",postItem.value=!1),postData.push(JSON.stringify(postItem))}AccountModel.set_notice_config(function(ret){200==ret.code?(dd.hasClass("false")&&dd.find(".noticeStyle em").text(_("网页动态")),dd.toggleClass("false")):Tips.warn(ret.message)},{json:"["+postData+"]"})}),$("body").data("category","notice").data("action","保存修改").data("content",""),$("body").delegate(".notice-modify","click",function(){0!=$("body").find(".notice-edit").length&&$("body").find(".notice-edit").remove();var self=this,bb=$(this).parents("dd");id=bb.attr("id").substr(1),AccountModel.get_notice_config(function(ret){if(200==ret.code){var value=ret.data.content[0].values,temp=$("#editTemp").html();msgBox=$(temp);var t=Util.getElementYPos(self),l=Util.getElementXPos(self)-150,winH=$(window).height();t+=30,$("body").append(temp),$(".notice-edit").css({left:l,top:t}),eval(value[0])&&($(".notice-edit").find("#web")[0].checked="checked"),eval(value[1])&&($(".notice-edit").find("#client")[0].checked="checked"),eval(value[2])&&($(".notice-edit").find("#email")[0].checked="checked")}},"1","event."+id),$(document).mouseup(function(e){$(".notice-edit").is(e.target)||0!=$(".notice-edit").has(e.target).length||$("body").find(".notice-edit").remove()})}),$("body").delegate("#save","click",function(e){for(var isSub=$("#web")[0].checked,isClient=!1,isEmail=$("#email")[0].checked,idArr=setEvent(id),postData=[],j=0;j<idArr.length;j++)for(var i=0;3>i;i++){var postItem={config_type:1,config_id:Util.getAccountId()};0==i?(postItem.name="event."+idArr[j]+".sub",postItem.value=isSub):1==i?(postItem.name="event."+idArr[j]+".client",postItem.value=isClient=!1):2==i&&(postItem.name="event."+idArr[j]+".email",postItem.value=isEmail),postData.push(JSON.stringify(postItem))}AccountModel.set_notice_config(function(ret){if(200==ret.code){var id="e"+ret.data[0].name.split(".")[1];if(isSub||isClient||isEmail){var str=[];isSub&&str.push(_("网页动态")),isClient&&str.push(_("客户端动态")),isEmail&&str.push(_("邮件通知")),$("#"+id).find(".noticeStyle em").text(str.join("、"))}else $("#"+id).addClass("false");$("body").find(".notice-edit").remove()}else Tips.warn(ret.message)},{json:"["+postData+"]"}),e.preventDefault(),e.stopPropagation()})}function getName(id){var name="";switch(id){case"1001":name=_("上传文件夹/文件");break;case"1010":name=_("更新文件");break;case"1003":name=_("下载/打包下载");break;case"1007":name=_("删除文件夹/文件");break;case"1012":name=_("移动/复制文件夹/文件");break;case"1028":name=_("定期清理");break;case"3002":name=_("团队信息变更");break;case"3003":name=_("增加移除成员");break;case"4001":name=_("添加共享");break;case"4007":name=_("删除共享");break;case"4004":name=_("修改共享");break;case"4014":name=_("移交共享");break;case"6001":name=_("生成外链");break;case"6002":name=_("取消外链");break;case"5001":name=_("发布公告");break;case"5002":name=_("修改公告");break;case"5013":name=_("系统升级及公告");break;case"5012":name=_("IP地址限定");break;case"5011":name=_("设备管理");break;default:name=_("....")}return name}function setEvent(id){var arr=[];switch(id){case"1001":arr=[1001,1002,1036];break;case"1010":arr=[1010,1011,1019,1020,1021,1035];break;case"1003":arr=[1003,1004,1005,1006];break;case"1007":arr=[1007,1008,1009,1033,1034];break;case"1012":arr=[1012,1013,1014,1015,1016,1017];break;case"1028":arr=[1028,1029,1037];break;case"3001":arr=[3001];break;case"3002":arr=[3002,3005,3006,3007,3008,3009];break;case"3003":arr=[3003,3004];break;case"4001":arr=[4001,4002,4003,4010,4016,4017];break;case"4007":arr=[4007,4008,4009,4011,4013,4015,4018,4020];break;case"4004":arr=[4004,4005,4006,4012,4019,4021];break;case"4014":arr=[4014];break;case"6001":arr=[6001,6003];break;case"6002":arr=[6002];break;case"5001":arr=[5001];break;case"5002":arr=[5002];break;case"5011":arr=[5011];break;case"5012":arr=[5012];break;case"5013":arr=[5013]}return arr}init()})}),define("component/previewDialog",function(require,exports,module){function PreviewDialog(uri,path,ok_callback){this.uri=uri,this.path=path,this._init()}{var $=require("jquery");require("util"),require("component/dialog")}require("i18n");$.i18n.prop;return require("mustache"),$.extend(PreviewDialog.prototype,{_init:function(){{var self=this;self.path.substr(self.path.lastIndexOf("/")+1)}window.open(self.uri)}}),PreviewDialog}),define("component/progressbar",function(require,exports){function ProgressBar(node,template,data){var node=this.node="string"==$.type(node)?$(node):node,pb=$('<div class="lui-progressbar"><div class="progress"></div><div class="error"></div><div class="progress-container"></div></div>');node.append(pb);var pc=pb.find(".progress-container"),err=pb.find(".error"),proc=pb.find(".progress"),html=Mustache.render(template,data);pc.append(html),this.node=pb,this.container=pc,this.err=err,this.progress=proc,this.template=template,this.cache={}}var $=require("jquery");return require("mustache"),$.extend(ProgressBar.prototype,{render:function(data){var self=this,node=self.node,g=self.cache;for(var key in data)g[key]||(g[key]=$("."+key,node)),"path"!=key?g[key].html(data[key]):g[key].attr("title",data[key])},delegate:function(map){var self=this;$.each(map,function(key,func){self.container.delegate(key,"click",function(e){func(e)})})},update:function(percent){var self=this,node=self.node,progress=self.progress;0==percent?progress.width(0):progress.stop().animate({width:node.width()*percent/100},200,"swing")},fail:function(message){var self=this,msg=$(message);msg=msg&&msg.length>0?msg.text():message,self.err.html(message).attr("title",msg).show()},hide:function(){var self=this;self.node.hide()},show:function(){var self=this;self.node.show()}}),ProgressBar}),define("component/regionSelect",function(require,exports){function RegionSelect(context,json){this.context=context,this.regions=$(json.region),this.count=0,this.selectedClass=json.selectedClass,this.selectedRegion=[],this.selectDiv=null,this.startX=null,this.startY=null,this.node="string"==$.type(json.node)?$(json.node):json.node}function clearEventBubble(evt){evt=evt||window.event,evt.stopPropagation?evt.stopPropagation():evt.cancelBubble=!0,evt.preventDefault?evt.preventDefault():evt.returnValue=!1}var $=require("jquery"),EventTarget=require("eventTarget");return $.extend(RegionSelect.prototype,EventTarget,{select:function(){var self=this;self.node.bind("mousedown",function(ev){var oEvent=event||ev;self.onBeforeSelect(oEvent),$(document).bind("mousemove",function(ev){var oEvent=event||ev;self.onSelect(oEvent),clearEventBubble(oEvent)}),$(document).bind("mouseup",function(){self.onEnd(),self.result=self.node.find("."+self.selectedClass),self.fire("up",self.result)}),clearEventBubble(oEvent)}),$(document).click(function(){self.onEnd()})},onBeforeSelect:function(evt){var self=this;document.getElementById("selContainer")?self.selectDiv=document.getElementById("selContainer"):(self.selectDiv=document.createElement("div"),$(self.selectDiv).css({position:"absolute",width:0,height:0,left:0,top:0,"font-size":0,margin:0,padding:0,border:"1px dashed #0099FF","background-color":"#C3D5ED","z-index":1e3,filter:"alpha(opacity:60)",opacity:"0.6",display:"none"}),self.selectDiv.id="selContainer",document.body.appendChild(this.selectDiv)),self.startX=self.posXY(evt).x,self.startY=self.posXY(evt).y,self.isSelect=!0},onSelect:function(evt){var self=this;if(self.isSelect){$(self.selectDiv).show();for(var posX=self.posXY(evt).x,poxY=self.posXY(evt).y,regionList=($(self.selectDiv)[0].style.left=Math.min(posX,this.startX)+"px",$(self.selectDiv)[0].style.top=Math.min(poxY,this.startY)+"px",$(self.selectDiv)[0].style.width=Math.abs(posX-this.startX)+"px",$(self.selectDiv)[0].style.height=Math.abs(poxY-this.startY)+"px",self.regions),i=0;i<regionList.length;i++){var r=regionList[i],sr=self.innerRegion(self.selectDiv,r);sr?($(r).addClass(self.selectedClass),$(r).find("input")[0].checked="checked"):($(r).removeClass(self.selectedClass),$(r).find("input").removeAttr("checked"),$("#item-selectAll").removeAttr("checked"))}}},onEnd:function(){var self=this;0!=$(self.selectDiv).length&&(self.selectDiv.style.display="none"),self.isSelect=!1,self.count=0,$(document).unbind("mousemove"),$(document).unbind("mouseup")},innerRegion:function(selDiv,region){{var self=this,t1=parseInt(selDiv.style.top),l1=parseInt(selDiv.style.left),r1=t1+parseInt(selDiv.offsetWidth),b1=t1+parseInt(selDiv.offsetHeight),t2=self.getPos(region).top,l2=self.getPos(region).left,r2=l2+parseInt(region.offsetWidth),b2=t2+parseInt(region.offsetHeight);Math.max(t1,t2),Math.min(r1,r2),Math.min(b1,b2),Math.max(l1,l2)}return t2>b1||l2>r1||t1>b2||l1>r2?null:region},getPos:function(obj){for(var l=0,t=0;obj;)l+=obj.offsetLeft,t+=obj.offsetTop,
obj=obj.offsetParent;return{left:l,top:t}},posXY:function(event){event=event||window.event;var posX=event.pageX||event.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft),posY=event.pageY||event.clientY+(document.documentElement.scrollTop||document.body.scrollTop);return{x:posX,y:posY}}}),RegionSelect}),define("component/renameDialog",function(require,exports,module){function RenameDialog(oldfilename,title,callback,context){this.callback=callback,this.oldfilename=oldfilename,this.title=title,this.context=context,this._init()}{var $=require("jquery");require("component/dialog")}ConfirmDialog=require("component/confirmDialog"),Util=require("lenovodata/util"),require("i18n");var _=$.i18n.prop;return $.extend(RenameDialog.prototype,{_init:function(){function editName(){var newfilename=$.trim($("#rename-input").val());""==newfilename||newfilename==self.oldfilename.substr(index)?Tips.warn(_("名称不能为空")):-1==index||extensionReg.test(newfilename)?self.callback(newfilename,cur):new ConfirmDialog({content:_("如果改变文件扩展名，可能会导致文件不可用。<br/>确实要更改吗？")},function(){self.callback(newfilename)})}var self=this,cur=self.context.node.find(".item-selected .filelist-icon");self.context.node.find(".item-selected").addClass("item-rename"),cur.find(".file-name").hide(),cur.find(".edit-input").length<1&&cur.append('<div class="edit-name edit-input"><input id="rename-input" class="rename-input" type="text" value="'+self.oldfilename+'"><span class="icon sure"></span><span class="icon cancel"></span></div>'),cur.find("input").select();var index=self.oldfilename.lastIndexOf("."),sure=cur.find(".sure"),cancel=cur.find(".cancel");if(-1!=index){$("#rename-input").selectRange(0,index);var sss=self.oldfilename.substr(index)+"$";/\)/.test(sss)&&(sss=sss.replace(")","\\)")),/\[/.test(sss)&&(sss=sss.replace("[","\\[")),/\{/.test(sss)&&(sss=sss.replace("{","\\{"));var extensionReg=new RegExp("."+sss)}sure.click(function(){editName(),self.context.node.find(".item-selected").removeClass("item-rename")}),$("#rename-input").on("keypress",function(ev){13==ev.keyCode&&editName()}),cancel.click(function(){cur.find(".file-name").show(),cur.find(".edit-name").remove(),self.context.node.find(".item-selected").removeClass("item-rename")})}}),RenameDialog}),define("component/reqUnlockDialog",function(require,exports,module){function ReqUnlockDialog(context,param){var self=this;self.filename=param.name,self.path=param.path,self.path_type=param.path_type,self.from=param.from,self.neid=param.neid,self._init()}var $=require("jquery"),Tips=require("component/tips"),Dialog=require("component/dialog"),FileManager=require("model/FileManager");require("i18n");var _=$.i18n.prop;require("mustache");var template='<div class="reqUnlockCon"><p class="tishi">'+_('文件"{0}"已被  {1} 锁定,要更新文件需请求解锁。',"{{file_name}}","{{lock_username}}")+'</p><p class="title">'+_("邮件内容")+'</p><p><textarea id="content"></textarea></p></div><div class="dialog-button-area"><a id="reqUnlock" class="dialog-button ok">'+_("确定")+'</a><a id="cancel" class="dialog-button cancel">'+_("取消")+"</a></div>";return $.extend(ReqUnlockDialog.prototype,{_init:function(){var self=this;FileManager.info(function(ret){200==ret.code&&(self.sendEmail=ret.data.lock_email,self.dialog=new Dialog(_("请求解锁"),{mask:!0},function(dialog,dialog_cb){var Dom=Mustache.render(template,{file_name:self.filename,lock_username:ret.data.lock_username});dialog.append(Dom),self._render(dialog,dialog_cb)}))},self.path,self.path_type,self.from,self.neid)},_render:function(dialog,dialog_cb){var self=this;dialog.find("#reqUnlock").click(function(){var email=self.sendEmail,message=$("#content").val(),username=Util.getUserName(),filepath=self.path;FileManager.reqUnlock(function(ret){200==ret.data.code&&200==ret.code?(Tips.show(_("请求解锁邮件发送成功")),self.dialog.close()):Tips.warn(ret.data.msg)},email,message,username,filepath,self.path_type,self.from,self.neid)}),$("#cancel").click(function(){self.dialog.close()})}}),ReqUnlockDialog}),define("component/roleCombox",function(require,exports,module){function RoleCombox(container,role_category,_callback){this.container="string"==$.type(container)?$(container):container,this.item_title=role_category?role_category.item_title:ROLE_CATEGORY.MEMBER.item_title,this.item_value=role_category?role_category.item_value:ROLE_CATEGORY.MEMBER.item_value,this._callback=_callback,this.currentItem=null,this._init()}var $=require("jquery");require("i18n");var _=$.i18n.prop,ROLE_CATEGORY={MEMBER:{item_title:_("团队成员"),item_value:"member"},ADMIN:{item_title:_("团队管理员"),item_value:"admin"}};return RoleCombox.ROLE_CATEGORY=ROLE_CATEGORY,RoleCombox.getRolePair=function(item){return item?ROLE_CATEGORY[item.toString().toUpperCase()]:void 0},$.extend(RoleCombox.prototype,{_init:function(){var self=this,comboxId="combox-"+Math.ceil(1e11*Math.random()),comboxIdforJq="#"+comboxId,htmlArr=[];htmlArr.push('<div id="'+comboxId+'" class="ld-combox">'),htmlArr.push('<div><span act="'+self.item_value+'">'+self.item_title+'</span><span class="icon i-expand arrow"></span></div>'),htmlArr.push("<ul>");for(var key in ROLE_CATEGORY)htmlArr.push('<li act="'+ROLE_CATEGORY[key].item_value+'">'+ROLE_CATEGORY[key].item_title+"</li>");htmlArr.push("</ul>"),htmlArr.push("</div>"),self.container.append(htmlArr.join("")),$(comboxIdforJq).mouseleave(function(e){$(comboxIdforJq).css("position",""),$(e.currentTarget).find("ul").hide()}),$(comboxIdforJq).click(function(e){var ul=$(e.currentTarget).find("ul");"none"==ul.css("display")?(ul.css("position","absolute"),ul.css("background","#FFF"),ul.css("left","-1px"),$(comboxIdforJq).css("position","relative"),ul.show()):(ul.css("position",""),ul.css("background","#FFF"),$(comboxIdforJq).css("position",""),ul.hide())}),$(comboxIdforJq+" ul li").click(function(e){var item=$(e.currentTarget).attr("act"),text=$(e.currentTarget).html();$(comboxIdforJq+" span").eq(0).html(text),$(comboxIdforJq+" span").eq(0).attr("act",item),self.currentItem=item,self._callback&&self._callback(item)})},getSelectItem:function(){var self=this;return self.currentItem}}),RoleCombox}),define("component/sLanguageBox",function(require,exports,module){function SLanguageBox(container,lang,_callback){this.container="string"==$.type(container)?$(container):container,this._callback=_callback,this.lang=lang,this._init()}var $=require("jquery"),Util=require("util");require("mustache"),require("i18n");var language=($.i18n.prop,{zh:{url:"/language/set/zh",cls:"i-chinese",title:"简体中文"},en:{url:"/language/set/en",cls:"i-english",title:"English"}});return $.extend(SLanguageBox.prototype,{_init:function(){var self=this,languageT1='<span class="zh"><a  href="{{zh.url}}">{{zh.title}}</a></span><span class="en"><a  href="{{en.url}}">{{en.title}}</a></span>',output=Mustache.render(languageT1,language);self.container.append(output),self.container.find("a").on("click",function(){Util.sendDirectlyRequest("多语言","切换语言","-")})}}),SLanguageBox}),define("component/scroll",function(require,exports,module){function Scroll(node,isBottom){this.node="string"==typeof node?$(node):node,this.direction=isBottom,this._init()}var $=require("jquery"),EventTarget=require("eventTarget");return require("js/gallery/jquery/mousewheel/3.1.3/jquery.mousewheel.js"),$.extend(Scroll.prototype,EventTarget,{_init:function(){var self=this;self.node.wrapInner('<div class="scl-content"></div>'),self.node.wrapInner('<div class="contentArea clearfix"></div>'),self.node.wrapInner('<div class="lui-scroll"></div>');var scroll=self.node.find(".lui-scroll");this.scroll=scroll,self.render(),self.direction&&(self.scrollDelta(-$("#listBody .scl-content").height(),!0),setTimeout(function(){self.scrollDelta(-30)},200)),scroll.bind("mousewheel",function(e,delta,deltaX,deltaY){self.scrollDelta(30*deltaY),e.preventDefault(),e.stopPropagation()})},render:function(flag){var scrollV,scrollH,barheight,barwidth,originTop,originCtop,self=this,BAR_SIZE=8,scroll=self.scroll,content=(scroll.find(".contentArea"),scroll.find(".scl-content")),trackV=$('<div class="trackV"><div class="track-bg"></div><div class="barV"></div></div>'),trackH=$('<div class="trackH"><div class="track-bg"></div><div class="barH"></div></div>'),sh=scroll.height(),sw=scroll.width();if(flag&&self.vbar){var status=self.vbar;originTop=status.barOffset/status.barMaxOffset,originCtop=status.contentOffset}var w=self.node.width(),h=self.node.height(),ch=content.outerHeight(),cw=content.outerWidth();scroll.find(".trackV").remove(),scroll.find(".trackH").remove(),flag||content.css({top:0}),content.css({left:0}),ch>sh?(scroll.append(trackV),trackH.width(w-BAR_SIZE),scrollV=!0,self.scrollV=scrollV):(scrollV=!1,self.scrollV=null,content.animate({top:0})),cw>sw?(scroll.append(trackH),trackV.height(h-BAR_SIZE),scrollH=!0,self.scrollH=scrollH):(scrollH=!1,self.scrollH=null);var moveFlagV=(trackV.height(),trackH.width(),!1),moveFlagH=!1,move={};if(scrollV){var barV=trackV.find(".barV"),barheight=h*h/ch;if(20>barheight?barheight=20:null,barV.height(barheight),self.vbar={contentHeight:ch,height:barheight,barMaxOffset:h-barheight,contentMaxOffset:ch-h,ratio:(ch-h)/(h-barheight),barOffset:0,contentOffset:0},barV.on("mousedown",function(e){var max=self.vbar.barMaxOffset,ratio=self.vbar.ratio;moveFlagV=!0,move.top=e.pageY-barV.position().top,e.preventDefault(),e.stopPropagation();var process,cnt=content;$("body").on("mousemove",function(me){if(moveFlagV&&!process){process=1;var top=me.pageY-move.top;0>top?top=0:null,top>max?top=max:null,barV.css({top:top}),cnt.css({top:-top*ratio}),self.vbar.barOffset=top,self.vbar.contentOffset=-top*ratio,setTimeout(function(){process=null},100),top==max&&self.fire("reachEnd")}me.preventDefault(),me.stopPropagation()}),$("body").on("mouseleave",function(me){moveFlagV&&(moveFlagV=!1,$("body").off()),me.preventDefault(),me.stopPropagation()}),$("body").on("mouseup",function(me){moveFlagV&&(moveFlagV=!1,$("body").off()),me.preventDefault(),me.stopPropagation()})}),flag){originTop=isNaN(originTop)?0:originTop,originCtop=isNaN(originCtop)?0:originCtop;var bt=self.vbar.ratio*originTop;barV.css({top:bt}),self.vbar.barOffset=bt,self.vbar.contentOffset=originCtop}}if(scrollH){var barH=trackH.find(".barH"),barwidth=w*w/cw;20>barwidth?barwidth=20:null,barH.width(barwidth),self.hbar={contentWidth:cw,width:barwidth,barMaxOffset:w-barwidth,contentMaxOffset:cw-w,ratio:(cw-w)/(w-barwidth),barOffset:0,contentOffset:0},barH.on("mousedown",function(e){var max=self.hbar.barMaxOffset,ratio=self.hbar.ratio;moveFlagH=!0,move.left=e.pageX-barH.position().left,e.preventDefault(),e.stopPropagation();var process,cnt=content;$("body").on("mousemove",function(me){if(moveFlagH&&!process){process=1;var left=me.pageX-move.left;0>left?left=0:null,left>max?left=max+6:null,barH.css({left:left}),cnt.css({left:-left*ratio}),self.hbar.barOffset=left,self.hbar.contentOffset=-left*ratio,setTimeout(function(){process=null},100)}me.preventDefault(),me.stopPropagation()}),$("body").on("mouseup",function(me){moveFlagH&&(moveFlagH=!1,$("body").off()),me.preventDefault(),me.stopPropagation()})})}},scrollTo:function(num,flag){var self=this,scroll=self.scroll,content=(scroll.find(".contentArea"),scroll.find(".scl-content"));if(self.scrollH){var barH=scroll.find(".barH"),hbar=self.hbar,bl=hbar.barMaxOffset*num,cl=-hbar.contentMaxOffset*num;flag?(barH.css({left:bl}),content.css({left:cl})):(barH.stop().animate({left:bl},500,"swing"),content.stop().animate({left:cl},500,"swing")),hbar.barOffset=bl,hbar.contentOffset=cl}if(self.scrollV){var barV=scroll.find(".barV"),vbar=self.vbar,bt=vbar.barMaxOffset*num,ct=-vbar.contentMaxOffset*num;flag?(barV.css({top:bt}),content.css({top:ct})):(barV.stop().animate({top:bt},500,"swing"),content.stop().animate({top:ct},500,"swing")),vbar.barOffset=bt,vbar.contentOffset=ct}},scrollDelta:function(delta,barvToBottom){function processBarV(){var barV=scroll.find(".barV"),vbar=self.vbar;if(barvToBottom)var bt=vbar.barOffset-delta,ct=vbar.contentOffset+delta*vbar.ratio;else{var ct=vbar.contentOffset+delta;bt=vbar.barOffset-1/vbar.ratio*delta}0>bt&&(bt=0),bt>vbar.barMaxOffset&&(bt=vbar.barMaxOffset),ct>0&&(ct=0),ct<-vbar.contentMaxOffset&&(ct=-vbar.contentMaxOffset),ct==-vbar.contentMaxOffset&&(bt=vbar.barMaxOffset),barV.css("top",bt),content.css("top",ct),vbar.barOffset=bt,vbar.contentOffset=ct,self.direction||ct!=-vbar.contentMaxOffset||self.fire("reachEnd"),self.direction&&ct>-10&&self.fire("reachEnd")}var self=this,scroll=self.scroll,content=(scroll.find(".contentArea"),scroll.find(".scl-content"));self.scrollV&&processBarV()},appendContent:function(nodeObj){var self=this,scroll=self.scroll,content=scroll.find(".scl-content");content.append(nodeObj)},emptyContent:function(){var self=this,scroll=self.scroll,content=scroll.find(".scl-content");content.empty()}}),Scroll}),define("component/searchbox",function(require,exports,module){function SearchBox(node,func){this.node=$(node),this.callback=func,this.render()}{var $=require("jquery"),EventTarget=require("component/eventTarget"),TeamModel=require("model/TeamManager"),UserModel=require("model/UserManager"),_=$.i18n.prop;require("util")}return $.extend(SearchBox.prototype,EventTarget,{render:function(){var searchbox=$("<input type='text' class='search-txt' placeholder="+_("输入用户名、邮箱搜索")+"><a><span class='icon i-search'></span></a>"),datalist=$("<ul class='data-list'></ul>");this.node.append(searchbox).append(datalist),this.searchbox=searchbox,this.datalist=datalist,this.bindEvent()},bindEvent:function(){var timer,self=this;self.node.delegate("input","keyup",function(ev){function suggestion(){UserModel.suggestion(function(result){if(200==result.code){if(self.datalist.empty(),result.data.length>0)for(var i=0;i<result.data.length;i++){var li=$("<li class='li-item'></li>");li.attr("dataid",result.data[i].id),result.data[i].email&&li.append("<span class='item-email'>"+result.data[i].email+"</span>"),li.append("<span class='item-name'>"+result.data[i].suggestion+"</span>"),self.datalist.append(li)}else self.datalist.append($("<li class='li-item-no-result'>"+_("搜索无结果")+"</li>"));self.datalist.show()}},key)}var key=this.value;key.length>0&&(clearTimeout(timer),timer=setTimeout(suggestion,500))}),self.node.on("mouseleave",function(ev){self.datalist.hide()}),self.node.delegate("input","blur",function(e){self.node.removeClass("boxfocus")}),self.node.delegate("input","keydown",function(ev){13==ev.keyCode&&(ev.preventDefault(),ev.stopPropagation(),$(this).blur(),self.datalist.hide(),self.search(self.node.find("input").val()),self.node.find("a>span").removeClass("i-search").addClass("i-search-close"))}),self.node.delegate("input","focus",function(ev){self.node.addClass("boxfocus")}),self.node.delegate("a","click",function(ev){var icon=$(this).find("span");icon.hasClass("i-search")?(self.search(self.node.find("input").val()),icon.removeClass("i-search").addClass("i-search-close")):(icon.removeClass("i-search-close").addClass("i-search"),self.fire("close"))}),self.datalist.delegate(".li-item","mouseover",function(e){$(this).addClass("active")}),self.datalist.delegate(".li-item","mouseout",function(e){$(this).removeClass("active")}),self.datalist.delegate(".li-item","click",function(e){var key=$(this).find(".item-name").html();self.node.find(".search-txt").val(key),self.node.find("a>span").removeClass("i-search").addClass("i-search-close"),self.node.removeClass("boxfocus"),self.search(key),self.datalist.hide()})},search:function(key){var self=this;TeamModel.searchUserTeamByName(function(result){200==result.code&&self.callback&&self.callback(result.data.content)},key,0,1e4)}}),SearchBox}),define("component/selectLanguageCombox",function(require,exports,module){function SelectLanguageCombox(container,lang,_callback){this.container="string"==$.type(container)?$(container):container,this._callback=_callback,this.lang=lang,this._init()}var $=require("jquery");require("mustache"),require("i18n");var language=($.i18n.prop,{zh:{url:"/language/set/zh",cls:"i-chinese",title:"简体中文"},en:{url:"/language/set/en",cls:"i-english",title:"English"}});return $.extend(SelectLanguageCombox.prototype,{_init:function(){var self=this,languageT='<div class="cur" style="cursor:pointer"><span class="lang">{{title}}</span><span class="icon i-dropdown"></span></div>',output=Mustache.render(languageT,language[self.lang]),languageT1='<ul><li><span class="zh"><a onclick="setLanguage();" href="{{zh.url}}">{{zh.title}}</a></span></li><li><span class="en"><a onclick="setLanguage();" href="{{en.url}}">{{en.title}}</a></span></li></ul>';output+=Mustache.render(languageT1,language),self.container.append(output),self.container.mouseover(function(e){var ul=$(e.currentTarget).find("ul");"none"==ul.css("display")&&(self.container.css("position","relative"),ul.show())}),self.container.mouseout(function(e){$(e.currentTarget).find("ul").hide()})}}),SelectLanguageCombox}),define("component/selectTeamDialog",function(require,exports){function SelectTeamDialog(callback){this.callback=callback,this._init()}{var $=require("jquery"),Dialog=(require("component/validator"),require("component/dialog")),ListView=(require("component/combox"),require("component/listview")),TeamModel=require("model/TeamManager");require("component/tips")}require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(SelectTeamDialog.prototype,{_init:function(){var self=this,create_template='<div id="selectTeamDialog"><div id="teamList"></div></div><div class="dialog-button-area"><a id="create" class="dialog-button ok">'+_("添加")+'</a><a id="cancel" class="dialog-button cancel">'+_("取消")+"</a></div>",dialog=new Dialog(_("选择团队"),function(parent){parent.append(create_template),TeamModel.list(function(result){if(200==result.code){for(var datas=[],i=0,len=result.data.length;len>i;i++){var item=result.data[i],data={value:item._id,name:item.name,member_limit:-1==item.member_limit?!1:item.member_limit==item.member_num?!0:!1};datas.push(data)}self.listview=new ListView("#teamList"),self.listview.render(datas)}},!0),parent.find("#create").on("click",function(){var items=self.listview.getSelectedItem();dialog.close(),self.callback&&self.callback(items)}),parent.find("#cancel").on("click",function(){dialog.close()})})},getSelectedItem:function(){var self=this;return self.listview.getSelectedItem()}}),SelectTeamDialog}),define("component/selectUserCore",function(require,exports){function SelectUserCore(node,teamId){this.node="string"==typeof node?$(node):node,this.teamId=teamId,this._init()}var $=require("jquery"),Util=require("util"),Combox=(require("component/validator"),require("component/combox")),ListView=require("component/listview"),TeamModel=require("model/TeamManager"),EventTarget=(require("component/tips"),require("eventTarget")),UserModel=require("model/UserManager");require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(SelectUserCore.prototype,EventTarget,{_init:function(){function getAllUser(keyword){var key=keyword||null;UserModel.list(function(result){if(200==result.code){for(var datas=[],i=0,len=result.data.length;len>i;i++){var item=result.data[i],d={uid:item.uid,name:item.user_name,accountId:item.account_id,role:"admin"};datas.push(d)}self.listview.render(datas),self.fire("render")}},UserModel.ROLE.MEMBER,key)}var self=this,create_template='<div id="selectUserDialog"><p><span id="teamGroup"></span><span class="search-area"><input id="search-input" placeholder="'+_("请输入搜索内容")+'"/><span class="icon i-search"></span></span></p><div id="teamUsers"></div></div>';self.node.append(create_template),TeamModel.list(function(result){if(200==result.code){var datas=[];if(datas.push({value:-1,name:_("所有用户")}),self.teamId)for(var i=0,len=result.data.length;len>i;i++){var item=result.data[i];if(item._id==self.teamId){var data={value:item._id,name:item.name};datas.push(data)}}else for(var i=0,len=result.data.length;len>i;i++){var item=result.data[i],data={value:item._id,name:item.name};datas.push(data)}self.combox=new Combox("#teamGroup",datas),self.listview=new ListView("#teamUsers"),self.combox.on("change",function(d){self.current=d.value,-1==d.value?getAllUser():TeamModel.membership_get(function(result){if(200==result.code){for(var datas=[],i=0,len=result.data.length;len>i;i++){var item=result.data[i],da={index:i,uid:item.uid,name:item.user_name,role:item.role,ctime:item.ctime,team:item.team};datas.push(da)}self.listview.render(datas),self.fire("render")}},d.value)}),self.combox.change(0)}},Util.isAdmin());var input=self.node.find("#search-input"),searchBtn=self.node.find(".i-search");searchBtn.on("click",function(e){""!=$.trim(input.val())&&getAllUser(input.val())}),input.on("keydown",function(e){13==e.keyCode&&searchBtn.trigger("click")})},getSelectedItem:function(){var self=this;return self.listview.getSelectedItem()}}),SelectUserCore}),define("component/selectUserDialog",function(require,exports){function SelectUserDialog(context,teamId,teamName){this.context=context,this.teamId=teamId,this.teamName=teamName,this._init()}var $=require("jquery"),Tips=require("component/tips"),Dialog=require("component/dialog"),UserTeamAuthList=(require("component/selectUserCore"),require("component/userTeamAuthList")),TeamModel=require("model/TeamManager");require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(SelectUserDialog.prototype,{_init:function(){var self=this,opt={teamName:self.teamName},create_template='<div class="dialog-button-area"><a id="create" class="dialog-button ok">'+_("确定")+'</a><a id="cancel" class="dialog-button cancel">'+_("取消")+"</a></div>",dialog=new Dialog(_("选择用户"),function(parent,callback){var suc=new UserTeamAuthList(parent,0,opt);parent.append(create_template),suc.on("render",function(){callback()}),$("body").data("category","adduser").data("action","工具栏内下拉按钮").data("content","成员"),parent.find("#create").on("click",function(){for(var arr=suc.getSelectedItem(),user_infos=[],i=0;i<arr.length;i++)"[object Function]"!=Object.prototype.toString.call(arr[i])&&user_infos.push('{"uid":'+arr[i].uid+',"role":"'+arr[i].role+'"}');return 0==user_infos.length?void dialog.close():void TeamModel.membership_batch_creat(function(result){200==result.code?(dialog.close(),Tips.show(_("添加成功")),self.context.render()):Tips.warn(result.message)},self.teamId,user_infos)}),parent.find("#cancel").on("click",function(){dialog.close()})})}}),SelectUserDialog}),define("component/setAuthDialog",function(require,exports,module){function SetAuthDialog(fileAttr,ok_callback){var self=this;self.fileAttr=fileAttr,self.path=fileAttr.path,self.authArr=null,self.ok_callback=ok_callback,self._init()}var $=require("jquery"),Dialog=require("component/dialog"),Tips=require("component/tips"),AuthModel=require("model/AuthManager"),UserModel=require("model/UserManager"),ConfirmDialog=require("component/confirmDialog"),AddAuthDialog=require("component/addAuthDialog"),Util=require("util"),EventTarget=require("eventTarget"),AuthCombox=require("component/authCombox");require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(SetAuthDialog.prototype,EventTarget,{_render:function(dialog,dialog_cb){var self=this,authHtml=[];authHtml.push('<div id="auth-dialog-id">'),authHtml.push('<div class="auth-dir">'),authHtml.push('<span class="auth-col-title">'+_("授权文件夹")+"</span>"),authHtml.push('<span style="width:378px;border:1px #CDD1D2 solid;display:inline-block;white-space: nowrap; overflow: hidden; text-overflow: ellipsis;margin-left: 8px;" title="'+Util.getRootDisplayName()+self.path+'">'),authHtml.push('<span style="width:20px;height:20px" class="icon i-folder1"></span>'),authHtml.push(Util.getRootDisplayName()+self.path),authHtml.push("</span>"),authHtml.push("</div>"),authHtml.push('<div class="auth-user-list lui-auth-list">'),authHtml.push('<span class="auth-col-title">'+_("授权记录")+"</span>"),self.authArr.sort(function(a,b){return a.agent_type==b.agent_type?0:"all"==a.agent_type?-1:"all"==b.agent_type?1:"team"==a.agent_type&&"user"==b.agent_type?-1:"user"==a.agent_type&&"team"==b.agent_type?1:void 0});for(var i=0,len=self.authArr.length;len>i;i++){var icon="icon ";switch(self.authArr[i].agent_type){case AuthModel.AGENT_TYPE.TEAM:icon+="i-user6";break;case AuthModel.AGENT_TYPE.ALL:self.authArr[i].agent_name=_("所有用户"),icon+="i-user7";break;case AuthModel.AGENT_TYPE.USER:icon+="i-user"}authHtml.push('<li class="clearfix" style="line-height:20px;margin:6px 0 0 11px; font-size:12px;">'),authHtml.push('<span class="'+icon+'"></span>'),authHtml.push('<span style="width: 19px;height: 19px; float:left; padding-left:5px;">'),authHtml.push('<span style="width:200px;text-overflow:ellipsis;overflow:hidden;display:inline-block;white-space:nowrap;vertical-align:middle;" title="'+self.authArr[i].agent_name+'">'+self.authArr[i].agent_name+"</span>"),authHtml.push("</span>"),authHtml.push('<span style="float:right;padding:0 10px 0px 5px;"><a class="icon i-delete" authid="'+self.authArr[i].id+'"></a></span>'),authHtml.push('<div id="authcombox'+i+'" style="float:right;"></div>'),authHtml.push("</li>")}authHtml.push("</div>"),authHtml.push('<div class="auth-dir">'),self.fileAttr.teamId,authHtml.push('<input type="button" id="add-auth-id" style="width:78px; height:28px;border: 1px #fefefe solid; margin-left: 64px; background:#cfcfcf; border:none;" value="'+_("添加授权")+'">'),authHtml.push("</div>"),authHtml.push("</div>"),dialog.append(authHtml.join("")+'<div class="dialog-button-area"><a id="auth-dialog-id-ok" class="dialog-button ok">'+_("确定")+'</a> <a id="auth-dialog-id-cancel" class="dialog-button cancel">'+_("取消")+"</a></div>");for(var i=0,len=self.authArr.length;len>i;i++)new AuthCombox("#authcombox"+i,AuthModel.getAuthPair(self.authArr[i].action),self.authArr[i],function(item,data){var authData=data;AuthModel.update(function(ret){return 200!=ret.code?void Tips.warn(ret.message):void 0},authData.id,item)});$("#auth-dialog-id").delegate(".i-delete","click",function(e){var authid=$(e.currentTarget).attr("authid");new ConfirmDialog({content:_("真的要删除当前用户的授权吗？")},function(){AuthModel.batch_del(function(ret){200==ret.code?($(e.currentTarget).parent().parent().remove(),Tips.show(ret.message),self.ok_callback&&self.ok_callback()):Tips.warn(500==ret.code?ret.message.join("<br"):ret.message)},[authid])})}),$("#add-unregister-user-btn").click(function(){var email=$.trim($("#add-unregister-user").val());return""==email?void Tips.warn(_("Email不能为空!")):Util.validEmail(email)?self.fileAttr.teamId?void UserModel.create_join_team(function(ret){200==ret.code&&self.ok_callback&&self.ok_callback()},email,self.fileAttr.teamId):void Tips.warn(_("该文件夹不属于任何组，不能创建新用户！")):void Tips.warn(_("Email格式不正确!"))}),$("#add-auth-id").click(function(){self.dialog.close(),new AddAuthDialog(self.fileAttr,function(){new SetAuthDialog(self.fileAttr,self.ok_callback)})}),$("#auth-dialog-id-cancel").click(function(){self.ok_callback&&self.ok_callback(),self.dialog.close()}),$("#auth-dialog-id-ok").click(function(){self.ok_callback&&self.ok_callback(),self.dialog.close()}),dialog_cb()},_init:function(){var self=this;self.dialog=new Dialog(_("设置授权"),{mask:!0},function(dialog,dialog_cb){AuthModel.get(function(ret){return null==ret.code?void Tips.warn(_("很抱歉，您的操作失败了，建议您重试一下！")):(self.authArr=ret.data,void self._render(dialog,dialog_cb))},self.path)})}}),SetAuthDialog}),define("component/shareMemberDialog",function(require,exports,module){function ShareMemberDialog(node,options){this.node=$(node),this.option=$.extend({},options),this.init()}var $=require("jquery"),ListView=require("component/listview"),_=$.i18n.prop;return require("mustache"),ShareMemberDialog.prototype={init:function(){var list_config={column:1,template:["<li class='list-item'>","<div class='item-image'><i class='icon i-head-user'></i></div>","<div class='fr'><span class='item-name'>{{username}}</span><span class='item-email'>{{#email}}({{email}}){{/email}}</span></div>","</li>"].join("")},inner=$(["<div class='lui-hover-dialog'>","<div class='lui-list-wraper'>","<h2>"+(1==this.option.data.length?_("共享成员1人"):_("共享成员{0}人",this.option.data.length))+"</h2>","<div class='lui-list member-list'></div><div class='lui-list search-list'></div></div>","</div>"].join(""));$("body").append(inner);this.member_list=new ListView(inner.find(".member-list"),list_config),this.render(this.option.data),$(document).mouseup(function(e){$(".file-share-user").is(e.target)||0!=$(".file-share-user").has(e.target).length||inner.is(e.target)||0!=inner.has(e.target).length||inner.remove()})},render:function(data){data&&data.length>0&&this.member_list.render(data)}},ShareMemberDialog}),define("component/survey",function(require,exports){function Survey(node,data){this.node="string"==$.type(node)?$(node):node,this.data=data,this.uuid=0,this._init()}var $=require("jquery");require("i18n");$.i18n.prop;return require("mustache"),$.extend(Survey.prototype,{_init:function(){for(var self=this,template="<tr><td>{{index}}</td><td>{{subject}}</td><td>{{&options}}</td></tr>",radio_temp='<input name="{{postName}}" type="radio" value="{{value}}" id="in_{{id}}"/><label for="in_{{id}}">{{text}}</label>',checkbox_temp='<input name="{{postName}}" type="checkbox" value="{{value}}" id="in_{{id}}"/><label for="in_{{id}}">{{text}}</label>',other_temp='<input type="checkbox" class="other" id="in_{{id}}"/><label for="in_{{id}}">{{text}}</label><input type="text" name="{{postName}}" disabled/>',suggest_temp='<textarea name="{{postName}}"></textarea>',html=['<table class="lui-survey"><tbody>'],i=0,ii=self.data.length;ii>i;i++){var item=self.data[i],itemData={index:i+1,subject:item.subject},opts=[];if(item.multiSelect)for(var j=0,jj=item.options.length;jj>j;j++){var itm=item.options[j];if(itm.mode&&"other"==itm.mode){var d={id:self.guid(),postName:item.postName,text:itm.text,type:"multi"};opts.push(Mustache.render(other_temp,d))}else{var d={id:self.guid(),postName:item.postName,value:itm.value,text:itm.text,type:"multi"};opts.push(Mustache.render(checkbox_temp,d))}}else for(var j=0,jj=item.options.length;jj>j;j++){var itm=item.options[j];if(itm.mode&&"other"==itm.mode){var d={id:self.guid(),postName:item.postName,text:itm.text,type:"single"};opts.push(Mustache.render(other_temp,d))}else if(itm.mode&&"suggest"==itm.mode){var d={id:self.guid(),postName:item.postName,text:itm.text,type:"suggest"};opts.push(Mustache.render(suggest_temp,d))}else{var d={id:self.guid(),postName:item.postName,value:itm.value,text:itm.text,type:"single"};opts.push(Mustache.render(radio_temp,d))}}itemData.options=opts.join(""),html.push(Mustache.render(template,itemData))}html.push("</tbody></table>"),self.node.html(html.join("")),$(".other").click(function(){var me=$(this);1==this.checked?me.siblings("input[type=text]").removeAttr("disabled"):me.siblings("input[type=text]").val("").attr("disabled",!0)})},validate:function(){var self=this,flag=!0;return $(".lui-survey tr").each(function(index,item){var tar=$(item);if(tar.find("input[type=radio]").length>0||tar.find("input[type=checkbox]").length>0){if(0==tar.find("input:checked").length)return self.glint(tar),flag=!1,!1;tar.css("background-color","#fff")}}),flag},glint:function(obj){obj.css("background-color");obj.css("background-color","#ff0000")},guid:function(){return++this.uuid}}),Survey}),define("component/table",function(require,exports,module){function Table(opt){var DEFAULT_CONFIG={node:"",template:{header:"",row:""},data:[]};this.cfg=$.extend(DEFAULT_CONFIG,opt),this.cache={},this._init()}{var $=require("jquery");require("component/dialog")}return EventTarget=require("component/eventTarget"),Scroll=require("component/scroll"),require("mustache"),$.extend(Table.prototype,EventTarget,{_init:function(){var self=this,opt=self.cfg,node=$(opt.node),ul=$("<ul></ul>"),wraper=$('<div class="lui-table"><div class="table-head"><ul class="header-ul"></ul></div><div class="contentTable"></div><div class="foot"></div></div>');node.empty();var header=wraper.find(".header-ul"),contentTable=wraper.find(".contentTable");""!=opt.template.header&&header.append(opt.template.header);var data=opt.data;

if(data&&""!=opt.template.row)for(var i=0,l=data.length;l>i;i++){var item=data[i],td=$(Mustache.render(opt.template.row,item));td.attr("index",i),td.addClass("table-tr"),td.appendTo(ul)}contentTable.append(ul),node.append(wraper),contentTable.height(node.height()-header.outerHeight()),self.uiScroll=new Scroll(contentTable),wraper.find("ul").delegate(".table-tr","click",function(e){var cache=self.cache,nn=$(e.currentTarget);wraper.find(".table-tr").removeClass("li-selected"),nn.addClass("li-selected");var idx=nn.attr("index"),param=opt.data[idx];cache.selected=param,self.fire("select",nn,param),e.stopPropagation(),e.preventDefault()})},reload:function(opt){$.extend(this.cfg,opt),this._init()}}),Table}),define("component/teamInfoDialog",function(require,exports){function TeamInfoDialog(teamId,teamFolder){this.teamId=teamId,this.teamFolder=teamFolder,this.current={},this._init()}var $=require("jquery"),Dialog=(require("component/validator"),require("component/dialog")),TeamModel=(require("component/confirmDialog"),require("model/FileManager"),require("model/TeamManager"));require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(TeamInfoDialog.prototype,{_init:function(){function render(){var step1_template='<div id="teamInfoDialog" class="form"><p><span class="label">'+_("团队名称")+'</span><span class="desc">{{name}}</span></p><p><span class="label">'+_("团队空间")+'</span><span class="desc">{{quota}}&nbsp;MB</span></p><p><span class="label">'+_("团队人数上限")+'</span><span class="desc">{{member_limit}}&nbsp;&nbsp;</span></p><p><span class="label">'+_("备注")+'</span><span class="desc" title="{{description}}">{{description}}</span></p></div><div class="dialog-button-area"><a id="cancel" class="dialog-button cancel">'+_("关闭")+"</a></div>",dialog=new Dialog(_("团队信息"),function(parent){parent.append(Mustache.render(step1_template,self.data)),parent.delegate("#cancel","click",function(){dialog.close()})})}var self=this;TeamModel.info_get(function(result){200==result.code&&(self.data={},self.data.name=result.data.name,self.data.quota=result.data.quota?result.data.quota/1024/1024:0,self.data.member_limit=-1==result.data.member_limit?_("无限制"):result.data.member_limit,self.data.description=result.data.description,render())},self.teamId)}}),TeamInfoDialog}),define("component/teamList",function(require,exports,module){function TeamList(container,uid,data,delete_cb,combox_cb){this.container="string"==$.type(container)?$(container):container,this.data=data,this.uid=uid,this.delete_cb=delete_cb,this.combox_cb=combox_cb,this._init()}var $=require("jquery"),RoleCombox=(require("model/TeamManager"),require("component/roleCombox"));require("i18n");var _=$.i18n.prop;return $.extend(TeamList.prototype,{_init:function(){var self=this;self.rolelistid="rolelist-"+Math.ceil(1e10*Math.random());var htmlArr=[];htmlArr.push('<div class="team-list-container">'),htmlArr.push('<div class="team-list-list-header">'),htmlArr.push('<span class="col1">'+_("名称")+"</span>"),htmlArr.push('<span class="col2">'+_("角色")+"</span>"),htmlArr.push("</div>"),htmlArr.push('<div id="'+self.rolelistid+'" class="team-list-container1">'),htmlArr.push("</div>"),htmlArr.push("</div>"),self.container.append(htmlArr.join("")),0==self.data.length&&$("#"+self.rolelistid).append("<p style='text-align:center;line-height:250px;'>"+_("没有加入任何团队")+"</p>");for(var i=0,len=self.data.length;len>i;i++)self.appendRoleItem(self.data[i]);$(".team-list-container").delegate(".i-delete","click",function(e){var dataid=$(e.currentTarget).attr("dataid");self.delete_cb&&self.delete_cb(e,dataid,[self.uid])})},_genRoleItem:function(dataItem,i){var htmlArr=[];return htmlArr.push('<div class="team-list-list-item-container clearfix">'),htmlArr.push('<span class="col1">'),htmlArr.push('<span class="icon i-user6"></span> '),htmlArr.push('<span title="'+dataItem.path.substring(1)+'">'+dataItem.name+"</span>"),htmlArr.push("</span>"),htmlArr.push('<span class="col3"><a class="icon i-delete" dataid="'+dataItem.dataid+'"></a></span>'),htmlArr.push('<span class="col2" id="rolecombox-'+i+'"></span>'),htmlArr.push("</div>"),htmlArr.join("")},_bindRoleItemEvent:function(dataItem,i){var self=this;new RoleCombox("#rolecombox-"+i,RoleCombox.getRolePair(dataItem.role),function(role){self.combox_cb&&self.combox_cb(dataItem,role)})},appendRoleItem:function(dataItem){var self=this,i=Math.ceil(1e10*Math.random()),html=self._genRoleItem(dataItem,i);$("#"+self.rolelistid).append(html),self._bindRoleItemEvent(dataItem,i)},beforeRoleItem:function(dataItem,i){var self=this,i=Math.ceil(1e10*Math.random()),html=self._genRoleItem(dataItem,i);$("#"+self.rolelistid).before(html),self._bindRoleItemEvent(dataItem,i)}}),TeamList}),define("component/teamMenu",function(require,exports){function TeamMenu(node,selectId,isAdmin){this.node=$(node),this.selectId=selectId,this.isAdmin=isAdmin,this._render()}var $=jquery=require("jquery"),TeamModel=require("model/TeamManager"),EventTarget=require("eventTarget"),Scroll=require("component/scroll");require("i18n");var _=$.i18n.prop;return $.extend(TeamMenu.prototype,EventTarget,{_render:function(){var self=this,topItem='<div class="menu-item" teamId="-1"><span class="icon i-user7"></span><a href="/user/manage" class="menu-text">'+_("团队和用户管理")+"</a></div>",subc=$('<div class="sub-container"></div>'),mItem='<div class="sub-item" teamId="{{_id}}" teamPath="{{}}"><span class="icon i-user6"></span><span class="menu-text" title="{{name}}">{{name}}{{number}}</span></div>';TeamModel.list(function(result){if(200==result.code){self.node.empty(),self.isAdmin&&self.node.append(Mustache.render(topItem,{total:result.data.length}));for(var i=0,len=result.data.length;len>i;i++)subc.append(Mustache.render(mItem,result.data[i]));self.node.append(subc);var h=subc.outerHeight()+20;h>$(".page-left").height()-90&&(h=$(".page-left").height()-90),subc.height(h),new Scroll(subc),self.node.delegate(".sub-item","click",function(e){var tar=$(e.currentTarget),id=tar.attr("teamId");self._select(id),self.fire("change",id,tar.find(".menu-text").text())}),self._select(self.selectId)}},!0)},_select:function(id){var self=this;if(-1==id){var topm=$(self.node.children()[0]);topm.addClass("active")}else{var found=!1;if(self.node.find(".sub-item").each(function(index,item){var itm=$(item);itm.attr("teamId")==id?(found=!0,itm.addClass("active")):itm.removeClass("active")}),!found){var first=self.node.find(".sub-item").eq(0);first.addClass("active"),self.fire("change",first.attr("teamId"),first.find(".menu-text").text())}}},render:function(){var self=this;self._render()}}),TeamMenu}),define("component/teamOfUsersDialog",function(require,exports,module){function TeamOfUsersDialog(uid,callback){this.uid=uid,this._init(),this.callback=callback}var $=require("jquery"),TeamList=require("component/teamList"),Tips=require("component/tips"),Dialog=require("component/dialog"),ConfirmDialog=require("component/confirmDialog"),SelectTeamDialog=require("component/selectTeamDialog"),Util=require("util"),TeamModel=require("model/TeamManager");require("i18n");var _=$.i18n.prop;return $.extend(TeamOfUsersDialog.prototype,{_init:function(){var self=this,htmlArr=[];htmlArr.push('<div class="team-user-dialog">'),htmlArr.push('<div class="team-list-subtitle">'+_("")+"</div>"),htmlArr.push('<div class="team-list-c"></div>'),htmlArr.push("</div>"),self.dialog=new Dialog(_("所属团队"),{mask:!0},function(dialog){dialog.append(htmlArr.join("")+'<div class="dialog-button-area"><a id="teamofusers-ok" class="dialog-button cancel">'+_("关闭")+"</a></div>")}),TeamModel.list_direct_belong_to_team(function(ret){if(200!=ret.code)return void Tips.warn(ret.message);for(var teamData=[],i=0,len=ret.data.length;len>i;i++)teamData.push({path:ret.data[i].path,name:Util.resolvePath(ret.data[i].path).name,role:ret.data[i].role,dataid:ret.data[i]._id});new TeamList(".team-list-c",self.uid,teamData,function(e,dataid,uids){return Util.isTeamLeader()&&Util.getUserID()==self.uid?void Tips.warn(_("不能移出自己")):($("body").data("action","所属团队列表").data("category","subtract").data("content","成员"),void new ConfirmDialog({content:_("真的要从团队中删除当前用户吗？")},function(){TeamModel.membership_kickoff(function(ret){200==ret.code?(Tips.show(ret.message),$(e.currentTarget).parent().parent().remove()):Tips.warn(ret.message)},dataid,uids)}))},function(dataItem,role){return Util.isTeamLeader()&&Util.getUserID()==self.uid?void Tips.warn(_("不能改变自己的角色")):($("body").data("action","所属团队列表").data("category","update").data("content","成员角色"),void TeamModel.set_role(function(ret){200!=ret.code&&Tips.warn(ret.message)},dataItem.dataid,self.uid,role))})},self.uid),$("#teamofusers-ok").click(function(){self.callback&&self.callback(),self.dialog.close()}),$("#teamofusers-cancel").click(function(){self.callback&&self.callback(),self.dialog.close()}),$(".team-list-add-link").click(function(){self.dialog.close(),new SelectTeamDialog(function(teams){for(var teamIds=[],i=0,len=teams.length;len>i;i++)teamIds.push(teams[i].value);TeamModel.batch_join(function(ret){200!=ret.code?Tips.warn(ret.message):new TeamOfUsersDialog(self.uid)},self.uid,teamIds)})})},close:function(){this.dialog.close()}}),TeamOfUsersDialog}),define("component/teamTree",function(require,exports){function TeamTree(node,func,option){this.node="string"==$.type(node)?$(node):node,this.func=func;var config={title:_("团队和用户管理")};this.option=$.extend(config,option),this.max_height=this.option.max_height||192,this.min_height=this.option.min_height||20,this.type=this.option.type||TREE_TYPE.DEFAULT,this._init()}var $=require("jquery"),TeamManager=(require("util"),require("model/TeamManager")),EventTarget=(require("model/AuthManager"),require("component/eventTarget"));require("i18n");var _=$.i18n.prop;require("jqtree");var TREE_TYPE=exports.TREE_TYPE={DEFAULT:0,COMBOX:1};return $.extend(TeamTree.prototype,EventTarget,{_init:function(nodes){var self=this;self.node.append('<div class="menu-item treeswitch" style="cursor: pointer;"><span class="icon i-user7"></span><span class="menu-text">'+this.option.title+'</span></div><div class="sub-menu-item"><div class="treeview-wraper"><div class="treeview"></div></div> </div>'),self.teamTree=self.node.find(".treeview"),self.root=self.node.find(".treeswitch"),self.option.authTree&&(self.root.addClass("auth-tree"),self.root.find("span.icon").addClass("i-team-user")),this.type==TREE_TYPE.DEFAULT&&self.root.remove(),self.node.find(".treeview-wraper").css("width",self.width),self.teamTree.tree({data:[],closedIcon:'<span class="icon i-fold" style="vertical-align:middle;"></span>',openedIcon:'<span class="icon i-expand" style="vertical-align:middle;"></span>',onCreateLi:function(node,$li){var folder_icon='<span class="icon i-user'+(node.isCer?"Cer":-1==node.id?7:6)+'"></span>';(!node.element||node.element&&0==node.children.length&&!node.hasOwnProperty("load_on_demand"))&&(folder_icon='<a class="jqtree_common jqtree-toggler"><span class="icon i-fold" node-data="'+node.id+'" style="vertical-align:middle;"></span></a>'+folder_icon);var item=$li.find(".jqtree-title");item.before(folder_icon),item.attr("title",item.text())}}),$(self.root).click(function(e){self.fire("manage",e.currentTarget.innerText)}),$(self.teamTree).delegate(".jqtree-title","click",function(e){self.selectTeam=!0}),$(self.teamTree).delegate(".i-fold","click",function(e){var id=$(e.target).attr("node-data");if(id){var curNode=self.teamTree.tree("getNodeById",id),parentNode=curNode.parent;if(parentNode.element&&$(parentNode.element).removeClass("jqtree-selected"),self.option.topTree&&self.fire("teamSelected",curNode._id,curNode.name,curNode.path,curNode.getLevel(),curNode.isCer),-1==curNode.id)return void self.fire("selectAllUser",curNode.name);self.teamTree.tree("selectNode",null),TeamManager.getTeamListById(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.teamTree.tree("loadData",nodes,curNode),self.teamTree.tree("toggle",curNode),self.teamTree.tree("selectNode",curNode),self._render()}},curNode._id,!1)}}),self.teamTree.bind("tree.init",function(){}),self.teamTree.bind("tree.click",function(event){self.root.css("color","#1E5D7C"),self.root.css("font-weight","normal");{var curNode=event.node;curNode.parent}return-1==curNode.id?void self.fire("selectAllUser",curNode.name):self.selectTeam&&self.type==TREE_TYPE.COMBOX?(self.fire("selectTeam",curNode._id,curNode.name,curNode.path,curNode.isCer),void(self.selectTeam=!1)):(self.fire("teamSelected",curNode._id,curNode.name,curNode.path,curNode.getLevel(),curNode.isCer),$(curNode).css("color","#1E5D7C"),$(curNode).css("font-weight","normal"),void TeamManager.getTeamListById(function(message){if(200==message.code){var nodes=self._dataToNodes(message.data.content);self.teamTree.tree("loadData",nodes,curNode),self.teamTree.tree("toggle",curNode),self.teamTree.tree("selectNode",curNode),self._render()}},curNode._id,!1))}),self.teamTree.bind("tree.close",function(e){self._render()}),self.teamTree.bind("tree.open",function(e){self._render()}),self.teamTree.bind("tree.move",function(event){TeamManager.move(function(ret){event.move_info.target_node.realpath=event.move_info.target_node.realpath+"/"+event.move_info.moved_node.name},event.move_info.moved_node.realpath,event.move_info.target_node.realpath+"/"+event.move_info.moved_node.name)})},_initData:function(){var self=this;self.func.call(self,{},function(result){if(200!=result.code)return void self.fire("initError");var nodes=self._dataToNodes(result.data.content);self.option.authTree&&nodes.splice(0,0,{id:-1,name:_("所有用户"),label:_("所有用户"),children:{length:-1}}),self.teamTree.tree("loadData",nodes),self._render(),self.type==TREE_TYPE.COMBOX&&(self.scroll.scrollTo(0,!0),self.scroll.scroll.find(".scl-content").css("top",0)),self.fire("loadComplete",nodes[0]._id,nodes[0].name,nodes[0].path,nodes[0].isCer)},function(result){console.log("error:"+result)})},render:function(){this._initData()},_render:function(){var self=this;self.node.find(".treeview-wraper").show();var max_height=this.max_height;self.max_height=max_height>45?max_height:45;var height=self.max_height<self.teamTree.height()?self.max_height:self.teamTree.height();0==height&&(height=self.min_height),self.node.find(".treeview-wraper").css("height",height+20),self.scroll||(self.scroll=new Scroll(self.node.find(".treeview-wraper"))),self.scroll&&self.scroll.render(!0),this.fire("renderCompleted")},insertTeamNode:function(parentPath,childTeam){var self=this,teamItem=childTeam,parentNode=self.teamTree.tree("getNodeById",parentPath),childNode=self.teamTree.tree("appendNode",{_id:teamItem._id,id:teamItem.path,name:teamItem.name,description:teamItem.description,member_limit:teamItem.member_limit,member_num:teamItem.member_num,quota:teamItem.quota,path:teamItem.path,label:this._getTeamName(teamItem.path)},parentNode);self._render(),self.teamTree.tree("selectNode",childNode),self.fire("teamSelected",childNode._id,childNode.name,childNode.path,childNode.getLevel(),!1)},_dataToNodes:function(data){for(var nodes=[],i=0,len=data.length;len>i;i++){var teamItem=data[i],childNode={_id:teamItem._id,id:teamItem.path,description:teamItem.description,member_limit:teamItem.member_limit,member_num:teamItem.member_num,name:teamItem.name,quota:teamItem.quota,path:teamItem.path,label:this._getTeamName(teamItem.path),isCer:teamItem.from_domain_account};nodes.push(childNode)}return nodes},getSelectedNode:function(){return this.teamTree.tree("getSelectedNode").path},setSelectedNode:function(node_path){var node=this.teamTree.tree("getNodeById",node_path);this.teamTree.tree("selectNode",node)},_getTeamName:function(path){var index=path.lastIndexOf("/"),teamName=path.substr(index+1);return teamName},gotoParentLevel:function(path){var node=this.teamTree.tree("getNodeById",path),parentNode=node.parent;return path.match(/^\/([^\/]+)$/)?void this.fire("manage"):(this.teamTree.tree("removeNode",node),this._render(),this.teamTree.tree("selectNode",parentNode),void this.fire("teamSelected",parentNode._id,parentNode.name,parentNode.path,parentNode.getLevel(),parentNode.isCer))}}),TeamTree}),define("component/tips",function(require,exports,module){function show(html,time){var uiTips=$('<div class="lui-tips toast"></div>'),content=$('<div class="tips-toast"></div>');uiTips.append(content),content.append($("<span>").html(html)),uiTips.appendTo($("body")).fadeIn();{var host=$(window),w=host.width(),tw=(host.height(),uiTips.outerWidth());uiTips.outerHeight()}uiTips.css({left:(w-tw)/2,top:66});var t=time||3e3;setTimeout(function(){uiTips.animate({opacity:"hide"},"normal","swing",function(){uiTips.remove()})},t)}function warn(message,callback){new AlertDialog(message,"warn",callback)}function prompt(node,html,button,fn,opt){var DEFAULT_CONFIG={position:"right",closable:!0},cfg=$.extend(DEFAULT_CONFIG,opt),uiTips=$('<div class="lui-tips lui-tips2"></div>'),triangle1=$('<span class="triangle-'+cfg.position+'1"></span>'),triangle2=$('<span class="triangle-'+cfg.position+'2"></span>'),content=$('<span class="tips-prompt-content"></span>');uiTips.append(triangle1),uiTips.append(triangle2),uiTips.append(content),cfg.closable||content.append('<a href="javascript:void(0)" class="close">✕</a>'),content.append($('<span class=""></span>').html(html)),button&&content.append('<span class="btn">'+button+"</span>"),uiTips.appendTo($("body")).fadeIn();var tleft,ttop,host=$(node),offset=host.offset(),w=host.outerWidth(),h=host.outerHeight(),tw=uiTips.outerWidth(),th=uiTips.outerHeight(),st=$("body","html").scrollTop();switch(cfg.position){case"left":tleft=offset.left+w+20,ttop=offset.top+(h-th)/2;break;case"right":tleft=offset.left+w+10,ttop=offset.top-st-8;break;case"up":tleft=offset.left+(w-tw)/2,ttop=offset.top+h+20;break;case"down":tleft=offset.left+(w-tw)/2,ttop=offset.top-th-20}uiTips.css({left:tleft,top:ttop}),content.find(".close").on("click",function(e){uiTips.remove()}),content.find(".btn").on("click",function(e){uiTips.remove()})}function dyToast(message){var toast=$(".infoDynamic").find(".dynamic-toast");message&&toast.length>0&&toast.html(message).fadeIn(500,function(){setTimeout(function(){toast.fadeOut(500)},2e3)})}function destory(){$(".lui-tips").remove()}var $=require("jquery"),AlertDialog=require("component/alertDialog"),Tips={show:show,warn:warn,prompt:prompt,destory:destory,dyToast:dyToast};return Tips}),define("component/transferauthdialog",function(require,exports,module){function TransferAuthDialog(type,params,func){var info={};0==type?info.folder=params:1==params.length&&1==type?(info.user=params[0],info.user.name=info.user.username):2==type&&(info.users=params),this.func=func,this.option=$.extend({},info),this.type=type,this.init()}var $=require("jquery"),Dialog=require("component/dialog"),ListView=require("component/listview"),SearchBox=require("component/searchbox"),UserModel=require("model/UserManager"),AuthModel=require("model/AuthManager"),Tips=require("component/tips"),_=$.i18n.prop;return require("mustache"),$.extend(TransferAuthDialog.prototype,{init:function(){var dialog,self=this,confirm_inner=$(["<div class='transferauth'><h2>"+_("该用户拥有与他人共享的文件夹，您可以：")+"</h2>","<p>"+_("1、彻底删除，清除其个人文件夹和共享文件夹数据")+"</p>","<p>"+_("2、将其共享文件夹移交给网盘其他用户")+"</p>","</div>","<div class='dialog-button-area'>","<a class='dialog-button ok'>"+_("移交共享文件夹")+"</a>","<a class='dialog-button cancel'>"+_("彻底删除")+"</a>","</div>"].join(""));0==this.type?this.selectUser([this.option.folder],Util.getUserID()):1==this.type?(this.dialog=dialog=new Dialog(_("删除用户"),function(parentNode,func){parentNode.append(confirm_inner),/msie/.test(navigator.userAgent.toLowerCase())&&parentNode.css("width",400)}),confirm_inner.find("a.ok").on("click",function(ev){dialog.close(),self.showSharelist(self.option.user)}),confirm_inner.find("a.cancel").on("click",function(ev){UserModel.batch_del(function(ret){200==ret.code?(Tips.show(ret.message),self.func(),dialog.close()):Tips.warn(ret.message)},[self.option.user.id],!0)})):this.showUserlist(this.option.users)},showUserlist:function(data){var inner=$(["<div class='transferauth showauth'><h2 class='info'>"+_("所选用户中有人拥有与他人共享的文件夹，您可以：")+"</h2>","<div class='selection clearfix'>","<p>"+_("1、彻底删除，清除其个人文件夹和共享文件夹数据")+"</p>","<p>"+_("2、将其共享文件夹移交给网盘其他用户")+"</p>","</div>","<h2 class='usernum'></h2>","<div class='lui-list'></div>","<div class='dialog-button-area'>","<a class='dialog-button cancel'>"+_("全部删除")+"</a>","</div>"].join("")),list_config={column:1,template:['<li class="list-item" index={{index}}>','<span class="item-name" title="{{name}}">{{name}}</span>','<span class="item-email" title="{{email}}">{{email}}</span>','{{#hasshare}}<span class="transfer">'+_("移交权限")+"</span>{{/hasshare}}",'<span class="i-authdelete">'+_("删除")+"</span>","</li>"].join("")},self=this;self.dialog=new Dialog(_("移交授权"),function(parentNode,func){parentNode.addClass("exwraper"),parentNode.append(inner),parentNode.css("width",400),self.user_to_transfer=new ListView($(".transferauth .lui-list"),list_config);for(var datas=[],user_counter=0,i=0;i<data.length;i++)data[i].hasshare&&user_counter++,datas.push({hasshare:data[i].hasshare,id:data[i].id,name:data[i].username,email:data[i].email,index:data[i].index});$(".transferauth .usernum").html(1==user_counter?_("有1人存在与他人共享文件夹"):_("有{0}人存在与他人共享文件夹",user_counter)),self.user_to_transfer.render(datas)}),self.user_to_transfer.on("delete",function(param){var user_id=data[param].id;UserModel.batch_del(function(result){200==result.code?(Tips.show(result.message),self.option.users.splice(param,1),self.dialog.close(),self.showUserlist(self.option.users)):Tips.warn(result.message)},[user_id],!0)}),self.user_to_transfer.on("item-added",function(param){param.hasshare&&(self.dialog.close(),self.showSharelist(param))}),inner.find("a.cancel").on("click",function(){for(var uids=[],i=0;i<data.length;i++)uids.push(data[i].id);UserModel.batch_del(function(result){200==result.code?(self.dialog.close(),Tips.show(result.message)):(Tips.warn(result.message),self.dialog.close()),self.func&&self.func()},uids,!0)})},showSharelist:function(data){var self=this,inner=$(["<div class='transferauth'><h2 class='share'></h2>","<div class='lui-list'></div>","<div class='dialog-button-area'>","<a class='dialog-button ok'>"+_("下一步")+"</a>","</div>"].join("")),list_config={column:1,template:['<li class="list-item" index={{index}}>','<span class="icon i-checkbox" index={{index}}><i class="icon i-checked"></i></span>','<span class="icon-file folder"></span>','<div class="row2" index={{index}}><span class="up">{{name}}</span><span class="down">共享文件夹</span></div>',"</li>"].join("")};self.dialog=new Dialog(_("移交权限"),function(parentNode,func){parentNode.addClass("exwraper"),parentNode.append(inner),/msie/.test(navigator.userAgent.toLowerCase())&&parentNode.css("width",400),self.filelist=new ListView(inner.find(".lui-list"),list_config),AuthModel.list_by_operator(function(result){if(200==result.code){for(var datas=[],obj={},i=0;i<result.data.length;i++){var item=result.data[i];if(!obj[item.path]){obj[item.path]=!0;var file=Util.resolvePath(item.path,item.is_dir);datas.push({id:item.id,path:item.path,name:file.name,neid:item.neid,index:datas.length})}}$(".transferauth h2.share").html(_('"{0}"的{1}个共享文件夹',data.name,datas.length)),self.filelist.render(datas)}},data.id,1)}),this.selected={},self.filelist.on("item-added",function(param){var index=param.index;self.selected[index]?(delete self.selected[index],$(".transferauth .lui-list .list-item").eq(index).removeClass("selected")):(self.selected[index]=param,$(".transferauth .lui-list .list-item").eq(index).addClass("selected"))}),$(".transferauth a.ok").click(function(ev){var shares=[];for(var i in self.selected)shares.push(self.selected[i]);shares.length>0&&(self.dialog.close(),self.selectUser(shares,data.id,function(){shares.length==self.filelist.data.length?(self.option.users[data.index].hasshare=!1,1==self.type?alert(_("您确定要删除用户吗")):2==self.type&&self.showUserlist(self.option.users)):self.showSharelist(data)}))})},selectUser:function(share,user_id,func){function searchUserSpace(context,param){$("#transferauth .lui-list .list-item").removeClass("selected"),self.selected&&self.selected.id==param.id?(context.node.find(".list-item").eq(param.index).removeClass("selected"),self.selected={}):(context.node.find(".list-item").eq(param.index).addClass("selected"),self.selected=param)}var self=this,inner=$(["<div id='transferauth'><h2>"+_("网盘成员")+"</h2>","<div class='search-box'></div>","<div id='foldersharememberlist' class='box-list'><h2>"+_("文件夹共享成员")+"</h2>","<div class='lui-list'></div></div>","<div id='memberlist' class='box-list'><h2>"+_("网盘成员")+"</h2>","<div class='lui-list'></div>","</div>","<div id='searchedlist' class='box-list'><h2>"+_("网盘成员")+"</h2>","<div class='lui-list'></div>","</div>","<div class='dialog-button-area'>","<a class='dialog-button ok'>"+_("确定")+"</a>","<a class='dialog-button cancel'>"+_("取消")+"</a>","</div>","</div>"].join("")),list_config={column:1,template:'<li class="list-item" index="{{index}}"><span class="item-name">{{name}}</span><span class="item-team">{{email}}</span><span class="item-message"></span></li>'};self.dialog=new Dialog(_("移交权限"),function(parentNode,func){if(parentNode.addClass("exwraper"),parentNode.append(inner),/msie/.test(navigator.userAgent.toLowerCase())&&parentNode.css("width",400),self.searchbox=new SearchBox($("#transferauth .search-box"),function(result){inner.find("#foldersharememberlist,#memberlist").hide();for(var datas=[],i=0;i<result.length;i++){var data=result[i];"user"==data.agent_type&&datas.push({id:data.uid,name:data.user_name,team:data.team,email:data.email})}self.searchedlist.render(datas),inner.find("#searchedlist").show()}),self.searchbox.on("close",function(){inner.find("#searchedlist").hide(),inner.find("#foldersharememberlist,#memberlist").show()}),self.searchedlist=new ListView($("#searchedlist>.lui-list"),list_config),self.sharelist=new ListView($("#foldersharememberlist>.lui-list"),list_config),self.sharelist.data=[],self.memberlist=new ListView($("#memberlist>.lui-list"),list_config),self.memberlist.data=[],share.length>=1){for(var s_path=[],n=0;n<share.length;n++)s_path.push('{"neid":"'+share[n].neid+'"}');var entrys="["+s_path.join(",")+"]";AuthModel.list_by_batch_resource(function(result){if(200==result.code){for(var obj={},count=0,i=0;i<result.data.length;i++){var item=result.data[i];obj[item.id]||(obj[item.id]=!0,self.sharelist.data.push({id:item.id,name:item.username,email:item.email,index:count++}))}var count=self.sharelist.data.length;if(3>count){if(0==count)return count=1,$(self.sharelist.node).find(".scl-content").append("<p class='item-empty'>"+_("暂无共享成员")+"</p>"),void $(self.sharelist.node).css("height",50*count);$(self.sharelist.node).css("height",50*count)}self.sharelist.render(self.sharelist.data)}},entrys,1)}UserModel.list_for_pages(function(result){if(200==result.code){for(var i=0;i<result.data.content.length;i++){var item=result.data.content[i];item.user_id!=user_id&&self.memberlist.data.push({id:item.user_id,name:item.user_name,email:item.email})}self.memberlist.render(self.memberlist.data)}},0,1e4)}),self.sharelist.on("item-added",function(param){searchUserSpace(self.sharelist,param)}),self.memberlist.on("item-added",function(param){searchUserSpace(self.memberlist,param)}),self.searchedlist.on("item-added",function(param){searchUserSpace(self.searchedlist,param)}),$("#transferauth a.ok").click(function(ev){if(self.selected&&self.selected.id){var frompath,json_arr=[];$(share).each(function(i,value){frompath={path:value.path},0!=value.prefix_neid&&(frompath.prefix_neid=value.prefix_neid),json_arr.push(frompath)}),AuthModel.auth_transfer(function(result){200==result.code?(self.dialog.close(),0==self.type&&Tips.show('<span class="tipsNone">'+_("{0}移交权限成功<em>{1}</em>",self.option.folder.name,self.selected.name))+"</span>",func&&func(),self.func&&self.func()):(Tips.warn(result.message),self.dialog.close())},user_id,JSON.stringify(json_arr),self.selected.id)}}),$("#transferauth a.cancel").click(function(ev){self.dialog.close()})}}),TransferAuthDialog}),define("component/updateTeamAuthDialog",function(require,exports,module){function UpdateTeamAuthDialog(fileAttr,ok_callback){this.fileAttr=fileAttr,this.path=fileAttr.path,this.action=fileAttr.action||AuthModel.ACTION.DOWNLOAD,this._init()}var $=require("jquery"),Util=require("util"),Dialog=require("component/dialog"),AuthModel=require("model/AuthManager"),Util=(require("model/UserManager"),require("util")),Tips=require("component/tips"),AuthCombox=require("component/authCombox");require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(UpdateTeamAuthDialog.prototype,{_init:function(){var self=this;self.dialog=new Dialog(_("修改团队授权"),{mask:!0},function(dialog){var authHtml=[];authHtml.push('<div id="update-auth-dialog-id">'),authHtml.push('<div class="auth-dir">'),authHtml.push('<span class="auth-col-title">'+_("授权文件夹")+"</span>"),authHtml.push('<span style="width:378px;border:1px #CDD1D2 solid;display:inline-block">'),authHtml.push('<span style="width:20px;height:20px;float:left;" class="icon i-folder1"></span>'),authHtml.push('<span class="file-name" title="'+Util.getRootDisplayName()+self.path+'">'+Util.getRootDisplayName()+self.path+"</span>"),authHtml.push("</span>"),authHtml.push("</div>"),authHtml.push('<div class="auth-dir">'),authHtml.push('<span class="auth-col-title" style="float:left;">'+_("权　　限")+"</span>"),authHtml.push('<span class="auth-col" id="authcombox-add-auth" style="float:left; margin-left:12px;"></span>'),authHtml.push("</div>"),authHtml.push("</div>"),dialog.append(authHtml.join("")+'<div class="dialog-button-area"><a id="auth-dialog-id-ok" class="dialog-button ok">'+_("确定")+'</a> <a id="auth-dialog-id-cancel" class="dialog-button cancel">'+_("取消")+"</a></div>"),new AuthCombox("#authcombox-add-auth",AuthModel.getAuthPair(self.action),null,function(item){self.action=item}),$("#auth-dialog-id-ok").click(function(){AuthModel.update(function(ret){200==ret.code?(self.dialog.fire("evt_close"),self.dialog.close()):Tips.warn(ret.message)},self.fileAttr.id,self.action)}),$("#auth-dialog-id-cancel").click(function(){self.dialog.close()})})}}),UpdateTeamAuthDialog}),define("component/upgradeDialog",function(require,exports){function UpgradeDialog(mode){this.mode=mode,this._init()}{var $=require("jquery"),Dialog=(require("component/validator"),require("component/dialog"));require("component/confirmDialog"),require("model/FileManager"),require("model/TeamManager")}require("i18n");var _=$.i18n.prop;return require("mustache"),$.extend(UpgradeDialog.prototype,{_init:function(){var content,self=this,domain_template='<div id="upgradeDialog" class="clearfix"><p>'+_("通过定制企业名称和域名，您可以即刻拥有专属域名访问，只对购买正式版用户提供此功能")+'</p><p><img width="371" height="138" src="/img/upgrade-domain.png"/></p><a id="upgrade-btn" href="/upgrade.html" target="_blank" class="upgrade-btn">'+_("升级")+"</a></div>",info_template='<div id="upgradeDialog" class="clearfix"><p>'+_("企业专属域名页面显示企业的基本信息，包括名称，文字描述，并支持中英文双语")+'</p><p><img width="371" height="58" src="/img/'+_("upgrade-tel.png")+'"/></p><a id="upgrade-btn" href="/upgrade.html" target="_blank" class="upgrade-btn">'+_("升级")+"</a></div>",logo_template='<div id="upgradeDialog" class="clearfix"><p>'+_("通过定制企业logo，您可以即刻拥有个性化界面效果，只对购买正式版用户提供此功能")+'</p><p><img width="367" height="139" src="/img/upgrade-logo.png"/></p><a id="upgrade-btn" href="/upgrade.html" target="_blank" class="upgrade-btn">'+_("升级")+"</a></div>",security_template='<div id="upgradeDialog" class="clearfix"><p><img width="375" height="193" src="/img/upgrade-security.png"/></p><a id="upgrade-btn" href="/upgrade.html" target="_blank" class="upgrade-btn">'+_("升级")+"</a></div>",delivery_email_template='<div id="upgradeDialog" class="clearfix"><p>'+_("外链邮件模板，企业自定义外链邮件内容，并支持中英文双语")+'</p><p><img width="371" height="58" src="/img/'+_("upgrade-tel.png")+'"/></p><a id="upgrade-btn" href="/upgrade.html" target="_blank" class="upgrade-btn">'+_("升级")+"</a>",title="";

switch(self.mode){case"domain":title=_("企业域名及访问域名"),content=domain_template;break;case"logo":title=_("订购LOGO及页面"),content=logo_template;break;case"info":title=_("企业信息定制"),content=info_template;break;case"security":title=_("密码安全"),content=security_template;break;case"delivery":title=_("外链邮件模板定制"),content=delivery_email_template}var dialog=new Dialog(title,function(parent){parent.append(content),parent.delegate("#upgrade-btn","click",function(){dialog.close()})})}}),UpgradeDialog}),define("component/upload",function(require,exports){function Upload(node,url,opt){if(this.node="string"==$.type(node)?$(node):node,this.url=url||"",this.option=opt,opt.postParam){var param="";for(var key in opt.postParam)param+=key+"="+opt.postParam[key]+"&";param=param.slice(0,-1),this.url+="?"+param}this._init()}var $=require("jquery"),ProgressBar=require("component/progressbar"),EventTarget=require("eventTarget"),Tips=require("component/tips"),flashCheckDialog=require("component/flashCheckDialog"),SwfUp=require("component/fileUploadDialog/swfUploadBuilder");return $.extend(Upload.prototype,EventTarget,{_init:function(){var self=this,up=$('<div class="lui-upload"><a style="float:left;width:80px;height:32px;background:url(\'/css/theme/default/img/upload-'+("en"==$.cookie("language")?"en":"zh")+'.png\')" id="uploadButton"></a><div class="uploadProgress"></div></div>');self.node.append(up);var barHolder=up.find(".uploadProgress"),template='<div class="content"><span class="name">{{name}}</span><span class="proc">{{proc}}</span><span class="icon i-delete"></span></div>',bar=new ProgressBar(barHolder,template,{});bar.delegate({".i-delete":function(e){self.instance.cancelUpload(),barHolder.hide()}}),flashCheckDialog.checkFlash()&&(self.instance=new SwfUp("uploadButton",{fileQueued:function(file){barHolder.show(),bar.render({name:file.name,proc:0})},fileDialogComplete:function(numFilesSelected,numFilesQueued){},uploadProgress:function(file,bytesLoaded,bytesTotal){var percent=Math.ceil(bytesLoaded/bytesTotal*100);bar.update(percent),bar.render({name:file.name,proc:percent})},uploadSuccess:function(file,serverData){self.fire("complete",serverData)},uploadComplete:function(file){return!1},uploadError:function(file,errorCode,message){self.fire("error",{errCode:errorCode,msg:message})},fileQueueError:function(file,errorCode,message){try{switch(errorCode){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:Tips.warn('文件超过500M了，请使用<a href="/client/windows/bin/LenovoBox.zip">客户端</a>上传');break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:Tips.warn(_("不能上传")+file.name+"&nbsp;&nbsp;,文件类型不允许");break;default:null!==file&&Tips.warn("很抱歉，您的操作失败了，建议您重试一下！")}}catch(ex){}}},self.option).build())},startUpload:function(){var self=this;self.instance.setUploadURL(self.url),self.instance.startUpload()}}),Upload}),define("component/userInfoDialog",function(require,exports,module){function UserInfoDialog(userAttr,ok_callback){var self=this;self.userAttr=userAttr,self.uid=userAttr.uid,self.authArr=null,self.ok_callback=ok_callback,self._init()}var $=require("jquery"),UserModel=require("model/UserManager"),Util=require("lenovodata/util"),Tips=require("component/tips"),Dialog=require("component/dialog");require("i18n");var _=$.i18n.prop;return $.extend(UserInfoDialog.prototype,{_init:function(){var self=this;self.dialog=new Dialog(_("修改用户信息"),{mask:!0},function(dialog){var userInfoHtml=[];userInfoHtml.push('<div class="user-info-tab">'),userInfoHtml.push("<div>"),userInfoHtml.push('<ul class="clearfix user-info-header">'),userInfoHtml.push('<li><a src="#userinfo">'+_("账户信息")+"</a></li>"),userInfoHtml.push('<li id="pwd" style="display:none"><a src="#editpassword" id="password" >'+_("密码")+"</a></li>"),userInfoHtml.push('<li><a src="#userspace">'+_("个人空间")+"</a></li>"),userInfoHtml.push("</ul>"),userInfoHtml.push("</div>"),userInfoHtml.push('<div id="userinfo" class="content" style="display:block;">'),userInfoHtml.push('<div class="error-info"></div>'),userInfoHtml.push('<div><span class="col1 col">'+_("用户类型")+'</span><span id="usertype"></span></div>'),userInfoHtml.push('<div><span class="col1 col">'+_("登录邮箱")+'</span><span id="useremail"></span></div>'),userInfoHtml.push('<div><span class="col1">'+_("手机号码")+'</span><input type="text" name="mobile" value="" /></div>'),userInfoHtml.push('<div><span class="col1">'+_("用户名")+'</span><input type="text" name="username" value="" maxlength="50"/></div>'),userInfoHtml.push("</div>"),userInfoHtml.push('<div id="editpassword" class="content">'),userInfoHtml.push('<div class="error-info"></div>'),userInfoHtml.push('<div><span class="col1">'+_("密　　码")+'</span><input type="password" name="pwd1" value="******" maxlength="32" onpaste="return false"/></div>'),userInfoHtml.push('<div><span class="col1">'+_("重复密码")+'</span><input type="password" name="pwd2" value="******" maxlength="32" onpaste="return false"/></div>'),userInfoHtml.push('<div style="padding-left:106px"><input type="checkbox" name="forbid"><span>'+_("禁止账户修改密码")+"</span></div>"),userInfoHtml.push("</div>"),userInfoHtml.push('<div id="userspace" class="content">'),userInfoHtml.push('<div class="error-info"></div>'),userInfoHtml.push('<div><span id="used-quota"></span></div>'),userInfoHtml.push('<div><span class="col1">'+_("个人空间")+'</span><input type="text" name="quota" size="6"> MB</div>'),userInfoHtml.push("</div>"),userInfoHtml.push("</div>"),dialog.append(userInfoHtml.join("")+'<div class="dialog-button-area"><a id="user-info-ok" class="dialog-button ok">'+_("确定")+'</a> <a id="user-info-cancel" class="dialog-button cancel">'+_("取消")+"</a></div>"),Util.isAdmin()&&$(".user-info-header>li:eq(1)").show()}),UserModel.info_get(function(ret){200==ret.code&&(self.userAttr=ret.data,self.userAttr.quota=self.userAttr.quota/1024/1024,self.userAttr.used=0==self.userAttr.used?0:(self.userAttr.used/1024/1024).toFixed(2),self.userAttr.from_domain_account?(self.userAttr.from_domain_account=_("企业认证用户"),$(".user-info-tab").find("li").eq(1).remove(),$(".user-info-tab").find("#editpassword").remove()):self.userAttr.from_domain_account=_("本地认证用户"),self.userAttr.email||(self.userAttr.email=""),self.userAttr.mobile||(self.userAttr.mobile=""),$("#userinfo").find("#usertype").html(self.userAttr.from_domain_account),$("#userinfo").find("#useremail").html(self.userAttr.email),$("#userinfo").find("input[name=mobile]").val(self.userAttr.mobile),$("#userinfo").find("input[name=username]").val(self.userAttr.user_name),$("#userspace").find("input[name=quota]").val(self.userAttr.quota),$("#used-quota").html(_("当前已用空间 {0} MB,共 {1} MB",self.userAttr.used,self.userAttr.quota)),0==self.userAttr.password_changeable&&$("#editpassword").find("input[name=forbid]:checkbox").attr("checked","checked"))},self.uid),$(".user-info-tab a").each(function(i){var contentId=$(this).attr("src");0==i?($(this).addClass("selected"),$(contentId).show()):($(this).removeClass("selected"),$(contentId).hide())}),$(".user-info-tab a").click(function(e){$(".user-info-tab a").each(function(i){var contentId=$(this).attr("src");$(this).removeClass("selected"),$(contentId).hide()}),$(e.currentTarget).addClass("selected");var contentId=$(e.currentTarget).attr("src");$(contentId).show()});var _bol=!1,_forbid=!1;$("#editpassword input[type=password]").focus(function(){$(this).val(""),_bol=!0}),$("#editpassword").find("input[name=forbid]:checkbox").change(function(){_forbid=!0}),$("#user-info-ok").click(function(){$(".user-info-tab a").each(function(i){if($(this).hasClass("selected")){var contentId=$(this).attr("src");switch(contentId){case"#userinfo":var mobile=$.trim($("#userinfo").find("input[name=mobile]").val()),username=$.trim($("#userinfo").find("input[name=username]").val());if(""!=mobile&&!Util.validMobile(mobile))return void Tips.warn(_("手机号码格式不正确"));if(!Util.validInput($("#userinfo").find("input[name=username]"),_("用户名不能包括特殊字符")))return;if(""==username)return void Tips.warn(_("用户名不能为空"));if(Util.getBytes(username)>50)return void Tips.warn(_("用户名长度限制在50个字符以内"));UserModel.info_set(function(ret){200!=ret.code&&Tips.warn(ret.message),self.ok_callback&&self.ok_callback()},{user_id:self.uid,user_name:username,mobile:mobile});break;case"#editpassword":var pwd1=$.trim($("#editpassword").find("input[name=pwd1]").val()),pwd2=$.trim($("#editpassword").find("input[name=pwd2]").val()),ischecked=!$("#editpassword").find("input[name=forbid]:checkbox").get(0).checked;if(""==pwd1)return void Tips.warn(_("密码不能为空"));if(pwd1!=pwd2)return void Tips.warn(_("两次输入密码不一致，请重新输入！"));"******"==pwd1&&(pwd1=""),UserModel.password_set(function(ret){200!=ret.code&&Tips.warn(ret.message)},self.uid,pwd1,pwd1,ischecked);break;case"#userspace":var quota=$.trim($("#userspace").find("input[name=quota]").val());if(/[\D]/.test(quota))return void Tips.warn(_("个人空间大小必须为正整数！"));if(parseFloat(quota)<parseFloat(self.userAttr.used))return void Tips.warn(_("个人空间大小必须大于或等于用户已用空间大小！"));if(1024*quota*1024>window.LenovoData.user.account_info.space.limit)return void Tips.warn(_("不能超过企业总空间大小"));UserModel.quota_set(function(ret){200!=ret.code&&Tips.warn(ret.message)},self.uid,1024*quota*1024)}self.dialog.close()}})}),$("#user-info-cancel").click(function(){self.dialog.close()})}}),UserInfoDialog}),define("component/userSettingDialog",function(require,exports,module){function UserSettingDialog(data,ok_callback){var self=this;this.data=data,this.ok_callback=ok_callback,self._init()}var $=require("jquery"),UserModel=require("model/UserManager"),Util=require("util"),Tips=require("component/tips"),Dialog=require("component/dialog");require("i18n");var _=$.i18n.prop;if(require("mustache"),/^mobile:\d{11}$/.test(LenovoData.user.user_info.user_slug))var userSettingTemplate='<div class="{{role}}"><div><span class="col-title">'+_("登录邮箱")+'</span><span>{{email}}</span></div> <div><span class="col-title">'+_("手机号")+'</span><span>{{mobile}}</span><span><input type="text" id="mobile" value="{{mobile}}" style="display:none;"/></span></div><div><span class="col-title">'+_("用户名")+'</span><span>{{username}}<a class="icon i-edit" sid="username"></a></span><span><input type="text" id="username" value="{{username}}" style="display:none;" maxlength="50"/></span></div><div class="disabled-{{password_changeable}}"><span class="col-title">'+_("旧密码")+'</span><span><input type="password" id="old-pwd" value="" maxlength="32"/></div></span><div class="disabled-{{password_changeable}}"><span class="col-title">'+_("新密码")+'</span><span><input type="password" id="new-pwd" value="" maxlength="32" onpaste="return false"/></span></div><div class="disabled-{{password_changeable}}"><span class="col-title">'+_("重新输入密码")+'</span><span><input type="password" id="new-pwd2" value="" maxlength="32" onpaste="return false"/></span></div><div class="forbidden-{{password_changeable}}"><span>'+_("禁止修改密码，请联系管理员")+"</span></div></div>";else var userSettingTemplate='<div class="{{role}}"><div><span class="col-title">'+_("登录邮箱")+'</span><span>{{email}}</span></div> <div><span class="col-title">'+_("手机号")+'</span><span>{{mobile}}<a class="icon i-edit" sid="mobile"></a></span><span><input type="text" id="mobile" value="{{mobile}}" style="display:none;"/></span></div><div><span class="col-title">'+_("用户名")+'</span><span>{{username}}<a class="icon i-edit" sid="username"></a></span><span><input type="text" id="username" value="{{username}}" style="display:none;" maxlength="50"/></span></div><div class="disabled-{{password_changeable}}"><span class="col-title">'+_("旧密码")+'</span><span><input type="password" id="old-pwd" value="" maxlength="32"/></div></span><div class="disabled-{{password_changeable}}"><span class="col-title">'+_("新密码")+'</span><span><input type="password" id="new-pwd" value="" maxlength="32" onpaste="return false"/></span></div><div class="disabled-{{password_changeable}}"><span class="col-title">'+_("重新输入密码")+'</span><span><input type="password" id="new-pwd2" value="" maxlength="32" onpaste="return false"/></span></div><div class="forbidden-{{password_changeable}}"><span>'+_("禁止修改密码，请联系管理员")+"</span></div></div>";return $.extend(UserSettingDialog.prototype,{_render:function(dialog,dialog_cb){var self=this,output=Mustache.render(userSettingTemplate,self.data);dialog.append('<div class="user-setting-dialog">'+output+'</div><div class="dialog-button-area"><a id="user-setting-ok" class="dialog-button ok">'+_("确定")+'</a> <a id="user-setting-cancel" class="dialog-button cancel">'+_("取消")+"</a></div>"),0==self.data.password_changeable&&"admin"!=self.data.role&&dialog.find("input[type='password']").attr("disabled","disabled"),$("#user-setting-ok").click(function(){var userInfo={},mobile=$.trim($("#mobile").val()),user_name=$.trim($("#username").val()),old_pwd=$.trim($("#old-pwd").val()),new_pwd=$.trim($("#new-pwd").val()),new_pwd2=$.trim($("#new-pwd2").val());if(""!=self.data.mobile){if(""==mobile)return void Tips.warn(_("手机号不能为空"));if(mobile&&!Util.validMobile(mobile))return void Tips.warn(_("手机号格式不正确"))}else if(mobile&&!Util.validMobile(mobile))return void Tips.warn(_("手机号格式不正确"));if(Util.validInput($("#username"),_("用户名不能包括特殊字符"))){if(!user_name)return void Tips.warn(_("用户名不能为空"));if(Util.getBytes(user_name)>50)return void Tips.warn(_("用户名长度限制在50个字符以内"));if(userInfo.mobile=mobile,userInfo.user_name=user_name,old_pwd||new_pwd||new_pwd2){if(""==old_pwd)return void Tips.warn(_("请输入旧密码"));if(""==new_pwd)return void Tips.warn(_("新密码不能为空"));if(old_pwd==new_pwd)return void Tips.warn(_("与原密码一致，请重试"));if(""==new_pwd2)return void Tips.warn(_("请重新输入密码"));if(new_pwd!=new_pwd2)return void Tips.warn(_("两次输入密码不一致，请重新输入！"));if(new_pwd.length>32||new_pwd.length<6)return void Tips.warn(_("密码长度6-32个字符之间"))}userInfo.old_password=old_pwd,userInfo.password=new_pwd,$("body").data("category","useredit").data("action","修改设置").data("content","用户"),UserModel.info_set(function(ret){200==ret.code?(userInfo.password?UserModel.password_set(function(ret1){200==ret1.code?self.dialog.close():Tips.warn(ret1.message)},void 0,userInfo.password,userInfo.old_password):self.dialog.close(),UserModel.changeSessionInfo(function(result){$(".user-name").html(result.data.user_name)},ret.data.user_name)):Tips.warn(ret.message)},userInfo)}}),$("#user-setting-cancel").click(function(){self.dialog.close()}),$(".user-setting-dialog").find(".i-edit").click(function(e){var id="#"+$(e.currentTarget).attr("sid");$(e.currentTarget).parent().hide(),$(id).show()}),dialog_cb()},_init:function(){var self=this;self.dialog=new Dialog(_("用户设置"),{mask:!0},function(dialog,dialog_cb){UserModel.info_get(function(ret){200==ret.code&&(self.data={},self.data.email=ret.data.email,self.data.mobile=ret.data.mobile,self.data.username=ret.data.user_name,self.data.password_changeable=ret.data.password_changeable,self.data.role=window.LenovoData.user.user_role,self._render(dialog,dialog_cb))})})}}),UserSettingDialog}),define("component/userTeamAuthCombox",function(require,exports){function UserTeamAuthCombox(node,type,opt){this.node="string"==$.type(node)?$(node):node,this.type=type;var DEFAULT={authTree:!1,title:_("所有用户"),isTeam:!1};this.config=$.extend(DEFAULT,opt),this.userTeamData=[{category:"role",name:_("团队成员"),value:"member"},{category:"role",name:_("团队管理员"),value:"admin"}],this.authData=[{category:"cssAction",name:_("预览"),value:"preview"},{category:"cssAction",name:_("上传"),value:"upload"},{category:"cssAction",name:_("上传/外链"),value:"upload:delivery"},{category:"cssAction",name:_("下载"),value:"download"},{category:"cssAction",name:_("下载/外链"),value:"download:delivery"},{category:"cssAction",name:_("上传/下载"),value:"upload:download"},{category:"cssAction",name:_("上传/下载/外链"),value:"upload:download:delivery"},{category:"cssAction",name:_("编辑"),value:"edit"}],this.template="<li class='combox-item' index='{{index}}' category={{category}} act={{value}}>{{name}}</li>",this.selected={},this._init()}var $=require("jquery"),EventTarget=require("component/eventTarget"),TeamTree=require("component/teamTree"),TeamModel=require("model/TeamManager"),Util=require("util");require("i18n");var _=$.i18n.prop;require("mustache");var AUTH_LIST=exports.AUTH_LIST=[{instruction:_("权限说明"),preview:_("预览"),upload:_("上传"),download:_("下载"),uploadlink:_("创建上传外链"),downloadlink:_("创建下载外链"),create:_("新建目录/文件"),remove:_("删除"),rename:_("重命名"),move:_("移动"),copy:_("复制")},{cssAction:"edit",instruction:_("全部"),preview:"1",upload:"1",download:"1",uploadlink:"1",downloadlink:"1",create:"1",remove:"1",rename:"1",move:"1",copy:"1"},{cssAction:"upload:download:delivery",instruction:_("上传/下载/外链"),preview:"1",upload:"1",download:"1",uploadlink:"1",downloadlink:"1",create:"1",remove:"0",rename:"0",move:"0",copy:"0"},{cssAction:"download:delivery",instruction:_("下载/外链"),preview:"1",upload:"0",download:"1",uploadlink:"0",downloadlink:"1",create:"0",remove:"0",rename:"0",move:"0",copy:"0"},{cssAction:"upload:delivery",instruction:_("上传/外链"),preview:"0",upload:"1",download:"0",uploadlink:"1",downloadlink:"0",create:"1",remove:"0",rename:"0",move:"0",copy:"0"},{cssAction:"upload:download",instruction:_("上传/下载"),preview:"1",upload:"1",download:"1",uploadlink:"0",downloadlink:"0",create:"1",remove:"0",rename:"0",move:"0",copy:"0"},{cssAction:"download",instruction:_("下载"),preview:"1",upload:"0",download:"1",uploadlink:"0",downloadlink:"0",create:"0",remove:"0",rename:"0",move:"0",copy:"0"},{cssAction:"upload",instruction:_("上传"),preview:"0",upload:"1",download:"0",uploadlink:"0",downloadlink:"0",create:"1",remove:"0",rename:"0",move:"0",copy:"0"},{cssAction:"preview",instruction:_("预览"),preview:"1",upload:"0",download:"0",uploadlink:"0",downloadlink:"0",create:"0",remove:"0",rename:"0",move:"0",copy:"0"}];return $.extend(UserTeamAuthCombox.prototype,EventTarget,{_init:function(){var self=this,combox=$("<div class='lui-combox'><div class='curli'><span class='icon i-user7'></span><span class='curtext'></span><span class='triangle'></span></div></div>"),ul=$("<ul class='combox-ul'></ul>");if(2==self.type)return self.tree=new TeamTree(ul,function(param,success,error){TeamModel.getTeamListById(function(result){success(result)})},{type:1,title:self.config.title,authTree:self.config.authTree}),self.tree.on("renderCompleted",function(){self.config.authTree&&self.tree.node.find("li:eq(0)").find("a").remove()}),self.tree.on("selectTeam",function(teamId,teamName,teamPath,isDomain){self.node.find("ul").hide(),combox.find(".curli>span.icon").removeClass(function(){var classNames=this.className.split(" ");return classNames.splice(0,2),classNames.join(" ")}).addClass(isDomain?"i-team-domain":"i-team"),combox.find(".curtext").text(teamName),self.fire("teamSearch",teamId)}),self.tree.on("selectAllUser",function(param){self.node.find("ul").hide(),combox.find(".curli>span.icon").removeClass(function(){var classNames=this.className.split(" ");return classNames.splice(0,2),classNames.join(" ")}).addClass("i-all"),combox.find(".curtext").text(param),self.fire("selectAllUser")}),self.tree.on("manage",function(param){self.node.find("ul").hide(),combox.find(".curli>span.icon").removeClass(function(){var classNames=this.className.split(" ");return classNames.splice(0,2),classNames.join(" ")}),self.config.authTree&&combox.find(".curli>span.icon").addClass("i-team-user"),combox.find(".curtext").text(param),self.fire("manage")}),self.config.authTree&&combox.find(".curli>span.icon").addClass("i-team-user"),combox.find(".curtext").text(self.config.title),combox.append(ul),self.node.append(combox),void self._bindEvent2TreeCombox();if(self.data=self.userTeamData,1==self.type&&(self.data=this.authData,self.node.addClass("auth-combox"),self.template="<li class='combox-item' index='{{index}}' category={{category}} act={{value}}>{{name}}</li>",combox.find(".curtext").text(_("预览"))),$(self.data).each(function(index,item){item.index=index,ul.append(Mustache.render(self.template,item))}),ul.height(24*ul.find("li").length),1==self.type&&self.config.isTeam){var checkbox_li=Mustache.render("<li class='allow' act='inherit'><input type='checkbox' {{#inherit}}checked{{/inherit}} class='allow-checkbox'/>"+_("允许子团队继承权限")+"</li>",{inherit:this.config.inherit});ul.append(checkbox_li),ul.height(24*ul.find("li").length+4)}$(combox).append(ul),self.node.append(combox),combox.find(".curtext").text(self.getDefaultValue(self.config.defaultValue)),self._bindEvent()},_bindEvent:function(e){var self=this;self.node.delegate(".lui-combox","mouseleave",function(e){$(this).find("ul.combox-ul").hide()}),self.node.delegate(".combox-ul","mouseleave",function(e){var tar=$(e.currentTarget);tar.hide()}),self.node.delegate(".combox-item","click",function(e){var text=$(e.currentTarget).text();$(e.currentTarget).parent().parent().find(".curli > .curtext").html(text);var type=$(e.target).attr("category"),value=$(e.target).attr("act"),_index=$(e.target).parents(".list-item").attr("index");self.fire("change",_index,type,value),$(e.currentTarget).parent().hide()}),self.node.delegate(".combox-ul>li>.allow-checkbox","click",function(e){var checkbox=e.currentTarget,_index=$(e.target).parents(".list-item").attr("index");self.fire("changeInherit",_index,"inherit",checkbox.checked)}),self.node.delegate(".curli","click",function(e){var tar=$(e.target),cur=$(e.currentTarget);if(tar.hasClass("curtext")||tar.hasClass("triangle")){var top=Util.getElementYPos(tar.parent()[0]),left=Util.getElementXPos(tar.parent()[0]),maxZIndex=0;$(self.node.parents(".scl-content").find(".list-item>span.combox")).each(function(i,item){var zIndex=parseInt($(item).css("z-index"));zIndex>maxZIndex&&(maxZIndex=zIndex)}),0==maxZIndex&&(maxZIndex=100),maxZIndex+=1,tar.parents("span.combox").css("z-index",maxZIndex);var _height=cur.height(),_width=cur.width(),self_height=self.node.find(".combox-ul").height();if(self.node.find(".combox-ul").css({position:"fixed",left:left+1,top:top+_height+self_height+2>Util.getTotalHeight()?top-self_height:top+_height+2,width:_width}),tar.hasClass("triangle"))return void self.node.find(".combox-ul").toggle();self.node.find(".combox-ul").show()}})},getSelected:function(){},getDefaultValue:function(value){for(var self=this,i=0;i<self.data.length;i++)if(self.data[i].value==value)return 1==self.type&&self.node.find(".combox-ul").find(".combox-item").eq(i).find(".icon").addClass("icon-radio-selected"),self.data[i].name;return self.data[0].name},_bindEvent2TreeCombox:function(){var self=this;self.node.delegate(".curli","click",function(e){var tar=$(e.target),top=Util.getElementYPos(tar.parent()[0]),left=Util.getElementXPos(tar.parent()[0]),_height=$(e.currentTarget).height(),display=self.node.find("ul")[0].style.display;return tar.hasClass("triangle")&&"block"==display?void self.node.find("ul").hide():(self.tree.render(),void self.node.find("ul.combox-ul").css({position:"fixed",left:left+1,top:top+_height+2}).slideDown())}),self.node.delegate(".lui-combox>.curli","mouseleave",function(e){e.target==e.currentTarget&&self.node.find("ul.combox-ul").hide()}),self.node.delegate(".lui-combox>.combox-ul","mouseenter",function(e){$(e.currentTarget).show()}),self.node.delegate(".lui-combox>.combox-ul","mouseleave",function(e){e.target==e.currentTarget&&$(e.currentTarget).hide()})},getAuthList:function(key){for(var authDescription=AUTH_LIST[0],auth_value={},i=1;i<AUTH_LIST.length;i++){var item=AUTH_LIST[i];if(item.cssAction==key)for(var k in item)auth_value[k]=item[k]}var ret=[];if(auth_value.cssAction){for(var prop in auth_value)1==auth_value[prop]&&(ret[ret.length]=authDescription[prop].replace("/",""));return ret.join("/")}return{}}}),UserTeamAuthCombox}),define("component/userTeamAuthList",function(require,exports){function UserTeamAuthList(node,type,opt){this.node="string"==typeof node?$(node):node,this.type=type,this.mark=opt.mark;var config={title:_("所有用户"),authTree:!1,userTeamListTitle:_("选择用户"),authListTitle:'<span><span class="tip">'+_("将下列用户添加到")+'</span>"<b>'+opt.teamName+'</b>"</span>'};this.option=$.extend(config,opt),this._init()}var $=require("jquery"),Dialog=require("component/dialog"),Tips=require("component/tips"),UserTeamAuthCombox=(require("component/combox"),require("component/userTeamAuthCombox")),ListView=require("component/listview"),EventTarget=require("component/eventTarget"),TeamModel=require("model/TeamManager"),AuthModel=require("model/AuthManager"),ConfirmDialog=require("component/confirmDialog"),Util=require("util"),Dialog=require("component/dialog"),UserModel=require("model/UserManager");require("i18n"),require("placeholder");var _=$.i18n.prop;return require("mustache"),Array.prototype.add=function(data){function transferData(data){var obj={};for(var key in data)obj[key]=data[key];return obj}if("[object Array]"===Object.prototype.toString.call(data))if(0==this.length)for(var i=0;i<data.length;i++){var item=data[i],item=transferData(item);this.push(item)}else for(var i=0;i<data.length;i++){for(var item=transferData(data[i]),flag=!1,j=0;j<this.length;j++)if(item.agent_type==this[j].agent_type&&item.id==this[j].id){flag=!0;break}flag||this.push(item)}else if(0==this.length)this.push(transferData(data));else{for(var item=transferData(data),flag=!1,i=0;i<this.length;i++)if(item.agent_type==this[i].agent_type&&item.id==this[i].id){flag=!0;break}if(flag){var dialog=new Dialog(_("提示"),{mask:!0},function(dialog){dialog.append(item.role?'<div class="tips-alertDialog"><div class="cell2">'+_("该用户已添加！")+'</div></div><div class="dialog-button-area"><a class="dialog-button confirm-cancel ok">'+_("确定")+"</a></div>":1==item.mark?'<div class="tips-alertDialog"><div class="cell2">'+_("该项已添加手机验证！")+'</div></div><div class="dialog-button-area"><a class="dialog-button confirm-cancel ok">'+_("确定")+"</a></div>":'<div class="tips-alertDialog"><div class="cell2">'+_("该项已添加到授权记录，请在右侧已授权记录中修改！")+'</div></div><div class="dialog-button-area"><a class="dialog-button confirm-cancel ok">'+_("确定")+"</a></div>")});$(".confirm-cancel").click(function(){dialog.close()})}else this.push(item)}},$.extend(UserTeamAuthList.prototype,EventTarget,{_init:function(){var self=this,path_template="<div class='auth-list-item' id='auth-path'><span class='icon i-folder1'></span><span class='auth-list-item-col1' title='{{auth-list-path}}'>{{auth-list-path}}</span></div>",content_template="<div class='user-team-auth-list'><div class='user-team-list'><h2>"+this.option.userTeamListTitle+"</h2><span id='teamGroup' class='combox'></span><input type='text' class='i-text' placeholder='"+_("搜索用户和团队")+"'/><span class='btn-search'><span class='icon icon-search'></span></span><div class='user-list-view' id='user_team_list'></div><div class='user-list-bottom'><input type='checkbox'><u class='user-add'>"+_("添加已选择")+"</u><u class='next'>"+_("下一页")+"</u><u class='prev'>"+_("上一页")+"</u></div></div><div class='auth-list'><h2><span class='i-auth'></span><u class='auth-link'>"+_("权限")+"</u>"+this.option.authListTitle+"</h2><div class='auth-list-view' id='auth_list'></div><div class='auth-list-bottom'><u>"+_("清空所有用户")+"</u></div></div></div>",auth_list_config={noclick:!0,column:1,template:'<li class="list-item item-{{agent_type}}" index="{{index}}" title="{{name}}{{#email}}({{email}}){{/email}}{{#domain_team}}('+_("域团队")+"){{/domain_team}}{{#domain_user}}-"+_("企业认证用户")+'{{/domain_user}}"><span class="icon i-{{agent_type}}{{#is_domain}}-domain{{/is_domain}}"></span><span class="item-text">{{name}}{{#email}}({{email}}){{/email}}</span><span class="i-inherit i-inherit-{{inherit}}" title='+_("允许子团队继承权限")+'></span><span class="icon col3"></span><span class="combox" id="combox-{{index}}"></span></li>'};if(1==self.type&&1==self.mark){self.node.append('<div class="userTip">请确保您添加的用户手机号不为空，避免出现无法登录的现象</div>');var auth_list_config={noclick:!0,column:1,template:'<li class="list-item item-{{agent_type}}" index="{{index}}" title="{{name}}{{#email}}({{email}}){{/email}}{{#domain_team}}('+_("域团队")+"){{/domain_team}}{{#domain_user}}-"+_("企业认证用户")+'{{/domain_user}}"><span class="icon i-{{agent_type}}{{#is_domain}}-domain{{/is_domain}}"></span><span class="item-text">{{name}}{{#email}}({{email}}){{/email}}</span><span class="i-inherit i-inherit-{{inherit}}" title='+_("允许子团队继承权限")+'></span><span class="icon col3"></span></li>'}}else 0==self.type?(self.node.addClass("add-team-user"),auth_list_config.hasTeamCombox=!0):1==self.type&&(auth_list_config.hasAuthCombox=!0,self.node.append(Mustache.render(path_template,{"auth-list-path":Util.getRootDisplayName()+self.option.path})));self.node.append(content_template),1==self.type&&1==self.mark&&($(".auth-link").remove(),$(".i-auth").remove()),$("input[type='text']").placeholder();var teamTreeCombox=new UserTeamAuthCombox("#teamGroup",2,{title:self.option.title,authTree:self.option.authTree});self.user_team_list=new ListView("#user_team_list",{column:1,template:'<li class="list-item" index="{{index}}" title="{{name}}{{#email}}({{email}}){{/email}}{{#domain_team}}('+_("域团队")+"){{/domain_team}}{{#domain_user}}-"+_("企业认证用户")+'{{/domain_user}}"><input class="item-checkbox" type="checkbox"/><span class="icon i-{{agent_type}}{{#is_domain}}-domain{{/is_domain}}"></span><span class="item-text text-{{agent_type}}">{{name}}{{#email}}({{email}}){{/email}}</span><u>'+_("添加")+"</u></li>"}),self.auth_list=new ListView("#auth_list",auth_list_config),self.auth_list.data=[],self._renderUserTeamList(),1==self.type&&1==self.mark?self._initSmsAuthList():1==self.type&&self._initAuthList(),1==self.type&&1==self.mark?self.node.append("<span class='userteamauth-instruction'>"+_("在团队及成员列表中选择要添加的团队或用户。")+"</span>"):1==self.type&&self.node.append("<span class='userteamauth-instruction'>"+_("在团队及成员列表中选择要授权的团队或用户,添加到已授权记录列表中。")+"</span>"),self.node.delegate(".user-list-bottom>input","click",function(e){var cur=e.currentTarget;cur.checked?(self.node.find(".user-list-bottom>.user-add").show(),self.user_team_list.selectAll(!0)):(self.node.find(".user-list-bottom>.user-add").hide(),self.user_team_list.selectAll(!1))}),self.user_team_list.on("selected",function(param){var selectedData=[];for(var key in param)selectedData.push(param[key]);0==selectedData.length?(self.node.find(".user-list-bottom>input")[0].checked=!1,self.node.find(".user-list-bottom>.user-add").hide()):(self.node.find(".user-list-bottom>input")[0].checked=!0,self.node.find(".user-list-bottom>.user-add").show())}),self.user_team_list.on("teamClick",function(index){var team=self.user_team_list.data[index];$("#teamGroup>.lui-combox").find(".curli>span.icon").removeClass(function(){var classNames=this.className.split(" ");return classNames.splice(0,2),classNames.join(" ")}).addClass(team.is_domain?"i-team-domain":"i-team"),$("#teamGroup>.lui-combox").find(".curtext").text(team.name),self.currentPage=0,self.searchType=1,self.searchKey=team.id,self._search()}),self.user_team_list.on("allClick",function(){$("#teamGroup>.lui-combox").find(".curli>span.icon").removeClass(function(){var classNames=this.className.split(" ");return classNames.splice(0,2),classNames.join(" ")}).addClass("i-all"),$("#teamGroup>.lui-combox").find(".curtext").text(_("所有用户")),self.currentPage=0,self.searchType=3,self.searchKey=null,self._search()}),self.user_team_list.node.delegate(".list-item","mouseenter",function(e){$(this).find("u").show()}),self.user_team_list.node.delegate(".list-item","mouseleave",function(e){$(this).find("u").hide()}),self.user_team_list.on("item-added",function(data){self.auth_list.data.add(data),self._renderAuthList()}),self.node.delegate(".user-list-bottom>.user-add","click",function(e){var data=self.user_team_list.getSelectedItem();self.auth_list.data.add(data),self._renderAuthList(),self.node.find(".user-list-bottom>input").trigger("click")});var not_already_search=!0;self.node.delegate(".btn-search>.icon","click",function(e){var target=$(e.target);if(target.hasClass("icon-search"))target.removeClass("icon-search").addClass("i-close2"),self.node.find(".i-text").show().focus(),$("#teamGroup").hide();else{if(target.addClass("icon-search"),self.node.find(".i-text").val("").hide(),$("#teamGroup").show(),self.searchKey=null,not_already_search)return;not_already_search=!0,$("#teamGroup").find(".curli>.icon").removeClass(function(){
var classNames=this.className.split(" ");return classNames.splice(0,2),classNames.join(" ")}),1==self.type&&$("#teamGroup").find(".curli>.icon").addClass("i-team-user"),$("#teamGroup").find(".curli>.curtext").text(teamTreeCombox.config.title),self._renderUserTeamList()}}),teamTreeCombox.on("teamSearch",function(param){self.currentPage=0,self.searchType=1,self.searchKey=param,self._search()}),teamTreeCombox.on("selectAllUser",function(){self.currentPage=0,self.searchType=3,self._search()}),teamTreeCombox.on("manage",function(){self.currentPage=0,self.searchKey=null,self._renderUserTeamList()}),self.node.delegate(".i-text","keydown",function(e){if(13==e.keyCode){var search_key=e.currentTarget.value;if(!search_key)return;not_already_search=!1,self.searchKey=search_key,self.searchType=2,self.currentPage=0,self._search()}}),self.node.delegate("u.prev","click",function(e){0!=self.currentPage&&(self.currentPage-=1,self._search(),self.node.find(".user-list-bottom>.user-add").hide(),self.node.find(".user-list-bottom>input").attr("checked",!1))}),self.node.delegate("u.next","click",function(e){var lastPage=self.totalSize%self.size==0?self.totalSize/self.size-1:parseInt(self.totalSize/self.size);self.currentPage!=lastPage&&(self.currentPage+=1,self._search(),self.node.find(".user-list-bottom>.user-add").hide(),self.node.find(".user-list-bottom>input").attr("checked",!1))}),self.node.delegate(".auth-list h2>u","mouseenter",function(e){self._showAuthList()}),self.node.delegate(".auth-list h2>u","mouseleave",function(e){self.node.find(".auth-panel").remove()}),self.node.delegate(".auth-list-bottom>u","click",function(e){self.auth_list.data=[],self._renderAuthList()}),self.auth_list.on("change",function(_index,category,value){self.auth_list.data[_index][category]=value}),self.auth_list.on("changeInherit",function(_index,flag){var span_inherit=self.auth_list.node.find(".list-item").eq(_index).find(".i-inherit");span_inherit.removeClass(function(){var clazz=this.className.split(" ");return clazz.splice(0,1),clazz.join(" ")}),span_inherit.addClass("i-inherit-"+flag)}),self.auth_list.on("delete",function(_index){function deleteItem(){var curId=self.auth_list.data[_index]._id,curType=self.auth_list.data[_index].agent_type;if(curId)if(1==self.type&&1==self.mark){var postData={action:"disable"};"all"==curType?postData.all=!0:"team"==curType?postData.team_ids=[curId]:postData.user_ids=[curId],UserModel.smsAuthSet(function(ret){200==ret.code?(self.auth_list.data.splice(_index,1),self._renderAuthList(),Tips.show(ret.message)):Tips.warn(500==ret.code?ret.message.join("<br"):ret.message),context.reload()},postData)}else AuthModel.batch_del(function(ret){200==ret.code?(self.auth_list.data.splice(_index,1),self._renderAuthList(),Tips.show(ret.message)):Tips.warn(500==ret.code?ret.message.join("<br"):ret.message),context.reload()},[curId]);else self.auth_list.data.splice(_index,1),self._renderAuthList()}return 0==self.type?void deleteItem():void new ConfirmDialog({content:_("您确认要删除吗？")},function(){deleteItem()})})},_renderUserTeamList:function(){this.searchType=0,this._search()},_renderAuthList:function(){var self=this,sort_by=function(name,minor){return function(o,p){var a,b;return o&&p&&"object"==typeof o&&"object"==typeof p?(a=o[name],b=p[name],a===b?"function"==typeof minor?minor(o,p):0:typeof a==typeof b?b>a?-1:1:typeof b>typeof a?-1:1):void thro("error")}},result=self.auth_list.data.sort(sort_by("agent_type",sort_by("name")));if(self.auth_list.render(result),0==self.type){var addNum=self.auth_list.data.length>0?self.auth_list.data.length:"";$(".auth-list h2 span:eq(1) .tip").html(addNum>0?Mustache.render(_("将下列{{number}}个用户添加到"),{number:addNum}):_("将下列用户添加到"))}},getSelectedItem:function(){return this.auth_list.getAllItem()},_showAuthList:function(){var self=this,authPanel=$("<div class='auth-panel'><h2></h2><ul class='auth-body'></ul></div>"),data=[{instruction:_("权限说明"),preview:_("预览"),upload:_("上传"),download:_("下载"),uploadlink:_("创建上传外链"),downloadlink:_("创建下载外链"),create:_("新建目录/文件"),remove:_("删除"),rename:_("重命名"),move:_("移动"),copy:_("复制")},{instruction:_("编辑"),preview:"1",upload:"1",download:"1",uploadlink:"1",downloadlink:"1",create:"1",remove:"1",rename:"1",move:"1",copy:"1"},{instruction:_("上传/下载/外链"),preview:"1",upload:"1",download:"1",uploadlink:"1",downloadlink:"1",create:"1",remove:"0",rename:"0",move:"0",copy:"0"},{instruction:_("下载/外链"),preview:"1",upload:"0",download:"1",uploadlink:"0",downloadlink:"1",create:"0",remove:"0",rename:"0",move:"0",copy:"0"},{instruction:_("上传/外链"),preview:"0",upload:"1",download:"0",uploadlink:"1",downloadlink:"0",create:"1",remove:"0",rename:"0",move:"0",copy:"0"},{instruction:_("上传/下载"),preview:"1",upload:"1",download:"1",uploadlink:"0",downloadlink:"0",create:"1",remove:"0",rename:"0",move:"0",copy:"0"},{instruction:_("下载"),preview:"1",upload:"0",download:"1",uploadlink:"0",downloadlink:"0",create:"0",remove:"0",rename:"0",move:"0",copy:"0"},{instruction:_("上传"),preview:"0",upload:"1",download:"0",uploadlink:"0",downloadlink:"0",create:"1",remove:"0",rename:"0",move:"0",copy:"0"},{instruction:_("预览"),preview:"1",upload:"0",download:"0",uploadlink:"0",downloadlink:"0",create:"0",remove:"0",rename:"0",move:"0",copy:"0"}],h_template="<span class='instruction'>{{instruction}}</span><span class='preview'>{{preview}}</span><span class='upload'>{{upload}}</span><span class='download'>{{download}}</span><span class='uploadlink'>{{uploadlink}}</span><span class='downloadlink'>{{downloadlink}}</span><span class='create'>{{create}}</span><span class='remove'>{{remove}}</span><span class='rename'>{{rename}}</span><span class='move'>{{move}}</span><span class='copy'>{{copy}}</span>",li_template="<li><span class='instruction'>{{instruction}}</span><span class='preview'><i class='i-auth-{{preview}}'></i></span><span class='upload'><i class='i-auth-{{upload}}'></i></span><span class='download'><i class='i-auth-{{download}}'></i></span><span class='uploadlink'><i class='i-auth-{{uploadlink}}'></i></span><span class='downloadlink'><i class='i-auth-{{downloadlink}}'></i></span><span class='create'><i class='i-auth-{{create}}'></i></span><span class='remove'><i class='i-auth-{{remove}}'></i></span><span class='rename'><i class='i-auth-{{rename}}'></i></span><span class='move'><i class='i-auth-{{move}}'></i></span><span class='copy'><i class='i-auth-{{copy}}'></i></span></li>";authPanel.find("h2").append(Mustache.render(h_template,data[0]));for(var i=1;i<data.length;i++)authPanel.find("ul.auth-body").append(Mustache.render(li_template,data[i]));self.node.append(authPanel),authPanel.show()},searchType:0,currentPage:0,size:9,totalSize:0,searchKey:null,_search:function(){function renderList(ret){self.totalSize=ret.data.total_size;for(var datas=[],i=0,len=ret.data.content.length;len>i;i++){var item=ret.data.content[i],d={};"team"==item.agent_type?(d={id:item._id,uid:item._id,name:item.name,agent_id:item._id,is_domain:item.from_domain_account,domain_team:item.from_domain_account,agent_type:"team",cssAction:"preview",inherit:!1},1==self.mark&&(d.mark=1)):(d={id:item.uid,uid:item.uid,name:item.user_name,email:item.email,is_domain:item.from_domain_account,domain_user:item.from_domain_account,agent_id:item.uid,agent_type:"user",cssAction:"preview"},0==self.type&&(d.role="member"),1==self.mark&&(d.mark=1)),datas.push(d)}1==self.type&&0==self.searchType&&0==self.currentPage&&datas.splice(0,0,{id:-1,name:_("所有用户"),agent_type:"all",cssAction:"preview"}),self.user_team_list.node.height(29*datas.length),self.user_team_list.render(datas),generatePage()}function generatePage(){var totalPage=self.totalSize%self.size==0?self.totalSize/self.size:parseInt(self.totalSize/self.size)+1;self.node.find(".user-list-bottom>u.prev,.user-list-bottom>u.next").show(),1>=totalPage?self.node.find(".user-list-bottom>u.prev,.user-list-bottom>u.next").hide():0==self.currentPage?self.node.find(".user-list-bottom>u.prev").hide():self.currentPage==totalPage-1?self.node.find(".user-list-bottom>u.next").hide():self.node.find(".user-list-bottom>u.prev,.user-list-bottom>u.next").show()}var self=this;0==this.type?0==this.searchType?UserModel.list_for_pages(function(result){200==result.code&&renderList(result)},this.currentPage,this.size):1==this.searchType?TeamModel.membership_get(function(result){200==result.code&&renderList(result)},this.searchKey,this.currentPage,this.size):UserModel.list_for_pages(function(result){200==result.code&&renderList(result)},this.currentPage,this.size,UserModel.ROLE.ALL,this.searchKey):0==this.searchType||1==this.searchType?TeamModel.getTeamListById(function(result){200==result.code&&renderList(result)},this.searchKey,1==this.searchType?!0:!1,this.currentPage,this.size):2==this.searchType?TeamModel.searchUserTeamByName(function(result){200==result.code&&renderList(result)},this.searchKey,this.currentPage,this.size):UserModel.list_for_pages(function(result){200==result.code&&renderList(result)},this.currentPage,this.size)},_initAuthList:function(){var self=this;AuthModel.list_by_resource(function(result){if(200==result.code){for(var data=result.data,i=0,len=data.length;len>i;i++){var item=data[i];self.auth_list.data.push("team"==item.agent_type?{_id:item.id,id:item.agent_id,name:item.agent_name,agent_id:item.agent_id,is_domain:item.from_domain_account,domain_team:item.from_domain_account,agent_type:item.agent_type,cssAction:item.privilege_name,inherit:item.inherit||!1}:{_id:item.id,id:item.agent_id,name:item.agent_name?item.agent_name:_("所有用户"),is_domain:item.from_domain_account,domain_user:item.from_domain_account,email:item.email,agent_id:item.agent_id,agent_type:item.agent_type,cssAction:item.privilege_name})}self._renderAuthList()}},self.option.path)},_initSmsAuthList:function(){var self=this;UserModel.smsAuthGet(function(result){if(200==result.code){for(var data=result.data.result,i=0,len=data.length;len>i;i++){var item=data[i];self.auth_list.data.push("team"==item.agent_type?{_id:item.id,id:item.agent_id,name:item.agent_name,agent_id:item.agent_id,is_domain:item.from_domain_account,domain_team:item.from_domain_account,agent_type:item.agent_type}:{_id:item.id,id:item.agent_id,name:"all"!=item.agent_name?item.agent_name:_("所有用户"),is_domain:item.from_domain_account,domain_user:item.from_domain_account,email:item.agent_slug,agent_id:item.agent_id,agent_type:item.agent_type})}self._renderAuthList()}})}}),UserTeamAuthList}),define("component/validator",function(require,exports){function Validator(config){this.config=config,this.fields=[],this._init(config)}var $=require("jquery"),Rules={mobile:function(val){return/^1\d{10}$/.test(val)},date:function(val){return/^(?:0[1-9]|1[0-2])\/(?:0[1-9]|[12][0-9]|3[01])\/(?:\d{4})/.test(val)},email:function(val){return/^(?:\w+\.?)*\w+@(?:\w+\.)+\w+$/.test(val)},number:function(val){return/^\d+$/.test(val)},english:function(val){return/^[\w-]+$/.test(val)},minLength:function(val,length){return val.length>=length},maxLength:function(val,length){return val.length<=length},equal:function(val1,val2){return val1==val2}};return $.extend(Validator.prototype,{_init:function(){var self=this,config=self.config;for(var item in config.fields)self._processField(config.fields[item],item);config.submitButton&&$(config.submitButton).click(self._handleSubmit)},getError:function(error){return $('<div id="'+error.id+'" class="lui-validator"><span class="triangle"></span><span class="triangle2"></span><span class="msg">'+error.message+"</span></div>")},_handleSubmit:function(){var i,l,self=this,fields=(self.config,self.fields),errors=!1;for(i=0,l=fields.length;l>i;i+=1)fields[i].testValid(!0)||(errors=!0);return!errors},_processField:function(opts,selector){var self=this,config=self.config,fields=self.fields,field=$(selector),error={message:opts.message,id:selector.slice(1)+"_unhappy"},errorEl=$(error.id).length>0?$(error.id):self.getError(error);fields.push(field),field.testValid=function(submit){var val,gotFunc,temp,el=$(this),error=!1,required=!!el.get(0).attributes.getNamedItem("required")||opts.required,password="password"===field.attr("type"),arg=$.isFunction(opts.arg)?opts.arg():opts.arg;if(val=$.isFunction(opts.clean)?opts.clean(el.val()):opts.trim||password?el.val():$.trim(el.val()),el.val(val),gotFunc=(val.length>0||"sometimes"===required)&&Rules[opts.rule],required===!0&&0===val.length?error=!0:gotFunc&&(error=!gotFunc(val,arg)),error){var pos=el.position();return errorEl.css({left:pos.left+el.width()+20,top:pos.top}),$(self.config.form).append(errorEl),el.addClass("unhappy").before(),!1}return temp=errorEl.get(0),temp.parentNode&&temp.parentNode.removeChild(temp),el.removeClass("unhappy"),!0},field.bind(config.when||"blur",field.testValid)},addField:function(field){var self=this;self._processField(field.rule,field.selector)},removeField:function(name){for(var self=this,i=0;i<self.fields.length;i++){var item=self.fields[i];item.attr("id")==name&&self.fields.splice(i,1)}},hasField:function(name){var self=this;$.each(self.fields,function(index,item){return item.attr("id")==name?!0:void 0})},isValid:function(){return this._handleSubmit()}}),Validator}),define("component/wait",function(require,exports){function Wait(){var wait=$('<div class="lui-wait"><img width="32" height="32" src="/img/loading3.gif"/></div>');wait.appendTo($("body")),this.wait=wait}var $=require("jquery"),EventTarget=require("eventTarget");return $.extend(Wait.prototype,EventTarget,{close:function(){var self=this;self.wait&&self.wait.remove()}}),Wait}),define("lenovodata/eventController",function(require,exports,module){var $=require("jquery"),_=(require("i18n"),$.i18n.prop),Util=require("lenovodata/util"),UserManager=require("lenovodata/model/UserManager"),FileManager=require("lenovodata/model/FileManager"),TempTool=require("component/eventTemplateTool"),previewController=require("lenovodata/previewController"),AuthModel=require("model/AuthManager"),fileController=require("lenovodata/fileController"),eventManager=require("lenovodata/model/EventManager"),Tips=require("component/tips");require("mustache");var eventController=function(call,isBox){this.index=0,this.currentData=[],this.fileData={},this.userInfo={},this.call=call,this.isBox=isBox?!0:!1,this.bindEvent(),this.eventManager=new eventManager,this.splitNeid={},this.showUserInfoBox=!1};eventController.prototype={bindEvent:function(){var self=this;self.isBox||$("#listBody").delegate(".dy-icon,.event","click",function(){self.gotoBox(this)}),$("#listBody").delegate(".select-icon","click",function(){$(this).parent().nextAll(".item,.line").slideToggle(300,function(){self.call()}),$(this).toggleClass("active-icon")}),$("#listBody").delegate(".file","mouseover",function(){$(this).find(".hover a").length>0?$(this).find(".hover a").show():self.getFileInfoByNeid($(this).attr("neid"),this)}).delegate(".file","mouseleave",function(){$(this).find(".hover a").hide()}),$("#listBody").delegate(".file .info","click",function(){self.locationToFolder(this)}),$("#listBody").delegate(".dy-icon-user","mouseenter",function(e){var offset=$(this).offset(),uid=$(this).attr("uid");self.showUserInfoBox=!0,self.getUserInfo(uid,offset.left,offset.top)}).delegate(".dy-icon-user","mouseleave",function(){$("body").find(".dynamic-user-info").remove(),self.showUserInfoBox=!1}),$("#listBody").delegate(".desc a","click",function(){Util.sendDirectlyRequest("主页面","由右侧栏动态中进入文件夹","-"),self.gotoBox(this)}),$("#listBody").delegate(".hover a","click",function(){var neid=$(this).parent().parent().attr("neid");$(this).hasClass("i-preview")?(Util.sendDirectlyRequest("主页面",'右侧动态栏中"预览"按钮',"-"),self.accessMode(neid,"preview")):$(this).hasClass("i-download")&&(Util.sendDirectlyRequest("主页面",'右侧动态栏中"下载"按钮',"-"),self.accessMode(neid,"download"))}),$("#listBody").undelegate(".more","click").delegate(".more","click",function(){$(this).find("i").hasClass("down")?($(this).find(".dispaly").html(_("收起")),$(this).siblings(".dy-content").removeClass("no-wrap"),$(this).find("i").removeClass("down").addClass("up")):($(this).find(".dispaly").html(_("更多")),$(this).siblings(".dy-content").addClass("no-wrap"),$(this).find("i").addClass("down").removeClass("up"))})},locationToFolder:function(box){var neid=$(box).parent().attr("neid"),data=this.getDataByNeid(neid);data&&data.isfolder&&this.locationTo(data)},gotoBox:function(box){var self=this,current=$(box).parents(".item").attr("index");localStorage.clear();for(var k in this.currentData)if(self.currentData[k].index==current){var bool="undefined"!=typeof this.currentData[k].target[0]&&parseInt(this.currentData[k].target[0].neid)>0||"undefined"!=typeof this.currentData[k].pneid&&parseInt(this.currentData[k].pneid)>0;bool?self.getInfo(this.currentData[k],box):(self.clearNum(self.currentData[k],box),self.showToast(404));break}},filterSplitNeid:function(neid,eventType){var splitType=[1001,1017001,1014001,1010];for(var i in splitType)splitType.hasOwnProperty(i)&&splitType[i]==eventType&&(this.splitNeid[neid]=!0)},getInfo:function(data,box){var useFromPNeidEventType=[1014],self=this,neid=parseInt(data.target[0].neid),path_type=data.pathType;for(var i in useFromPNeidEventType)if(data.eventType==useFromPNeidEventType[i]){neid=data.from[0].pneid;break}parseInt(data.pneid)>0&&(neid=parseInt(data.pneid)),-1!=location.pathname.indexOf("/event/list")?("self"==path_type&&(path_type="share_out"),this.filterSplitNeid(neid,data.eventType)):path_type=Util.getPathType(),neid>0&&FileManager.metadata_path_info_no_wait(function(json){200==json.code?self.locationTo(json.data):(self.clearNum(data,box),self.showToast(json.code,json.message))},neid,path_type)},clearNum:function(data,box){var params=("share_out"==data.path_type?"self":data.path_type,{type:"clear",etuIds:data.etuIds});this.eventManager.list_no_wait(function(json){200==json.code&&$(box).siblings(".has-dynamic").remove()},params)},showToast:function(code,message,useMessage){localStorage.clear(),404!=code||useMessage||(message=_("文件夹不存在")),403!=code||useMessage||(message=_("您没有查看该文件夹的权限")),-1!=location.href.indexOf("event/list")?Tips.show(message):Tips.dyToast(message)},locationTo:function(data){if("undefined"!=typeof data.isfolder&&(data.isFolder=data.isfolder),/^share_/.test(data.path_type)&&(localStorage.setItem("from",data.from),localStorage.setItem("prefix_neid",data.prefix_neid)),0===data.path.indexOf("/")&&(data.path=data.path.substr(1)),data.isFolder){if(this.splitNeid[data.neid]===!0&&-1!=location.pathname.indexOf("event/list")){var tmp=data.path.split("/");tmp.pop(),data.path=tmp.join("/")}}else{var tmp=data.path.split("/");tmp.pop(),data.path=tmp.join("/")}return localStorage.setItem("currentPath",data.path),localStorage.setItem("showTab",1),localStorage.setItem("path_type",data.path_type),"ent"==data.path_type?void(location.href="/"):"share_in"==data.path_type?void(location.href="/folder/shared"):"share_out"==data.path_type?void(location.href="/folder/myshare"):"self"==data.path_type?void(location.href="/folder/self"):void 0},getUserInfo:function(uid,x,y){var self=this;if(x-=263,y-=35,$("body").find(".dynamic-user-info").remove(),self.userInfo.hasOwnProperty(uid)){var data=self.userInfo[uid];if(self.showUserInfoBox){var html=Mustache.render($("#dynamic-user-info-template").html(),data);$("body").append(html).find(".dynamic-user-info").css({top:y+"px",left:x+"px"}).show()}}else UserManager.info_get(function(data){var data={username:data.data.user_name,email:data.data.email,phone:data.data.mobile};if(self.userInfo[uid]=data,self.showUserInfoBox){var html=Mustache.render($("#dynamic-user-info-template").html(),data);$("body").append(html).find(".dynamic-user-info").css({top:y+"px",left:x+"px"}).show()}},uid)},filterData:function(data,unflip){var self=this,today=Util.formatDate(new Date,"yyyy-MM-dd"),yesterday=Util.formatDate(new Date((new Date).getTime()-864e5),"yyyy-MM-dd"),newData={};unflip||(data=this.flipData(data));for(var i in data)if("object"==typeof data[i]&&!isNaN(i)){var time=Util.formatDate(new Date(data[i].ctime),"yyyy-MM-dd");today==time?time=_("今天"):yesterday==time&&(time=_("昨天")),newData.hasOwnProperty(time)||(newData[time]=[]);var path=data[i].path?data[i].path:data[i].target[0].path;data[i].time=Util.formatDate(new Date(data[i].ctime),"hh:mm"),data[i].titlePath=path?path.split("/").pop():"",data[i].folderIconType=data[i].hasOwnProperty("pathType")&&data[i].pathType&&isNaN(data[i].pathType)&&""!=data[i].pathType?/^share_/.test(data[i].pathType)?"folder_share":"self"==data[i].pathType?"folder":"folder_team":"folder",data[i].num>99&&(data[i].num="99+"),data[i].cla=data[i].num>9&&data[i].num<99?"msgMid":"99+"==data[i].num?"msgBig":"msgSmall",data[i].index=self.index++,this.currentData.push(data[i]),newData[time].push(self.createTemplateData(data[i]))}data=[];for(var i in newData)data.push({date:i,list:newData[i]});return data},flipData:function(data){for(var newData=[],i=data.length-1;i>=0;i--)newData.push(data[i]);return newData},createTemplateData:function(data){return data.iconType="user",TempTool.getTemplate(data)},getFileInfoByNeid:function(neid,dom){var self=this,path=this.getPathByNeid(neid);path&&"undefined"==typeof this.fileData[neid]?(this.fileData[neid]=!0,FileManager.metadata_no_wait(function(data){200==data.code?(self.fileData[neid]=self.adapt(data.data),self.showFileAccess(neid,dom)):self.fileData[neid]=data},path,{neid:neid})):self.showFileAccess(neid,dom)},showFileAccess:function(neid,dom){if(this.fileData.hasOwnProperty(neid)&&"object"==typeof this.fileData[neid]&&!this.fileData[neid].isfolder){var data=this.fileData[neid],access={preview:!1,download:!1};Util.canPreview(data.mimeType)&&1==(1&data.access_mode)&&(access.preview=!0),4==(4&data.access_mode)&&(access.download=!0),$(dom).find(".hover").append(Mustache.render($("#dynamic-event-file-hover-template").html(),access)),this.call()}},getPathByNeid:function(neid){var self=this;for(var i in self.currentData)if(self.currentData[i].hasOwnProperty("event_file")){var tmp=self.currentData[i].event_file;for(var k in tmp)if(tmp.hasOwnProperty(k)&&tmp[k].neid&&neid==tmp[k].neid)return tmp[k].path}return null},getEventDataByNeid:function(neid){var self=this;for(var i in self.currentData)if(self.currentData[i].hasOwnProperty("event_file")){var tmp=self.currentData[i].event_file;for(var k in tmp)if(tmp.hasOwnProperty(k)&&tmp[k].neid&&neid==tmp[k].neid)return self.currentData[i]}return null},getDataByNeid:function(neid){return this.fileData.hasOwnProperty(neid)?this.fileData[neid]:null},accessMode:function(neid,type){var data=this.getDataByNeid(neid);switch(type){case"preview":new previewController(data,"preview",data,[data]);break;case"download":new fileController({currentData:data},"download",data,null)}},adapt:function(item){var file=Util.resolvePath(item.path,item.is_dir),typeIcon=file.type;item.is_dir&&(typeIcon=item.is_shared&&item.is_team?"folder_team":item.is_shared?"folder_share":"folder");var d={};return d.access_mode=item.access_mode,d.isfolder=item.is_dir,d.isdelete=item.is_deleted,d.isShare=item.is_shared,d.thumbExist=item.thumb_exist,d.isTeam=item.is_team,d.type=typeIcon,d.typeIcon=Util.typeIcon(typeIcon),d.name=file.name,d.size=Util.formatBytes(item.bytes),d.datetime=Util.formatDate(item.modified,_("yyyy-MM-dd")+" hh:mm"),d.path=item.path,d.path_type=item.path_type,d.creator=item.creator,d.uid=item.uid,d.neid=item.neid,d.prefix_neid=item.prefix_neid,d.from=item.from,d.hash=item.hash,d.action=Util.resolveFileAction(item.access_mode),d.languageAction=AuthModel.getAuthTitle(d.action),d.authable=item.authable,d.cssAction=Util.resolveFileAction(item.access_mode).replace(/:/g,"-"),d.hasDelivery=item.delivery_code?!0:!1,d.islocked=item.lock_uid?!0:!1,d.unlockAdmin=item.lock_uid==Util.getUserID()||Util.isAdmin(),d.deliveryTitle=_(d.hasDelivery?"查看外链":"外链分享"),d.deliveryCode=item.delivery_code,d.mimeType=item.mime_type,d.desc=item.desc,d.share_to_personal=item.share_to_personal,d.isshared=item.is_shared&&"/folder/self"==location.pathname,d.category=_(item.is_shared?item.is_team?"团队文件夹":"共享文件夹":"普通文件夹"),d.isfolder||(d.rev=item.rev,d.version=item.rev_index),d},display:function(){$(".dynamic-item .item .dy-content").each(function(){$("body").append('<div id="text-data" style="float:left;">'+$(this).html()+"</div>"),$("#text-data").width()+5>=$(this).width()&&$(this).siblings(".more").show(),$("#text-data").remove()})}},module.exports=eventController}),define("lenovodata/fileController",function(require,exports){function controller(context,type,param,token){switch(type){case"purge":purge(context,param);break;case"remove":if(param.length>100)return void Tips.warn(_("批量操作数量不能超过100"));remove(context,param);break;case"copymove":if(param.length>100)return void Tips.warn(_("批量操作数量不能超过100"));copymove(context,param);break;case"history":history(context,param);break;case"recover":if("array"==$.type(param))for(var i=0;i<param.length;i++)recover(context,param[i]);else recover(context,param);break;case"rename":rename(context,param);break;case"cleanup":cleanup(context,param);break;case"share":share(context,param);break;case"rmShare":rmShare(context,param);break;case"auth":auth(context,param);break;case"transfer":transfer(context,param);break;case"exitshare":exitshare(context,param);break;case"cancelauth":cancelauth(context,param);break;case"rmAuth":rmAuth(context,param);break;case"download":if(param.length>100)return void Tips.warn(_("批量操作数量不能超过100"));download(context,param,token);break;case"attribute":attribute(context,param);break;case"remarkEdit":remarkEdit(context,param);break;case"lock":lock(context,param);break;case"unlock":unlock(context,param);break;case"reqUnlock":reqUnlock(context,param);break;case"addfolder":addfolder(context,param);break;case"preview":preview(context,param,token)}}function _getPathes(param){var pathes=[],obj={};if("[object Array]"===Object.prototype.toString.call(param))for(var i=0,len=param.length;len>i;i++)obj={neid:param[i].neid,path:param[i].path,from:param[i].from,path_type:param[i].path_type,prefix_neid:param[i].prefix_neid},pathes.push(obj);else obj={neid:param.neid,path:param.path,from:param.from,path_type:param.path_type,prefix_neid:param.prefix_neid},pathes.push(obj);return pathes}function purge(context,param){function _callback(){FileModel.batch_purge(function(ret){200==ret.code?Tips.show(ret.message):Tips.warn(ret.message),context.reload()},pathes)}var pathes=_getPathes(param);return 0==pathes.length?void Tips.show(_("请选择要彻底删除的文件。")):void new ConfirmDialog({title:_("删除确认"),content:_("您确认要彻底删除选中的文件么？")},_callback)}function remove(context,param){function _callback(){FileModel.batch_delete(function(ret){200==ret.code?(context.reload(),Tips.show(ret.message)):412==ret.code?new ConfirmDialog({title:_("删除确认"),content:ret.message,okBtn:_("继续")},function(){FileModel.batch_delete(function(res){200==res.code?(context.reload(),Tips.show(res.message)):Tips.warn("[object Array]"==Object.prototype.toString.call(res.message)?ret.message.join("<br>"):ret.message)},pathes,!0)}):Tips.warn("[object Array]"==Object.prototype.toString.call(ret.message)?ret.message.join("<br>"):ret.message)},pathes)}var pathes=_getPathes(param);"share_out"==param.path_type||"self"==param.path_type&&param.isShare?_callback():new ConfirmDialog({title:_("删除确认"),content:_("您确认要删除选中的文件么？")},_callback)}function copymove(context,param){var cm=new CopyMove,dialog=new DirSelectDialog({teamPath:"/",title:_("移动/复制到指定位置"),buttonContext:'<div class="dialog-button-area"><a id="create-folder" class="dialog-button create-folder disabled"><i class="icon"></i>'+_("新建文件夹")+'</a><a id="move-file" class="dialog-button disabled">'+_("移动")+'</a> <a id="copy-file" class="dialog-button disabled">'+_("复制")+"</a></div>"},450,250,Util.isAdmin()?!0:!1,!0);cm.path_type="[object Array]"===Object.prototype.toString.call(param)?param[0].path_type:param.path_type,dialog.on("changePath",function(realpath,cssAction,dirData){cm.changePath(dialog,realpath,cssAction,dirData)}),cm.bindEvent(dialog,param,context)}function recover(context,param){var path=param.path,path_type=param.path_type,from=param.from,neid=param.neid,prefix_neid=(param.rev,param.prefix_neid);context.fa.data&&context.fa.data.length&&(pathLen=context.fa.data.length),FileModel.undelete(function(ret){return 200!=ret.code?void Tips.warn(ret.message):(pathNum++,pathLen==pathNum&&(Tips.show(ret.message),pathNum=0),context.reload(),void 0)},path,path_type,from,neid,prefix_neid)}function history(context,param){var path=param.path,filename=param.name,neid=param.neid,contents=[];Util.sendBuridPointRequest(),FileModel.revisions(function(ret){if(200!=ret.code)return void Tips.warn(ret.message);for(var len=ret.data.length,i=len-1;i>=0;i--){var curVer,file=ret.data[i];curVer=i==len-1?!0:!1;var version=file.version.toUpperCase();contents.push({neid:neid,version:version,rev:file.rev,path:file.path,user:file.user,revop:FileModel.REVISIONS_OP[file.op],modified:Util.formatDate(file.modified,"yyyy.MM.dd"),curVer:curVer})}var dialog=new HistoryDialog({title:filename,content:contents},function(op,path,neid,rev){if("restore"==op)$("body").data("category","historyrecover").data("action","历史版本画面恢复").data("content","文件"),FileModel.restore(function(ret){return 200!=ret.code?void Tips.warn(ret.message):(Tips.show(ret.message),context.reload(),void dialog.close())},path,"","",neid,rev,param.prefix_neid);else if("download"==op){var uri=FileModel.downloadLink(path,"","",neid,"","",rev);Util.sendDirectlyRequest("历史版本","历史版本画面下载","文件"),$("#download-iframe").attr("src",uri+"&rev="+rev)}});dialog.on("close",function(){})},path,"","",param.neid)}function rename(context,param){function renamefn(){function _callback(newfilename,cur){if(""==newfilename)return void Tips.warn(_(param.isfolder?"文件夹名不能为空":"文件名不能为空"));if(oldfilename==newfilename)return cur.find(".file-name").show(),void $(".edit-name").remove();if(Util.validFilename(newfilename)){var path=param.path,i=path.lastIndexOf("/");path=path.substr(0,i+1);var from_path=param.path,path_type=param.path_type,to_path=path+newfilename;FileModel.move(function(ret){200==ret.code?(context.reload(),Tips.show(ret.message)):412==ret.code?new ConfirmDialog({content:ret.message,okBtn:_("继续")},function(){FileModel.move(function(ret){200==ret.code?(context.reload(),Tips.show(ret.message)):Tips.warn(ret.message)},from_path,path_type,path_from,reneid,from_prefix_neid,to_path,path_type,path_from,to_prefix_neid,!0)}):Tips.warn(ret.message)},from_path,path_type,path_from,reneid,from_prefix_neid,to_path,path_type,path_from,to_prefix_neid)}}new RenameDialog(oldfilename,title,_callback,context)}var title,oldfilename=param.name,reneid=param.neid,path_from=param.from,from_prefix_neid=to_prefix_neid=param.prefix_neid;title=_(param.isfolder?"将文件夹重命名为":"将文件重命名为"),renamefn()}function cleanup(context,param){new CleanupDialog(context,param)}function download(context,param,token){function confirmDownload(fn){var dg=new Dialog(_("提示"),function(context){var template='<div class="dialog-oldversion">'+_("加密文件需要使用客户端才能解密，如果您还未下载客户端请安装客户端。")+'<br><a class="link-button" target="_blank" href="/client/windows/bin/LenovoBox.zip">'+_("下载Windows客户端")+'</a><br><br></div><div class="dialog-button-area"><a id="cancel" class="dialog-button ok">'+_("继续")+'</a><a id="cancel" class="dialog-button cancel">'+_("关闭")+"</a></div>";context.append(template),context.find(".ok").on("click",function(){fn()}),context.find(".cancel").on("click",function(){dg.close()})})}function setUri(){var session_id=$.cookie("X-LENOVO-SESS-ID");-1!=uri.indexOf("?")?param.rev&&(uri+="&rev="+param.rev):(uri+="?rev="+param.rev+"&neid="+param.neid,uri=uri.replace("//","/")),-1==uri.indexOf("account_id")&&-1==uri.indexOf("uid")&&(uri=Util._generateURLStr(uri));var postform=document.createElement("form"),actionurl=uri.substr(0,uri.indexOf("?")).replace(/%/g,"%25").replace(/#/g,"%23"),query=Util.queryString(uri.substring(uri.indexOf("?")));if(postform.action=actionurl+"?path_type="+query.path_type+"&X-LENOVO-SESS-ID="+session_id,/^share/.test(query.path_type)){if(!actionurl[actionurl.indexOf("/archives/databox/")+18])return void Tips.warn(_("我的共享根目录下不支持打包下载"));

postform.action+="&from="+context.currentData.from,postform.action+="&prefix_neid="+context.currentData.prefix_neid}if(postform.enctype="application/x-www-form-urlencoded",postform.method="post",postform.target="download-iframe",param.length){for(i=0;i<param.length;i++){var input=document.createElement("input");input.type="hidden",input.name="files[]",input.value=param[i].path,postform.appendChild(input)}document.body.appendChild(postform),postform.submit(),document.body.removeChild(postform)}else $("#download-iframe").attr("src",uri)}Util.sendBuridPointRequest();var uri="about:blank";if(param.dataUrl||param[0]&&param[0].dataUrl)return uri=(param.dataUrl||param[0].dataUrl)+"?token="+token,uri=encodeURI(uri).replace(/#/g,"%23"),void $("#download-iframe").attr("src",uri);if("[object Array]"===Object.prototype.toString.call(param)||param.isfolder){if(param.isfolder&&(param=new Array(param)),param.length>1){var pathes=_getPathes(param);uri=FileModel.archives(pathes,param[0].dataUrl,token,param[0].path_type,param[0].from,param[0].neid),setUri()}else if(1==param.length){var fileObj=param[0];fileObj.isfolder?(uri=FileModel.archives([fileObj.path],fileObj.dataUrl,token,fileObj.path_type,fileObj.from,fileObj.neid),setUri()):/\.lock$/.test(fileObj.path)?confirmDownload(function(){uri=FileModel.downloadLink(fileObj.path,fileObj.dataUrl,token),setUri()}):(uri=FileModel.downloadLink(fileObj.path,fileObj.dataUrl,token),setUri())}}else/\.lock$/.test(param.path)?confirmDownload(function(){uri=FileModel.downloadLink(param.path,param.dataUrl,token),setUri()}):(uri=FileModel.downloadLink(param.path,param.path_type,param.from,param.neid,param.dataUrl,token),setUri())}function attribute(context,param,onOff){param.isfolder&&FileModel.info(function(ret){if(200!=ret.code)return void Tips.warn(_("很抱歉，您的操作失败了，建议您重试一下！"));param.dirNum=ret.data.dir_num,param.fileNum=ret.data.file_num,param.size=ret.data.size;var template="<p><span>"+_("大　　小")+"：</span><span>"+param.size+"</span></p><p><span>"+_("包　　含")+"：</span><span>"+param.fileNum+_("个文件，")+param.dirNum+_("个文件夹")+"</span></p>";1==$(".infoAuth .attribute").find(".i-arrow2").length?($(".infoAuth .foldermore").show().html(template),$(".infoAuth .attribute").find("span").text(_("收起")),$(".infoAuth .attribute").find("i").removeClass("i-arrow2").addClass("i-arrow4")):($(".infoAuth .foldermore").empty().hide(),$(".infoAuth .attribute").find("span").text(_("更多")),$(".infoAuth .attribute").find("i").removeClass("i-arrow4").addClass("i-arrow2"))},param.path,param.path_type,param.from,param.neid),Util.sendBuridPointRequest()}function auth(context,param){var obj=null;obj="[object Array]"===Object.prototype.toString.call(param)?param[0]:param,new AuthDialog(obj,function(){context.reload()})}function rmAuth(context,param){var ids=[];if("[object Array]"===Object.prototype.toString.call(param))for(var i=0,len=param.length;len>i;i++)ids.push({neid:param[i].neid,grant_type:0});else ids.push({neid:param.neid,grant_type:0});return 0==ids.length?void Tips.warn(_("请选择需要删除的授权！")):void new ConfirmDialog({content:_("要删除选中的授权么？")},function(){AuthModel.batch_del(function(ret){return 200!=ret.code?500==ret.code?void Tips.warn(ret.message.join("<br>")):void Tips.warn(ret.message):(Tips.show(ret.message),void context.reload())},ids)})}function share(context,param){var obj=null;if(obj="[object Array]"===Object.prototype.toString.call(param)?param[0]:param,obj.action==AuthModel.ACTION["UPLOAD:DELIVERY"]&&0==obj.isfolder)Tips.warn(_("上传外链的权限，不能创建文件的外链！"));else{new DeliveryDialog(obj,function(){context.reload()})}}function rmShare(context,param){var codes=[];if("[object Array]"===Object.prototype.toString.call(param))for(var i=0,len=param.length;len>i;i++)codes.push(param[i].deliveryCode);else codes.push(param.deliveryCode);new ConfirmDialog({title:_("确认取消外链"),content:'<p style="text-align:center">'+_("您确认要取消外链么？")+"</p>"},function(){DeliveryModel.batch_del(function(ret){return 200!=ret.code?500==ret.code?void Tips.warn(ret.message.join("<br>")):void Tips.warn(ret.message):(Tips.show(ret.message),$(".file-attr-select").css("display","none"),void context.reload())},codes)})}function remarkEdit(context,param){var editDialog=new Dialog(_("备注编辑"),function(parent){parent.append("<div style='background:#FFFFFF;'><textarea style='margin:10px 20px;padding:5px;width:298px;height:150px;resize:none;' placeholder='"+_("最多可输入50个汉字或100个字符")+"' maxlength=100></textarea></div><div class='dialog-button-area'><a class='dialog-button ok'>"+_("确定")+"</a><a class='dialog-button cancel'>"+_("取消")+"</a></div>"),param.desc?$("textarea",parent).val(param.desc):$("textarea").placeholder(),parent.find(".ok").on("click",function(){var desc=$.trim($("textarea").val());if(desc&&desc==param.desc||!desc&&!param.desc)return void editDialog.close();if(Util.getBytes(desc)>100)return void Tips.warn(_("最多可输入50个汉字或100个字符"));var postData={path:param.path,neid:param.neid,desc:desc,field:"desc"};FileModel.info_set(function(result){200==result.code?(editDialog.close(),param.desc=desc,context.fa.render(param.isfolder?"folder":"file",param),Tips.show(_("备注设置成功"))):(editDialog.close(),Tips.warn(result.data.message))},postData)}),parent.find(".cancel").on("click",function(){editDialog.close()})})}function lock(context,param){new LockDialog(context,param)}function unlock(context,param){Util.sendBuridPointRequest(),FileModel.unLock(param.path,"",param.from,param.neid,function(ret){200==ret.code?(Tips.show(_("解锁成功")),context.reload()):Tips.warn(ret.message)})}function reqUnlock(context,param){new ReqUnlockDialog(context,param)}function transfer(context,param){new TransferAuthDialog(0,param,function(){context.reload()})}function exitshare(context,param){new ConfirmDialog({content:_("确认退出这个文件夹？</br>退出之后将无法继续查看该文件夹")},function(){AuthModel.batch_del(function(result){200==result.code&&(Tips.show(_("成功退出共享")),context.reload())},[{neid:param.neid,grant_type:1,agent_type:"user",agent_id:Util.getUserID()}])})}function cancelauth(context,param){new ConfirmDialog({content:_("确认取消这个文件夹的共享？</br>取消后其他被共享的用户将无法继续查看该文件夹")},function(){AuthModel.batch_del(function(result){200==result.code&&(Tips.show(_("取消共享成功")),context.reload())},[{neid:param.neid,grant_type:"ent"==Util.getPathType()?0:1}])})}function addfolder(context,param){new AddFolder(context,param)}function preview(context,current,data){function previewImage(context,current,data){var mask=document.createElement("div");mask.className="lui-mask",mask.style.zIndex="70",mask.id="lui-mask-iframe",document.body.appendChild(mask);var preview_dialog=$("<div id='web_iframediv' style='position:absolute;top:5%;left:10%;height:90%;width:80%;z-index:900;min-width:1000px;'></div>");window.previewData=data;var iframe=document.createElement("iframe");iframe.src="sigleDelivery"==context.mark?"/thumbs.html?path="+encodeURIComponent(context.path)+"&path_type="+context.path_type+"&mark="+context.mark+"&delivery_token="+encodeURIComponent(current.token)+"&cur="+current.name:current.isDelivery?"/thumbs.html?path=/"+encodeURIComponent(context.path)+"&path_type="+context.path_type+"&delivery_token="+encodeURIComponent(current.token)+"&isDelivery=true&offset=0&limit=50&cur="+encodeURIComponent(current.name):"/thumbs.html?path=/"+encodeURIComponent(context.path)+"&path_type="+context.path_type+"&offset=0&limit=50&cur="+encodeURIComponent(current.name),$(iframe).attr("width","100%").attr("height","100%").attr("frameborder","no").attr("scrolling","no"),preview_dialog.append($(iframe)),$("body").append(preview_dialog)}current.mimeType&&(-1!=current.mimeType.indexOf("image")?previewImage(context,current,data):(-1!=current.mimeType.indexOf("doc")||-1!=current.mimeType.indexOf("pdf")||-1!=current.mimeType.indexOf("ppt"))&&(current.dataUrl&&window.open(FileModel.deliveryPreview(current.previewUrl,current.path_type,current.deliveryCode,current.token)),window.open(FileModel.preview(current.path,current.rev))))}var $=require("jquery"),Util=require("util"),Dialog=require("component/dialog"),Tips=require("component/tips"),FileModel=require("model/FileManager"),AuthModel=require("model/AuthManager"),DeliveryModel=require("model/DeliveryManager"),ConfirmDialog=require("component/confirmDialog"),HistoryDialog=require("component/historyDialog"),RenameDialog=require("component/renameDialog"),CleanupDialog=require("component/cleanupDialog"),DeliveryDialog=(require("component/fileAttrDetail"),require("component/setAuthDialog"),require("component/deliveryDialog")),DirSelectDialog=require("component/dirSelectDialog"),AuthDialog=(require("component/userTeamAuthList"),require("component/authDialog")),LockDialog=require("component/lockDialog"),ReqUnlockDialog=require("component/reqUnlockDialog"),AddFolder=require("component/addfolder"),CopyMove=require("component/copymove"),TransferAuthDialog=require("component/transferauthdialog");require("mustache"),require("i18n"),require("placeholder");var pathLen,_=$.i18n.prop,pathNum=(require("eventTarget"),0);return controller}),define("lenovodata/forgot_password",function(require,exports,module){var $=require("jquery"),Util=require("lenovodata/util"),Tips=(require("i18n"),require("component/tips")),_=$.i18n.prop;$(document).ready(function(){var maxh=Math.max($(window).height(),$(document.body).height()),h=maxh-$("#head").outerHeight()-$("#foot").outerHeight();$("#container").height(h-100),$("#box").css("margin-top",(h-100-$("#box").height())/2),$("#change_captcha").bind("click",function(){$("#captcha_image").attr("src","/captcha/create?"+Util.random())}),Util.focusAndBlurChTtColor("#form_forgot","#545454","#bebec0"),$("#submit_button").click(function(e){var type,user_slug=$.trim($("#user_slug").val()),user_slug_def=$.trim($("#user_slug").attr("def")),captcha=$("#captcha").val()==$("#captcha").attr("def")?"":$.trim($("#captcha").val());if(user_slug==user_slug_def||""==user_slug)return Tips.warn(_("登录邮箱不能为空")),void $("#change_captcha").trigger("click");if(!Util.validEmail(user_slug))return Tips.warn(_("邮箱格式不正确")),void $("#change_captcha").trigger("click");if(""==captcha)return void Tips.warn(_("验证码不能为空"));$(e.target).attr("disabled",!0).val(_("正在找回密码...")),-1==user_slug.indexOf("@")?(user_slug="mobile:"+user_slug,type="mobile"):(user_slug="email:"+user_slug,type="email");var url="/mail/reset_password",postData={};postData.user_slug=user_slug,postData.captcha=captcha,Util.ajax_json_post(url,postData,function(xhr,textStatus){return data=xhr.responseJSON,$(e.target).val(_("确定")).removeAttr("disabled"),200!=data.code?405==data.code?($("#container").hide(),void $("#notallowed-update").height($("#container").height()).show()):402==data.code?void(location.href="/user/exception/"+postData.user_slug):(Tips.warn(data.msg),void $("#change_captcha").trigger("click")):"email"==type?void(location.href=data.data.location):"mobile"==type?void(location.href="/user/reset_password"):void 0})})})}),define("lenovodata/guide",function(require,exports,module){function doGuide(){function preLoadImage(url,callback){var img=new Image;img.src=url,img.complete?callback(url,img.width,img.height):img.onload=function(){callback(url,img.width,img.height),img.onload=null}}var all=$('<div id="mask-div"></div><div id="mask-divContainer"><img id="guideImg"/><br><br><a class="skip"></a><a class="next"></a><a class="start"></a></div><div id="guide-indicator"></div>');all.appendTo($("body"));var container=$("#mask-divContainer"),indicator=$("#guide-indicator"),img=container.find("#guideImg"),skip=container.find(".skip"),start=container.find(".start"),next=container.find(".next");next.on("click",function(e){fsm.next()}),start.on("click",function(e){GuideModel.guideDone(function(result){200==result.code&&(location.href="/")})}),skip.on("click",function(){location.href="/"}),window.onresize=function(){$(document.body).width()-$(window).width()>=0&&(fsm.delta=18);var isIE7=-1!=navigator.userAgent.indexOf("IE 7.0")?!0:!1;isIE7&&0==fsm.delta&&(fsm.delta=18),fsm.render()};var fsm={state:1,delta:0,delta2:18,next:function(){this.state<4&&(this.state++,this.render())},naviagte:function(index){this.state=state,this.render()},render:function(){var uploadBtnLeft=$(".upload").offset().left,addfolderBtnLeft=$(".addfolder").offset().left,delta=($(".i-user9").offset().left,this.delta),delta2=this.delta2,position={1:{left:uploadBtnLeft-293-delta,top:117},2:{left:addfolderBtnLeft-407-delta2,top:11},3:{left:19,top:113}},self=this;3==self.state?(start.css("display","inline-block"),next.remove(),skip.remove()):self.state>1&&skip.remove();var url="css/theme/default/img/guide_"+self.state+".png";preLoadImage(url,function(uri,w,h){img.attr("src",uri);var pos=position[self.state];container.width(w),container.height(h+70),container.css(pos)});for(var indi=[],i=1;4>i;i++)indi.push(i==self.state?'<span class="active">&bull;</span>':"<span>&bull;</span>");indicator.empty().html(indi.join(""))}};fsm.render()}var $=require("jquery"),Util=require("util"),GuideModel=require("model/GuideManager");require("i18n");$.i18n.prop;exports.guide=function(){!this.isDone()&&Util.isAdmin()&&doGuide()},exports.isDone=function(){return"false"===window.LenovoData.user.first_login}}),define("lenovodata/mobile_verification",function(require,exports,module){var $=require("jquery"),Util=require("lenovodata/util"),_=(require("i18n"),$.i18n.prop);require("js/gallery/jquery/placeholder/2.0.7/jquery.placeholder.js");var UserManager=require("lenovodata/model/UserManager"),Tips=require("lenovodata/component/tips");$(document).ready(function(){function sendSuccess(restTime){var i=60-restTime,oldValue=_("重新发送");$("#get_verifycode_button").attr("disabled","disabled").addClass("disabled");var intervalId=window.setInterval(function(){i>0?($("#get_verifycode_button").val(_("重新发送")+"("+i+"s)"),i--):($("#get_verifycode_button").val(oldValue),$("#get_verifycode_button").attr("disabled",!1).removeClass("disabled"),window.clearInterval(intervalId))},1e3)}function errMsg(msg){$("#error").html(msg).show()}function clearMsg(){$("#error").hide()}Util.focusAndBlurChTtColor("#formMobileCer","#545454","#bebec0"),$("#verifi-code").focus(function(){$(this).attr("value","")}),$("#mobile").text(info.mobile),sendSuccess(info.rest_time);var oInput=$("#verifi-code"),getCodeBtn=$("#get_verifycode_button"),signinBtn=$("#signin_btn");oInput.focus(function(){$(this).removeClass("err").val("")}),getCodeBtn.click(function(){$.ajax({type:"POST",url:"/captcha/loginsms?"+Math.random(),async:!1,dataType:"json",data:{},success:function(data){1==data.status?(clearMsg(),sendSuccess(data.rest_time),Tips.warn("<span>"+_("验证码已发！")+"</span><p>"+_("近期手机网络不稳定，<br/>如果没有接收到短信验证码，请重试！")+"</p>")):4001==data.code?(clearMsg(),errMsg(data.msg)):oInput.addClass("err").css("color","#f85a2a").val(data.msg)}})}),signinBtn.click(function(){function _callback(ret){200==ret.code?location.href="/":(getCodeBtn.val(_("重新获取")).removeAttr("disabled").removeClass("disabled"),oInput.addClass("err").css("color","#f85a2a").val(ret.message))}return oInput.val()?void UserManager.signin(_callback,"","","","",oInput.val()):void oInput.addClass("err").css("color","#f85a2a").val(_("验证码不能为空"))})})}),define("lenovodata/model/AccountManager",function(require,exports,module){var $=require("jquery"),Util=(require("i18n"),$.i18n.prop,require("lenovodata/util")),URL_PREFIX=Util.getApiVersion();exports.signup=function(func,user_slug,password,user_name,invitaion_code,captcha,company,contact,phone,email,website,mobile){var uri=URL_PREFIX+"/account/register",post_data={user_slug:user_slug,user_name:user_name,password:password,promo_code:invitaion_code,captcha:captcha,company:company,contact:contact,phone:phone,email:email,website:website,mobile:mobile};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.freeze=function(func,account_id){var uri=URL_PREFIX+"/account/freeze/"+account_id,post_data={};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.info_set=function(func,accountInfo){var uri=URL_PREFIX+"/account/info/set",post_data=accountInfo;Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.info_get=function(func){var uri=URL_PREFIX+"/account/info/get/";Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.domain_set=function(func,user_id,one_level,second_level){var uri=URL_PREFIX+"/account/domain/set/"+user_id,post_data={one_level:one_level,second_level:second_level};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.domain_get=function(func,user_id){var uri=URL_PREFIX+"/account/domain/get/"+user_id;Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.render_set=function(func,render_template){var uri=URL_PREFIX+"/account/render/set/",post_data={render_template:render_template};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.render_get=function(func,render_template){var uri=URL_PREFIX+"/account/render/get/";Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.SECURITY={SPEC_CHAR:1,CAPTICAL:2,WEAKNESS:4},exports.security_set=function(func,password_expire_duration,password_length,password_strategy){var uri=URL_PREFIX+"/account/security/set/",post_data={password_expire_duration:password_expire_duration,password_length:password_length,password_strategy:password_strategy};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.security_get=function(func){var uri=URL_PREFIX+"/account/security/get/";Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.quota_set=function(func,account_id,space,user_num){var uri=URL_PREFIX+"/account/quota/set/"+account_id,post_data={space:{limit:space},user_num:{limit:user_num}};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.quota_get=function(func,user_id){var uri=URL_PREFIX+"/account/quota/get/";user_id&&(uri+=user_id),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.admin_set=function(func,user_id,admin_slug){var uri=URL_PREFIX+"/account/admin/set/"+user_id,post_data={admin_slug:admin_slug};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.oauth_config=function(func,user_id){var uri="/oauth/status/"+user_id;Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.oauth_unbind=function(func){var uri="/oauth/unbind",post_data={};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.delivery_mail_get=function(func){var uri=URL_PREFIX+"/account/delivery_mail/get";Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.delivery_mail_set=function(func,deliveryMailInfo){var uri=URL_PREFIX+"/account/delivery_mail/set",post_data=deliveryMailInfo;Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.access_set=function(func,category,obj_list,enable){var uri=URL_PREFIX+"/account/security/restrict/set",post_data={category:category,obj_list:obj_list};enable&&(post_data.enable=enable),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.access_get=function(func){var uri=URL_PREFIX+"/account/security/restrict/get";Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.get_notice_config=function(func,config_type,name,config_id){var uri=URL_PREFIX+"/config/get?",arr=[];name&&arr.push("name="+name),config_type&&arr.push("config_type="+config_type),config_id&&arr.push("config_id="+config_id),uri+=arr.join("&"),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.set_notice_config=function(func,arr){var uri=URL_PREFIX+"/config/set?",post_data=arr;Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})}}),define("lenovodata/model/AclManager",function(require,exports,module){var $=require("jquery"),Util=(require("i18n"),$.i18n.prop,require("lenovodata/util")),VERSION=Util.getApiVersion(),URL_PREFIX=VERSION;exports.create=function(repository,path,action,agents){var uri=URL_PREFIX+"/acl/create",post_data={repository:repository,path:path,action:action,agents:agents};return Util.ajax_json_post(uri,post_data,function(xhr,textStatus){retVal=Util.ajax_json_process_normal_result(xhr,textStatus)}),retVal},exports.del=function(acl_id){var uri=URL_PREFIX+"/acl/delete/"+acl_id,post_data={};return Util.ajax_json_post(uri,post_data,function(xhr,textStatus){retVal=Util.ajax_json_process_normal_result(xhr,textStatus)}),retVal}}),define("lenovodata/model/AuthManager",function(require,exports,module){var $=require("jquery"),_=(require("i18n"),$.i18n.prop),Util=require("lenovodata/util"),VERSION=Util.getApiVersion(),ROOT="databox",URL_PREFIX=VERSION+"/auth",ACTION=exports.ACTION={LIST:"list",DELETE:"delete",VIEW:"view","UPLOAD:DOWNLOAD":"upload:download","UPLOAD:DOWNLOAD:DELIVERY":"upload:download:delivery",UPLOAD:"upload","UPLOAD:DELIVERY":"upload:delivery",DOWNLOAD:"download","DOWNLOAD:DELIVERY":"download:delivery",PREVIEW:"preview",EDIT:"edit",COLLABORATE:"collaborate"},AUTH_CATEGORY=exports.AUTH_CATEGORY={PREVIEW:{item_title:_("预览"),item_value:"preview"},UPLOAD:{item_title:_("上传"),item_value:"upload"},"UPLOAD:DELIVERY":{item_title:_("上传/外链"),item_value:"upload:delivery"},DOWNLOAD:{item_title:_("下载"),item_value:"download"},"DOWNLOAD:DELIVERY":{item_title:_("下载/外链"),item_value:"download:delivery"},"UPLOAD:DOWNLOAD":{item_title:_("上传/下载"),item_value:"upload:download"},"UPLOAD:DOWNLOAD:DELIVERY":{item_title:_("上传/下载/外链"),item_value:"upload:download:delivery"},EDIT:{item_title:_("编辑"),item_value:"edit"}},AGENT_TYPE=exports.AGENT_TYPE={ALL:"all",TEAM:"team",USER:"user"};exports.create=function(func,path,action,agent_id,agent_type){var uri=URL_PREFIX+"/set/"+ROOT+"/"+path;uri=uri.replace("//","/");var paramErr=!0;for(var key in ACTION)if(ACTION[key]===action){paramErr=!1;break}if(paramErr)return retVal={code:900,data:null,message:_("参数错误")},func(retVal),retVal;for(var key in AGENT_TYPE)if(AGENT_TYPE[key]===agent_type){paramErr=!1;break}if(paramErr)return retVal={code:900,data:null,message:_("参数错误")},func(retVal),retVal;var post_data={action:action,agent_id:agent_id,agent_type:agent_type};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.auth_batch_create=function(func,path,path_type,prefix_neid,entry_infos){var uri=URL_PREFIX+"/batch_create/"+ROOT+path;uri=uri.replace("//","/");var post_data={};path_type&&(post_data.path_type=path_type),prefix_neid&&(post_data.prefix_neid=prefix_neid),post_data.entry_infos="["+entry_infos+"]",Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.batch_user_set=function(func,path,action,agent_ids){var uri=URL_PREFIX+"/batch_set/"+ROOT+"/"+path;uri=uri.replace("//","/");var paramErr=!0;for(var key in ACTION)if(ACTION[key]===action){paramErr=!1;break}if(paramErr)return retVal={code:900,data:null,message:_("参数错误")},func(retVal),retVal;var post_data={action:action,agent_ids:agent_ids};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_batch_result(xhr,textStatus);func(retVal)})},exports.update=function(func,auth_entry_id,action){var uri=URL_PREFIX+"/update/"+auth_entry_id,paramErr=!0;for(var key in ACTION)if(ACTION[key]===action){paramErr=!1;break}if(paramErr)return retVal={code:900,data:null,message:_("参数错误")},func(retVal),retVal;var post_data={action:action};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.del=function(func,auth_entry_id){var uri=URL_PREFIX+"/delete/"+auth_entry_id,post_data={};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.batch_del=function(func,auth_entry_ids){var uri=URL_PREFIX+"/batch_delete",post_data={json:JSON.stringify(auth_entry_ids)};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus,_("删除成功"));func(retVal)})},exports.get=function(func,path,agent_id,agent_type){var uri=URL_PREFIX+"/get/"+ROOT+"/"+path;uri=uri.replace("//","/");var param=[];for(var key in AGENT_TYPE)if(AGENT_TYPE[key]===agent_type){param.push("agent_type="+agent_type);break}agent_id&&param.push("agent_id="+agent_id),param.length>1?uri+="?"+param.join("&"):1==param.length&&(uri+="?"+param[0]),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.list_by_operator=function(func,operatorId,grant_type){var uri=URL_PREFIX+"/list_by_operator?operator="+operatorId;uri+="&grant_type="+grant_type,Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.list_by_resource=function(func,path,path_type,prefix_neid){var uri=URL_PREFIX+"/list_by_resource"+path;path_type&&(uri+="?path_type="+path_type),prefix_neid&&(uri+="?prefix_neid="+prefix_neid),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.list_subset_resource=function(func,team_id){var uri=URL_PREFIX+"/list_subset_resource?team_id="+team_id;Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.getContextAction=function(actionObj){var action;return ACTION.LIST in actionObj?action=ACTION.LIST:ACTION.PREVIEW in actionObj?action=ACTION.PREVIEW:ACTION.UPLOAD in actionObj?action=ACTION.UPLOAD:ACTION.DOWNLOAD in actionObj?action=ACTION.DOWNLOAD:ACTION["UPLOAD:DELIVERY"]in actionObj?action=ACTION["UPLOAD:DELIVERY"].replace(/:/g,"-"):ACTION["DOWNLOAD:DELIVERY"]in actionObj?action=ACTION["DOWNLOAD:DELIVERY"].replace(/:/g,"-"):ACTION["UPLOAD:DOWNLOAD:DELIVERY"]in actionObj?action=ACTION["UPLOAD:DOWNLOAD:DELIVERY"].replace(/:/g,"-"):ACTION["UPLOAD:DOWNLOAD"]in actionObj?action=ACTION["UPLOAD:DOWNLOAD"].replace(/:/g,"-"):ACTION.EDIT in actionObj&&(action=ACTION.EDIT),action},exports.getAuthTitle=function(item){if(item){var pair=AUTH_CATEGORY[item.toString().toUpperCase()];return pair?pair.item_title:""}},exports.getAuthPair=function(item){return item?AUTH_CATEGORY[item.toString().toUpperCase()]:void 0},exports.batch_set=function(func,user_auth_list){var uri=URL_PREFIX+"/auth/batch_set",post_data=user_auth_list;Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.auth_transfer=function(func,from,fromname,to){var uri=URL_PREFIX+"/transfer",post_data={from:from,frompath:fromname,to:to};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.list_by_batch_resource=function(func,paths,grant_type){var uri=URL_PREFIX+"/list_by_batch_resource?entry_infos="+paths+"&grant_type="+grant_type+"&agent_type=user";Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})}}),define("lenovodata/model/AuthUploadManager",function(require,exports,module){var $=require("jquery"),Util=(require("i18n"),$.i18n.prop,require("lenovodata/util")),URL_PREFIX="/v2";exports.authUpload=function(func,path,path_type,from,bytes,prefix_neid){var uri=URL_PREFIX+"/fileops/auth_upload/databox/",get_data={path_type:path_type,bytes:bytes};from&&(get_data.from=from),prefix_neid&&(get_data.prefix_neid=prefix_neid);var tmp=[];""!=path&&(uri+=path);for(var i in get_data)get_data[i]&&tmp.push(i+"="+get_data[i]);uri+="?"+tmp.join("&"),Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var data=xhr.responseJSON?xhr.responseJSON:{message:Util.unknownErrMessage};switch(xhr.status){case 200:retVal={code:200,data:data,message:data.message};break;case 401:retVal={code:xhr.status,data:data,message:data.message};break;case 400:case 403:case 404:case 405:case 409:retVal={code:xhr.status,data:data,message:data.message};break;case 500:retVal={code:xhr.status,data:{},message:data.message};default:retVal={code:xhr.status,data:data,message:data.message}}func(retVal)})},exports.authDeliveryUpload=function(func,deliveryCode,path,bytes,token){var uri=URL_PREFIX+"/delivery/auth_upload/"+deliveryCode,get_data={token:token,bytes:bytes},tmp=[];for(var i in get_data)get_data[i]&&tmp.push(i+"="+get_data[i]);uri+="?"+tmp.join("&"),Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var data=xhr.responseJSON?xhr.responseJSON:{message:Util.unknownErrMessage};switch(xhr.status){case 200:retVal={code:200,data:data,message:data.message};break;case 401:retVal={code:xhr.status,data:data,message:data.message};break;case 400:case 403:case 404:case 405:case 409:retVal={code:xhr.status,data:data,message:data.message};break;case 500:retVal={code:xhr.status,data:{},message:data.message};default:retVal={code:xhr.status,data:data,message:data.message}}func(retVal)})}}),define("lenovodata/model/DeliveryManager",function(require,exports,module){var $=require("jquery"),_=(require("i18n"),$.i18n.prop),Util=require("lenovodata/util"),ROOT="databox",URL_PREFIX=Util.getApiVersion()+"/delivery";exports.create=function(func,path,path_type,from,neid,prefix_neid,mode,password,expiration,description){var uri=URL_PREFIX+"/create/"+ROOT+"/"+path;uri=uri.replace("//","/");var postData={mode:mode,password:password,expiration:expiration,description:description};neid?postData.neid=neid:(postData.path_type=path_type,postData.from=from),prefix_neid&&(postData.prefix_neid=prefix_neid),Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.del=function(func,path){var uri=URL_PREFIX+"/delete/"+ROOT+"/"+path;uri=uri.replace("//","/");var postData={};Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.batch_del=function(func,codes){var uri=URL_PREFIX+"/batch_delete/",postData={codes:codes};Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.info=function(func,code){var uri=URL_PREFIX+"/info/"+code;Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.auth=function(func,code,password){var uri=URL_PREFIX+"/auth/"+code,postData={password:password};Util.ajax_json_post(uri,postData,function(xhr,textStatus){
var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.list=function(func,include_expired){var uri=URL_PREFIX+"/list";uri+=include_expired?"?include_expired=true":"?include_expired=false",Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.metadata=function(func,code,relative_path,token,order_type,sort,offset,limit){if(!code)return{code:999,data:null,message:_("code不能为空!")};var uri=URL_PREFIX+"/metadata/"+code;relative_path&&(uri+="/"+relative_path);var queryString=[];token&&queryString.push("token="+token),order_type&&queryString.push("orderby="+order_type),sort&&queryString.push("sort="+sort),void 0!=offset&&queryString.push("offset="+offset),limit&&queryString.push("limit="+limit),queryString.length>0&&(uri+="?"+queryString.join("&")),uri=uri.replace("//","/"),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.sendmail=function(func,link,emails,message,isfolder,name,path){var uri="/mail/sendlink/",postData={link:link,email:emails,message:message,isfolder:isfolder,name:name,path:path};Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})}}),define("lenovodata/model/EventManager",function(require,exports,module){var $=require("jquery"),Util=(require("i18n"),$.i18n.prop,require("lenovodata/util")),URL_PREFIX=Util.getApiVersion()+"/event",EventManager=function(){};EventManager.prototype={list:function(func,postData){var uri=URL_PREFIX+"/pull";Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);retVal.data.hasOwnProperty("total")&&(retVal.total=retVal.data.total),retVal.data.hasOwnProperty("event")||(retVal.data.event=[],retVal.total=0),func(retVal)})},list_no_wait:function(func,postData){var uri=URL_PREFIX+"/pull";Util.ajax_json_post_nowait(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);retVal.data.hasOwnProperty("total")&&(retVal.total=retVal.data.total),retVal.data.hasOwnProperty("event")||(retVal.data.event=[],retVal.total=0),func(retVal)})},hasNew:function(func,postData){var uri=URL_PREFIX+"/unread/count";Util.ajax_json_post_nowait(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus),hasNew=!1,count=0;200==retVal.code&&retVal.data.hasOwnProperty("count")&&parseInt(retVal.data.count)>0&&(hasNew=!0,count=parseInt(retVal.data.count)),func({hasNew:hasNew,count:count})})}},module.exports=EventManager}),define("lenovodata/model/FileManager",function(require,exports,module){var $=require("jquery"),_=(require("i18n"),$.i18n.prop),Util=require("lenovodata/util"),ROOT="databox",URL_PREFIX=Util.getApiVersion(),STORAGE_URL=Util.getStorageUrl(),ORDERBY=exports.ORDERBY={MTIME:"mtime",NAME:"name",TYPE:"updator",SIZE:"size"},CONTENT_TYPE=(exports.ORDERNAME={mtime:"创建时间",name:"名称",type:"更新者",size:"大小"},exports.SORT={ASC:"asc",DESC:"desc"},exports.CONTENT_TYPE={DIR:"dir",FILE:"file"});exports.metadata=function(func,path,filter){var uri=URL_PREFIX+"/metadata/"+ROOT+path;uri=uri.replace("//","/"),filter||(filter={});var queryString=[];filter.neid?queryString.push("neid="+filter.neid):filter.path_type&&queryString.push("path_type="+filter.path_type),filter.from&&queryString.push("from="+filter.from),filter.prefix_neid&&queryString.push("prefix_neid="+filter.prefix_neid),filter.include_deleted||(filter.include_deleted="false"),queryString.push("include_deleted="+filter.include_deleted),filter.list&&queryString.push("list="+filter.list),filter.hash&&queryString.push("hash="+filter.hash),filter.rev&&queryString.push("rev="+filter.rev),filter.limit&&queryString.push("limit="+filter.limit),filter.offset=filter.offset?filter.offset:0,queryString.push("offset="+filter.offset),filter.sort&&queryString.push("sort="+filter.sort);var paramErr=!0;for(var key in ORDERBY)if(ORDERBY[key]===filter.orderby){paramErr=!1;break}paramErr||queryString.push("orderby="+ORDERBY[key]),paramErr=!0;for(var key in CONTENT_TYPE)if(CONTENT_TYPE[key]===filter.content_type){paramErr=!1;break}paramErr||queryString.push("content_type="+CONTENT_TYPE[key]),queryString.length>0&&(uri+="?"+queryString.join("&")),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.metadata_path_info_no_wait=function(func,neid,path_type){var uri=URL_PREFIX+"/path_info?neid="+neid+"&path_type="+path_type;Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.metadata_no_wait=function(func,path,filter){var uri=URL_PREFIX+"/metadata/"+ROOT+path;uri=uri.replace("//","/"),filter||(filter={});var queryString=[];filter.neid?queryString.push("neid="+filter.neid):filter.path_type&&queryString.push("path_type="+filter.path_type),filter.from&&queryString.push("from="+filter.from),filter.prefix_neid&&queryString.push("prefix_neid="+filter.prefix_neid),filter.include_deleted||(filter.include_deleted="false"),queryString.push("include_deleted="+filter.include_deleted),filter.list&&queryString.push("list="+filter.list),filter.hash&&queryString.push("hash="+filter.hash),filter.rev&&queryString.push("rev="+filter.rev),filter.limit&&queryString.push("limit="+filter.limit),filter.offset=filter.offset?filter.offset:0,queryString.push("offset="+filter.offset),filter.sort&&queryString.push("sort="+filter.sort);var paramErr=!0;for(var key in ORDERBY)if(ORDERBY[key]===filter.orderby){paramErr=!1;break}paramErr||queryString.push("orderby="+ORDERBY[key]),paramErr=!0;for(var key in CONTENT_TYPE)if(CONTENT_TYPE[key]===filter.content_type){paramErr=!1;break}paramErr||queryString.push("content_type="+CONTENT_TYPE[key]),queryString.length>0&&(uri+="?"+queryString.join("&")),Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.info=function(func,path,path_type,from,neid){var uri=URL_PREFIX+"/info/"+ROOT+path;uri+="?neid="+neid+"&path_type="+path_type+"&from="+from,Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.info_set=function(func,infoData){var uri=URL_PREFIX+"/info_set/"+ROOT+infoData.path+"?a",post_data={};infoData.neid?post_data.neid=infoData.neid:(post_data.path_type=infoData.path_type,post_data.from=infoData.from),infoData.field&&(post_data.field=infoData.field),(!infoData.clean_arg||infoData.clean_arg)&&(post_data.clean_arg=infoData.clean_arg),(!infoData.clean_mode||infoData.clean_mode)&&(post_data.clean_mode=infoData.clean_mode),"desc"==infoData.field&&(post_data.desc=infoData.desc?infoData.desc:""),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.search=function(func,path,path_type,from,neid,offset,file_limit,type,query,include_deleted,size_start,size_end,time_start,time_end,creator,desc,prefixNeid){var uri=URL_PREFIX+"/search/"+ROOT+path;return uri=uri.replace("//","/"),void 0===query?{code:999,data:null,message:_("查询字符串,不能为空!")}:(uri+="?query="+query,neid&&(uri+="&neid="+neid,uri+="&prefix_neid="+prefixNeid),path_type&&(uri+="&path_type="+path_type),from&&(uri+="&from="+from),offset&&(uri+="&offset="+offset),file_limit&&(uri+="&limit="+file_limit),uri+="&include_deleted="+include_deleted,size_start&&(uri+="&size_start="+size_start),size_end&&(uri+="&size_end="+size_end),time_start&&(uri+="&time_start="+time_start),time_end&&(uri+="&time_end="+time_end),creator&&(uri+="&creator="+creator),type&&(uri+="&type="+type),desc&&(uri+="&desc="+desc),void Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)}))},exports.lock=function(path,path_type,from,prefix_neid,neid,time,func){var uri=URL_PREFIX+"/lock/"+ROOT+path;uri+="?neid="+neid,path_type&&(uri+="&path_type="+path_type),from&&(uri+="&from="+from),prefix_neid&&(uri+="&prefix_neid="+prefix_neid),time&&(uri+="&time="+time),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.unLock=function(path,path_type,from,neid,func){var uri=URL_PREFIX+"/unlock/"+ROOT+path;neid?uri+="?neid="+neid:(path_type&&(uri+="?path_type="+path_type),from&&(uri+="&from="+from)),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.reqUnlock=function(func,email,message,username,filepath,path_type,from,neid){var uri="/mail/requnlock/",postData={email:email,message:message,user_name:username,path:filepath,path_type:path_type,from:from,neid:neid};Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})};exports.REVISIONS_OP={create:_("创建"),restore:_("恢复"),undelete:_("还原"),update:_("更新"),rename:_("重命名"),move:_("移动"),"delete":_("删除")};exports.revisions=function(func,path,path_type,from,neid,rev_limit){var uri=URL_PREFIX+"/revisions/"+ROOT+"/"+path;uri=uri.replace("//","/"),neid?uri+="?neid="+neid:(path_type&&(uri+="?path_type="+path_type),from&&(uri+="&from="+from)),rev_limit&&(uri+="&rev_limit="+rev_limit),uri+="&t="+Math.random(),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.restore=function(func,path,path_type,from,neid,rev,prefix_neid){var uri=URL_PREFIX+"/restore/"+ROOT+"/"+path;uri=uri.replace("//","/");var post_data={};neid?post_data.neid=neid:(path_type&&(post_data.path_type=path_type),from&&(post_data.from=from)),post_data.rev=rev,("share_in"==path_type||"share_out"==path_type)&&(post_data.prefix_neid=prefix_neid),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.downloadLink=function(path,path_type,from,neid,url,token){var uri="";return url?uri=url+"&token="+token:(uri=URL_PREFIX+"/dl_router/"+ROOT+"/"+path+"?",path_type&&(uri+="path_type="+path_type),from&&(uri+="&from="+from),neid&&(uri+="&neid="+neid)),uri=uri.replace("//","/"),uri=encodeURI(uri),uri=uri.replace(/#/g,"%23")},exports.archives=function(pathes,url,token,path_type,from,neid,prefix_neid){var uri="";if("string"==$.type(pathes[0]))var index=pathes[0].lastIndexOf("/");else var index=pathes[0].path.lastIndexOf("/");var pathroot;pathroot=0==index?"/":"string"==$.type(pathes[0])?pathes[0].substr(0,index):pathes[0].path.substr(0,index),token=token?token:"",uri=url?url+"/archives/?token="+token+"&":URL_PREFIX+"/archives/"+ROOT+"/"+pathroot+"/?token="+token+"&path_type="+path_type+"&",("0"==from||from)&&(uri+="from="+from+"&"),neid&&(uri+="neid="+neid+"&");for(var files=[],i=0,len=pathes.length;len>i;i++)files.push("files[]="+encodeURIComponent(pathes[i]));files.push("account_id="+window.LenovoData.user.account_info._id),files.push("uid="+window.LenovoData.user.user_info.uid),files.push("X-LENOVO-SESS-ID="+$.cookie("X-LENOVO-SESS-ID")),uri+=files.join("&");var storageUrl=STORAGE_URL;return/box.lenovo.com/.test(STORAGE_URL)&&(storageUrl="https://content-box.vips100.com"),uri=uri.replace("//","/"),uri=storageUrl+uri.replace("//","/")},exports.preview=function(path,rev,path_type,from,neid){var uri=URL_PREFIX+"/preview_router?type=doc&root="+ROOT+"&path="+Util.getMyEncodeURI(path)+"&path_type="+path_type+"&from"+from+"&neid="+neid+"&";return uri+="rev="+rev,uri=uri.replace("//","/")},exports.thumbnails=function(storage_url,path,path_type,from,neid,width,height,hash,rev,isDelivery,deliveryCode,token,previewUrl){var uri=URL_PREFIX+"/preview_router?type=pic&root="+ROOT+"&path=";return isDelivery?(previewUrl=Util.getMyEncodeURI(previewUrl),uri=previewUrl+"&path_type="+path_type+"&delivery_code="+deliveryCode+"&delivery_token="+token):uri+=Util.getMyEncodeURI(path),uri+="&path_type="+path_type+"&from="+from+"&neid="+neid+"&width="+width+"&height="+height+"&hash="+hash+"&rev="+rev},exports.sigleThumbnails=function(path,path_type,width,height,hash,rev,deliveryCode,token){var uri=URL_PREFIX+"/preview_router?type=pic&root="+ROOT+"&path="+encodeURI(path);return uri=uri.replace("//","/"),uri+="&path_type="+path_type+"&w="+width+"&h="+height+"&hash="+hash+"&rev="+rev+"&delivery_code="+deliveryCode+"&delivery_token="+token,STORAGE_URL+uri},exports.copy=function(func,from_path,from_path_type,from_from,from_neid,to_path,to_path_type,to_from){var uri=URL_PREFIX+"/fileops/copy",post_data={root:ROOT,from_path:from_path,to_path:to_path,to_path_type:to_path_type,to_from:to_from};from_neid?post_data.from_neid=from_neid:(from_path_type&&(post_data.from_path_type=from_path_type),from_from&&(post_data.from_from=from_from)),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.batch_copy=function(func,from_pathes,to_path){var uri=URL_PREFIX+"/fileops/batch_copy",data=JSON.stringify({from:from_pathes,to:to_path}),post_data={json:data};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_batch_result(xhr,textStatus,_("文件复制成功"));func(retVal)})},exports.create_folder=function(func,path,path_type,from,neid,prefix_neid){var uri=URL_PREFIX+"/fileops/create_folder/"+ROOT+path;uri=uri.replace("//","/");var post_data={};neid?post_data.neid=neid:(path_type&&(post_data.path_type=path_type),from&&(post_data.from=from)),/^share/.test(path_type)&&(post_data.prefix_neid=prefix_neid),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.undelete=function(func,path,path_type,from,neid,prefix_neid){var uri=URL_PREFIX+"/fileops/undelete/"+ROOT+"/"+path;uri=uri.replace("//","/");var post_data={};neid?post_data.neid=neid:(post_data.path_type=path_type,post_data.from=from),("share_in"==path_type||"share_out"==path_type)&&(post_data.prefix_neid=prefix_neid),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus,_("目录还原成功!"));func(retVal)})},exports.del=function(func,path,path_type,from,neid,ignore_share){var uri=URL_PREFIX+"/fileops/delete/"+ROOT+"/"+path;uri=uri.replace("//","/");var post_data={};neid?post_data.neid=neid:(path_type&&(post_data.path_type=path_type),from&&(post_data.from=from)),ignore_share&&(post_data.ignore_share=!0),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.batch_delete=function(func,pathes,ignore_share){var uri=URL_PREFIX+"/fileops/batch_delete",json={};json.pathes=[];for(var i=0;i<pathes.length;i++){var obj={};obj.root="databox",obj.neid=pathes[i].neid,obj.path=Util.getMyEncodeURI(pathes[i].path),obj.from=pathes[i].from,obj.path_type=pathes[i].path_type,obj.prefix_neid=pathes[i].prefix_neid,json.pathes.push(obj)}ignore_share&&(json.ignore_share=!0);var post_data={json:JSON.stringify(json)};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_batch_result(xhr,textStatus,_("删除成功"));func(retVal)})},exports.batch_purge=function(func,pathes){var uri=URL_PREFIX+"/fileops/batch_purge",json={};json.pathes=[];for(var i=0;i<pathes.length;i++){var obj={};obj.root="databox",obj.neid=pathes[i].neid,obj.path=Util.getMyEncodeURI(pathes[i].path),obj.from=pathes[i].from,obj.path_type=pathes[i].path_type,json.pathes.push(obj)}var post_data="json = "+JSON.stringify(json);Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus,_("文件彻底删除成功"));func(retVal)})},exports.move=function(func,from_path,from_path_type,from_from,from_neid,from_prefix_neid,to_path,to_path_type,to_from,to_prefix_neid,ignore_share){var uri=URL_PREFIX+"/fileops/move",post_data={root:ROOT,from_path:from_path,from_path_type:from_path_type,from_from:from_from,from_neid:from_neid,from_prefix_neid:from_prefix_neid,to_path:to_path,to_path_type:to_path_type,to_from:to_from,to_prefix_neid:to_prefix_neid};ignore_share&&(post_data.ignore_share=!0),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.batch_move=function(func,from_pathes,to_path,ignore_share){var uri=URL_PREFIX+"/fileops/batch_move",data={from:from_pathes,to:to_path};ignore_share&&(data.ignore_share=!0);var post_data={json:JSON.stringify(data)};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_batch_result(xhr,textStatus,_("文件移动成功"));func(retVal)})},exports.deliveryPreview=function(url,delivery_code,token){var url=url+"&delivery_code="+delivery_code+"&delivery_token="+token;return url}}),define("lenovodata/model/GuideManager",function(require,exports,module){var $=require("jquery"),Util=(require("i18n"),$.i18n.prop,require("lenovodata/util")),URL_PREFIX=Util.getApiVersion()+"/task",TASK_NUM=exports.TASK_NUM={GUIDE:1,CREATE_USER:2,CREATE_DIR:3,UPLOAD_FILE:4,CREATE_LINK:5,INSTALL_CLIENT:6,DETAILS:7,SURVEY:8};exports.get=function(func){var uri=URL_PREFIX+"/info";Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.guideDone=function(func){var uri=URL_PREFIX+"/status/set",post_data={task_number:TASK_NUM.GUIDE,achieved:!0};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.reward=function(func,task_number){var uri=URL_PREFIX+"/reward/exchange",post_data={task_number:task_number};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.getCount=function(func){var uri=Util.getApiVersion()+"/lottery/count";Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.draw=function(func){var uri=Util.getApiVersion()+"/lottery/draw";Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.getDrawResult=function(func){var uri=Util.getApiVersion()+"/lottery/result/query";Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.getAllDrawResult=function(func,limit){var uri=Util.getApiVersion()+"/lottery/result/query?query_type=all&limit="+limit;Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})}}),define("lenovodata/model/LogManager",function(require,exports,module){var $=require("jquery"),Util=(require("i18n"),$.i18n.prop,require("lenovodata/util")),URL_PREFIX=Util.getApiVersion();exports.list=function(func,fromTime,toTime,category,action,uid,offset,limit){var uri=URL_PREFIX+"/log/get?";fromTime&&(uri+="&from_date="+fromTime),toTime&&(uri+="&to_date="+toTime),category&&(uri+="&category="+category),action&&(uri+="&action="+action),uid&&(uri+="&operator="+uid),void 0!=offset&&(uri+="&offset="+offset),limit&&(uri+="&limit="+limit),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})}}),define("lenovodata/model/NoticeManager",function(require,exports,module){var $=require("jquery"),Util=(require("i18n"),$.i18n.prop,require("lenovodata/util")),VERSION=Util.getApiVersion(),URL_PREFIX=VERSION+"/notice";exports.create=function(func,title,body){var uri=URL_PREFIX+"/create",post_data={title:title,body:body};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.del=function(func,notice_id){var uri=URL_PREFIX+"/delete/"+notice_id,post_data={};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.list=function(func,limit,offset){var uri=URL_PREFIX+"/list",queryString=[];queryString.push("limit="+parseInt(limit)),queryString.push("offset="+parseInt(offset)),queryString.length>0&&(uri+="?"+queryString.join("&")),Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.pull=function(func,limit,offset,sort){var uri=URL_PREFIX+"/pull",queryString=[];limit&&queryString.push("limit="+parseInt(limit)),void 0!=offset&&queryString.push("offset="+parseInt(offset)),sort&&queryString.push("sort="+sort),queryString.length>0&&(uri+="?"+queryString.join("&")),Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.update=function(func,notice_id,title,body){var uri=URL_PREFIX+"/update/"+notice_id,post_data={title:title,body:body};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.top=function(func,notice_id,index){var uri=URL_PREFIX+"/top/"+notice_id,post_data={Top_index:index};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.viewed=function(func,notice_id){var uri=URL_PREFIX+"/viewed/"+notice_id;Util.ajax_json_post_nowait(uri,{},function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})}}),define("lenovodata/model/TeamManager",function(require,exports,module){var $=require("jquery"),Util=(require("i18n"),$.i18n.prop,require("lenovodata/util")),URL_PREFIX=Util.getApiVersion()+"/team",ROOT="databox";exports.create=function(func,teamObj){var uri=URL_PREFIX+"/create",postData=teamObj;postData.root=ROOT,Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.del=function(func,teamId){var uri=URL_PREFIX+"/delete/"+teamId,postData={};Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.getTeamListByUser=function(func){var uri=URL_PREFIX+"/list_by_user/";Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.getTeamListById=function(func,teamId,with_member,page_num,num_each_page){var uri=URL_PREFIX+"/list_by_id/";teamId&&(uri+=teamId),uri+=with_member?"?with_member=true":"?with_member=false",uri+=page_num?"&page_num="+page_num:"&page_num=0",num_each_page&&(uri+="&num_each_page="+num_each_page),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.list_direct_belong_to_team=function(func,request_uid){var uri=URL_PREFIX+"/list_direct_belong_to_team?request_uid="+request_uid;Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.membership_create=function(func,teamId,uids){var uri=URL_PREFIX+"/membership/create/"+teamId,postData={uids:uids};Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.membership_batch_creat=function(func,teamId,user_infos){var uri=URL_PREFIX+"/membership/batch_create/"+teamId,postData={};uri+="?user_infos=["+user_infos+"]",Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.batch_join=function(func,uid,teamIds){var uri=URL_PREFIX+"/membership/join",postData={user_id:uid,team_ids:teamIds};Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.membership_kickoff=function(func,teamId,uids){var uri=URL_PREFIX+"/membership/kickoff/"+teamId,postData={uids:uids};Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.membership_get=function(func,teamId,page_num,num_each_page){var uri=URL_PREFIX+"/membership/get/"+teamId;uri+=page_num?"?page_num="+page_num:"?page_num=0",num_each_page&&(uri+="&num_each_page="+num_each_page),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.search=function(func,teamId,query){var uri=URL_PREFIX+"/membership/search/";void 0!==teamId&&(uri+=teamId),uri+="?query="+query,Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.info_get=function(func,teamId){var uri=URL_PREFIX+"/info/get/"+teamId;Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.info_set=function(func,teamId,teamObj){var uri=URL_PREFIX+"/info/set/"+teamId,postData=teamObj;Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})};var _admin_set=exports.admin_set=function(func,teamId,uid){var uri=URL_PREFIX+"/admin/set/"+teamId,postData={admin_uid:uid};Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},_admin_unset=exports.admin_unset=function(func,teamId,uid){var uri=URL_PREFIX+"/admin/unset/"+teamId,postData={admin_uid:uid};Util.ajax_json_post(uri,postData,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})};exports.searchUserTeamByName=function(func,keyword,page_num,num_each_page){var uri=Util.getApiVersion()+"/user_team/search?keyword="+keyword+"&page_num="+page_num+"&num_each_page="+num_each_page;Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.set_role=function(func,teamId,uid,role){"member"==role?_admin_unset(func,teamId,uid):_admin_set(func,teamId,uid)}}),define("lenovodata/model/UserManager",function(require,exports,module){{var $=require("jquery"),_=(require("i18n"),$.i18n.prop),Util=require("lenovodata/util"),URL_PREFIX=Util.getApiVersion();exports.ROLE={ALL:"all",MEMBER:"member",ADMIN:"admin"}}exports.signin=function(func,user_slug,password,captcha,autologin,rem_pwd){var uri=URL_PREFIX+"/user/login",retVal={code:null,data:null,message:Util.unknownErrMessage},post_data={user_slug:user_slug,password:password,captcha:captcha};autologin&&(post_data.auto_login=autologin),rem_pwd&&(post_data.rem_pwd=rem_pwd),Util.ajax_json_post_nowait(uri,post_data,function(xhr,textStatus){var data=xhr.responseJSON?xhr.responseJSON:{message:Util.unknownErrMessage};switch(xhr.status){case 200:retVal={code:200,data:data,message:data.message};break;case 401:retVal={code:xhr.status,data:data,message:data.message};break;case 400:case 403:case 404:case 409:retVal={code:xhr.status,data:data,message:data.message}}func(retVal)})},exports.signout=function(func){var uri=URL_PREFIX+"/user/logout",post_data={};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.create=function(func,user_slug,user_name,email,quota,password,mobile,password_changeable,active){var uri=URL_PREFIX+"/user/create",post_data={user_slug:user_slug,user_name:user_name,email:email,quota:quota};password&&(post_data.password=password),mobile&&(post_data.mobile=mobile),post_data.password_changeable=password_changeable,post_data.active=active,Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.create_join_team=function(func,email,team_id){var uri=URL_PREFIX+"/user/team_create",post_data={t_email:email,team_id:team_id};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.info_set=function(func,userInfo){var uri=URL_PREFIX+"/user/info/set/";userInfo.user_id&&(uri+=userInfo.user_id);var post_data={};userInfo.email&&(post_data.new_email=userInfo.email),post_data.new_mobile=userInfo.mobile?userInfo.mobile:"empty",userInfo.user_name&&(post_data.new_user_name=userInfo.user_name),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus,_("用户设置成功"));func(retVal)})},exports.quota=function(func){this.info_get(function(ret){200==ret.code&&func({quota:ret.data.quota,used:ret.data.used})})},exports.info_get=function(func,user_id){var uri=URL_PREFIX+"/user/info/get/";user_id&&(uri+=user_id),Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.list=function(func,role,keyword){var uri=URL_PREFIX+"/user/list";role||(role="member"),uri+="?role="+role,keyword&&(uri+="&keyword="+keyword),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.list_for_pages=function(func,page_num,num_each_page,role,keyword){var uri=URL_PREFIX+"/user/list_for_pages";role||(role="member"),uri+="?role="+role,uri+=page_num?"&page_num="+page_num:"&page_num=0",num_each_page&&(uri+="&num_each_page="+num_each_page),keyword&&(uri+="&keyword="+keyword),Util.ajax_json_get(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.freeze=function(func,user_id){var uri=URL_PREFIX+"/user/freeze/"+user_id,post_data={};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.batch_freeze=function(func,user_ids){var uri=URL_PREFIX+"/user/batch_freeze",post_data={uids:user_ids};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_user_batch_result(xhr,textStatus);func(retVal)})},exports.activate=function(func,user_id){var uri=URL_PREFIX+"/user/activate/"+user_id,post_data={};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.batch_activate=function(func,user_ids){var uri=URL_PREFIX+"/user/batch_activate",post_data={uids:user_ids};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_user_batch_result(xhr,textStatus);func(retVal)})},exports.batch_del=function(func,user_ids,force){var uri=URL_PREFIX+"/user/batch_delete",post_data={uids:user_ids};force&&(post_data.force=!0),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_user_batch_result(xhr,textStatus);func(retVal)})},exports.del=function(func,user_id){var uri=URL_PREFIX+"/user/delete/"+user_id,post_data={};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.password_set=function(func,user_id,password,old_password,password_changeable){var uri=URL_PREFIX+"/user/password/set/";if(user_id&&(uri+=user_id),password)var post_data={old_password:old_password,password:password};else var post_data={};void 0!==password_changeable&&(post_data.password_changeable=password_changeable),Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal);

})},exports.quota_set=function(func,user_id,quota){var uri=URL_PREFIX+"/user/quota/set/"+user_id,post_data={quota:quota};Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.changeSessionInfo=function(func,user_name,quota){var uri="/user/changeSessionInfo",post_data={user_name:user_name,quota:quota};Util.ajax_json_post_nowait(uri,post_data,function(xhr,textStatus){var ret=Util.ajax_json_process_normal_result(xhr,textStatus);func(ret)})},exports.getUserEmailList=function(func,key){var uri=URL_PREFIX+"/user/search?query="+key+"&pattern=head&type=email";Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.smsAuthSet=function(func,post_data){var uri=URL_PREFIX+"/sms/auth_set/",post_data=post_data;Util.ajax_json_post(uri,post_data,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.smsAuthGet=function(func){var uri=URL_PREFIX+"/sms/auth_get";Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})},exports.suggestion=function(func,prefix){var uri=URL_PREFIX+"/suggestion?prefix="+prefix;Util.ajax_json_get_nowait(uri,function(xhr,textStatus){var retVal=Util.ajax_json_process_normal_result(xhr,textStatus);func(retVal)})}}),define("lenovodata/previewController",function(require,exports){function controller(context,type,current,data){if(Util.sendBuridPointRequest(),"preview"==type&&current.mimeType)if(-1!=current.mimeType.indexOf("image"))previewImage(context,current,data);else if(-1!=current.mimeType.indexOf("doc")||-1!=current.mimeType.indexOf("pdf")||-1!=current.mimeType.indexOf("ppt")){if(current.dataUrl)return void previewDeliveryDoc(context,current,data);previewDoc(context,current,data)}else-1!=current.mimeType.indexOf("doc")&&previewImage(context,current,data)}function previewImage(context,current,data){var mask=document.createElement("div");mask.className="lui-mask",mask.style.zIndex="70",mask.style.minWidth="1024px",mask.id="lui-mask-iframe",document.body.appendChild(mask);var preview_dialog=$("<div id='web_iframediv' style='position:absolute;top:0;overflow:hidden;left:0;height:100%;width:100%;z-index:1000;min-width:1024px;'></div>");window.previewData=data;var iframe=document.createElement("iframe");iframe.src="sigleDelivery"==context.mark?"/thumbs.html?path="+encodeURIComponent(context.path)+"&mark="+context.mark+"&delivery_token="+encodeURIComponent(current.token)+"&cur="+encodeURIComponent(current.name):current.isDelivery?"/thumbs.html?path=/"+encodeURIComponent(context.path)+"&delivery_token="+encodeURIComponent(current.token)+"&isDelivery=true&offset=0&limit=50&cur="+encodeURIComponent(current.name):"/thumbs.html?path=/"+encodeURIComponent(context.path)+"&path_type="+current.path_type+"&offset=0&limit=50&cur="+encodeURIComponent(current.name),$(iframe).attr("width","100%").attr("height","100%").attr("frameborder","no").attr("scrolling","no"),preview_dialog.append($(iframe)),$("body").append(preview_dialog)}function previewDoc(context,current,data){var url=FileModel.preview(current.path,current.rev,current.path_type,current.from,current.neid);window.open(url)}function previewDeliveryDoc(content,current,data){var url=FileModel.deliveryPreview(current.previewUrl,current.deliveryCode,current.token);window.open(url)}var $=require("jquery"),Util=require("util"),FileModel=require("model/FileManager");return controller}),define("lenovodata/reset_password",function(require,exports,module){{var $=require("jquery"),Util=require("lenovodata/util"),Tips=(require("i18n"),require("component/tips")),_=$.i18n.prop;require("lenovodata/model/AccountManager.js")}require("js/gallery/jquery/placeholder/2.0.7/jquery.placeholder.js"),$(document).ready(function(){function callback(xhr,textStatus){200!=xhr.status?(data=xhr.responseJSON,Tips.warn(data.message)):(Tips.show(_("操作成功")),setTimeout(function(){location.href="/"},2e3))}function validPassword(pwd,pwd2){if(""==pwd)return Tips.warn(_("密码不能为空")),!1;var MIN_PWD=6,MAX_PWD=32;return pwd.length<MIN_PWD||pwd.length>MAX_PWD?(Tips.warn(_("密码长度必须大于等于6，小于等于32")),!1):""==pwd2?(Tips.warn(_("请输入确认密码")),!1):pwd2.length<MIN_PWD||pwd2.length>MAX_PWD?(Tips.warn(_("密码长度必须大于等于6，小于等于32")),!1):pwd!=pwd2?(Tips.warn(_("两次输入密码不一致，请重新输入！")),!1):!0}$("#head").outerHeight()+$("#container").outerHeight()+$("#foot").outerHeight()<$(window).height()&&$("#container").height($(window).height()-$("#head").outerHeight()-$("#foot").outerHeight()-100),Util.focusAndBlurChTtColor("#form_reset","#545454","#bebec0"),$("#form_reset").find("input:text,input:password").css("color","#bebec0"),$("#submit_button").click(function(){var token=$("#token").val(),password1=$("#password").val(),password2=$("#password2").val();if(""==$.trim(token))return void Tips.warn(_("验证码不能为空"));if(validPassword(password1,password2))var password=password1;var url=Util.getApiVersion()+"/user/password/reset",postData={};postData.token=$("#token").val(),postData.password=password,Util.ajax_json_post(url,postData,callback)})})}),define("lenovodata/searchController",function(require,exports){function controller(context,type,param,size_start,size_end,time_start,time_end,creator,filetype,desc){switch(type){case"file":fileSearch(context,param,size_start,size_end,time_start,time_end,creator,filetype,desc);break;case"user":userSearch(context,param);break;case"team-user":teamUserSearch(context,param,arguments[3])}}function fileSearch(context,keyword,size_start,size_end,time_start,time_end,creator,filetype,desc){var curFileNeid=null,prefixNeid="";("share_in"==context.type||"share_out"==context.type)&&context.path&&(curFileNeid=context.currentData.neid,prefixNeid=context.currentData.prefix_neid),FileModel.search(function(result){if(200==result.code){for(var totalSize=result.data.total_size,datas=[],i=0,ii=result.data.content.length;ii>i;i++)try{var item=result.data.content[i],file=Util.resolvePath(item.path,item.is_dir),typeIcon=file.type;item.is_dir&&(typeIcon=item.is_shared&&item.is_team?"folder_team":item.is_shared?"folder_share":"folder");var d={};d.isfolder=item.is_dir,d.isdelete=item.is_deleted,d.isShare=item.is_shared,d.thumbExist=item.thumb_exist,d.type=typeIcon,d.typeIcon=Util.typeIcon(typeIcon),d.name=file.name,d.updator=item.updator,d.filename=file.name,d.mimeType=item.mime_type,d.size=Util.formatBytes(item.bytes),d.datetime=Util.formatDate(item.modified,_("yyyy-MM-dd")+" hh:mm"),d.path=item.path,d.path_type=item.path_type,d.from=item.from,d.neid=item.neid,d.prefix_neid=item.prefix_neid,d.parentPath=Util.getParentPath(item.path),d.creator=item.creator,d.hash=item.hash,d.desc=item.desc,d.team=item.team,d.action=Util.resolveFileAction(item.access_mode),d.cssAction=Util.resolveFileAction(item.access_mode).replace(/:/g,"-"),d.languageAction=AuthModel.getAuthTitle(d.action),item.team_id||(item.team_id=""),d.teamId=item.team_id,d.hasMoreVersion=item.has_more_version?"has-version":"no-version",d.hasDelivery=item.delivery_code?!0:!1,d.deliveryCode=item.delivery_code,d.deliveryTitle=_(d.hasDelivery?"查看外链":"外链分享"),d.islocked=item.lock_uid?!0:!1,d.unlockAdmin=item.lock_uid==Util.getUserID()||Util.isAdmin(),d.keyword=keyword,d.category=item.is_shared?item.team?_("团队文件夹")+"("+AuthModel.getAuthTitle(d.action)+")":_("共享文件夹")+"("+AuthModel.getAuthTitle(d.action)+")":_("普通文件夹"),d.isfolder||(d.rev=item.rev,d.version=item.rev_index),datas.push(d)}catch(err){}datas.searchData=!0,datas.keyword=keyword,context.processSearch(totalSize),context.filelist.render(datas),$(".file-date").css("display","none"),$(".file-path").addClass("file-path-show")}},"/"+context.path,Util.getPathType(),null,curFileNeid,0,100,filetype,keyword,!1,size_start,size_end,time_start,time_end,creator,desc,prefixNeid)}function userSearch(context,keyword){UserModel.list(function(result){if(200==result.code){for(var datas=[],i=0,ii=result.data.length;ii>i;i++){var item=result.data[i],d={userAlias:item.user_name+(item.from_domain_account?"("+_("企业认证用户")+")":""),uid:item.uid,userName:item.user_name,accountId:item.account_id,role:item.role,email:item.email,mobile:item.mobile,isAdmin:"admin"==item.role?!0:!1,ctime:Util.formatDate(item.ctime,_("yyyy年MM月dd日")+" hh:mm:ss"),frozen:-1==item.status?"true":"false",isFrozen:-1==item.status?"true":"false",isActive:-1!=item.status?"true":"false",isCer:item.from_domain_account};datas.push(d)}context.totalPage=1,context.renderList(datas)}},UserModel.ROLE.MEMBER,keyword)}function teamUserSearch(context,teamId,keyword){TeamModel.search(function(result){if(200==result.code){for(var datas=[],i=0,len=result.data.length;len>i;i++){var item=result.data[i],da={index:i,uid:item.uid,userName:item.user_name,accountId:item.account_id,role:item.role,email:item.email,mobile:item.mobile,teamId:teamId,isAdmin:"admin"==item.role?!0:!1,ctime:Util.formatDate(item.ctime,_("yyyy年MM月dd日")+" hh:mm:ss"),frozen:-1==item.status?!0:!1,isFrozen:"false",isActive:"false",userAlias:item.user_name+(item.from_domain_account?"("+_("企业认证用户")+")":""),isCer:item.from_domain_account};datas.push(da)}context.renderList(datas)}},teamId,keyword)}var $=require("jquery"),Util=(require("component/dialog"),require("component/tips"),require("util")),FileModel=require("model/FileManager"),TeamModel=require("model/TeamManager"),UserModel=require("model/UserManager"),AuthModel=require("model/AuthManager");require("i18n");var _=$.i18n.prop;return controller}),define("lenovodata/signin",function(require,exports,module){var $=require("jquery"),Dialog=require("component/dialog"),Util=require("lenovodata/util"),_=(require("i18n"),require("component/tips"),$.i18n.prop);require("cookie"),require("js/gallery/jquery/placeholder/2.0.7/jquery.placeholder.js");var UserManager=require("lenovodata/model/UserManager");$(document).ready(function(){localStorage.clear();var lbn=$.cookie("LB_N");lbn?($("#user_slug").val(lbn),$("#pwd").focus()):$("#user_slug").focus(),$("input, textarea").placeholder(),$("#change_verify_code").click(function(){$("#verify_code").attr("src","/captcha/create/login?_="+ +new Date)}),Util.focusAndBlurChTtColor("#form_login","#545454","#bebec0");var errCount=0;$("#oldVersion").on("click",function(e){var dia=new Dialog(_("温馨提示"),{mask:!0,control:!1},function(content){var template='<div class="dialog-oldversion">'+_("尊敬的用户：<br>如果您使用或试用联想企业网盘2.0版本的产品(www.vips100.com)，请进入老版本系统进行登录，对您带来的不便敬请谅解。")+'<br><a class="link-button" target="_blank" href="https://www.vips100.com/themes/v1/login.html">'+_("点击进入老版本系统登录页面")+'</a></div><div class="dialog-button-area"><a id="cancel" class="dialog-button ok">'+_("关闭")+"</a></div>";content.append(template),content.find(".dialog-button").on("click",function(){dia.close()})})}),$("#submit_button").click(function(e){function errMsg(msg){var msgArea=$("#msgArea");msgArea.html(msg).show("slow")}function _callback(ret){if(403==ret.code){if("bad captcha"==ret.data.code)return errMsg(_("验证码错误")),$("#verify").focus(),$(e.currentTarget).val(_("登录")),$(e.currentTarget).removeAttr("disabled"),!1;"device is forbidden"==ret.data.code||"ip is forbidden"==ret.data.code||"web is forbidden"==ret.data.code?(errMsg(ret.message),$(e.currentTarget).val(_("登录")),$(e.currentTarget).removeAttr("disabled")):location.href="/user/exception/"+user_slug}else{if(200!=ret.code)return++errCount>=3&&(errMsg(_("您输入的密码不正确")),$("#pwd").focus(),$("#verify_cody_container").show(),$("#verify_code").attr("src","/captcha/create/login?_="+ +new Date)),$(e.currentTarget).val(_("登录")),$(e.currentTarget).removeAttr("disabled"),errMsg(ret.message),$("#pwd").focus(),!1;if($.cookie("LB_N",$("#user_slug").val(),{expires:365}),ret.data.sms_auth)return void(location.href="/user/mobile");location.href="/"}}var user_slug=$.trim($("#user_slug").val()).toLowerCase(),pwd=$.trim($("#pwd").val()),verify=$.trim($("#verify").val()),autologin=$("#auto_login").get(0).checked;return user_slug?pwd?Util.validEmail(user_slug)||Util.validMobile(user_slug)?(user_slug=-1==user_slug.indexOf("@")?"mobile:"+user_slug:"email:"+user_slug,$(e.currentTarget).val(_("登录中...")),$(e.currentTarget).attr("disabled","disabled"),Util.sendDirectlyRequest("登录/注销","登录","-"),UserManager.signin(_callback,user_slug,pwd,verify,autologin),!1):(errMsg(_("邮箱格式不正确")),$("#user_slug").focus(),!1):(errMsg(_("密码不能为空")),$("#pwd").focus(),!1):(errMsg(_("登录邮箱不能为空")),$("#user_slug").focus(),!1)})})}),define("lenovodata/signup",function(require,exports,module){function validCompany(value,def,type){var err="";value&&value!=def||(err=_("请输入您的企业名称")),Util.getBytes(value)>50&&(err=_("长度限制在50个字符以内")),""!=err?($(type).find("#company").parent("li").addClass("error"),$(type).find("#company").prev(".tishi").text(err)):$(type).find("#company").parent("li").removeClass("error").addClass("yes")}function validPassword1(pwd,pwd_def,type){var err="",MIN_PWD=6,MAX_PWD=32;pwd&&pwd!=pwd_def?/\s/g.test(pwd)?err=_("密码不允许有空格"):(pwd.length<MIN_PWD||pwd.length>MAX_PWD)&&(err=_("密码长度为6-32个字符")):err=_("请输入您的密码"),""!=err?($(type).find("#pwd").parent("li").addClass("error"),$(type).find("#pwd").parent("li").find(".tishi").text(err)):$(type).find("#pwd").parent("li").removeClass("error").addClass("yes")}function validPassword2(pwd,pwd2,pwd2_def,type){var err="",MIN_PWD=6,MAX_PWD=32;pwd2&&pwd2!=pwd2_def?/\s/g.test(pwd)?err=_("密码不允许有空格"):pwd2.length<MIN_PWD||pwd2.length>MAX_PWD?err=_("密码长度为6-32个字符"):pwd!=pwd2&&(err=_("两次输入密码不一致，请重新输入！")):err=_("请再次输入您的密码"),""!=err?($(type).find("#pwd2").parent("li").addClass("error"),$(type).find("#pwd2").parent("li").find(".tishi").text(err)):$(type).find("#pwd2").parent("li").removeClass("error").addClass("yes")}function validEmail(email,email_def,type){var err="";email&&email!=email_def?email.length<6||email.length>50?err=_("长度限制在6~50个字符！"):Util.validEmail(email)||(err=_("邮箱格式不正确")):err=_("请输入您的邮箱"),""!=err?($(type).find("#email").parent("li").addClass("error"),$(type).find("#email").prev(".tishi").text(err)):"#mobile_reg_div"==type&&$(type).find("#email").parent("li").removeClass("error").addClass("yes")}function validMobile(mobile,mobile_def,type){var err="";mobile&&mobile!=mobile_def?Util.validMobile(mobile)||(err=_("手机号格式不正确")):err=_("请输入您的手机号"),""!=err?($(type).find("#mobile").parent("li").addClass("error"),$(type).find("#mobile").prev(".tishi").text(err)):"#mail_reg_div"==type&&$(type).find("#mobile").parent("li").removeClass("error").addClass("yes")}function validUserName(username,username_def,type){var err="";username&&username!=username_def&&"请输入您的用户名"!=username||(err=_("请输入您的用户名")),username.length>50&&(err=_("长度限制在50个字符以内")),""!=err?($(type).find("#username").parent("li").addClass("error"),$(type).find("#username").prev(".tishi").text(err)):$(type).find("#username").parent("li").removeClass("error").addClass("yes")}function valid_verify(verify,verify_def,type){var err="";verify&&verify!=verify_def&&"请输入验证码"!=verify||(err=_("请输入验证码")),""!=err&&($(type).find("#verify").parent("li").addClass("error"),$(type).find("#verify").prev(".tishi").text(err))}{var $=require("jquery"),Util=require("lenovodata/util");require("i18n")}require("cookie");var Tips=require("component/tips");require("js/gallery/jquery/placeholder/2.0.7/jquery.placeholder.js");var _=$.i18n.prop,AccountManager=require("lenovodata/model/AccountManager");$(document).ready(function(){function autoMiddle(){var autoH=$(window).height()-$("#head").outerHeight()-$("#foot").outerHeight(),minH=parseInt($("#reg_container").css("min-height"));autoH=Math.max(autoH,minH),$("#reg_container").height(autoH)}autoMiddle(),$(window).resize(function(){autoMiddle()}),$("input, textarea").placeholder();var invitation_code=Util.queryString(location.search).c||$.cookie("promo_code");invitation_code||(invitation_code="L4000");var maxh=Math.max($(window).height(),$(document.body).height()),h=maxh-$("#head").outerHeight()-$("#foot").outerHeight();$("#container").height(h-100),$("#box").css("margin-top",(h-100-$("#box").height())/2),$("#verify_code").attr("src","/captcha/create?"+Math.random()),$("#get_mobile_verifycode").click(function(){function sendSuccess(){var i=60,oldValue=$("#get_mobile_verifycode").val();$("#get_mobile_verifycode").attr("disabled","disabled").addClass("disabled");var intervalId=window.setInterval(function(){i>0?($("#get_mobile_verifycode").val(_("重新发送")+"("+i+"s)"),i--):($("#get_mobile_verifycode").val(oldValue),$("#get_mobile_verifycode").attr("disabled",!1).removeClass("disabled"),window.clearInterval(intervalId))},1e3)}var mobile=$.trim($("#mail_reg_div").find("#mobile").val()),mobile_def=$.trim($("#mail_reg_div").find("#mobile").attr("def")),err="";return mobile&&mobile!=mobile_def?Util.validMobile(mobile)||(err=_("手机号格式不正确")):err=_("请输入您的手机号"),""!=err?($("#mobile").parent("li").addClass("error"),void $("#mobile").prev(".tishi").text(err)):void $.ajax({type:"POST",url:"/captcha/sendSMS?"+Math.random(),async:!1,dataType:"json",data:{mobile:mobile,sms_token:sms_token},success:function(data){1==data.status?($("#msgArea").css("display","none"),sendSuccess(),$("#mail_reg_div .mobile_msg").remove(),Tips.warn("<span>"+_("验证码已发！")+"</span><p>"+_("近期手机网络不稳定，<br/>如果没有接收到短信验证码，请重试！")+"</p>")):4001==data.code?0==$("#mail_reg_div .mobile_msg").length&&$("#mail_reg_div").append(' <p class="mobile_msg">'+data.msg+"</p>"):($("#mobile").parent("li").addClass("error"),$("#mobile").prev(".tishi").text(data.msg),$("#mail_reg_div .mobile_msg").remove())}})}),Util.focusAndBlurChTtColor("#form_register","#545454","#bebec0"),/msie/.test(window.navigator.userAgent.toLocaleLowerCase())&&($("#form_register input:text").css("color","#bebec0"),$("#form_register input:password").css("color","#bebec0")),$("#form_register .tishi").mousedown(function(){return $(this).parent("li").removeClass("error"),$(this).next("input").focus(),!1}),$("#form_register input[type!=button]").focus(function(){$(this).parent("li").attr("class","")}),$("#submit_button").click(function(e){function _callback(ret){return 200!=ret.code?($(e.currentTarget).val(_("注册")),$(e.currentTarget).removeAttr("disabled"),$("#change_verify_code").trigger("click"),void("409"==ret.code?("Error #1001"==ret.message.substr(0,11)&&($(sel_type).find("#email").parent().addClass("error"),$(sel_type).find("#email").prev(".tishi").text(ret.message.substr(12))),"Error #1002"==ret.message.substr(0,11)&&($(sel_type).find("#mobile").parent().removeClass("yes").addClass("error"),$(sel_type).find("#mobile").prev(".tishi").text(ret.message.substr(12)))):"验证码错误"==ret.message||"incorrect captcha"==ret.message?($(sel_type).find("#verify").parent().addClass("error"),$(sel_type).find("#verify").prev(".tishi").text(ret.message)):"邀请码错误"==ret.message||"invalid invitation code"==ret.message?($(sel_type).find("#invitation-code").parent().addClass("error"),$(sel_type).find("#invitation-code").prev(".tishi").text(ret.message)):Tips.warn(ret.message))):void(window.location=ret.data.location)}var email=$.trim($("#mail_reg_div").find("#email").val()).toLowerCase(),email_def=$.trim($("#mail_reg_div").find("#email").attr("def")),username=$.trim($("#mail_reg_div").find("#username").val()),username_def=$.trim($("#mail_reg_div").find("#username").attr("def")),pwd=$("#mail_reg_div").find("#pwd").val(),pwd_def=$.trim($("#mail_reg_div").find("#pwd").attr("def")),pwd2=$("#mail_reg_div").find("#pwd2").val(),pwd2_def=$.trim($("#mail_reg_div").find("#pwd2").attr("def")),verify=$.trim($("#mail_reg_div").find("#verify").val()),verify_def=$.trim($("#mail_reg_div").find("#verify").attr("def")),mobile=$.trim($("#mail_reg_div").find("#mobile").val()),mobile_def=$.trim($("#mail_reg_div").find("#mobile").attr("def")),company={value:$.trim($("#mail_reg_div").find("#company").val()),def:$.trim($("#mail_reg_div").find("#company").attr("def"))},type="#mail_reg_div";validEmail(email,email_def,type),validPassword1(pwd,pwd_def,type),validPassword2(pwd,pwd2,pwd2_def,type),validCompany(company.value,company.def,type),validUserName(username,username_def,type),validMobile(mobile,mobile_def,type),valid_verify(verify,verify_def,type);var bol=!0;if($("#mail_reg_div li").each(function(i){return $("#mail_reg_div li").eq(i).hasClass("error")?void(bol=!1):void 0}),0!=bol){var pd={user_slug:"email:"+email,user_name:username,password:pwd,invitation_code:invitation_code,captcha:verify,company:company.value,contact:username,phone:"",email:email,website:"",mobile:mobile};if("checked"!=$("#agree:checked").attr("checked"))return void Tips.warn(_("请阅读并接受《联想企业网盘服务协议》"));if(pd.user_slug.match("email"))var sel_type="#mail_reg_div";else var sel_type="#mobile_reg_div";AccountManager.signup(_callback,pd.user_slug,pd.password,pd.user_name,pd.invitation_code,pd.captcha,pd.company,pd.contact,pd.phone,pd.email,pd.website,pd.mobile),$(e.currentTarget).attr("disabled","disabled"),$(e.currentTarget).val(_("注册中..."))}})})}),define("lenovodata/teamController",function(require,exports){function controller(context,type,param){switch(type){case"create":create(context,param);break;case"auth":auth(context,param);break;case"kickoff":kickoff(context,param);break;case"delTeam":delTeam(context,param)}}function kickoff(context,param){var uids=[];if("[object Array]"===Object.prototype.toString.call(param)){if(0==param.length)return void Tips.warn(_("请选择要移出的用户！"));for(var i=0,len=param.length;len>i;i++){if(Util.isTeamLeader()&&Util.getUserID()==param[i].uid)return void Tips.warn(_("不能移出自己"));uids.push(param[i].uid)}}else{if(Util.isTeamLeader()&&Util.getUserID()==param.uid)return void Tips.warn(_("不能移出自己"));uids.push(param.uid)}new ConfirmDialog({content:'<div class="confirm-rmUser">'+_("确认要移除选中的用户吗？")+"</div>"},function(){TeamModel.membership_kickoff(function(ret){200==ret.code&&(Tips.show(_("移除成功")),context.reload())},param[0].teamId,uids)})}function create(context,param){var TeamContext=teamTree.teamTree.tree("getNodeById",param.path),dialog=new AddTeamDialog(param.path,function(team){param.teamTree.insertTeamNode(param.path,team)},TeamContext);dialog.on("close",function(){})}function auth(context,param){new AddDirAuthDialog(param.teamPath,void 0,AuthModel.AGENT_TYPE.TEAM,"/"+param.teamName,function(){context.reload()})}function delTeam(context,param){new ConfirmDialog({title:_("删除"),content:_("是否删除团队空间及空间中的数据？")},function(){TeamModel.del(function(ret){return 200!=ret.code?void Tips.warn(ret.message):void context.gotoParentLevel(param.teamPath)},param.teamId)})}var $=require("jquery"),Tips=(require("component/dialog"),require("component/tips")),Util=require("util"),AddDirAuthDialog=require("component/addDirAuthDialog"),ConfirmDialog=require("component/confirmDialog"),AuthModel=require("model/AuthManager"),TeamModel=(require("model/FileManager"),require("model/TeamManager")),AddTeamDialog=(require("component/teamTree"),require("component/addTeamDialog"));require("i18n");var _=$.i18n.prop;return controller}),define("lenovodata/thumbs",function(require,exports,modules){function previewImage(storage_url,current,data,isDelivery,delivery_token){for(var currentId,photodata=[],i=0,len=data.length;len>i;i++){var da=data[i];if((da.thumb_exist||da.thumbExist)&&"upload"!==da.action&&"upload:delivery"!==da.action){var d={id:da.hash,name:Util.resolvePath(da.path,!1).name,description:"",originPath:FileModel.thumbnails(storage_url,da.path,da.path_type,da.from,da.neid,width,height,da.hash,da.rev,isDelivery,da.deliveryCode,delivery_token,da.previewUrl),thumbnails:FileModel.thumbnails(storage_url,da.path,da.path_type,da.from,da.neid,100,76,da.hash,da.rev,isDelivery,da.deliveryCode,delivery_token,da.previewUrl)};photodata.push(d),decodeURIComponent(current)==d.name&&(currentId=photodata.length-1)}}if(photodata.length){new PhotoSlide(photodata,currentId)}}function previewSigleImage(current,data){var currentId,photodata=[],da=data[0],d={id:da.hash,name:decodeURIComponent(current),description:"",originPath:da.path+"&delivery_token="+da.token+"&w="+width+"&h="+height+"&hash="+da.hash+"&rev="+da.rev,thumbnails:da.path+"&delivery_token="+da.token+"&w=100&h=76&hash="+da.hash+"&rev="+da.rev};if(photodata.push(d),currentId=0,photodata.length){new PhotoSlide(photodata,currentId)}}var FileModel=(require("jquery"),require("model/FileManager")),PhotoSlide=require("component/galleryslide/photoslide"),width=document.body.offsetWidth-132,height=parseInt(.76*width),Util=require("util");exports.init=function(){var queryString=location.href.substring(location.href.indexOf("?")),params=Util.queryString(queryString);if(parent.window.previewData){if("sigleDelivery"==params.mark)return void previewSigleImage(params.cur,parent.window.previewData);var storage_url=Util.getStorageUrlForPreview();previewImage(storage_url,params.cur,parent.window.previewData,params.isdelivery,params.delivery_token)}else FileModel.metadata(function(result){var mask=document.createElement("div");mask.className="lui-mask",mask.style.zIndex="70",mask.id="lui-mask-iframe",document.body.appendChild(mask),previewImage(params.storageurl,params.cur,result.data.content)},decodeURIComponent(params.path),{offset:params.offset,limit:params.limit,cur:params.cur,path_type:params.path_type,from:params.from,prefix_neid:params.prefix_neid,content_type:FileModel.CONTENT_TYPE.FILE,orderby:params.orderby?params.orderby:FileModel.ORDERBY.NAME,sort:params.sort?params.sort:FileModel.SORT.ASC})}}),define("lenovodata/userController",function(require,exports){function controller(context,type,param){switch(type){case"auth":auth(context,param);break;case"frozen":frozen(context,param);break;case"activate":activate(context,param);break;case"delete":del(context,param);break;case"edit":edit(context,param);break;case"teamlist":teamlist(context,param);break;case"create":create(context,param);break;case"import":importUser(context,param);break;case"mobileCer":mobileCer(context,param)}}function auth(context,param){if("[object Array]"===Object.prototype.toString.call(param)){if(0==param.length)return void Tips.warn(_("请选择要批量授权的账户"));if(1==param.length){var path="";AuthModel.get(function(ret){return null==ret.code?void Tips.warn(_("很抱歉，您的操作失败了，建议您重试一下！")):void new ManageAuthDialog([param[0].uid],ret.data)},path,param.uid,AuthModel.AGENT_TYPE.USER)}else{for(var uids=[],i=0,len=param.length;len>i;i++)uids.push(param[i].uid);new ManageAuthDialog(uids)}}else{var path="";AuthModel.get(function(ret){return null==ret.code?void Tips.warn(_("很抱歉，您的操作失败了，建议您重试一下！")):void new ManageAuthDialog([param.uid],ret.data)},path,param.uid,AuthModel.AGENT_TYPE.USER)}}function activate(context,param){var uids=[];if("[object Array]"===Object.prototype.toString.call(param)){if(0==param.length)return void Tips.warn(_("请选择要激活的账户"));for(var i=0,len=param.length;len>i;i++)"true"==param[i].frozen&&uids.push(param[i].uid)}else uids.push(param.uid);return 0==uids.length?void Tips.warn(_("请选择要激活的账户")):void new ConfirmDialog({content:_("确认要激活选中的用户吗？")},function(){UserModel.batch_activate(function(ret){200==ret.code?(context.reload(),Tips.show(_("激活成功"))):Tips.warn(ret.message.join("<br/>"))},uids)})}function frozen(context,param){var uids=[];if("[object Array]"===Object.prototype.toString.call(param)){if(0==param.length)return void Tips.warn(_("请选择要冻结的账户"));for(var i=0,len=param.length;len>i;i++)uids.push(param[i].uid)}else uids.push(param.uid);new ConfirmDialog({content:_("冻结账户操作会使该账户无法登陆网盘，<br />但其个人空间中的数据和团队权限仍然保留。<br />您确定要冻结该账户吗？")},function(){UserModel.batch_freeze(function(ret){200==ret.code?(context.reload(),Tips.show(ret.message)):Tips.warn(ret.message.join("<br/>"))},uids)})}function del(context,param){var uids=[];if("[object Array]"===Object.prototype.toString.call(param)){if(0==param.length)return void Tips.warn(_("请选择要删除的账户"));for(var i=0,len=param.length;len>i;i++)uids.push(param[i].uid)}else uids.push(param.uid);new ConfirmDialog({content:_("删除用户会删除其所属的个人空间数据，并取消授予的权限，确定要删除该用户吗？")},function(){UserModel.batch_del(function(ret){if(200==ret.code)Tips.show(ret.message);else if(203==ret.code){var result=ret.data,users=[];$(result).each(function(i,value){var obj=value.user;obj.hasshare=value.hasshare,obj.index=i,users.push(obj)}),new TransferAuthDialog(1==uids.length?1:2,users,function(){context.reload()})}else Tips.warn(ret.message.join("<br/>"));context.reload()},uids)})}function edit(context,param){new UserInfoDialog(param[0],function(){context.reload()})}function create(context,teamId){new AddUserDialog(context,teamId,function(uidArr){var mad=new ManageAuthDialog(uidArr);mad.dialog.on("close",function(){context&&context.reload()})})}function importUser(context,param){var iud=new ImportUserDialog;iud.on("close",function(){context.reload()})}function teamlist(context,param){var uid=null;uid="[object Array]"===Object.prototype.toString.call(param)?param[0].uid:param.uid,Util.sendDirectlyRequest("用户/团队",$("body").data("action")+"查看","-"),new TeamOfUsersDialog(uid,function(){context.reload()})}function mobileCer(context,param){var obj={},create_template='<div class="dialog-button-area"><a id="create" class="dialog-button ok">'+_("确定")+'</a><a id="cancel" class="dialog-button cancel">'+_("取消")+"</a></div>",smsAuthDialog=new Dialog(_("手机验证"),function(parent,callback){obj.authTree=!0,obj.title=_("所有用户及团队"),obj.userTeamListTitle=_("团队及成员"),obj.authListTitle=_("已添加"),obj.mark=1;var userTeamAuthList=new UserTeamAuthList(parent,1,obj);parent.append(create_template),parent.find("#cancel").click(function(e){smsAuthDialog.close()}),userTeamAuthList.on("render",function(){callback()}),parent.find("#create").on("click",function(e){for(var arr=userTeamAuthList.getSelectedItem(),arrUid=[],arrTeamid=[],all=!1,i=0;i<arr.length;i++){var item=arr[i];"[object Function]"!=Object.prototype.toString.call(item)&&("all"==item.agent_type?all=!0:"team"==item.agent_type?arrTeamid.push(item.agent_id):arrUid.push(item.agent_id))}if(1!=all&&0==arrTeamid.length&&0==arrUid.length)return void smsAuthDialog.close();var post_data={user_ids:arrUid,team_ids:arrTeamid,all:all,action:"enable"};UserModel.smsAuthSet(function(ret){200==ret.code?(Tips.show(_("设置成功")),smsAuthDialog.close()):Tips.warn(ret.massage)},post_data)})})}var $=require("jquery"),Dialog=require("component/dialog"),Tips=require("component/tips"),AuthModel=require("model/AuthManager"),UserModel=require("model/UserManager"),ConfirmDialog=(require("model/TeamManager"),require("component/confirmDialog")),ManageAuthDialog=require("component/manageAuthDialog"),UserInfoDialog=require("component/userInfoDialog"),TeamOfUsersDialog=(require("component/dirSelectDialog"),require("component/teamOfUsersDialog")),AddUserDialog=require("component/addUserDialog"),ImportUserDialog=require("component/importUserDialog"),TransferAuthDialog=require("component/transferauthdialog"),UserTeamAuthList=require("component/userTeamAuthList");require("i18n");var _=$.i18n.prop;return controller}),define("lenovodata/util",function(require,exports,module){var $=require("jquery"),Tips=require("component/tips"),Wait=require("component/wait");require("i18n");var _=$.i18n.prop,unknownErrMessage=_("很抱歉，您的操作失败了，建议您重试一下！"),retVal={code:null,data:null,message:unknownErrMessage};return $.fn.selectRange=function(start,end){return this.each(function(){if(this.setSelectionRange)this.focus(),this.setSelectionRange(start,end);else if(this.createTextRange){var range=this.createTextRange();range.collapse(!0),range.moveEnd("character",end),range.moveStart("character",start),range.select()}})},Array.prototype.indexOf=function(key){for(var i=0;i<this.length;i++)if(this[i]==key)return i;return-1},{unknownErrMessage:unknownErrMessage,publick_confirm:function(){var r=confirm(CONFIRM_DELETE+"?");return r?!0:!1},random:function(){for(var baseStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="",n=10,i=0;n>i;i++)r+=baseStr.charAt(Math.floor(62*Math.random()));return r},unique1:function(arr){for(var n=[],i=0;i<arr.length;i++){for(var sign=!0,j=0;j<n.length;j++)n[j]==arr[i]&&(sign=!1);sign===!0&&n.push(arr[i])}return n},getTotalHeight:function(){return/msie/.test(navigator.userAgent.toLowerCase())?"CSS1Compat"==document.compatMode?document.documentElement.clientHeight:document.body.clientHeight:self.innerHeight;

},getTotalWidth:function(){return $.browser.msie?"CSS1Compat"==document.compatMode?document.documentElement.clientWidth:document.body.clientWidth:self.innerWidth},validEmail:function(email){var emailtest=/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/;return emailtest.test(email)},validMobile:function(value){var mtest=/^1[3|4|5|8|7]\d{9}$/;return mtest.test(value)},validPhone:function(phone){var reg=/(^((\d{7,8})|(\d{4}|\d{3})-(\d{7,8})|(\d{4}|\d{3})-(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1}))$)/;return reg.test(phone)},validNumber:function(number){var reg=/^\d+$/;return reg.test(number)},validFilename:function(filename){var reg=/[\/:*?"<>|\\]/;return reg.test(filename)?(Tips.warn(_("文件夹名称不能包括下列任何字符")+' : \\/:*?"<>|'),!1):!0},validInput:function(input,message){var reg=/[\^\.*<>%&',;=?$"':#@!~\]\[{}\\/`\|\+\-\(\)]/;return reg.test(input.val())?(Tips.warn(message?message:_("不能包括特殊字符")),input.focus(),!1):!0},focusAndBlurChTtColor:function(id,focusColor,blurColor){$(id).find(":text").focus(function(){var obj=$(this);obj.val()==obj.attr("def")?(obj.css("color",focusColor),obj.val(""),("pwd"==obj.attr("id")||"pwd2"==obj.attr("id"))&&obj.attr("type","password")):obj.css("color",focusColor)}),$(id).find(":password").focus(function(event){$(this).css("color",focusColor),$(event.target).closest(".pwdparent").find(".pwtip").hide()}),$(id).find(":password").blur(function(event){""==$.trim($(event.target).val())?$(event.target).closest(".pwdparent").find(".pwtip").show():$(event.target).closest(".pwdparent").find(".pwtip").hide()}),$(id).find(":password").closest(".pwdparent").find(".pwtip").bind("focus, click",function(event){$(event.target).hide(),$(event.target).closest(".pwdparent").find(":password").focus()}),$(id).find(":text").blur(function(){var obj=$(this);obj.val()||(obj.css("color",blurColor),obj.val($(this).attr("def")),("pwd"==obj.attr("id")||"pwd2"==obj.attr("id"))&&obj.attr("type","text"))}),$(id).find("textarea").focus(function(){var obj=$(this);obj.val()==obj.attr("def")?(obj.css("color",focusColor),obj.val("")):(obj.css("color",focusColor),/msie/.test(window.navigator.userAgent.toLocaleLowerCase())&&""==obj.val()&&obj.val(""))}),$(id).find("textarea").blur(function(){var obj=$(this);obj.val()||(obj.css("color",blurColor),obj.val($(this).attr("def")))})},ajax_json_process_user_batch_result:function(xhr,textStatus,successMsg){var data=xhr.responseJSON?xhr.responseJSON:{message:unknownErrMessage};switch(data||(data={}),xhr.status){case 200:for(var message=[],i=0,len=data.length;len>i;i++)200!=data[i].status&&message.push(data[i].message);retVal=message.length>0?{code:500,data:data,message:message}:{code:200,data:data,message:data[0].message};break;case 401:return void this.invalidSession();case 402:retVal={code:xhr.status,data:null,message:_("License已失效")};break;case 400:case 403:case 404:case 409:retVal={code:xhr.status,data:null,message:data.message};break;default:retVal={code:xhr.status,data:data,message:data.message}}return retVal},ajax_json_process_batch_result:function(xhr,textStatus,successMsg){var data=xhr.responseJSON?xhr.responseJSON:{message:unknownErrMessage};switch(data||(data={}),successMsg||(successMsg=_("成功")),void 0===data.content&&(data.content=[]),void 0===data.failed&&(data.failed=[]),xhr.status){case 200:case 207:for(var message=[],i=0,len=data.failed.length;len>i;i++)-1==message.indexOf(data.failed[i].message)&&message.push(data.failed[i].message);retVal=message.length>0?{code:500,data:null,message:message}:{code:200,data:data.success,message:successMsg};break;case 401:return void this.invalidSession();case 402:retVal={code:xhr.status,data:null,message:_("License已失效")};break;case 304:case 400:case 403:case 404:case 406:case 409:retVal={code:xhr.status,data:null,message:data.message};break;default:retVal={code:xhr.status,data:null,message:data.message}}return retVal},ajax_json_process_normal_result:function(xhr,textStatus,successMsg){var data=xhr.responseJSON?xhr.responseJSON:{message:unknownErrMessage};switch(data||(data={}),successMsg||(successMsg=_("成功")),void 0===data.content&&(data.content=[]),xhr.status){case 200:retVal={code:200,data:data,message:successMsg};break;case 207:for(var message=[],i=0,len=data.failed.length;len>i;i++)message.push(data.failed[i].message);retVal={code:500,data:null,message:message};break;case 401:if("invalid password/token"==data.code){retVal={code:401,data:data,message:data.message};break}return void this.invalidSession();case 402:retVal={code:xhr.status,data:null,message:_("License已失效")};break;case 403:retVal={code:data.state,data:data,message:data.message};break;case 304:case 400:case 404:case 406:case 409:retVal={code:xhr.status,data:null,message:data.message};break;default:retVal={code:xhr.status,data:null,message:data.message}}return retVal},_generateURLStr:function(url){var account_id_add=this.getAccountId(),uid_add=this.getUserID();return uid_add&&account_id_add&&(url+=-1==url.indexOf("?")?"?account_id="+account_id_add:"&account_id="+account_id_add,url+="&uid="+uid_add),url},ajax_json_get_nowait:function(url,callback){url=encodeURI(url),url=url.replace(/\+/g,"%2B"),url=url.replace(/#/g,"%23"),url+=-1==url.indexOf("?")?"?_="+ +new Date:"&_="+ +new Date,url=this._generateURLStr(url),$.ajax({type:"GET",url:url,async:!0,dataType:"json",complete:function(){callback.apply(this,arguments)}})},ajax_json_get:function(url,callback){url=encodeURI(url),url=url.replace(/\+/g,"%2B"),url=url.replace(/#/g,"%23"),url+=-1==url.indexOf("?")?"?_="+ +new Date:"&_="+ +new Date,url=this._generateURLStr(url);var wait=new Wait;$.ajax({type:"GET",url:url,async:!0,dataType:"json",complete:function(){try{wait.close(),callback.apply(this,arguments)}catch(e){wait.close()}},error:function(){wait.close()}})},ajax_json_post_nowait:function(url,postData,callback){url=encodeURI(url),url=url.replace(/\+/g,"%2B"),url=url.replace(/#/g,"%23"),url=this._generateURLStr(url),$.ajax({type:"POST",url:url,data:postData,async:!0,dataType:"json",contentType:"application/x-www-form-urlencoded",complete:function(){callback.apply(this,arguments)}})},ajax_json_post:function(url,postData,callback){url=encodeURI(url),url=url.replace(/\+/g,"%2B"),url=url.replace(/#/g,"%23"),url=this._generateURLStr(url);var wait=new Wait,self=this;$.ajax({type:"POST",url:url,data:postData,async:!0,dataType:"json",contentType:"application/x-www-form-urlencoded",complete:function(){try{wait.close(),callback.apply(this,arguments),self.sendBuridPointRequest()}catch(e){wait.close()}},error:function(){wait.close()}})},_formatUnits:function(baseNumber,unitDivisors,unitLabels,singleFractional){var i,unit,unitDivisor,unitLabel;if(0===baseNumber)return"0 "+unitLabels[unitLabels.length-1];if(singleFractional){for(unit=baseNumber,unitLabel=unitLabels.length>=unitDivisors.length?unitLabels[unitDivisors.length-1]:"",i=0;i<unitDivisors.length;i++)if(baseNumber>=unitDivisors[i]){unit=(baseNumber/unitDivisors[i]).toFixed(2),unitLabel=unitLabels.length>=i?" "+unitLabels[i]:"";break}return unit+unitLabel}var formattedStrings=[],remainder=baseNumber;for(i=0;i<unitDivisors.length;i++)unitDivisor=unitDivisors[i],unitLabel=unitLabels.length>i?" "+unitLabels[i]:"",unit=remainder/unitDivisor,unit=i<unitDivisors.length-1?Math.floor(unit):unit.toFixed(0),unit>0&&(remainder%=unitDivisor,formattedStrings.push(unit+unitLabel));return formattedStrings.join(" ")},formatBytes:function(baseNumber){var sizeUnits=[1099511627776,1073741824,1048576,1024,1],sizeUnitLabels=["TB","GB","MB","KB","B"];return this._formatUnits(baseNumber,sizeUnits,sizeUnitLabels,!0)},formatTime:function(baseNumber){var timeUnits=[86400,3600,60,1],timeUnitLabels=[_("天"),_("时"),_("分"),_("秒")];return this._formatUnits(baseNumber,timeUnits,timeUnitLabels,!1)},canPreview:function(mime){return/\.doc|pdf|ppt|xls|docx|pptx|xlsx|png|jpeg|jpg|gif|pic|word|excel/.test(mime)},canEdit:function(mime){return/\.doc|pdf|ppt|xls|docx|pptx|xlsx/.test(mime)},resolvePath:function(path,flag){var name,suffix,regName=/\/([^\/]+)$/,exSuffix=/\.([^.]+)$/;return path?(name=path.match(regName),!flag&&name[1]&&(suffix=name[1].match(exSuffix)||["",""]),{name:name[1]||"",type:flag?"folder":suffix[1].toLowerCase()}):""},resolveFolderType:function(share){var ret="folder";return share&&(ret=this.isAdmin()?"folder_team":"folder_share"),ret},resolveAuth:function(auth){var permission="";switch(auth){case"r":permission=_("下载");break;case"w":permission=_("上传");break;case"rw":permission=_("上传/下载")}return permission},resolvePrivilegeID:function(auth){var privilege_id="";switch(auth){case"preview":privilege_id="2009";break;case"upload":privilege_id="2008";break;case"upload:delivery":privilege_id="2007";break;case"download":privilege_id="2006";break;case"download:delivery":privilege_id="2005";break;case"upload:download":privilege_id="2004";break;case"upload:download:delivery":privilege_id="2003";break;case"edit":privilege_id="2001";break;default:privilege_id="2009"}return privilege_id},resolveCSSAction:function(id){var cssAction="";switch(""+id){case"2009":cssAction="preview";break;case"2008":cssAction="upload";break;case"2007":cssAction="upload:delivery";break;case"2006":cssAction="download";break;case"2005":cssAction="download:delivery";break;case"2004":cssAction="upload:download";break;case"2003":cssAction="upload:download:delivery";break;case"2001":cssAction="edit";break;default:cssAction="preview"}return cssAction},resolveFileAction:function(id){var fileAction="";switch(""+id){case"2047":fileAction="edit";break;case"1048":fileAction="create_delivery";break;case"1087":fileAction="upload:download:delivery";break;case"1599":fileAction="upload:download:delivery";break;case"1063":fileAction="upload:download";break;case"1575":fileAction="upload:download";break;case"1045":fileAction="download:delivery";break;case"1557":fileAction="download:delivery";break;case"1029":fileAction="download";break;case"1541":fileAction="download";break;case"1066":fileAction="upload:delivery";break;case"1058":fileAction="upload";break;case"1059":fileAction="upload:preview";break;case"0":fileAction="noAction";break;default:fileAction="preview"}return fileAction},resolveActionCss:function(cssAction){var action=0;switch(cssAction){case"edit":action=2047;break;default:action=1025}return action},formatDate:function(dateObj,fmt){var year,month,date,hours,minutes,seconds;if(dateObj){if("[object Date]"==Object.prototype.toString.call(dateObj))year=dateObj.getFullYear(),month=dateObj.getMonth()+1,date=dateObj.getDate(),hours=dateObj.getHours(),minutes=dateObj.getMinutes(),seconds=dateObj.getSeconds();else{var regexp=/([\d]{4})-([\d]{2})-([\d]{2})T([\d]{2}):([\d]{2}):([\d]{2})(?:\+([\d]{2}):([\d]{2}))?/,d=regexp.exec(dateObj);if(!d)return;year=d[1],month=d[2],date=d[3],hours=d[4],minutes=d[5],seconds=d[6]}var o={"M+":+month,"d+":+date,"h+":+hours,"m+":+minutes,"s+":+seconds,"q+":Math.floor((+month+3)/3)};/(y+)/.test(fmt)&&(fmt=fmt.replace(RegExp.$1,(year+"").substr(4-RegExp.$1.length)));for(var k in o)new RegExp("("+k+")").test(fmt)&&(fmt=fmt.replace(RegExp.$1,1==RegExp.$1.length?o[k]:("00"+o[k]).substr((""+o[k]).length)));return fmt}},scientificToString:function(sn){var n=sn.toString(),output="",negative=/([\d\.]+)e-(\d+)/i.exec(n),positive=/([\d\.]+)e\+(\d+)/i.exec(n);if(negative){var num=negative[1].replace(".",""),numDecs=negative[2]-1;output="0.";for(var i=0;numDecs>i;i++)output+="0";output+=num}else{if(!positive)return n.toString();var idx=positive[1].indexOf(".");0>idx&&(idx=0);for(var num=positive[1].replace(".",""),numDecs=positive[2]-num.length+idx,i=0;numDecs>i;i++)output+="0";output=num+output}return output},haveDirAuth:function(fileObj){return this.isAdmin()||fileObj&&fileObj.authable},isOwner:function(creator){return window.LenovoData&&window.LenovoData.user.user_info.user_name==creator},isAdmin:function(){return window.LenovoData&&"admin"==window.LenovoData.user.user_role},isTeamLeader:function(){return window.LenovoData&&"admin"==window.LenovoData.user.team_role},getUserID:function(){return window.LenovoData?window.LenovoData.user.user_info.uid:-1},isUser:function(){return!this.isAdmin()&&!this.isTeamLeader()},isTrialUser:function(){return window.LenovoData&&"trial"==window.LenovoData.user.account_info.type},getUserSpaceUsed:function(){return window.LenovoData&&window.LenovoData.user.user_info.used},getUserSpaceQuota:function(){return window.LenovoData&&window.LenovoData.user.user_info.quota},getUserName:function(){return window.LenovoData&&window.LenovoData.user.user_info.user_name},getUserAccountNumUsed:function(){return window.LenovoData&&window.LenovoData.user.account_info.user_num.used},getUserAccountNumQuota:function(){return window.LenovoData&&window.LenovoData.user.account_info.user_num.limit},getRootDisplayName:function(type){var name="";switch(type){case"ent":name=_("企业空间");break;case"self":name=_("个人文件");break;case"share_out":name=_("我的共享");break;case"share_in":name=_("收到的共享");break;default:name=_("个人文件")}return name},invalidSession:function(){window.location.href="/user/login"},getStorageUrlForPreview:function(){var url=parent.window.LenovoData&&parent.window.LenovoData.storage_url?parent.window.LenovoData.storage_url:"";return url},getStorageUrl:function(){var url=window.LenovoData&&window.LenovoData.storage_url?window.LenovoData.storage_url:"";return url},queryString:function(str){str=str.substr(1);for(var keyValArr=str.split("&"),keyValObj={},i=0,len=keyValArr.length;len>i;i++){var a=keyValArr[i].split("=");a.length>1&&(keyValObj[a[0].toLowerCase()]=a[1])}return keyValObj},isPathRoot:function(path){var isNotRoot=/\/.+?\/.+/.test(path);return!isNotRoot},errorLog:function(flags,errcode,message){this.sendLog("flags="+flags,"errcode="+errcode,"message="+encodeURIComponent(message))},sendLog:function(){for(var param=[],i=0,len=arguments.length;len>i;i++)param.push(arguments[i]);var userId=this.getUserID();param.push("uid="+userId);var statUrl="/st.php?"+param.join("&");this.ajax_json_get(statUrl)},getElementYPos:function(el){var offset=el.offsetTop;return null!=el.offsetParent&&(offset+=this.getElementYPos(el.offsetParent)),offset},getElementXPos:function(el){var offset=el.offsetLeft;return null!=el.offsetParent&&(offset+=this.getElementXPos(el.offsetParent)),offset},getBytes:function(str){for(var len=str.length,bytes=len,i=0;len>i;i++)str.charCodeAt(i)>255&&bytes++;return bytes},getAccountId:function(){return window.LenovoData?window.LenovoData.user.account_info._id:-1},checkFlashInstalled:function(){var isInstalled=!0;if(/msie/.test(navigator.userAgent.toLowerCase()))try{flashObject=new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){isInstalled=!1}else navigator.plugins["Shockwave Flash"]||(isInstalled=!1);return isInstalled},getTopTeamName:function(path){var reg1=/^\/([^\/]+)$/,reg2=/^\/([^\/]+)([\/\S]+)$/,name=path.match(reg1);return name&&name[1]?name[1]:(name=path.match(reg2),name&&name[1]?name[1]:path.split("/")[1])},getTeamAdminTeamPath:function(path){var reg1=/^\/([^\/]+)$/,reg2=/^\/([^\/]+)([\/\S]+)$/,name=path.match(reg1);if(name&&name[1])return path+"(team)";if(name=path.match(reg2),name&&name[1])return"/"+name[1]+"(team)"+name[2];var t_names=path.split("/");return t_names[1]=t_names[1]+"(team)",t_names.join("/")},getParentPath:function(path){var parentPath=path.substring(0,path.lastIndexOf("/"));return"/"==parentPath&&(parentPath=""),parentPath},getMyEncodeURI:function(path){return path=encodeURI(path).replace(/\&/g,"%26").replace(/#/g,"%23").replace(/\+/g,"%2B")},buildRequestUrl:function(category,action,content){var uid=this.getUserID(),account_id=this.getAccountId(),url="https://sahara.box.lenovo.com/st.gif?",param=[];return param.push("ca="+category),param.push("ac="+action),param.push("co="+content),param.push("uid="+uid),param.push("aid="+account_id),param.push("_="+(new Date).getTime()),url+""+encodeURI(param.join("&"))},sendDirectlyRequest:function(category,action,content){var self=this,image=new Image;if(image.src=self.buildRequestUrl(category,action,content),image.complete);else try{image.onload=function(){},image.onerror=function(){}}catch(e){}},sendBuridPointRequest:function(){var action=$("body").data("action"),category=$("body").data("category"),content=$("body").data("content"),map={preview:"预览",move:"移动",rename:"重新命名","delete":"删除",copy:"复制",download:"下载",share:"外链",rmShare:"取消外链",remove:"删除",recover:"恢复已经删除",purge:"永久删除",addfolder:"新建目录",attribute:"属性",remarkEdit:"编辑备注",cleanup:"设置定期清理",history:"历史版本",activate:"激活",frozed:"激活",frozen:"冻结",useredit:"设置",edit:"设置",subtract:"移出团队",kickoff:"移出团队",create:"创建","import":"批量导入",add:"添加",update:"修改",auth:"权限",authedit:"编辑授权",addauth:"添加授权",rmAuth:"删除授权",login:"登录/注销",box:"网盘设置",message:"公告",modify:"修改",send:"发送",lookup:"访问",deleteTeam:"删除",teamSetting:"修改",adduser:"添加用户",linkdownload:"外链",linkpreview:"外链",upload:"上传",historyrecover:"历史版本",lock:"锁定",unlock:"解锁",exitshare:"退出共享",cancelauth:"取消共享",transfer:"移交权限",notice:"消息设置"},ca="";map[category]&&(ca=map[category]);var pathname=location.pathname;"rename"==category||"recover"==category||"purge"==category||"remove"==category||"addfolder"==category||"delete"==category&&"/"==pathname?this.sendDirectlyRequest("文件列表",action+ca,content):"copy"==category||"move"==category?this.sendDirectlyRequest("网盘移动复制",action+ca,content):"auth"==category?this.sendDirectlyRequest(ca,"确定",content):"share"==category?this.sendDirectlyRequest("设置外链",action+"创建",content):"modify"==category||"send"==category?this.sendDirectlyRequest("设置外链",action+ca,content):"linkdownload"==category||"linkpreview"==category?this.sendDirectlyRequest("使用外链",action,content):"rmShare"==category||"delete"==category&&"/link/list"==pathname?this.sendDirectlyRequest("设置外链","删除外链",content):"import"==category?this.sendDirectlyRequest("用户/团队","批量导入","用户"):"deleteTeam"==category||"teamSetting"==category||"add"==category?this.sendDirectlyRequest("用户/团队",ca,"团队"):"adduser"==category||"subtract"==category||"kickoff"==category?this.sendDirectlyRequest("用户/团队","添加删除用户","团队"):"addauth"==category||"authedit"==category||"auth"==category&&"/user/manage"==pathname?this.sendDirectlyRequest("用户/团队","编辑授权","团队"):"useredit"==category||"edit"==category?this.sendDirectlyRequest("用户/团队","修改设置","用户"):"activate"==category||"frozed"==category||"frozen"==category||"create"==category?this.sendDirectlyRequest("用户/团队",ca,"用户"):"remarkEdit"==category||"cleanup"==category?this.sendDirectlyRequest("属性",action+ca,content):"historyrecover"==category?this.sendDirectlyRequest("历史版本",action,content):this.sendDirectlyRequest(ca,action+ca,content)},getApiVersion:function(){return"/v2"},dataInArray:function(obj,arr){var flag=!1;if(obj&&arr&&arr.length>0)for(var i in arr)"all"==obj.agent_type&&"all"==arr[i].agent_type?flag=!0:arr[i].id==obj.id&&arr[i].agent_type==obj.agent_type&&(flag=!0);return flag},typeIcon:function(typeIcon){var Extension,ImgType=typeIcon,jar={folder_team:"folder_team",folder_share:"folder_share",folder:"folder",doc:"word",docx:"word",rtf:"word",txt:"text",jpg:"pic",jpeg:"pic",png:"pic",bmp:"pic",gif:"pic",tiff:"pic",pcx:"pic",psd:"pic",thm:"pic",yuv:"pic",pps:"ppt",ppsx:"ppt",ppt:"ppt",pptx:"ppt",xls:"excel",xlsx:"excel",csv:"excel",lock:"lock",pct:"pdf",pdf:"pdf",pmd:"pdf",mp3:"music",wma:"music",ra:"music",wav:"music",mid:"music",vqf:"music",aif:"music",au:"music",dsp:"music",cmf:"music",cda:"music",mod:"music",iff:"music",m3u:"music",m4a:"music",mpa:"music",aiff:"music",avi:"video",mov:"video",mpg:"video",mp4:"video",xv:"video","3gp":"video",divx:"video",dat:"video",rm:"video",rmvb:"video",asf:"video",wmv:"video",vob:"video",mkv:"video",flv:"video","3g2":"video",asx:"video",exe:"exe",rar:"zip",zip:"zip",zipx:"zip","7z":"zip",cab:"zip",arj:"zip",jar:"zip",lzh:"zip",bin:"zip",deb:"zip",gz:"zip",rpm:"zip",sit:"zip",sitx:"zip",tar:"zip",cad:"cad",dxf:"cad",psd:"ps",ai:"ai",dw:"dw",fil:"fl",id:"id",ae:"ae","3d":"3d",eps:"svg",svg:"svg",cdr:"svg",cdr:"svg",pages:"other",log:"other",msg:"other",wps:"other",xps:"other",chm:"other",pdg:"other",key:"other",dat:"other",efx:"other",sdf:"other",vcf:"other",wks:"other",munbers:"other","3dm":"other",max:"other",com:"other",bat:"other",scr:"other",lib:"other",app:"other",cgi:"other",gadget:"other",vb:"other",wsf:"other",accdb:"other",db:"other",dbf:"other",mdb:"other",pdb:"other",sql:"other",cpl:"setting",cur:"setting",dll:"setting",dmp:"setting",drv:"setting",lnk:"setting",sys:"setting",cfg:"setting",ini:"setting",keychain:"setting",prf:"setting",c:"cpp","class":"cpp",cpp:"cpp",cs:"cpp",dtd:"cpp",fla:"cpp",java:"cpp",m:"cpp",pl:"cpp",py:"cpp",html:"html",htm:"html",xhtml:"html",php:"html",css:"html",js:"html",xml:"html",asp:"html",cer:"html",rss:"html",ttf:"font",fnt:"font",otf:"font",fon:"font",dmg:"iso",toast:"iso",vcd:"iso",iso:"iso"};return $.map(jar,function(key,value){ImgType==value&&(Extension=key)}),void 0==Extension&&(Extension="other"),typeIcon=Extension},getPathType:function(){var pathname=location.pathname;return"/"==pathname?"ent":"/folder/self"==pathname?"self":"/folder/myshare"==pathname?"share_out":"/folder/shared"==pathname?"share_in":"self"}}});